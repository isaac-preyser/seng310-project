"use strict";var jsdrawMaterialIcons=(()=>{var mn=Object.defineProperty;var ks=Object.getOwnPropertyDescriptor;var Rs=Object.getOwnPropertyNames;var Is=Object.prototype.hasOwnProperty;var Ls=(s,o)=>{for(var e in o)mn(s,e,{get:o[e],enumerable:!0})},zs=(s,o,e,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let i of Rs(o))!Is.call(s,i)&&i!==e&&mn(s,i,{get:()=>o[i],enumerable:!(n=ks(o,i))||n.enumerable});return s};var Bs=s=>zs(mn({},"__esModule",{value:!0}),s);var wl={};Ls(wl,{makeMaterialIconProviderClass:()=>fs});var fn=class s{onDrop(o){}static union(o,e){return new class extends s{apply(n){o.apply(n),e.apply(n)}unapply(n){e.unapply(n),o.unapply(n)}description(n,i){let r=o.description(n,i),a=e.description(n,i);return r===a?r:`${r}, ${a}`}}}static{this.empty=new class extends s{description(o,e){return""}apply(o){}unapply(o){}}}},Pe=fn;var gn=class{constructor(o,e,n){this.x=o;this.y=e;this.z=n}get xy(){return{x:this.x,y:this.y}}at(o){if(o===0)return this.x;if(o===1)return this.y;if(o===2)return this.z;throw new Error(`${o} out of bounds!`)}length(){return this.magnitude()}magnitude(){return Math.sqrt(this.magnitudeSquared())}magnitudeSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}squareDistanceTo(o){let e=this.x-o.x,n=this.y-o.y,i=this.z-o.z;return e*e+n*n+i*i}distanceTo(o){return Math.sqrt(this.squareDistanceTo(o))}maximumEntryMagnitude(){return Math.max(Math.abs(this.x),Math.max(Math.abs(this.y),Math.abs(this.z)))}angle(){return Math.atan2(this.y,this.x)}normalized(){let o=this.magnitude();return N.of(this.x/o,this.y/o,this.z/o)}normalizedOrZero(){return this.eq(N.zero)?N.zero:this.normalized()}times(o){return N.of(this.x*o,this.y*o,this.z*o)}plus(o){return N.of(this.x+o.x,this.y+o.y,this.z+o.z)}minus(o){return N.of(this.x-o.x,this.y-o.y,this.z-o.z)}dot(o){return this.x*o.x+this.y*o.y+this.z*o.z}cross(o){return N.of(this.y*o.z-o.y*this.z,o.x*this.z-this.x*o.z,this.x*o.y-o.x*this.y)}scale(o){return typeof o=="number"?this.times(o):N.of(this.x*o.x,this.y*o.y,this.z*o.z)}orthog(){return this.dot(N.unitX)===0&&this.dot(N.unitY)===0?this.dot(N.unitX)===0?N.unitX:this.cross(N.unitX).normalized():this.cross(N.unitZ.times(-1)).normalized()}extend(o,e){return this.plus(e.normalized().times(o))}lerp(o,e){return this.times(1-e).plus(o.times(e))}zip(o,e){return N.of(e(o.x,this.x),e(o.y,this.y),e(o.z,this.z))}map(o){return N.of(o(this.x,0),o(this.y,1),o(this.z,2))}asArray(){return[this.x,this.y,this.z]}eq(o,e=1e-10){return Math.abs(o.x-this.x)<=e&&Math.abs(o.y-this.y)<=e&&Math.abs(o.z-this.z)<=e}toString(){return`Vec(${this.x}, ${this.y}, ${this.z})`}},bn=class{constructor(o,e){this.x=o;this.y=e}get z(){return 0}get xy(){return{x:this.x,y:this.y}}at(o){if(o===0)return this.x;if(o===1)return this.y;if(o===2)return 0;throw new Error(`${o} out of bounds!`)}length(){return this.magnitude()}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}magnitudeSquared(){return this.x*this.x+this.y*this.y}squareDistanceTo(o){let e=this.x-o.x,n=this.y-o.y;return e*e+n*n+o.z*o.z}distanceTo(o){return Math.sqrt(this.squareDistanceTo(o))}maximumEntryMagnitude(){return Math.max(Math.abs(this.x),Math.abs(this.y))}angle(){return Math.atan2(this.y,this.x)}normalized(){let o=this.magnitude();return S.of(this.x/o,this.y/o)}normalizedOrZero(){return this.eq(N.zero)?N.zero:this.normalized()}times(o){return S.of(this.x*o,this.y*o)}plus(o){return N.of(this.x+o.x,this.y+o.y,o.z)}minus(o){return N.of(this.x-o.x,this.y-o.y,-o.z)}dot(o){return this.x*o.x+this.y*o.y}cross(o){return N.of(this.y*o.z,-this.x*o.z,this.x*o.y-o.x*this.y)}scale(o){return typeof o=="number"?this.times(o):S.of(this.x*o.x,this.y*o.y)}orthog(){return this.dot(N.unitX)===0&&this.dot(N.unitY)===0?this.dot(N.unitX)===0?N.unitX:this.cross(N.unitX).normalized():this.cross(N.unitZ.times(-1)).normalized()}extend(o,e){return this.plus(e.normalized().times(o))}lerp(o,e){return this.times(1-e).plus(o.times(e))}zip(o,e){return N.of(e(o.x,this.x),e(o.y,this.y),e(o.z,0))}map(o){return N.of(o(this.x,0),o(this.y,1),o(0,2))}asArray(){return[this.x,this.y,0]}eq(o,e=1e-10){return Math.abs(o.x-this.x)<=e&&Math.abs(o.y-this.y)<=e&&Math.abs(o.z)<=e}toString(){return`Vec(${this.x}, ${this.y})`}},S;(r=>(r.of=(a,l)=>new bn(a,l),r.ofXY=({x:a,y:l})=>r.of(a,l),r.unitX=r.of(1,0),r.unitY=r.of(0,1),r.zero=r.of(0,0)))(S||={});var N;(r=>(r.of=(a,l,c)=>c===0?S.of(a,l):new gn(a,l,c),r.unitX=S.unitX,r.unitY=S.unitY,r.zero=S.zero,r.unitZ=r.of(0,0,1)))(N||={});var ye=N;var I=class s{constructor(o,e,n,i,r,a,l,c,d){this.a1=o;this.a2=e;this.a3=n;this.b1=i;this.b2=r;this.b3=a;this.c1=l;this.c2=c;this.c3=d;this.cachedInverse=void 0;this.rows=[ye.of(o,e,n),ye.of(i,r,a),ye.of(l,c,d)]}static ofRows(o,e,n){return new s(o.x,o.y,o.z,e.x,e.y,e.z,n.x,n.y,n.z)}static{this.identity=new s(1,0,0,0,1,0,0,0,1)}inverse(){return this.computeInverse()??s.identity}invertable(){return this.computeInverse()!==null}computeInverse(){if(this.cachedInverse!==void 0)return this.cachedInverse;let o=[this.rows[0],this.rows[1],this.rows[2]],e=[ye.unitX,ye.unitY,ye.unitZ];for(let i=0;i<3;i++){let r=o[i].at(i),a=1e-10;if(Math.abs(r)<a){let p=-1;for(let f=1;f<=2;f++){let v=(i+f)%3;if(Math.abs(o[v].at(i))>=a){p=v;break}}if(p===-1)return this.cachedInverse=null,null;let u=o[i],h=e[i];o[i]=o[p],e[i]=e[p],o[p]=u,e[p]=h,r=o[i].at(i)}let l=1/r;o[i]=o[i].times(l),e[i]=e[i].times(l);let c=o[i],d=e[i];for(let p=1;p<=2;p++){let u=(i+p)%3;l=-o[u].at(i),o[u]=o[u].plus(c.times(l)),e[u]=e[u].plus(d.times(l))}}let n=s.ofRows(e[0],e[1],e[2]);return this.cachedInverse=n,n}transposed(){return new s(this.a1,this.b1,this.c1,this.a2,this.b2,this.c2,this.a3,this.b3,this.c3)}rightMul(o){o=o.transposed();let e=(n,i)=>this.rows[n].dot(o.rows[i]);return new s(e(0,0),e(0,1),e(0,2),e(1,0),e(1,1),e(1,2),e(2,0),e(2,1),e(2,2))}transformVec2(o){let e=ye.of(o.x,o.y,1);return e=this.transformVec3(e),S.of(e.x,e.y)}transformVec3(o){return ye.of(this.rows[0].dot(o),this.rows[1].dot(o),this.rows[2].dot(o))}isIdentity(){return this===s.identity?!0:this.eq(s.identity)}eq(o,e=0){for(let n=0;n<3;n++)if(!this.rows[n].eq(o.rows[n],e))return!1;return!0}toString(){let o="",e=[0,0,0];for(let n of this.rows)for(let i=0;i<3;i++)e[i]=Math.max(e[0],`${n.at(i)}`.length);for(let n=0;n<3;n++){n===0?o+="\u23A1 ":n===1?o+="\u23A2 ":o+="\u23A3 ";for(let i=0;i<3;i++){let r=this.rows[n].at(i).toString(),a="";for(let l=r.length;l<e[i];l++)a+=" ";o+=r+", "+a}n===0?o+=" \u23A4":n===1?o+=" \u23A5":o+=" \u23A6",o+=`
`}return o.trimEnd()}toArray(){return[this.a1,this.a2,this.a3,this.b1,this.b2,this.b3,this.c1,this.c2,this.c3]}mapEntries(o){return new s(o(this.a1,[0,0]),o(this.a2,[0,1]),o(this.a3,[0,2]),o(this.b1,[1,0]),o(this.b2,[1,1]),o(this.b3,[1,2]),o(this.c1,[2,0]),o(this.c2,[2,1]),o(this.c3,[2,2]))}getScaleFactor(){return Math.hypot(this.a1,this.a2)}getColumn(o){return ye.of(this.rows[0].at(o),this.rows[1].at(o),this.rows[2].at(o))}maximumEntryMagnitude(){let o=Math.abs(this.a1);for(let e of this.toArray())o=Math.max(o,Math.abs(e));return o}static translation(o){return new s(1,0,o.x,0,1,o.y,0,0,1)}static zRotation(o,e=S.zero){if(o===0)return s.identity;let n=Math.cos(o),i=Math.sin(o),r=s.translation(e);return r=r.rightMul(new s(n,-i,0,i,n,0,0,0,1)),r.rightMul(s.translation(e.times(-1)))}static scaling2D(o,e=S.zero){let n=s.translation(e),i,r;return typeof o=="number"?(i=o,r=o):(i=o.x,r=o.y),n=n.rightMul(new s(i,0,0,0,r,0,0,0,1)),n.rightMul(s.translation(e.times(-1)))}toCSSMatrix(){return`matrix(${this.a1},${this.b1},${this.a2},${this.b2},${this.a3},${this.b3})`}static fromCSSMatrix(o){if(o===""||o==="none")return s.identity;o=o.trim().replace(/\s+/g," ");let e=l=>l.split(/[, \t\n]+/g).map(d=>{if(d.trim()==="")return null;let p=!1;if(d.endsWith("%")&&(p=!0,d=d.substring(0,d.length-1)),d=d.replace(/px$/gi,""),!/^[-]?\d*(?:\.\d*)?(?:[eE][-+]?\d+)?$/i.exec(d))throw new Error(`All arguments to transform functions must be numeric (state: ${JSON.stringify({currentArgument:d,allArguments:l})})`);let h=parseFloat(d);return p&&(h/=100),h}).filter(d=>d!==null),n={matrix:l=>{if(l.length!==6)throw new Error(`Invalid matrix argument: ${l}. Must have length 6`);let c=l[0],d=l[1],p=l[2],u=l[3],h=l[4],f=l[5];return new s(c,p,h,d,u,f,0,0,1)},scale:l=>{let c,d;if(l.length===1)c=l[0],d=l[0];else if(l.length===2)c=l[0],d=l[1];else throw new Error(`The scale() function only supports two arguments. Given: ${l}`);return s.scaling2D(S.of(c,d))},translate:l=>{let c=0,d=0;if(l.length===1)c=l[0];else if(l.length===2)c=l[0],d=l[1];else throw new Error(`The translate() function requires either 1 or 2 arguments. Given ${l}`);return s.translation(S.of(c,d))}},i=/(?:^|\W)(\w+)\s?\(([^)]*)\)/gi,r,a=null;for(;(r=i.exec(o))!==null;){let l=r[1].toLowerCase();if(!(l in n))throw new Error(`Unsupported CSS transform action: ${l}`);let c=e(r[2]),d=n[l](c);a?a=a.rightMul(d):a=d}return a??s.identity}},Ai=I;var So=class s{static{this.smallValue=1e-12}distance(o){return Math.abs(this.signedDistance(o))}containsPoint(o,e=s.smallValue){return this.signedDistance(o)<e}getLooseBoundingBox(){return this.getTightBoundingBox()}},wo=So;var z=class s extends wo{constructor(e,n,i,r){super();this.x=e;this.y=n;this.w=i;this.h=r;i<0&&(this.x+=i,this.w=Math.abs(i)),r<0&&(this.y+=r,this.h=Math.abs(r)),this.topLeft=S.of(this.x,this.y),this.size=S.of(this.w,this.h),this.area=this.w*this.h}translatedBy(e){return new s(e.x+this.x,e.y+this.y,this.w,this.h)}resizedTo(e){return new s(this.x,this.y,e.x,e.y)}containsPoint(e){return this.x<=e.x&&this.y<=e.y&&this.x+this.w>=e.x&&this.y+this.h>=e.y}containsRect(e){return this.x<=e.x&&this.y<=e.y&&this.x+this.w>=e.x+e.w&&this.y+this.h>=e.y+e.h}intersects(e){let n=this.x,i=n+this.w,r=e.x,a=e.x+e.w;if(i<r||n>a)return!1;let l=this.y,c=l+this.h,d=e.y,p=e.y+e.h;return!(c<d||l>p)}intersection(e){if(!this.intersects(e))return null;let n=this.topLeft.zip(e.topLeft,Math.max),i=this.bottomRight.zip(e.bottomRight,Math.min);return s.fromCorners(n,i)}union(e){return s.union(this,e)}divideIntoGrid(e,n){let i=[];if(e<=0||n<=0)return i;let r=this.w/e,a=this.h/n;r===0&&(e=1),a===0&&(n=1);for(let l=0;l<n;l++)for(let c=0;c<e;c++){let d=r*c+this.x,p=a*l+this.y;i.push(new s(d,p,r,a))}return i}grownToPoint(e,n=0){let i=new s(e.x-n,e.y-n,n*2,n*2);return this.union(i)}grownBy(e){if(e===0)return this;if(e<0){let n=-Math.min(-e,this.w/2),i=-Math.min(-e,this.h/2);return new s(this.x-n,this.y-i,this.w+n*2,this.h+i*2)}return new s(this.x-e,this.y-e,this.w+e*2,this.h+e*2)}grownToSize(e){if(this.width>=e.x&&this.height>=e.y)return this;let n=Math.max(0,e.x-this.width),i=Math.max(0,e.y-this.height);return new s(this.x-n/2,this.y-i/2,this.width+n,this.height+i)}getClosestPointOnBoundaryTo(e){let n=this.getEdges().map(a=>a.closestPointTo(e)),i=null,r=null;for(let a of n){let l=a.distanceTo(e);(r===null||l<r)&&(i=a,r=l)}return i}isWithinRadiusOf(e,n){if(this.maxDimension>e)return!1;let i=e*e;return this.corners.every(r=>r.minus(n).magnitudeSquared()<i)}get corners(){return[this.bottomRight,this.topRight,this.topLeft,this.bottomLeft]}get maxDimension(){return Math.max(this.w,this.h)}get minDimension(){return Math.min(this.w,this.h)}get bottomRight(){return this.topLeft.plus(this.size)}get topRight(){return this.bottomRight.plus(S.of(0,-this.h))}get bottomLeft(){return this.topLeft.plus(S.of(0,this.h))}get width(){return this.w}get height(){return this.h}get center(){return S.of(this.x+this.w/2,this.y+this.h/2)}getEdges(){let e=this.corners;return[new Te(e[0],e[1]),new Te(e[1],e[2]),new Te(e[2],e[3]),new Te(e[3],e[0])]}intersectsLineSegment(e){let n=[];for(let i of this.getEdges())i.intersectsLineSegment(e).forEach(a=>n.push(a));return n}signedDistance(e){let n=this.getClosestPointOnBoundaryTo(e),i=e.minus(n).magnitude();return this.containsPoint(e)?-i:i}getTightBoundingBox(){return this}transformedBoundingBox(e){return e===Ai.identity?this:s.bboxOf(this.corners.map(n=>e.transformVec2(n)))}eq(e,n=0){return this.topLeft.eq(e.topLeft,n)&&this.size.eq(e.size,n)}toString(){return`Rect(point(${this.x}, ${this.y}), size(${this.w}, ${this.h}))`}static fromCorners(e,n){return new s(Math.min(e.x,n.x),Math.min(e.y,n.y),Math.abs(e.x-n.x),Math.abs(e.y-n.y))}static bboxOf(e,n=0){let i=0,r=0,a=0,l=0,c=!0;for(let d of e)c&&(i=d.x,r=d.y,a=d.x,l=d.y,c=!1),i=Math.min(i,d.x),r=Math.min(r,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y);return s.fromCorners(S.of(i-n,r-n),S.of(a+n,l+n))}static union(...e){if(e.length===0)return s.empty;let n=e[0],i=n.x,r=n.y,a=n.x+n.w,l=n.y+n.h;for(let c=1;c<e.length;c++){let d=e[c];i=Math.min(i,d.x),r=Math.min(r,d.y),a=Math.max(a,d.x+d.w),l=Math.max(l,d.y+d.h)}return new s(i,r,a-i,l-r)}static of(e){let n=e.width??e.w??0,i=e.height??e.h??0;return new s(e.x,e.y,n,i)}static{this.empty=new s(0,0,0,0)}static{this.unitSquare=new s(0,0,1,1)}},le=z;var Po=class extends wo{intersectsLineSegment(o){return this.argIntersectsLineSegment(o).map(e=>this.at(e))}},xt=Po;var pe=class s extends xt{constructor(e,n){super();this.point1=e;this.point2=n;this.bbox=le.bboxOf([e,n]),this.direction=n.minus(e),this.length=this.direction.magnitude(),this.length>0&&(this.direction=this.direction.times(1/this.length))}static ofSmallestContainingPoints(e){if(e.length<=1)return null;let n=[...e].sort((r,a)=>r.x!==a.x?r.x-a.x:r.y-a.y),i=new s(n[0],n[n.length-1]);for(let r of n)if(!i.containsPoint(r))return null;return i}get p1(){return this.point1}get p2(){return this.point2}get center(){return this.point1.lerp(this.point2,.5)}get(e){return this.point1.plus(this.direction.times(e))}at(e){return this.get(e*this.length)}normalAt(e){return this.direction.orthog()}tangentAt(e){return this.direction}splitAt(e){return e<=0||e>=1?[this]:[new s(this.point1,this.at(e)),new s(this.at(e),this.point2)]}intersection(e){let n,i;if(Math.abs(this.direction.x)<4e-13){if(e.direction.x===0||this.direction.y===0)return null;let p=this.point1.x,u=(this.point1.x-e.point1.x)*e.direction.y/e.direction.x+e.point1.y;n=S.of(p,u),i=(u-this.point1.y)/this.direction.y}else{let p=(this.point1.y-e.point1.y)*this.direction.x*e.direction.x+this.direction.x*e.direction.y*e.point1.x-this.direction.y*e.direction.x*this.point1.x,u=e.direction.y*this.direction.x-this.direction.y*e.direction.x;if(u===0)return null;let h=p/u,f=(h-this.point1.x)/this.direction.x,v=this.point1.y+this.direction.y*f;n=S.of(h,v),i=(h-this.point1.x)/this.direction.x}let a=n.distanceTo(this.point1),l=n.distanceTo(this.point2),c=n.distanceTo(e.point1),d=n.distanceTo(e.point2);return a>this.length||l>this.length||c>e.length||d>e.length?null:{point:n,t:i}}intersects(e){return this.intersection(e)!==null}argIntersectsLineSegment(e){let n=this.intersection(e);return n?[n.t/this.length]:[]}intersectsLineSegment(e){let n=this.intersection(e);return n?[n.point]:[]}closestPointTo(e){return this.nearestPointTo(e).point}nearestPointTo(e){let n=e.minus(this.p1).dot(this.direction),i=this.length-n,r=this.p1.plus(this.direction.times(n));return n>0&&n<this.length?{point:r,parameterValue:n/this.length}:Math.abs(i)<Math.abs(n)?{point:this.p2,parameterValue:1}:{point:this.p1,parameterValue:0}}signedDistance(e){return this.closestPointTo(e).minus(e).magnitude()}transformedBy(e){return new s(e.transformVec2(this.p1),e.transformVec2(this.p2))}getTightBoundingBox(){return this.bbox}toString(){return`LineSegment(${this.p1.toString()}, ${this.p2.toString()})`}eq(e,n){if(!(e instanceof s))return!1;let i=n?.tolerance,r=n?.ignoreDirection??!0;return e.p1.eq(this.p1,i)&&e.p2.eq(this.p2,i)||r&&e.p1.eq(this.p2,i)&&e.p2.eq(this.p1,i)}},Te=pe;var{abs:qt,cos:Ne,sin:Tt,acos:Ms,atan2:Kt,sqrt:_e,pow:Ce}=Math;function Gt(s){return s<0?-Ce(-s,1/3):Ce(s,1/3)}var Vi=Math.PI,Eo=2*Vi,je=Vi/2,Ds=1e-6,vn=Number.MAX_SAFE_INTEGER||9007199254740991,yn=Number.MIN_SAFE_INTEGER||-9007199254740991,As={x:0,y:0,z:0},L={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(s,o){let e=o(s),n=e.x*e.x+e.y*e.y;return typeof e.z<"u"&&(n+=e.z*e.z),_e(n)},compute:function(s,o,e){if(s===0)return o[0].t=0,o[0];let n=o.length-1;if(s===1)return o[n].t=1,o[n];let i=1-s,r=o;if(n===0)return o[0].t=s,o[0];if(n===1){let l={x:i*r[0].x+s*r[1].x,y:i*r[0].y+s*r[1].y,t:s};return e&&(l.z=i*r[0].z+s*r[1].z),l}if(n<4){let l=i*i,c=s*s,d,p,u,h=0;n===2?(r=[r[0],r[1],r[2],As],d=l,p=i*s*2,u=c):n===3&&(d=l*i,p=l*s*3,u=i*c*3,h=s*c);let f={x:d*r[0].x+p*r[1].x+u*r[2].x+h*r[3].x,y:d*r[0].y+p*r[1].y+u*r[2].y+h*r[3].y,t:s};return e&&(f.z=d*r[0].z+p*r[1].z+u*r[2].z+h*r[3].z),f}let a=JSON.parse(JSON.stringify(o));for(;a.length>1;){for(let l=0;l<a.length-1;l++)a[l]={x:a[l].x+(a[l+1].x-a[l].x)*s,y:a[l].y+(a[l+1].y-a[l].y)*s},typeof a[l].z<"u"&&(a[l]=a[l].z+(a[l+1].z-a[l].z)*s);a.splice(a.length-1,1)}return a[0].t=s,a[0]},computeWithRatios:function(s,o,e,n){let i=1-s,r=e,a=o,l=r[0],c=r[1],d=r[2],p=r[3],u;if(l*=i,c*=s,a.length===2)return u=l+c,{x:(l*a[0].x+c*a[1].x)/u,y:(l*a[0].y+c*a[1].y)/u,z:n?(l*a[0].z+c*a[1].z)/u:!1,t:s};if(l*=i,c*=2*i,d*=s*s,a.length===3)return u=l+c+d,{x:(l*a[0].x+c*a[1].x+d*a[2].x)/u,y:(l*a[0].y+c*a[1].y+d*a[2].y)/u,z:n?(l*a[0].z+c*a[1].z+d*a[2].z)/u:!1,t:s};if(l*=i,c*=1.5*i,d*=3*i,p*=s*s*s,a.length===4)return u=l+c+d+p,{x:(l*a[0].x+c*a[1].x+d*a[2].x+p*a[3].x)/u,y:(l*a[0].y+c*a[1].y+d*a[2].y+p*a[3].y)/u,z:n?(l*a[0].z+c*a[1].z+d*a[2].z+p*a[3].z)/u:!1,t:s}},derive:function(s,o){let e=[];for(let n=s,i=n.length,r=i-1;i>1;i--,r--){let a=[];for(let l=0,c;l<r;l++)c={x:r*(n[l+1].x-n[l].x),y:r*(n[l+1].y-n[l].y)},o&&(c.z=r*(n[l+1].z-n[l].z)),a.push(c);e.push(a),n=a}return e},between:function(s,o,e){return o<=s&&s<=e||L.approximately(s,o)||L.approximately(s,e)},approximately:function(s,o,e){return qt(s-o)<=(e||Ds)},length:function(s){let e=L.Tvalues.length,n=0;for(let i=0,r;i<e;i++)r=.5*L.Tvalues[i]+.5,n+=L.Cvalues[i]*L.arcfn(r,s);return .5*n},map:function(s,o,e,n,i){let r=e-o,a=i-n,l=s-o,c=l/r;return n+a*c},lerp:function(s,o,e){let n={x:o.x+s*(e.x-o.x),y:o.y+s*(e.y-o.y)};return o.z!==void 0&&e.z!==void 0&&(n.z=o.z+s*(e.z-o.z)),n},pointToString:function(s){let o=s.x+"/"+s.y;return typeof s.z<"u"&&(o+="/"+s.z),o},pointsToString:function(s){return"["+s.map(L.pointToString).join(", ")+"]"},copy:function(s){return JSON.parse(JSON.stringify(s))},angle:function(s,o,e){let n=o.x-s.x,i=o.y-s.y,r=e.x-s.x,a=e.y-s.y,l=n*a-i*r,c=n*r+i*a;return Kt(l,c)},round:function(s,o){let e=""+s,n=e.indexOf(".");return parseFloat(e.substring(0,n+1+o))},dist:function(s,o){let e=s.x-o.x,n=s.y-o.y;return _e(e*e+n*n)},closest:function(s,o){let e=Ce(2,63),n,i;return s.forEach(function(r,a){i=L.dist(o,r),i<e&&(e=i,n=a)}),{mdist:e,mpos:n}},abcratio:function(s,o){if(o!==2&&o!==3)return!1;if(typeof s>"u")s=.5;else if(s===0||s===1)return s;let e=Ce(s,o)+Ce(1-s,o),n=e-1;return qt(n/e)},projectionratio:function(s,o){if(o!==2&&o!==3)return!1;if(typeof s>"u")s=.5;else if(s===0||s===1)return s;let e=Ce(1-s,o),n=Ce(s,o)+e;return e/n},lli8:function(s,o,e,n,i,r,a,l){let c=(s*n-o*e)*(i-a)-(s-e)*(i*l-r*a),d=(s*n-o*e)*(r-l)-(o-n)*(i*l-r*a),p=(s-e)*(r-l)-(o-n)*(i-a);return p==0?!1:{x:c/p,y:d/p}},lli4:function(s,o,e,n){let i=s.x,r=s.y,a=o.x,l=o.y,c=e.x,d=e.y,p=n.x,u=n.y;return L.lli8(i,r,a,l,c,d,p,u)},lli:function(s,o){return L.lli4(s,s.c,o,o.c)},makeline:function(s,o){return new Ct(s.x,s.y,(s.x+o.x)/2,(s.y+o.y)/2,o.x,o.y)},findbbox:function(s){let o=vn,e=vn,n=yn,i=yn;return s.forEach(function(r){let a=r.bbox();o>a.x.min&&(o=a.x.min),e>a.y.min&&(e=a.y.min),n<a.x.max&&(n=a.x.max),i<a.y.max&&(i=a.y.max)}),{x:{min:o,mid:(o+n)/2,max:n,size:n-o},y:{min:e,mid:(e+i)/2,max:i,size:i-e}}},shapeintersections:function(s,o,e,n,i){if(!L.bboxoverlap(o,n))return[];let r=[],a=[s.startcap,s.forward,s.back,s.endcap],l=[e.startcap,e.forward,e.back,e.endcap];return a.forEach(function(c){c.virtual||l.forEach(function(d){if(d.virtual)return;let p=c.intersects(d,i);p.length>0&&(p.c1=c,p.c2=d,p.s1=s,p.s2=e,r.push(p))})}),r},makeshape:function(s,o,e){let n=o.points.length,i=s.points.length,r=L.makeline(o.points[n-1],s.points[0]),a=L.makeline(s.points[i-1],o.points[0]),l={startcap:r,forward:s,back:o,endcap:a,bbox:L.findbbox([r,s,o,a])};return l.intersections=function(c){return L.shapeintersections(l,l.bbox,c,c.bbox,e)},l},getminmax:function(s,o,e){if(!e)return{min:0,max:0};let n=vn,i=yn,r,a;e.indexOf(0)===-1&&(e=[0].concat(e)),e.indexOf(1)===-1&&e.push(1);for(let l=0,c=e.length;l<c;l++)r=e[l],a=s.get(r),a[o]<n&&(n=a[o]),a[o]>i&&(i=a[o]);return{min:n,mid:(n+i)/2,max:i,size:i-n}},align:function(s,o){let e=o.p1.x,n=o.p1.y,i=-Kt(o.p2.y-n,o.p2.x-e),r=function(a){return{x:(a.x-e)*Ne(i)-(a.y-n)*Tt(i),y:(a.x-e)*Tt(i)+(a.y-n)*Ne(i)}};return s.map(r)},roots:function(s,o){o=o||{p1:{x:0,y:0},p2:{x:1,y:0}};let e=s.length-1,n=L.align(s,o),i=function(T){return 0<=T&&T<=1};if(e===2){let T=n[0].y,V=n[1].y,O=n[2].y,$=T-2*V+O;if($!==0){let ie=-_e(V*V-T*O),ee=-T+V,de=-(ie+ee)/$,ve=-(-ie+ee)/$;return[de,ve].filter(i)}else if(V!==O&&$===0)return[(2*V-O)/(2*V-2*O)].filter(i);return[]}let r=n[0].y,a=n[1].y,l=n[2].y,c=n[3].y,d=-r+3*a-3*l+c,p=3*r-6*a+3*l,u=-3*r+3*a,h=r;if(L.approximately(d,0)){if(L.approximately(p,0))return L.approximately(u,0)?[]:[-h/u].filter(i);let T=_e(u*u-4*p*h),V=2*p;return[(T-u)/V,(-u-T)/V].filter(i)}p/=d,u/=d,h/=d;let f=(3*u-p*p)/3,v=f/3,x=(2*p*p*p-9*p*u+27*h)/27,g=x/2,y=g*g+v*v*v,m,C,P,w,E;if(y<0){let T=-f/3,V=T*T*T,O=_e(V),$=-x/(2*O),ie=$<-1?-1:$>1?1:$,ee=Ms(ie),de=Gt(O),ve=2*de;return P=ve*Ne(ee/3)-p/3,w=ve*Ne((ee+Eo)/3)-p/3,E=ve*Ne((ee+2*Eo)/3)-p/3,[P,w,E].filter(i)}else{if(y===0)return m=g<0?Gt(-g):-Gt(g),P=2*m-p/3,w=-m-p/3,[P,w].filter(i);{let T=_e(y);return m=Gt(-g+T),C=Gt(g+T),[m-C-p/3].filter(i)}}},droots:function(s){if(s.length===3){let o=s[0],e=s[1],n=s[2],i=o-2*e+n;if(i!==0){let r=-_e(e*e-o*n),a=-o+e,l=-(r+a)/i,c=-(-r+a)/i;return[l,c]}else if(e!==n&&i===0)return[(2*e-n)/(2*(e-n))];return[]}if(s.length===2){let o=s[0],e=s[1];return o!==e?[o/(o-e)]:[]}return[]},curvature:function(s,o,e,n,i){let r,a,l,c,d=0,p=0,u=L.compute(s,o),h=L.compute(s,e),f=u.x*u.x+u.y*u.y;if(n?(r=_e(Ce(u.y*h.z-h.y*u.z,2)+Ce(u.z*h.x-h.z*u.x,2)+Ce(u.x*h.y-h.x*u.y,2)),a=Ce(f+u.z*u.z,3/2)):(r=u.x*h.y-u.y*h.x,a=Ce(f,3/2)),r===0||a===0)return{k:0,r:0};if(d=r/a,p=a/r,!i){let v=L.curvature(s-.001,o,e,n,!0).k,x=L.curvature(s+.001,o,e,n,!0).k;c=(x-d+(d-v))/2,l=(qt(x-d)+qt(d-v))/2}return{k:d,r:p,dk:c,adk:l}},inflections:function(s){if(s.length<4)return[];let o=L.align(s,{p1:s[0],p2:s.slice(-1)[0]}),e=o[2].x*o[1].y,n=o[3].x*o[1].y,i=o[1].x*o[2].y,r=o[3].x*o[2].y,a=18*(-3*e+2*n+3*i-r),l=18*(3*e-n-3*i),c=18*(i-e);if(L.approximately(a,0)){if(!L.approximately(l,0)){let h=-c/l;if(0<=h&&h<=1)return[h]}return[]}let d=2*a;if(L.approximately(d,0))return[];let p=l*l-4*a*c;if(p<0)return[];let u=Math.sqrt(p);return[(u-l)/d,-(l+u)/d].filter(function(h){return 0<=h&&h<=1})},bboxoverlap:function(s,o){let e=["x","y"],n=e.length;for(let i=0,r,a,l,c;i<n;i++)if(r=e[i],a=s[r].mid,l=o[r].mid,c=(s[r].size+o[r].size)/2,qt(a-l)>=c)return!1;return!0},expandbox:function(s,o){o.x.min<s.x.min&&(s.x.min=o.x.min),o.y.min<s.y.min&&(s.y.min=o.y.min),o.z&&o.z.min<s.z.min&&(s.z.min=o.z.min),o.x.max>s.x.max&&(s.x.max=o.x.max),o.y.max>s.y.max&&(s.y.max=o.y.max),o.z&&o.z.max>s.z.max&&(s.z.max=o.z.max),s.x.mid=(s.x.min+s.x.max)/2,s.y.mid=(s.y.min+s.y.max)/2,s.z&&(s.z.mid=(s.z.min+s.z.max)/2),s.x.size=s.x.max-s.x.min,s.y.size=s.y.max-s.y.min,s.z&&(s.z.size=s.z.max-s.z.min)},pairiteration:function(s,o,e){let n=s.bbox(),i=o.bbox(),r=1e5,a=e||.5;if(n.x.size+n.y.size<a&&i.x.size+i.y.size<a)return[(r*(s._t1+s._t2)/2|0)/r+"/"+(r*(o._t1+o._t2)/2|0)/r];let l=s.split(.5),c=o.split(.5),d=[{left:l.left,right:c.left},{left:l.left,right:c.right},{left:l.right,right:c.right},{left:l.right,right:c.left}];d=d.filter(function(u){return L.bboxoverlap(u.left.bbox(),u.right.bbox())});let p=[];return d.length===0||(d.forEach(function(u){p=p.concat(L.pairiteration(u.left,u.right,a))}),p=p.filter(function(u,h){return p.indexOf(u)===h})),p},getccenter:function(s,o,e){let n=o.x-s.x,i=o.y-s.y,r=e.x-o.x,a=e.y-o.y,l=n*Ne(je)-i*Tt(je),c=n*Tt(je)+i*Ne(je),d=r*Ne(je)-a*Tt(je),p=r*Tt(je)+a*Ne(je),u=(s.x+o.x)/2,h=(s.y+o.y)/2,f=(o.x+e.x)/2,v=(o.y+e.y)/2,x=u+l,g=h+c,y=f+d,m=v+p,C=L.lli8(u,h,x,g,f,v,y,m),P=L.dist(C,s),w=Kt(s.y-C.y,s.x-C.x),E=Kt(o.y-C.y,o.x-C.x),T=Kt(e.y-C.y,e.x-C.x),V;return w<T?((w>E||E>T)&&(w+=Eo),w>T&&(V=T,T=w,w=V)):T<E&&E<w?(V=T,T=w,w=V):T+=Eo,C.s=w,C.e=T,C.r=P,C},numberSort:function(s,o){return s-o}};var St=class s{constructor(o){this.curves=[],this._3d=!1,o&&(this.curves=o,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map(function(o){return L.pointsToString(o.points)}).join(", ")+"]"}addCurve(o){this.curves.push(o),this._3d=this._3d||o._3d}length(){return this.curves.map(function(o){return o.length()}).reduce(function(o,e){return o+e})}curve(o){return this.curves[o]}bbox(){let o=this.curves;for(var e=o[0].bbox(),n=1;n<o.length;n++)L.expandbox(e,o[n].bbox());return e}offset(o){let e=[];return this.curves.forEach(function(n){e.push(...n.offset(o))}),new s(e)}};var{abs:Zt,min:Oi,max:Fi,cos:Vs,sin:Os,acos:Fs,sqrt:_t}=Math,Hs=Math.PI;var Ct=class s{constructor(o){let e=o&&o.forEach?o:Array.from(arguments).slice(),n=!1;if(typeof e[0]=="object"){n=e.length;let f=[];e.forEach(function(v){["x","y","z"].forEach(function(x){typeof v[x]<"u"&&f.push(v[x])})}),e=f}let i=!1,r=e.length;if(n){if(n>4){if(arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");i=!0}}else if(r!==6&&r!==8&&r!==9&&r!==12&&arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");let a=this._3d=!i&&(r===9||r===12)||o&&o[0]&&typeof o[0].z<"u",l=this.points=[];for(let f=0,v=a?3:2;f<r;f+=v){var c={x:e[f],y:e[f+1]};a&&(c.z=e[f+2]),l.push(c)}let d=this.order=l.length-1,p=this.dims=["x","y"];a&&p.push("z"),this.dimlen=p.length;let u=L.align(l,{p1:l[0],p2:l[d]}),h=L.dist(l[0],l[d]);this._linear=u.reduce((f,v)=>f+Zt(v.y),0)<h/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(o,e,n,i){if(typeof i>"u"&&(i=.5),i===0)return new s(e,e,n);if(i===1)return new s(o,e,e);let r=s.getABC(2,o,e,n,i);return new s(o,r.A,n)}static cubicFromPoints(o,e,n,i,r){typeof i>"u"&&(i=.5);let a=s.getABC(3,o,e,n,i);typeof r>"u"&&(r=L.dist(e,a.C));let l=r*(1-i)/i,c=L.dist(o,n),d=(n.x-o.x)/c,p=(n.y-o.y)/c,u=r*d,h=r*p,f=l*d,v=l*p,x={x:e.x-u,y:e.y-h},g={x:e.x+f,y:e.y+v},y=a.A,m={x:y.x+(x.x-y.x)/(1-i),y:y.y+(x.y-y.y)/(1-i)},C={x:y.x+(g.x-y.x)/i,y:y.y+(g.y-y.y)/i},P={x:o.x+(m.x-o.x)/i,y:o.y+(m.y-o.y)/i},w={x:n.x+(C.x-n.x)/(1-i),y:n.y+(C.y-n.y)/(1-i)};return new s(o,P,w,n)}static getUtils(){return L}getUtils(){return s.getUtils()}static get PolyBezier(){return St}valueOf(){return this.toString()}toString(){return L.pointsToString(this.points)}toSVG(){if(this._3d)return!1;let o=this.points,e=o[0].x,n=o[0].y,i=["M",e,n,this.order===2?"Q":"C"];for(let r=1,a=o.length;r<a;r++)i.push(o[r].x),i.push(o[r].y);return i.join(" ")}setRatios(o){if(o.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=o,this._lut=[]}verify(){let o=this.coordDigest();o!==this._print&&(this._print=o,this.update())}coordDigest(){return this.points.map(function(o,e){return""+e+o.x+o.y+(o.z?o.z:0)}).join("")}update(){this._lut=[],this.dpoints=L.derive(this.points,this._3d),this.computedirection()}computedirection(){let o=this.points,e=L.angle(o[0],o[this.order],o[1]);this.clockwise=e>0}length(){return L.length(this.derivative.bind(this))}static getABC(o=2,e,n,i,r=.5){let a=L.projectionratio(r,o),l=1-a,c={x:a*e.x+l*i.x,y:a*e.y+l*i.y},d=L.abcratio(r,o);return{A:{x:n.x+(n.x-c.x)/d,y:n.y+(n.y-c.y)/d},B:n,C:c,S:e,E:i}}getABC(o,e){e=e||this.get(o);let n=this.points[0],i=this.points[this.order];return s.getABC(this.order,n,e,i,o)}getLUT(o){if(this.verify(),o=o||100,this._lut.length===o+1)return this._lut;this._lut=[],o++,this._lut=[];for(let e=0,n,i;e<o;e++)i=e/(o-1),n=this.compute(i),n.t=i,this._lut.push(n);return this._lut}on(o,e){e=e||5;let n=this.getLUT(),i=[];for(let r=0,a,l=0;r<n.length;r++)a=n[r],L.dist(a,o)<e&&(i.push(a),l+=r/n.length);return i.length?t/=i.length:!1}project(o){let e=this.getLUT(),n=e.length-1,i=L.closest(e,o),r=i.mpos,a=(r-1)/n,l=(r+1)/n,c=.1/n,d=i.mdist,p=a,u=p,h;d+=1;for(let f;p<l+c;p+=c)h=this.compute(p),f=L.dist(o,h),f<d&&(d=f,u=p);return u=u<0?0:u>1?1:u,h=this.compute(u),h.t=u,h.d=d,h}get(o){return this.compute(o)}point(o){return this.points[o]}compute(o){return this.ratios?L.computeWithRatios(o,this.points,this.ratios,this._3d):L.compute(o,this.points,this._3d,this.ratios)}raise(){let o=this.points,e=[o[0]],n=o.length;for(let i=1,r,a;i<n;i++)r=o[i],a=o[i-1],e[i]={x:(n-i)/n*r.x+i/n*a.x,y:(n-i)/n*r.y+i/n*a.y};return e[n]=o[n-1],new s(e)}derivative(o){return L.compute(o,this.dpoints[0],this._3d)}dderivative(o){return L.compute(o,this.dpoints[1],this._3d)}align(){let o=this.points;return new s(L.align(o,{p1:o[0],p2:o[o.length-1]}))}curvature(o){return L.curvature(o,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return L.inflections(this.points)}normal(o){return this._3d?this.__normal3(o):this.__normal2(o)}__normal2(o){let e=this.derivative(o),n=_t(e.x*e.x+e.y*e.y);return{t:o,x:-e.y/n,y:e.x/n}}__normal3(o){let e=this.derivative(o),n=this.derivative(o+.01),i=_t(e.x*e.x+e.y*e.y+e.z*e.z),r=_t(n.x*n.x+n.y*n.y+n.z*n.z);e.x/=i,e.y/=i,e.z/=i,n.x/=r,n.y/=r,n.z/=r;let a={x:n.y*e.z-n.z*e.y,y:n.z*e.x-n.x*e.z,z:n.x*e.y-n.y*e.x},l=_t(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=l,a.y/=l,a.z/=l;let c=[a.x*a.x,a.x*a.y-a.z,a.x*a.z+a.y,a.x*a.y+a.z,a.y*a.y,a.y*a.z-a.x,a.x*a.z-a.y,a.y*a.z+a.x,a.z*a.z];return{t:o,x:c[0]*e.x+c[1]*e.y+c[2]*e.z,y:c[3]*e.x+c[4]*e.y+c[5]*e.z,z:c[6]*e.x+c[7]*e.y+c[8]*e.z}}hull(o){let e=this.points,n=[],i=[],r=0;for(i[r++]=e[0],i[r++]=e[1],i[r++]=e[2],this.order===3&&(i[r++]=e[3]);e.length>1;){n=[];for(let a=0,l,c=e.length-1;a<c;a++)l=L.lerp(o,e[a],e[a+1]),i[r++]=l,n.push(l);e=n}return i}split(o,e){if(o===0&&e)return this.split(e).left;if(e===1)return this.split(o).right;let n=this.hull(o),i={left:this.order===2?new s([n[0],n[3],n[5]]):new s([n[0],n[4],n[7],n[9]]),right:this.order===2?new s([n[5],n[4],n[2]]):new s([n[9],n[8],n[6],n[3]]),span:n};return i.left._t1=L.map(0,0,1,this._t1,this._t2),i.left._t2=L.map(o,0,1,this._t1,this._t2),i.right._t1=L.map(o,0,1,this._t1,this._t2),i.right._t2=L.map(1,0,1,this._t1,this._t2),e?(e=L.map(e,o,1,0,1),i.right.split(e).left):i}extrema(){let o={},e=[];return this.dims.forEach(function(n){let i=function(a){return a[n]},r=this.dpoints[0].map(i);o[n]=L.droots(r),this.order===3&&(r=this.dpoints[1].map(i),o[n]=o[n].concat(L.droots(r))),o[n]=o[n].filter(function(a){return a>=0&&a<=1}),e=e.concat(o[n].sort(L.numberSort))}.bind(this)),o.values=e.sort(L.numberSort).filter(function(n,i){return e.indexOf(n)===i}),o}bbox(){let o=this.extrema(),e={};return this.dims.forEach(function(n){e[n]=L.getminmax(this,n,o[n])}.bind(this)),e}overlaps(o){let e=this.bbox(),n=o.bbox();return L.bboxoverlap(e,n)}offset(o,e){if(typeof e<"u"){let n=this.get(o),i=this.normal(o),r={c:n,n:i,x:n.x+i.x*e,y:n.y+i.y*e};return this._3d&&(r.z=n.z+i.z*e),r}if(this._linear){let n=this.normal(0),i=this.points.map(function(r){let a={x:r.x+o*n.x,y:r.y+o*n.y};return r.z&&n.z&&(a.z=r.z+o*n.z),a});return[new s(i)]}return this.reduce().map(function(n){return n._linear?n.offset(o)[0]:n.scale(o)})}simple(){if(this.order===3){let i=L.angle(this.points[0],this.points[3],this.points[1]),r=L.angle(this.points[0],this.points[3],this.points[2]);if(i>0&&r<0||i<0&&r>0)return!1}let o=this.normal(0),e=this.normal(1),n=o.x*e.x+o.y*e.y;return this._3d&&(n+=o.z*e.z),Zt(Fs(n))<Hs/3}reduce(){let o,e=0,n=0,i=.01,r,a=[],l=[],c=this.extrema().values;for(c.indexOf(0)===-1&&(c=[0].concat(c)),c.indexOf(1)===-1&&c.push(1),e=c[0],o=1;o<c.length;o++)n=c[o],r=this.split(e,n),r._t1=e,r._t2=n,a.push(r),e=n;return a.forEach(function(d){for(e=0,n=0;n<=1;)for(n=e+i;n<=1+i;n+=i)if(r=d.split(e,n),!r.simple()){if(n-=i,Zt(e-n)<i)return[];r=d.split(e,n),r._t1=L.map(e,0,1,d._t1,d._t2),r._t2=L.map(n,0,1,d._t1,d._t2),l.push(r),e=n;break}e<1&&(r=d.split(e,1),r._t1=L.map(e,0,1,d._t1,d._t2),r._t2=d._t2,l.push(r))}),l}translate(o,e,n){n=typeof n=="number"?n:e;let i=this.order,r=this.points.map((a,l)=>(1-l/i)*e+l/i*n);return new s(this.points.map((a,l)=>({x:a.x+o.x*r[l],y:a.y+o.y*r[l]})))}scale(o){let e=this.order,n=!1;if(typeof o=="function"&&(n=o),n&&e===2)return this.raise().scale(n);let i=this.clockwise,r=this.points;if(this._linear)return this.translate(this.normal(0),n?n(0):o,n?n(1):o);let a=n?n(0):o,l=n?n(1):o,c=[this.offset(0,10),this.offset(1,10)],d=[],p=L.lli4(c[0],c[0].c,c[1],c[1].c);if(!p)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach(function(u){let h=d[u*e]=L.copy(r[u*e]);h.x+=(u?l:a)*c[u].n.x,h.y+=(u?l:a)*c[u].n.y}),n?([0,1].forEach(function(u){if(!(e===2&&u)){var h=r[u+1],f={x:h.x-p.x,y:h.y-p.y},v=n?n((u+1)/e):o;n&&!i&&(v=-v);var x=_t(f.x*f.x+f.y*f.y);f.x/=x,f.y/=x,d[u+1]={x:h.x+v*f.x,y:h.y+v*f.y}}}),new s(d)):([0,1].forEach(u=>{if(e===2&&u)return;let h=d[u*e],f=this.derivative(u),v={x:h.x+f.x,y:h.y+f.y};d[u+1]=L.lli4(h,v,p,r[u+1])}),new s(d))}outline(o,e,n,i){if(e=e===void 0?o:e,this._linear){let w=this.normal(0),E=this.points[0],T=this.points[this.points.length-1],V,O,$;n===void 0&&(n=o,i=e),V={x:E.x+w.x*o,y:E.y+w.y*o},$={x:T.x+w.x*n,y:T.y+w.y*n},O={x:(V.x+$.x)/2,y:(V.y+$.y)/2};let ie=[V,O,$];V={x:E.x-w.x*e,y:E.y-w.y*e},$={x:T.x-w.x*i,y:T.y-w.y*i},O={x:(V.x+$.x)/2,y:(V.y+$.y)/2};let ee=[$,O,V],de=L.makeline(ee[2],ie[0]),ve=L.makeline(ie[2],ee[0]),se=[de,new s(ie),ve,new s(ee)];return new St(se)}let r=this.reduce(),a=r.length,l=[],c=[],d,p=0,u=this.length(),h=typeof n<"u"&&typeof i<"u";function f(w,E,T,V,O){return function($){let ie=V/T,ee=(V+O)/T,de=E-w;return L.map($,0,1,w+ie*de,w+ee*de)}}r.forEach(function(w){let E=w.length();h?(l.push(w.scale(f(o,n,u,p,E))),c.push(w.scale(f(-e,-i,u,p,E)))):(l.push(w.scale(o)),c.push(w.scale(-e))),p+=E}),c=c.map(function(w){return d=w.points,d[3]?w.points=[d[3],d[2],d[1],d[0]]:w.points=[d[2],d[1],d[0]],w}).reverse();let v=l[0].points[0],x=l[a-1].points[l[a-1].points.length-1],g=c[a-1].points[c[a-1].points.length-1],y=c[0].points[0],m=L.makeline(g,v),C=L.makeline(x,y),P=[m].concat(l).concat([C]).concat(c);return new St(P)}outlineshapes(o,e,n){e=e||o;let i=this.outline(o,e).curves,r=[];for(let a=1,l=i.length;a<l/2;a++){let c=L.makeshape(i[a],i[l-a],n);c.startcap.virtual=a>1,c.endcap.virtual=a<l/2-1,r.push(c)}return r}intersects(o,e){return o?o.p1&&o.p2?this.lineIntersects(o):(o instanceof s&&(o=o.reduce()),this.curveintersects(this.reduce(),o,e)):this.selfintersects(e)}lineIntersects(o){let e=Oi(o.p1.x,o.p2.x),n=Oi(o.p1.y,o.p2.y),i=Fi(o.p1.x,o.p2.x),r=Fi(o.p1.y,o.p2.y);return L.roots(this.points,o).filter(a=>{var l=this.get(a);return L.between(l.x,e,i)&&L.between(l.y,n,r)})}selfintersects(o){let e=this.reduce(),n=e.length-2,i=[];for(let r=0,a,l,c;r<n;r++)l=e.slice(r,r+1),c=e.slice(r+2),a=this.curveintersects(l,c,o),i.push(...a);return i}curveintersects(o,e,n){let i=[];o.forEach(function(a){e.forEach(function(l){a.overlaps(l)&&i.push({left:a,right:l})})});let r=[];return i.forEach(function(a){let l=L.pairiteration(a.left,a.right,n);l.length>0&&(r=r.concat(l))}),r}arcs(o){return o=o||.5,this._iterate(o,[])}_error(o,e,n,i){let r=(i-n)/4,a=this.get(n+r),l=this.get(i-r),c=L.dist(o,e),d=L.dist(o,a),p=L.dist(o,l);return Zt(d-c)+Zt(p-c)}_iterate(o,e){let n=0,i=1,r;do{r=0,i=1;let a=this.get(n),l,c,d,p,u=!1,h=!1,f,v=i,x=1,g=0;do if(h=u,p=d,v=(n+i)/2,g++,l=this.get(v),c=this.get(i),d=L.getccenter(a,l,c),d.interval={start:n,end:i},u=this._error(d,a,n,i)<=o,f=h&&!u,f||(x=i),u){if(i>=1){if(d.interval.end=x=1,p=d,i>1){let m={x:d.x+d.r*Vs(d.e),y:d.y+d.r*Os(d.e)};d.e+=L.angle({x:d.x,y:d.y},m,this.get(1))}break}i=i+(i-n)/2}else i=v;while(!f&&r++<100);if(r>=100)break;p=p||d,e.push(p),n=x}while(i<1);return e}};var ko=class extends xt{#e=null;constructor(o){super(),o&&(this.#e=o)}getBezier(){return this.#e||(this.#e=new Ct(this.getPoints().map(o=>o.xy))),this.#e}signedDistance(o){return this.nearestPointTo(o).point.distanceTo(o)}distance(o){return this.signedDistance(o)}at(o){return S.ofXY(this.getBezier().get(o))}derivativeAt(o){return S.ofXY(this.getBezier().derivative(o))}secondDerivativeAt(o){return S.ofXY(this.getBezier().dderivative(o))}normal(o){return S.ofXY(this.getBezier().normal(o))}normalAt(o){return this.normal(o)}tangentAt(o){return this.derivativeAt(o).normalized()}getTightBoundingBox(){let o=this.getBezier().bbox(),e=o.x.max-o.x.min,n=o.y.max-o.y.min;return new le(o.x.min,o.y.min,e,n)}argIntersectsLineSegment(o){let e=Te.ofSmallestContainingPoints(this.getPoints());return e?e.intersectsLineSegment(o).map(r=>this.nearestPointTo(r).parameterValue):this.getBezier().intersects(o).map(i=>{typeof i=="string"&&(i=parseFloat(i));let r=S.ofXY(this.at(i));return r.distanceTo(o.p1)>o.length||r.distanceTo(o.p2)>o.length?null:i}).filter(i=>i!==null)}splitAt(o){if(o<=0||o>=1)return[this];let n=this.getBezier().split(o);return[new Ro(n.left.points.map(i=>S.ofXY(i)),n.left),new Ro(n.right.points.map(i=>S.ofXY(i)),n.right)]}nearestPointTo(o){let e=p=>o.squareDistanceTo(this.at(p)),n=e(0),i=0,r=n,a=4;for(let p=0;p<a;p++){let u=p/(a-1),h=e(u);h<r&&(i=u,r=h)}let l=p=>{let u=this.at(p),h=this.derivativeAt(p),f=this.secondDerivativeAt(p);return 2*h.x*h.x+2*u.x*f.x-2*o.x*f.x+2*h.y*h.y+2*u.y*f.y-2*o.y*f.y},c=p=>{let u=this.at(p),h=this.derivativeAt(p);return 2*u.x*h.x-2*o.x*h.x+2*u.y*h.y-2*o.y*h.y},d=()=>{let p=l(i);if(p===0)return;i=(0-c(i))/p+i,i>1?i=1:i<0&&(i=0)};for(let p=0;p<12;p++)d();return{parameterValue:i,point:this.at(i)}}intersectsBezier(o){let e=this.getBezier().intersects(o.getBezier());if(!e||e.length===0)return[];let n=[];for(let i of e){let r=/^([-0-9.eE]+)\/([-0-9.eE]+)$/.exec(i);if(!r)throw new Error(`Incorrect format returned by .intersects: ${e} should be array of "number/number"!`);let a=parseFloat(r[1]);n.push({parameterValue:a,point:this.at(a)})}return n}toString(){return`B\xE9zier(${this.getPoints().map(o=>o.toString()).join(", ")})`}},Ro=class extends ko{constructor(e,n){super(n);this.controlPoints=e}getPoints(){return this.controlPoints}},Io=ko;var xn=class extends Io{constructor(e,n,i,r){super();this.p0=e;this.p1=n;this.p2=i;this.p3=r}getPoints(){return[this.p0,this.p1,this.p2,this.p3]}getLooseBoundingBox(){return le.bboxOf([this.p0,this.p1,this.p2,this.p3])}},Hi=xn;var Ns=(s,o,e)=>{if(s===0){let l;return o===0?l=e===0?0:NaN:l=-e/o,[l,l]}let n=o*o-4*s*e;if(n<0)return[NaN,NaN];let i=Math.sqrt(n),r=(-o+i)/(2*s),a=(-o-i)/(2*s);return r>a?[r,a]:[a,r]},Ni=Ns;var Ee=class s extends Io{constructor(e,n,i){super();this.p0=e;this.p1=n;this.p2=i}static componentAt(e,n,i,r){return n+e*(-2*n+2*i)+e*e*(n-2*i+r)}static derivativeComponentAt(e,n,i,r){return-2*n+2*i+2*e*(n-2*i+r)}static secondDerivativeComponentAt(e,n,i,r){return 2*(n-2*i+r)}at(e){if(e===0)return this.p0;if(e===1)return this.p2;let n=this.p0,i=this.p1,r=this.p2;return S.of(s.componentAt(e,n.x,i.x,r.x),s.componentAt(e,n.y,i.y,r.y))}derivativeAt(e){let n=this.p0,i=this.p1,r=this.p2;return S.of(s.derivativeComponentAt(e,n.x,i.x,r.x),s.derivativeComponentAt(e,n.y,i.y,r.y))}secondDerivativeAt(e){let n=this.p0,i=this.p1,r=this.p2;return S.of(s.secondDerivativeComponentAt(e,n.x,i.x,r.x),s.secondDerivativeComponentAt(e,n.y,i.y,r.y))}normal(e){return this.derivativeAt(e).orthog().normalized()}getLooseBoundingBox(){return le.bboxOf([this.p0,this.p1,this.p2])}approximateDistance(e){let n=this.p0.x-e.x,i=-2*this.p0.x+2*this.p1.x,r=this.p0.x-2*this.p1.x+this.p2.x,a=this.p0.y-e.y,l=-2*this.p0.y+2*this.p1.y,c=this.p0.y-2*this.p1.y+this.p2.y,d=2*n*i+2*a*l-e.x*i-e.y*l,p=2*i*i+2*l*l+2*r*n+2*c*a-e.x*r-e.y*c,u=2*l*c+2*i*r+2*r*i+2*c*l,h=d,f=p,v=2*u,[x,g]=Ni(v/2,f,h);isNaN(x)&&(x=.25),isNaN(g)&&(g=.75);let y=this.at(x),m=this.at(g),C=y.squareDistanceTo(e),P=m.squareDistanceTo(e),w=this.at(0).squareDistanceTo(e),E=this.at(1).squareDistanceTo(e);return Math.sqrt(Math.min(C,P,w,E))}getPoints(){return[this.p0,this.p1,this.p2]}},Wi=Ee;var Tn=class extends xt{constructor(e){super();this.p=e}signedDistance(e){return this.p.distanceTo(e)}argIntersectsLineSegment(e,n){return e.containsPoint(this.p,n)?[0]:[]}getTightBoundingBox(){return new le(this.p.x,this.p.y,0,0)}at(e){return this.p}normalAt(e){return S.unitY}tangentAt(e){return S.unitX}splitAt(e){return[this]}nearestPointTo(e){return{point:this.p,parameterValue:0}}},Ui=Tn;var Ws=s=>{if(s.indexOf("e")>0&&s.match(/[eE][-]\d{2,}$/))return"0";let o=s.charAt(s.length-1);(o==="0"||o===".")&&(s=s.replace(/([.]\d*[^0])0+$/,"$1"),s=s.replace(/[.]0+$/,"."),s=s.replace(/[.]$/,""));let e=s.charAt(0);return(e==="0"||e==="-")&&(s=s.replace(/^(0+)[.]/,"."),s=s.replace(/^-(0+)[.]/,"-."),s=s.replace(/^(-?)0+$/,"$10")),s==="-0"?"0":s},Lo=Ws;var fe=s=>{let o=/^([-]?\d*\.\d{3,})0{4,}\d{1,4}$/,e=/^([-]?)(\d*)\.(\d{3,}9{4,})\d{1,4}$/,n=s.toString(10);if(n.indexOf(".")===-1)return n;let i=e.exec(n);if(i){let r=i[1],a=i[3],l=parseInt(a.charAt(a.length-1),10),c=parseInt(a,10),d=parseInt(i[2],10),p=i[3],u=(c+10-l).toString(),h=0;for(u.length>c.toString().length&&(u=u.substring(1),h=1);u.length<p.length;)u=h.toString(10)+u,h=0;n=`${r+(d+h).toString()}.${u}`}return n=n.replace(o,"$1"),Lo(n)},rt=fe;var zo=/^([-]?)(\d*)[.](\d+)$/;var Us=s=>{let o=zo.exec(s);return o?o[3].length:s.search(/[eE]/)!==-1||/^[a-zA-Z]+$/.exec(s)?-1:0},$i=Us;var $s=(s,...o)=>{let e=s.toString(10),n=zo.exec(e);if(!n)return e;let i=-1;for(let d of o)i=Math.max($i(d),i);if(i===-1)return rt(s);let r=n[3].substring(0,i),a=n[2],l=n[3].charAt(i);if(l!==""&&parseInt(l,10)>=5){if(r.length>0){let p=/^(0+)(\d*)$/.exec(r),u="",h=r;p&&(u=p[1],h=p[2]),r=(parseInt(r)+1).toString(),r.length>h.length&&u.length>0&&(u=u.substring(1)),r=u+r}(r.length===0||r.length>i)&&(a=(parseInt(a)+1).toString(),r=r.substring(1))}let c=n[1];return Lo(`${c}${a}.${r}`)},Cn=$s;var qs=s=>{if(s.length===0)return[];let o=s.reduce((r,a)=>a.y<r.y?a:r,s[0]),e=[o],n=[...s.filter(r=>!r.eq(o))],i=S.of(-1,0);for(;n.length>0;){let r=e[e.length-1],a=i.dot(o.minus(r).normalizedOrZero()),l=o;for(let d of n){let p=i.dot(d.minus(r).normalizedOrZero());p<=a&&(l=d,a=p)}n=n.filter(d=>!d.eq(l));let c=l.minus(r).normalized();if(Math.abs(c.dot(i))===1&&e.length>1&&e.pop(),l.eq(o))break;e.push(l),i=r.minus(l).normalized()}return e},qi=qs;var Bo=(s,o)=>{let e=s.curveIndex-o.curveIndex;return e===0?s.parameterValue-o.parameterValue:e},Sn=(s,o)=>s.parameterValue+o>1?{curveIndex:s.curveIndex+1,parameterValue:s.parameterValue+o-1}:s.parameterValue+o<0?s.curveIndex===0?{curveIndex:0,parameterValue:0}:{curveIndex:s.curveIndex-1,parameterValue:s.parameterValue+o+1}:{curveIndex:s.curveIndex,parameterValue:s.parameterValue+o},W=class s{constructor(o,e){this.startPoint=o;this.cachedGeometry=null;this.cachedPolylineApproximation=null;this.cachedStringVersion=null;this.parts=e,this.bbox=le.bboxOf([o]);for(let n of this.parts)this.bbox=this.bbox.union(s.computeBBoxForSegment(o,n))}getExactBBox(){let o=[];for(let e of this.geometry)o.push(e.getTightBoundingBox());return le.union(...o)}get geometry(){if(this.cachedGeometry)return this.cachedGeometry;let o=this.startPoint,e=[];for(let n of this.parts){let i;switch(n.kind){case 2:e.push(new Hi(o,n.controlPoint1,n.controlPoint2,n.endPoint)),o=n.endPoint;break;case 3:e.push(new Wi(o,n.controlPoint,n.endPoint)),o=n.endPoint;break;case 0:e.push(new Te(o,n.point)),o=n.point;break;case 1:e.push(new Ui(n.point)),o=n.point;break;default:return i=n,i}}return this.cachedGeometry=e,this.cachedGeometry}*startEndPoints(){yield this.startPoint;for(let o of this.parts){let e;switch(o.kind){case 2:yield o.endPoint;break;case 3:yield o.endPoint;break;case 0:yield o.point;break;case 1:yield o.point;break;default:return e=o,e}}}polylineApproximation(){if(this.cachedPolylineApproximation)return this.cachedPolylineApproximation;let o=[];for(let i of this.parts)switch(i.kind){case 2:o.push(i.controlPoint1,i.controlPoint2,i.endPoint);break;case 3:o.push(i.controlPoint,i.endPoint);break;case 1:case 0:o.push(i.point);break}let e=[],n=this.startPoint;for(let i of o)e.push(new Te(n,i)),n=i;return e}static computeBBoxForSegment(o,e){let n=[o],i;switch(e.kind){case 1:case 0:n.push(e.point);break;case 2:n.push(e.controlPoint1,e.controlPoint2,e.endPoint);break;case 3:n.push(e.controlPoint,e.endPoint);break;default:return i=e,i}return le.bboxOf(n)}signedDistance(o,e){let n=1/0;for(let i of this.geometry){let r=i.signedDistance(o)-e;r<n&&(n=r)}return n}raymarchIntersectionWith(o,e,n=[]){if(!o.bbox.intersects(this.bbox.grownBy(e)))return[];let i=o.length,r=[];for(let v of this.geometry){let x=v.getTightBoundingBox().grownBy(e);if(!x.intersects(o.bbox))continue;let g=m=>v.signedDistance(m),y=m=>g(m)-e;y(o.p1)>i&&y(o.p2)>i||r.push({part:v,distFn:g,bbox:x})}if(r.length===0)return[];let a=v=>{let x=1/0,g=null,y=[];for(let m of r){let{part:C,distFn:P,bbox:w}=m;if(!w.containsPoint(v)){y.push(m);continue}let E=P(v);E<=x&&(x=E,g=C)}for(let{part:m,distFn:C,bbox:P}of y){if(isFinite(x)&&!P.grownBy(x).containsPoint(v))continue;let w=C(v);w<=x&&(x=w,g=m)}return[g,x-e]},l=8,c=[o.p1,...n,o.p2],d=v=>v.minus(o.p1).dot(o.direction);c.sort((v,x)=>{let g=d(v),y=d(x);return g-y});let p=[],u=e/1e3,h=(v,x,g)=>{let y=v,[m,C]=a(y),P=d(y);if(C>i)return P;let w=o.direction.times(x);for(let T=0;T<l;T++){let V=C;if(y=y.plus(w.times(V)),P=d(y),P<=g)return P;let[O,$]=a(y);if(Math.abs($)>Math.abs(C))return null;if(C=$,m=O,Math.abs(C)<u)break}let E=P>=0&&P<=i;if(m&&E&&Math.abs(C)<u){p.push({point:y,parameterValue:m.nearestPointTo(y).parameterValue,curve:m,curveIndex:this.geometry.indexOf(m)});let T=e/20/o.length;P+=isFinite(T)?T:0}return P},f=0;for(let v=0;v<c.length;v++){let x=c[v];f=Math.max(f,h(x,1,f)??f),f=Math.max(f,h(x,-1,f)??f)}return p}intersection(o,e){let n=[];if(!o.bbox.intersects(this.bbox.grownBy(e??0)))return[];if(this.parts.length===0)return new s(this.startPoint,[{kind:1,point:this.startPoint}]).intersection(o,e);let i=0;for(let a of this.geometry){let l=a.argIntersectsLineSegment(o);for(let c of l)n.push({curve:a,curveIndex:i,point:a.at(c),parameterValue:c});i++}if(e&&e>1e-8){let a=n.map(l=>l.point);n=this.raymarchIntersectionWith(o,e,a)}return n}nearestPointTo(o){let e=1/0,n=0,i=0,r=this.startPoint;for(let a=0;a<this.geometry.length;a++){let c=this.geometry[a].nearestPointTo(o),d=c.point.squareDistanceTo(o);(a===0||d<e)&&(n=a,e=d,i=c.parameterValue,r=c.point)}return{curve:this.geometry[n],curveIndex:n,parameterValue:i,point:r}}at(o){return o.curveIndex===0&&o.parameterValue===0?this.startPoint:this.geometry[o.curveIndex].at(o.parameterValue)}tangentAt(o){return this.geometry[o.curveIndex].tangentAt(o.parameterValue)}splitNear(o,e){let n=this.nearestPointTo(o);return this.splitAt(n,e)}spliced(o,e,n,i){if(((a,l)=>a.curveIndex<l.curveIndex||a.curveIndex===l.curveIndex&&a.parameterValue<=l.parameterValue)(o,e)){let a=this.splitAt(o,i),l=this.splitAt(e,i),c=a[0],d=l[l.length-1];return n?c.union(n).union(d):c.union(d)}else{let c=this.splitAt([o],i)[0].splitNear(this.at(e),i),d=c[c.length-1];return n?d.union(n):d}}splitAt(o,e){for(Array.isArray(o)||(o=[o]),o=[...o],o.sort(Bo);o.length>0&&o[o.length-1].curveIndex>=this.parts.length-1&&o[o.length-1].parameterValue>=1;)o.pop();for(o.reverse();o.length>0&&o[o.length-1].curveIndex<=0&&o[o.length-1].parameterValue<=0;)o.pop();if(o.length===0||this.parts.length===0)return[this];let n=o.length+1,i=e?.mapNewPoint??(p=>p),r=[],a=this.startPoint,l=[],{curveIndex:c,parameterValue:d}=o.pop();for(let p=0;p<this.parts.length;p++)if(p!==c)l.push(this.parts[p]);else{let u=this.parts[p],h=this.geometry[p];for(;p===c;){let f,v=[];switch(u.kind){case 1:l.push({kind:u.kind,point:u.point}),f=u.point;break;case 0:{let g=h.splitAt(d);l.push({kind:u.kind,point:i(g[0].p2)}),f=g[0].p2,g.length>1&&(console.assert(g.length===2),v.push({kind:u.kind,point:g[1].p2}),h=g[1])}break;case 3:case 2:{let g=h.splitAt(d),y=g.length===2;for(let m of g){h=m;let C=y?l:v,P=m.getPoints();u.kind===2?C.push({kind:u.kind,controlPoint1:i(P[1]),controlPoint2:i(P[2]),endPoint:i(P[3])}):C.push({kind:u.kind,controlPoint:i(P[1]),endPoint:i(P[2])}),y||(f=P[0]),y=!1}}break;default:return u}r.push(new s(a,[...l])),a=i(f),console.assert(!!a,"should have a start point"),l=v,u=v[v.length-1]??u;let x=o.pop();if(x)if(c=x.curveIndex,p===c){let g=this.at(x);d=h.nearestPointTo(g).parameterValue,l=[]}else d=x.parameterValue;else break}}return r.push(new s(a,l)),console.assert(r.length===n,`should split into splitAt.length + 1 splits (was ${r.length}, expected ${n})`),r}asClosed(){let o=[],e=!1;for(let i of this.parts)i.kind===1?(o.push({kind:0,point:i.point}),e=!0):o.push(i);if(this.getEndPoint().eq(this.startPoint)||(o.push({kind:0,point:this.startPoint}),e=!0),!e)return this;let n=new s(this.startPoint,o);return console.assert(n.getEndPoint().eq(n.startPoint)),n}static mapPathCommand(o,e){switch(o.kind){case 1:case 0:return{kind:o.kind,point:e(o.point)};case 2:return{kind:o.kind,controlPoint1:e(o.controlPoint1),controlPoint2:e(o.controlPoint2),endPoint:e(o.endPoint)};case 3:return{kind:o.kind,controlPoint:e(o.controlPoint),endPoint:e(o.endPoint)}}return o}mapPoints(o){let e=o(this.startPoint),n=[];for(let i of this.parts)n.push(s.mapPathCommand(i,o));return new s(e,n)}transformedBy(o){return o.isIdentity()?this:this.mapPoints(e=>o.transformVec2(e))}closedContainsPoint(o){let e=this.getExactBBox();if(!e.containsPoint(o))return!1;let n=o.plus(S.of(e.width,0)),i=this.asClosed(),r=new Te(o,n),a=i.intersection(r);return a.filter((c,d)=>d===0?!0:!(a[d-1].parameterValue>=1&&c.parameterValue<=0)).length%2===1}closedContainsRect(o){if(!this.bbox.containsRect(o)||!o.corners.every(e=>this.closedContainsPoint(e)))return!1;for(let e of o.getEdges())if(this.intersection(e).length)return!1;return!0}union(o,e={allowReverse:!0}){if(!o)return this;if(Array.isArray(o))return new s(this.startPoint,[...this.parts,...o]);let n=this.getEndPoint(),i=[];if(n.eq(o.startPoint))i=this.parts.concat(o.parts);else{if(e.allowReverse&&this.startPoint.eq(o.getEndPoint()))return o.union(this,{allowReverse:!1});if(e.allowReverse&&this.startPoint.eq(o.startPoint))return this.union(o.reversed(),{allowReverse:!1});i=[...this.parts,{kind:1,point:o.startPoint},...o.parts]}return new s(this.startPoint,i)}reversed(){let o=this.getEndPoint(),e=[],n=this.startPoint;for(let i of this.parts)switch(i.kind){case 0:case 1:e.push({kind:i.kind,point:n}),n=i.point;break;case 2:e.push({kind:i.kind,controlPoint1:i.controlPoint2,controlPoint2:i.controlPoint1,endPoint:n}),n=i.endPoint;break;case 3:e.push({kind:i.kind,controlPoint:i.controlPoint,endPoint:n}),n=i.endPoint;break;default:return i}return e.reverse(),new s(o,e)}getEndPoint(){if(this.parts.length===0)return this.startPoint;let o=this.parts[this.parts.length-1];return o.kind===3||o.kind===2?o.endPoint:o.point}roughlyIntersects(o,e=0){if(this.parts.length===0)return o.containsPoint(this.startPoint);if(this.startPoint.eq(this.getEndPoint())&&e===0)return this.closedRoughlyIntersects(o);if(o.containsRect(this.bbox))return!0;let i=this.startPoint;for(let r of this.parts){let a=s.computeBBoxForSegment(i,r).grownBy(e);if(r.kind===0||r.kind===1?i=r.point:i=r.endPoint,o.intersects(a))return!0}return!1}closedRoughlyIntersects(o){if(o.containsRect(this.bbox))return!0;let e=this.bbox.topLeft.minus(S.of(1,1)),n=o.corners,i=this.polylineApproximation();for(let l of n){let c=new Te(l,e),d=0;for(let p of i)p.intersects(c)&&d++;if(d%2===1)return!0}let r=o.grownBy(Math.min(o.size.x,o.size.y)),a=[];for(let l of r.divideIntoGrid(4,4))a.push(...l.getEdges());for(let l of a)for(let c of i)if(l.intersects(c))return!0;return!1}eq(o,e){if(o.parts.length!==this.parts.length)return!1;for(let n=0;n<this.parts.length;n++){let i=this.parts[n],r=o.parts[n];switch(i.kind){case 0:case 1:if(i.kind!==r.kind)return!1;if(!i.point.eq(r.point,e))return!1;break;case 2:if(i.kind!==r.kind)return!1;if(!i.controlPoint1.eq(r.controlPoint1,e)||!i.controlPoint2.eq(r.controlPoint2,e)||!i.endPoint.eq(r.endPoint,e))return!1;break;case 3:if(i.kind!==r.kind)return!1;if(!i.controlPoint.eq(r.controlPoint,e)||!i.endPoint.eq(r.endPoint,e))return!1;break;default:return i}}return!0}static fromRect(o,e=null){let n=[],i,r;if(e!==null){let a=S.of(e,e).times(.5),l=le.fromCorners(o.topLeft.plus(a),o.bottomRight.minus(a)),c=le.fromCorners(o.topLeft.minus(a),o.bottomRight.plus(a));i=[l.corners[3],...l.corners,...c.corners.reverse()],r=c.corners[3]}else i=o.corners.slice(1),r=o.corners[0];for(let a of i)n.push({kind:0,point:a});return n.push({kind:0,point:r}),new s(r,n)}toString(o,e=!1){if(this.cachedStringVersion&&!e)return this.cachedStringVersion;o===void 0&&(o=Math.abs(this.bbox.topLeft.x)>10&&Math.abs(this.bbox.topLeft.y)>10);let n=s.toString(this.startPoint,this.parts,!o);return this.cachedStringVersion=n,n}serialize(){return this.toString()}static toString(o,e,n){let i=[],r,a=(c,...d)=>{let p=[],u=[],h=!r||n,f=r?rt(r.x):"",v=r?rt(r.y):"";for(let g of d){let y=rt(g.x),m=rt(g.y);if(h)p.push(`${y},${m}`);else{let C=Cn(g.x-r.x,y,f,v),P=Cn(g.y-r.y,m,f,v);P.charAt(0)==="-"?u.push(`${C}${P}`):u.push(`${C},${P}`)}}let x;h?x=`${c}${p.join(" ")}`:x=`${c.toLowerCase()}${u.join(" ")}`,!(x==="l0,0"||x==="m0,0")&&(i.push(x),d.length>0&&(r=d[d.length-1]))};e[0]?.kind!==1&&a("M",o);let l;for(let c=0;c<e.length;c++){let d=e[c];switch(d.kind){case 1:a("M",d.point);break;case 0:a("L",d.point);break;case 2:a("C",d.controlPoint1,d.controlPoint2,d.endPoint);break;case 3:a("Q",d.controlPoint,d.endPoint);break;default:return l=d,l}}return i.join("")}static fromString(o){o=o.split(`
`).join(" ");let e=S.zero,n=null,i=null,r=!0,a=[],l=x=>{if(r){r=!1;return}a.push({kind:1,point:x})},c=x=>{if(r){r=!1;return}a.push({kind:0,point:x})},d=(x,g,y)=>{a.push({kind:2,controlPoint1:x,controlPoint2:g,endPoint:y})},p=(x,g)=>{a.push({kind:3,controlPoint:x,endPoint:g})},u={m:1,l:1,c:3,q:2,z:0,h:1,v:1},h=/([MZLHVCSQTA])\s*([^MZLHVCSQTA]*)/gi,f;for(;(f=h.exec(o))!==null;){let g=f[2].trim().split(/[^0-9Ee.-]/).filter(w=>w.length>0).reduce((w,E)=>{E=E.replace(/([^eE])[-]/g,"$1 -");let T=E.split(" -");return T[0]!==""&&w.push(T[0]),w.push(...T.slice(1).map(V=>`-${V}`)),w},[]).map(w=>parseFloat(w)),y=f[1].toLowerCase(),m=f[1]!==y;if(y==="v"||y==="h")g=g.reduce((w,E)=>y==="v"?w.concat(m?e.x:0,E):w.concat(E,m?e.y:0),[]),y="l";else if(y==="z"){if(n)g=[n.x,n.y],n=e;else continue;m=!0,y="l"}let C=u[y]??0,P=g.reduce((w,E,T,V)=>{if(T%2!==0){let O=E,$=V[T-1];return w.concat(S.of($,O))}else return w},[]).map((w,E)=>{let T;return m?T=w:T=e.plus(w),(E+1)%C===0&&(e=T),T});if(P.length%C!==0)throw new Error([`Incorrect number of arguments: got ${JSON.stringify(P)} with a length of ${P.length} \u2260 ${C}k, k \u2208 \u2124.`,`The number of arguments to ${y} must be a multiple of ${C}!`,`Command: ${f[0]}`].join(`
`));for(let w=0;w<P.length;w+=C){let E=P.slice(w,w+C);switch(y.toLowerCase()){case"m":w===0?l(E[0]):c(E[0]);break;case"l":c(E[0]);break;case"c":d(E[0],E[1],E[2]);break;case"q":p(E[0],E[1]);break;default:throw new Error(`Unknown path command ${y}`)}r=!1}P.length>0&&(n??=P[0],i??=n,e=P[P.length-1])}let v=new s(i??S.zero,a);return v.cachedStringVersion=o,v}static fromConvexHullOf(o){if(o.length===0)return s.empty;let e=qi(o),n=e.slice(1).map(i=>({kind:0,point:i}));return n.push({kind:0,point:e[0]}),new s(e[0],n)}static{this.empty=new s(S.zero,[])}};var M=class s{constructor(o,e,n,i){this.r=o;this.g=e;this.b=n;this.a=i;this.hexString=null}static ofRGB(o,e,n){return s.ofRGBA(o,e,n,1)}static ofRGBA(o,e,n,i){return o=Math.max(0,Math.min(o,1)),e=Math.max(0,Math.min(e,1)),n=Math.max(0,Math.min(n,1)),i=Math.max(0,Math.min(i,1)),new s(o,e,n,i)}static fromRGBArray(o,e=255){let n=o[0],i=o[1]??n,r=o[2]??n,a=255;return 3<o.length&&(a=o[3]),s.ofRGBA(n/e,i/e,r/e,a/e)}static fromHex(o){if(o=(o.match(/^[#]?(.*)$/)??[])[1],o=o.toUpperCase(),!o.match(/^[0-9A-F]+$/))throw new Error(`${o} is not in a valid format.`);(o.length===3||o.length===4)&&(o=o.split("").map(i=>`${i}0`).join("")),o.length===6&&(o+="FF");let e=[];for(let n=2;n<=o.length;n+=2){let i=o.substring(n-2,n);e.push(parseInt(i,16)/255)}if(e.length!==4)throw new Error(`Unable to parse ${o}: Wrong number of components.`);return s.ofRGBA(e[0],e[1],e[2],e[3])}static fromString(o){if(o.startsWith("#"))return s.fromHex(o);if(o==="none"||o==="transparent")return s.transparent;if(o==="")return s.black;let e=/^rgba?\(([,0-9.]+)\)$/i,n=o.replace(/\s*/g,"").match(e);if(n){let u=n[1],h=JSON.parse(`[ ${u} ]`);if(h.length===3)return s.ofRGB(h[0]/255,h[1]/255,h[2]/255);if(h.length===4)return s.ofRGBA(h[0]/255,h[1]/255,h[2]/255,h[3]);throw new Error(`RGB string, ${o}, has wrong number of components: ${h.length}`)}let i=document.createElement("canvas");i.width=1,i.height=1;let r=i.getContext("2d");if(!r)return s.black;r.fillStyle=o,r.fillRect(0,0,1,1);let a=r.getImageData(0,0,1,1),l=a.data[0]/255,c=a.data[1]/255,d=a.data[2]/255,p=a.data[3]/255;return s.ofRGBA(l,c,d,p)}eq(o){return o==null?!1:this.a===0&&o.a===0?!0:this.toHexString()===o.toHexString()}mix(o,e){e=Math.min(Math.max(e,0),1);let n=1-e;return new s(this.r*n+o.r*e,this.g*n+o.g*e,this.b*n+o.b*e,this.a*n+o.a*e)}withAlpha(o){return new s(this.r,this.g,this.b,o)}get rgb(){return ye.of(this.r,this.g,this.b)}relativeLuminance(){let o=[this.r,this.g,this.b].map(e=>e<.03928?e/12.92:Math.pow((e+.055)/1.055,2.4));return .2126*o[0]+.7152*o[1]+.0722*o[2]}static contrastRatio(o,e){let n=o.relativeLuminance(),i=e.relativeLuminance();return(Math.max(n,i)+.05)/(Math.min(n,i)+.05)}static average(o){let e=0,n=0,i=0,r=0;for(let a of o)e+=a.a,n+=a.r,i+=a.g,r+=a.b;return o.length>0&&(e/=o.length,n/=o.length,i/=o.length,r/=o.length),new s(n,i,r,e)}asHSV(){let o=Math.min(this.r,this.g,this.b),e=Math.max(this.r,this.g,this.b),n=e-o,i;n===0?i=0:this.r>=this.g&&this.r>=this.b?i=(this.g-this.b)/n%6:this.g>=this.r&&this.g>=this.b?i=(this.b-this.r)/n+2:i=(this.r-this.g)/n+4,i*=60,i*=Math.PI/180,i<0&&(i+=Math.PI*2);let r=e,a=r>0?n/r:0;return ye.of(i,a,r)}static fromHSV(o,e,n){o<0&&(o+=Math.PI*2),o%=Math.PI*2,n=Math.max(0,Math.min(1,n)),e=Math.max(0,Math.min(1,e));let i=n*e,r=o/(Math.PI/3),a=i*(1-Math.abs(r%2-1)),l;r<1?l=[i,a,0]:r<2?l=[a,i,0]:r<3?l=[0,i,a]:r<4?l=[0,a,i]:r<5?l=[a,0,i]:l=[i,0,a];let c=n-i;return s.ofRGB(l[0]+c,l[1]+c,l[2]+c)}static fromRGBVector(o,e){return s.ofRGBA(o.x,o.y,o.z,e??1)}toHexString(){if(this.hexString)return this.hexString;let o=a=>{let l=Math.round(255*a).toString(16);return l.length===1?`0${l}`:l},e=o(this.a),n=o(this.r),i=o(this.g),r=o(this.b);return e==="ff"?`#${n}${i}${r}`:(this.hexString=`#${n}${i}${r}${e}`,this.hexString)}toString(){return this.toHexString()}static{this.transparent=s.ofRGBA(0,0,0,0)}static{this.red=s.ofRGB(1,0,0)}static{this.orange=s.ofRGB(1,.65,0)}static{this.green=s.ofRGB(0,1,0)}static{this.blue=s.ofRGB(0,0,1)}static{this.purple=s.ofRGB(.5,.2,.5)}static{this.yellow=s.ofRGB(1,1,.1)}static{this.clay=s.ofRGB(.8,.4,.2)}static{this.black=s.ofRGB(0,0,0)}static{this.gray=s.ofRGB(.5,.5,.5)}static{this.white=s.ofRGB(1,1,1)}};var Ks=(s,o,e,n)=>{let i=o.transformVec3(S.unitX),r=o.transformVec2(s),a=i.magnitude(),l=-(180/Math.PI)*i.angle(),c=r.minus(s),d=[];if(a>1.2?d.push(n.zoomedIn):a<.8&&d.push(n.zoomedOut),Math.floor(Math.abs(l))>0){let u=Math.round(e?-l:l);d.push(n.rotatedBy(u))}let p=1e-4;return c.x>p?d.push(e?n.movedLeft:n.movedRight):c.x<-p&&d.push(e?n.movedRight:n.movedLeft),c.y<-p?d.push(e?n.movedDown:n.movedUp):c.y>p&&d.push(e?n.movedUp:n.movedDown),d.join("; ")},wt=Ks;var wn=class extends Pe{},xe=class s{constructor(o){this.onTransformChangeCallback=o;this.resetTransform(I.identity),this.screenRect=z.empty}static{this.ViewportTransform=class extends wn{constructor(e){super();this.transform=e;this.#e=e.inverse()}#e;apply(e){let n=e.viewport;n.resetTransform(n.transform.rightMul(this.transform)),e.queueRerender()}unapply(e){let n=e.viewport;n.resetTransform(n.transform.rightMul(this.#e)),e.queueRerender()}description(e,n){return wt(e.viewport.visibleRect.center,this.transform,!0,n)}}}getTemporaryClone(){let o=new s(()=>{});return o.transform=this.transform,o.inverseTransform=this.inverseTransform,o.screenRect=this.screenRect,o}updateScreenSize(o){this.screenRect=this.screenRect.resizedTo(o)}get visibleRect(){return this.screenRect.transformedBoundingBox(this.inverseTransform)}screenToCanvas(o){return this.inverseTransform.transformVec2(o)}canvasToScreen(o){return this.transform.transformVec2(o)}static transformBy(o){return new s.ViewportTransform(o)}resetTransform(o=I.identity){let e=this.transform;this.transform=o,this.inverseTransform=o.inverse(),this.onTransformChangeCallback?.(e,o)}get screenToCanvasTransform(){return this.inverseTransform}get canvasToScreenTransform(){return this.transform}getScreenRectSize(){return this.screenRect.size}getResolution(){return this.getScreenRectSize()}getScaleFactor(){return this.transform.transformVec3(N.unitX).magnitude()}getScaleFactorToNearestPowerOfTen(){return this.getScaleFactorToNearestPowerOf(10)}getScaleFactorToNearestPowerOf(o){let e=this.getScaleFactor();return Math.pow(o,Math.round(Math.log(e)/Math.log(o)))}static getGridSize(o){return 50/o}snapToGrid(o){let e=this.getScaleFactorToNearestPowerOf(2),n=r=>{let a=1/s.getGridSize(e);return Math.round(r*a)/a};return S.of(n(o.x),n(o.y))}getSizeOfPixelOnCanvas(){return 1/this.getScaleFactor()}getRotationAngle(){return this.transform.transformVec3(N.unitX).angle()}static roundPoint(o,e){let n=10**Math.floor(Math.log10(e)),i=r=>Math.round(r/n)*n;return typeof o=="number"?i(o):o.map(i)}roundPoint(o){return s.roundPoint(o,1/this.getScaleFactor())}static roundScaleRatio(o,e=1){if(Math.abs(o)<=1e-12)return 0;let n=10**Math.floor(Math.log10(Math.abs(o))),i=2**e;return o=Math.round(o/n*i)/i*n,o}computeZoomToTransform(o,e=!0,n=!0){let i=I.identity;if(o.w===0||o.h===0){let d=Math.max(o.w,o.h);d===0&&(d=50,e=!1,n=!1),o=new z(o.x,o.y,d,d)}if(isNaN(o.size.magnitude()))throw new Error(`${o.toString()} rectangle has NaN size! Cannot zoom to!`);let r=()=>{let d=this.visibleRect.transformedBoundingBox(i.inverse());return d.transformedBoundingBox(I.scaling2D(4/5,d.center))},a=r(),l=a.w<o.w||a.h<o.h,c=o.maxDimension/a.maxDimension<1/3;if(l&&n||c&&e){let d=Math.max(o.w/a.w,o.h/a.h),u=I.scaling2D(d,a.topLeft).inverse();i=i.rightMul(u)}if(a=r(),!a.containsRect(o)){let d=o.center.minus(a.center),u=I.translation(d).inverse();i=i.rightMul(u)}return i.invertable()||(console.warn("Unable to zoom to ",o,"! Computed transform",i,"is singular."),i=I.identity),i}zoomTo(o,e=!0,n=!0){let i=this.computeZoomToTransform(o,e,n);return new s.ViewportTransform(i)}},q=xe;var U=class s extends Pe{#e;constructor(o){if(super(),!(o in s.deserializationCallbacks))throw new Error(`Command ${o} must have a registered deserialization callback. To do this, call SerializableCommand.register.`);this.#e=o}static{this.deserializationCallbacks={}}serialize(){return{data:this.serializeToJSON(),commandType:this.#e}}static deserialize(o,e){let n=typeof o=="string"?JSON.parse(o):o,i=n.commandType;if(!(i in s.deserializationCallbacks))throw new Error(`Unrecognised command type ${i}!`);return s.deserializationCallbacks[i](n.data,e)}static register(o,e){s.deserializationCallbacks[o]=e}};var st=class extends U{constructor(o,e,n){super(o),this.component=n??null,this.componentID=e}resolveComponent(o){if(this.component)return;let e=o.lookupElement(this.componentID);if(!e)throw new Error(`Unable to resolve component with ID ${this.componentID}`);this.component=e}};function Ki(s){throw new Error(`Should be unreachable. Key: ${s}.`)}function We(s,o=!1){if(typeof s!="number"||!o&&isNaN(s))throw new Error("Given value is not a number")}function Pn(s){if(typeof s!="string")throw new Error("Given value is not a string")}function Gi(s){if(!Array.isArray(s))throw new Error("Asserting isArray: Given entity is not an array")}function Ye(s,o=!1){Gi(s),We(s.length);for(let e of s)We(e,o)}function jt(s){Gi(s),We(s.length);for(let o of s)Pn(o)}function En(s){if(typeof s!="boolean")throw new Error("Given value is not a boolean")}function Zi(s){if(!s)throw new Error(`${JSON.stringify(s)} is not truthy`)}function Mo(s){if(typeof s!="object")throw new Error(`AssertIsObject: Given entity is not an object (type = ${typeof s})`)}var Z=class s{constructor(o,e){this.componentKind=o;this.loadSaveData={};if(this.lastChangedTime=new Date().getTime(),e!==void 0?this.zIndex=e:this.zIndex=s.zIndexCounter++,this.id=`${new Date().getTime()}-${Math.random()}`,s.deserializationCallbacks[o]===void 0)throw new Error(`Component ${o} has not been registered using AbstractComponent.registerComponent`)}static{this.zIndexCounter=0}getId(){return this.id}static{this.deserializationCallbacks={}}static registerComponent(o,e){this.deserializationCallbacks[o]=e??null}attachLoadSaveData(o,e){this.loadSaveData[o]||(this.loadSaveData[o]=[]),this.loadSaveData[o].push(e)}getLoadSaveData(){return this.loadSaveData}getZIndex(){return this.zIndex}getBBox(){return this.contentBBox}getExactBBox(){return this.getBBox()}getSizingMode(){return 0}occludesEverythingBelowWhenRenderedInRect(o){return!1}onAddToImage(o){}onRemoveFromImage(){}intersectsRect(o){return o.containsRect(this.getExactBBox())?!0:o.getEdges().some(n=>this.intersects(n))}keyPoints(){return[this.getBBox().center]}isSelectable(){return!0}isBackground(){return!1}getProportionalRenderingTime(){return 1}transformBy(o){return new s.TransformElementCommand(o,this.getId(),this)}setZIndex(o){return new s.TransformElementCommand(I.identity,this.getId(),this,o)}setZIndexAndTransformBy(o,e,n){return new s.TransformElementCommand(o,this.getId(),this,e,n)}static{this.transformElementCommandId="transform-element"}static{this.TransformElementCommand=class extends st{constructor(e,n,i,r,a){super(s.transformElementCommandId,n,i);this.affineTransfm=e;this.origZIndex=a;this.targetZIndex=r??s.zIndexCounter++,this.targetZIndex>=s.zIndexCounter&&(s.zIndexCounter=this.targetZIndex+1),i&&a===void 0&&(this.origZIndex=i.getZIndex())}resolveComponent(e){this.component||(super.resolveComponent(e),this.origZIndex??=this.component.getZIndex())}updateTransform(e,n,i){if(!this.component)throw new Error("this.component is undefined or null!");let r=e.image.findParent(this.component),a=!1;r&&(r.remove(),a=!0),this.component.applyTransformation(n),this.component.zIndex=i,this.component.lastChangedTime=new Date().getTime(),i>=s.zIndexCounter&&(s.zIndexCounter=i+1),a&&Q.addComponent(this.component).apply(e)}apply(e){this.resolveComponent(e.image),this.updateTransform(e,this.affineTransfm,this.targetZIndex),e.queueRerender()}unapply(e){this.resolveComponent(e.image),this.updateTransform(e,this.affineTransfm.inverse(),this.origZIndex),e.queueRerender()}description(e,n){return n.transformedElements(1,wt(S.zero,this.affineTransfm,!1,n))}static{U.register(s.transformElementCommandId,(e,n)=>{let i=n.image.lookupElement(e.id)??void 0,r=new I(...e.transfm),a=e.targetZIndex,l=e.origZIndex??void 0;return new s.TransformElementCommand(r,e.id,i,a,l)})}serializeToJSON(){return{id:this.componentID,transfm:this.affineTransfm.toArray(),targetZIndex:this.targetZIndex,origZIndex:this.origZIndex}}}}clone(){let o=this.createClone();for(let e in this.loadSaveData)for(let n of this.loadSaveData[e])o.attachLoadSaveData(e,n);return o}cloneWithId(o){let e=this.clone();return e.id=o,e}serialize(){let o=this.serializeToJSON();if(o===null)throw new Error(`${this} cannot be serialized.`);return{name:this.componentKind,zIndex:this.zIndex,id:this.id,loadSaveData:this.loadSaveData,data:o}}static isNotDeserializable(o){return typeof o=="string"&&(o=JSON.parse(o)),typeof o!="object"||!this.deserializationCallbacks[o?.name]||!o.data}static deserialize(o){if(typeof o=="string"&&(o=JSON.parse(o)),s.isNotDeserializable(o))throw new Error(`Element with data ${o} cannot be deserialized.`);Pn(o.id);let e=this.deserializationCallbacks[o.name](o.data);return e.id=o.id,isFinite(o.zIndex)&&(e.zIndex=o.zIndex,s.zIndexCounter=Math.max(s.zIndexCounter,e.zIndex+1)),e}};var Ue=class{constructor(){this.listeners={}}dispatch(o,e){let n=this.listeners[o];if(n)for(let i=0;i<n.length;i++)n[i](e)}on(o,e){return this.listeners[o]||(this.listeners[o]=[]),this.listeners[o].push(e),{remove:()=>{let n=this.listeners[o];return this.off(o,e),n.length!==this.listeners[o].length}}}off(o,e){let n=this.listeners[o];n&&(this.listeners[o]=n.filter(i=>i!==e))}};var Pt=s=>{s.sort((o,e)=>o.getContent().getZIndex()-e.getContent().getZIndex())};var Do=!1,Q=class s{constructor(){this.componentCount=0;this.settingExportRect=!1;this.root=new Ao,this.background=new Ao,this.componentsById=Object.create(null),this.notifier=new Ue,this.importExportViewport=new q(()=>{this.onExportViewportChanged()}),this.importExportViewport.updateScreenSize(S.of(500,500)),this.shouldAutoresizeExportViewport=!1}getBackgroundComponents(){let o=[],e=this.background.getLeaves();Pt(e);for(let n of e){let i=n.getContent();i&&o.push(i)}return o}findParent(o){return this.background.getChildWithContent(o)??this.root.getChildWithContent(o)}queueRerenderOf(o){let e=this.findParent(o);e&&(e.remove(),this.addComponentDirectly(o))}renderWithCache(o,e,n){this.background.render(o,n.visibleRect),Do?this.root.render(o,n.visibleRect):e.render(o,this.root,n)}render(o,e){this.background.render(o,e?.visibleRect),this.root.render(o,e?.visibleRect)}async renderAllAsync(o,e){return await this.background.renderAllAsync(o,e)?await this.root.renderAllAsync(o,e):!1}renderAll(o){this.render(o,null)}getAllComponents(){let o=this.root.getLeaves();return Pt(o),o.map(e=>e.getContent())}getAllElements(){return this.getAllComponents()}estimateNumElements(){return this.componentCount}getElementsIntersectingRegion(o,e=!1){return this.getComponentsIntersecting(o,e)}getComponentsIntersecting(o,e=!1){let n=this.root.getLeavesIntersectingRegion(o);return e&&(n=n.concat(this.background.getLeavesIntersectingRegion(o))),Pt(n),n.map(i=>i.getContent())}onDestroyElement(o){this.componentCount--,delete this.componentsById[o.getId()],this.autoresizeExportViewport()}onElementAdded(o){this.componentCount++,this.componentsById[o.getId()]=o,this.autoresizeExportViewport()}lookupElement(o){return this.componentsById[o]??null}addComponentDirectly(o){o.onAddToImage(this);let n=(o.isBackground()?this.background:this.root).addLeaf(o);return this.onElementAdded(o),n}removeElementDirectly(o){let e=this.findParent(o);return e?.remove(),e?(this.onDestroyElement(o),!0):!1}static addComponent(o,e=!1){return new s.AddComponentCommand(o,e)}addComponent(o,e){return s.addComponent(o,e)}addElement(o,e){return this.addComponent(o,e)}static addElement(o,e=!1){return this.addComponent(o,e)}static{this.AddComponentCommand=class extends U{constructor(e,n=!1){super("add-element");this.element=e;this.applyByFlattening=n;this.serializedElem=null;if(this.serializedElem=null,isNaN(e.getBBox().area))throw new Error("Elements in the image cannot have NaN bounding boxes")}apply(e){e.image.addComponentDirectly(this.element),this.applyByFlattening?(this.applyByFlattening=!1,e.display.flatten()):e.queueRerender()}unapply(e){e.image.removeElementDirectly(this.element),e.queueRerender()}description(e,n){return n.addComponentAction(this.element.description(n))}serializeToJSON(){return{elemData:this.serializedElem??this.element.serialize()}}static{U.register("add-element",(e,n)=>{let i=e.elemData.id,a=n.image.lookupElement(i)??Z.deserialize(e.elemData),l=new s.AddComponentCommand(a);return l.serializedElem=e.elemData,l})}}}getImportExportViewport(){return this.importExportViewport}getImportExportRect(){return this.getImportExportViewport().visibleRect}setImportExportRect(o){return s.SetImportExportRectCommand.of(this,o,!1)}getAutoresizeEnabled(){return this.shouldAutoresizeExportViewport}setAutoresizeEnabled(o){if(o===this.shouldAutoresizeExportViewport)return Pe.empty;let e=this.root.getBBox();return s.SetImportExportRectCommand.of(this,e,o)}setAutoresizeEnabledDirectly(o){o!==this.shouldAutoresizeExportViewport&&(this.shouldAutoresizeExportViewport=o,this.notifier.dispatch(1,{image:this}))}autoresizeExportViewport(){this.shouldAutoresizeExportViewport&&this.setExportRectDirectly(this.root.getBBox())}setExportRectDirectly(o){let e=this.getImportExportViewport(),n=e.getScreenRectSize(),i=e.canvasToScreenTransform,r=I.translation(o.topLeft.times(-1));return!n.eq(o.size)||!i.eq(r)?(this.settingExportRect=!0,e.updateScreenSize(o.size),e.resetTransform(r),this.settingExportRect=!1,this.onExportViewportChanged(),!0):!1}onExportViewportChanged(){this.settingExportRect||this.notifier.dispatch(0,{image:this})}static setDebugMode(o){Do=o}static{this.SetImportExportRectCommand=class extends U{constructor(e,n,i,r,a){super(s.SetImportExportRectCommand.commandId);this.originalSize=e;this.originalTransform=n;this.originalAutoresize=i;this.newExportRect=r;this.newAutoresize=a}static{this.commandId="set-import-export-rect"}static of(e,n,i){let r=e.getImportExportViewport(),a=r.visibleRect.size,l=r.canvasToScreenTransform,c=e.getAutoresizeEnabled();return new s.SetImportExportRectCommand(a,l,c,n,i)}apply(e){e.image.setAutoresizeEnabledDirectly(this.newAutoresize),e.image.setExportRectDirectly(this.newExportRect),e.queueRerender()}unapply(e){let n=e.image.getImportExportViewport();e.image.setAutoresizeEnabledDirectly(this.originalAutoresize),n.updateScreenSize(this.originalSize),n.resetTransform(this.originalTransform),e.queueRerender()}description(e,n){return this.newAutoresize!==this.originalAutoresize?this.newAutoresize?n.enabledAutoresizeOutputCommand:n.disabledAutoresizeOutputCommand:n.resizeOutputCommand(this.newExportRect)}serializeToJSON(){return{originalSize:this.originalSize.xy,originalTransform:this.originalTransform.toArray(),newRegion:{x:this.newExportRect.x,y:this.newExportRect.y,w:this.newExportRect.w,h:this.newExportRect.h},autoresize:this.newAutoresize,originalAutoresize:this.originalAutoresize}}static{let e=this.commandId;U.register(e,(n,i)=>{We(n.originalSize.x),We(n.originalSize.y),Ye(n.originalTransform),Ye([n.newRegion.x,n.newRegion.y,n.newRegion.w,n.newRegion.h]),En(n.autoresize??!1),En(n.originalAutoresize??!1);let r=S.ofXY(n.originalSize),a=new I(...n.originalTransform),l=new z(n.newRegion.x,n.newRegion.y,n.newRegion.w,n.newRegion.h),c=n.autoresize??!1,d=n.originalAutoresize??!1;return new s.SetImportExportRectCommand(r,a,d,l,c)})}}}},_i=(s,o)=>{let e=0;if(o){for(let n=s.length-1;n>=1;n--)if(s[n].getBBox().containsRect(o)&&s[n].getContent()?.occludesEverythingBelowWhenRenderedInRect(o)){e=n;break}}return e},Yt=class s{constructor(o=null){this.parent=o;this.targetChildCount=30;this.children=[],this.bbox=z.empty,this.content=null,this.id=s.idCounter++}static{this.idCounter=0}getId(){return this.id}onContentChange(){this.id=s.idCounter++}getContent(){return this.content}getParent(){return this.parent}getChildrenIntersectingRegion(o,e){return this.children.filter(n=>{let i=n.getBBox();return!e?.(i)&&i.intersects(o)})}getChildrenOrSelfIntersectingRegion(o,e){return this.content&&this.bbox.intersects(o)&&!e?.(this.bbox)?[this]:this.getChildrenIntersectingRegion(o,e)}getLeavesIntersectingRegion(o,e){let n=[],i=[];for(i.push(this);i.length>0;){let a=i.pop().getChildrenOrSelfIntersectingRegion(o,e);for(let l of a)l.content?n.push(l):i.push(l)}return n}getChildWithContent(o){let e=this.getLeavesIntersectingRegion(o.getBBox());for(let n of e)if(n.getContent()===o)return n;return null}getLeaves(){if(this.content)return[this];let o=[];for(let e of this.children)o.push(...e.getLeaves());return o}addLeaf(o){if(this.onContentChange(),this.content===null&&this.children.length===0)return this.content=o,this.recomputeBBox(!0),this;if(this.content!==null){console.assert(this.children.length===0);let r=new s(this);r.content=this.content,this.content=null,this.children.push(r),r.recomputeBBox(!1)}let e=o.getBBox();if(e.containsRect(this.getBBox())){let r=new s(this);if(this.children.length<this.targetChildCount)this.children.push(r);else{let a=new s(this);a.children=this.children,this.children=[r,a],a.updateParents(),a.recomputeBBox(!0)}return r.addLeaf(o)}let n=this.children.filter(r=>r.getBBox().containsRect(e));if(n.length>0&&this.children.length>=this.targetChildCount){n.sort((a,l)=>a.getBBox().area-l.getBBox().area);let r=n[0].addLeaf(o);return r.rebalance(),r}let i=s.createLeafNode(this,o);return this.children.push(i),i.recomputeBBox(!0),this.children.length>=this.targetChildCount&&this.rebalance(),i}static createLeafNode(o,e){let n=new s(o);return n.content=e,n}getBBox(){return this.bbox}recomputeBBox(o){let e=this.bbox;this.content!==null?this.bbox=this.content.getBBox():this.bbox=z.union(...this.children.map(n=>n.getBBox())),o&&!e.eq(this.bbox)&&(this.bbox.containsRect(e)?this.parent?.unionBBoxWith(this.bbox):this.parent?.recomputeBBox(!0)),this.checkRep()}unionBBoxWith(o){this.bbox=this.bbox.union(o),this.parent?.unionBBoxWith(o)}updateParents(o=!1){for(let e of this.children)e.parent=this,o&&e.updateParents(o)}rebalance(){if(this.parent&&this.parent.children.length===1){console.assert(this.parent.content===null),console.assert(this.parent.children[0]===this);let o=this.parent;if(o.parent!==null){let e=o.parent;e.children=e.children.filter(n=>n!==o),o.parent=null,o.children=[],this.parent=e,e.children.push(this),this.parent.recomputeBBox(!1)}else this.content===null&&(this.parent.children=this.children,this.parent.updateParents(),this.parent=null)}if(this.children.length>this.targetChildCount*10){let o=this.getBBox().divideIntoGrid(4,4),e=[];for(;e.length<o.length;)e.push(0);for(let a of this.children)for(let l=0;l<o.length;l++)o[l].containsRect(a.getBBox())&&e[l]++;let n=0,i=e[0];for(let a=1;a<e.length;a++)e[a]>i&&(n=a,i=e[a]);let r=o[n];if(i>4){let a=[],l=[];for(let c of this.children)r.containsRect(c.getBBox())?l.push(c):a.push(c);if(l.length<this.children.length){this.children=a;let c=new s(this);this.children.push(c),c.children=l,c.updateParents(!1),c.recomputeBBox(!1),c.rebalance()}}}this.parent&&this.children.length===0&&this.content===null&&this.remove()}removeChild(o){this.checkRep();let e=this.children.length;this.children=this.children.filter(n=>n!==o),console.assert(this.children.length===e-1,`${e-1} \u2260 ${this.children.length} after removing all nodes equal to ${o}. Nodes should only be removed once.`),this.children.forEach(n=>{n.rebalance()}),this.recomputeBBox(!0),this.rebalance(),this.checkRep()}remove(){if(this.content?.onRemoveFromImage(),!this.parent){this.content=null,this.children=[];return}this.parent.removeChild(this),this.parent=null,this.content=null,this.children=[],this.checkRep()}async renderAllAsync(o,e){let n=this.getLeaves();Pt(n);let i=n.length;for(let r=0;r<i;r++){let l=n[r].getContent();if(!l)continue;if(!await e(l,r,i))return!1;l.render(o,void 0)}return!0}render(o,e){let n;e?n=this.getLeavesIntersectingRegion(e,r=>o.isTooSmallToRender(r)):n=this.getLeaves(),Pt(n);let i=_i(n);for(let r=i;r<n.length;r++)n[r].getContent().render(o,e);Do&&e&&(i!==0&&console.log("EditorImage: skipped ",i,"nodes due to occlusion"),this.renderDebugBoundingBoxes(o,e))}renderDebugBoundingBoxes(o,e,n=0){let i=this.getBBox(),r=1/(o.getSizeOfCanvasPixelOnScreen()||1);if(i.maxDimension<3*r||!i.intersects(e))return;o.startObject(i);let a=!!this.content,l=a?M.ofRGBA(1,0,1,.4):M.ofRGBA(0,1,Math.sin(n),.6),c=a?1*r:2*r;if(o.drawRect(i.intersection(e),c,{fill:l}),o.endObject(),i.maxDimension>e.maxDimension/3){let d={fontFamily:"monospace",size:i.minDimension/20,renderingStyle:{fill:M.red}};o.drawText(`Depth: ${n}`,I.translation(i.bottomLeft),d)}for(let d of this.children)d.renderDebugBoundingBoxes(o,e,n+1)}checkRep(o=0){if(Do){if(this.parent&&!this.parent.children.includes(this))throw new Error(`Parent does not have this node as a child. (depth: ${o})`);let e=null,n=new Set;for(let r of this.children){if(e??=r.getBBox(),e=e.union(r.getBBox()),r.parent!==this)throw new Error(`Child with bbox ${r.getBBox()} and ${r.children.length} has wrong parent (was ${r.parent}).`);if(n.has(r))throw new Error(`Child ${r} is present twice or more in its parent's child list`);n.add(r)}let i=this.bbox.minDimension/100;if(e&&!this.bbox.eq(e,i))throw new Error(`Wrong bounding box ${e} \\neq ${this.bbox} (depth: ${o})`)}}},Ao=class extends Yt{constructor(){super(...arguments);this.fullscreenChildren=[];this.dataComponents=[]}getChildrenIntersectingRegion(e,n){let i=super.getChildrenIntersectingRegion(e);for(let r of this.fullscreenChildren)i.push(r);return i}getChildrenOrSelfIntersectingRegion(e,n){let i=this.getContent();return i&&i.getSizingMode()===1?[this]:super.getChildrenOrSelfIntersectingRegion(e,n)}getLeaves(){let e=super.getLeaves();return this.dataComponents.concat(this.fullscreenChildren,e)}removeChild(e){let n=!1,i=r=>{let a=r===e;return n||=a,!a};this.dataComponents=this.dataComponents.filter(i),this.fullscreenChildren=this.fullscreenChildren.filter(i),n||super.removeChild(e)}getChildWithContent(e){let n=()=>{let i=this.fullscreenChildren.concat(this.dataComponents);for(let r of i)if(r.getContent()===e)return r;return null};return e.getSizingMode()===0?super.getChildWithContent(e)??n():super.getChildWithContent(e)??n()}addLeaf(e){let n=e.getSizingMode();if(n===0)return super.addLeaf(e);if(n===1){this.onContentChange();let i=Yt.createLeafNode(this,e);return this.fullscreenChildren.push(i),i}else if(n===2){this.onContentChange();let i=Yt.createLeafNode(this,e);return this.dataComponents.push(i),i}else{let i=n;throw new Error(`Invalid sizing mode, ${n}`)}}};var Gs=()=>new Promise(s=>{requestAnimationFrame(()=>s())}),at=Gs;var ji=(s,o)=>({kind:s,key:o.key,code:o.code,ctrlKey:o.ctrlKey||o.metaKey,altKey:o.altKey,shiftKey:o.shiftKey}),Rn=s=>ji(6,s),In=s=>ji(5,s),Vo=s=>s.kind===0||s.kind===1||s.kind===2;var Yi={remove(){}},Zs=()=>Yi,_=class s{waitForNextUpdate(){return new Promise(o=>{let e=this.onUpdate(n=>{e.remove(),o(n)})})}static fromInitialValue(o){return new Oo(o)}static fromImmutable(o){return{get:()=>o,onUpdate:Zs,onUpdateAndNow:e=>(e(o),Yi),waitForNextUpdate:()=>new Promise(()=>{})}}static fromCallback(o,e){let n=new Oo(o()),i=typeof WeakRef<"u"?new WeakRef(n):{deref:()=>n};for(let r of e){let a=r.onUpdate(()=>{let l=i.deref();l?l.set(o()):a.remove()})}return n}static map(o,e,n){let i=s.fromInitialValue(e(o.get())),r=i.get();return o.onUpdate(a=>{r=e(a),i.set(r)}),n&&i.onUpdate(a=>{a!==r&&o.set(n(a))}),i}static union(o){return s.fromCallback(()=>o.map(e=>e.get()),o)}},re=class extends _{static fromProperty(o,e){let n=_.fromInitialValue(o.get()[e]),i=typeof WeakRef<"u"?new WeakRef(n):{deref:()=>n},r=o.onUpdate(a=>{let l=i.deref();l?l.set(a[e]):r.remove()});return n.onUpdate(a=>{o.set({...o.get(),[e]:a})}),n}},Oo=class extends re{#e;#t;constructor(o){super(),this.#e=o,this.#t=[]}set(o){if(this.#e!==o){this.#e=o;for(let e of this.#t)e(o)}}get(){return this.#e}onUpdate(o){return this.#t.push(o),{remove:()=>{this.#t=this.#t.filter(e=>e!==o)}}}onUpdateAndNow(o){return o(this.get()),this.onUpdate(o)}},Ln=_;var K=class{constructor(o,e){this.notifier=o;this.description=e;this.#e=_.fromInitialValue(!0),this.#e.onUpdate(n=>{n?(this.#t?.notifyEnabled(this),this.notifier.dispatch(0,{kind:0,tool:this})):this.notifier.dispatch(1,{kind:1,tool:this})})}#e;#t=null;#o=null;#n=null;canReceiveInputInReadOnlyEditor(){return!1}setInputMapper(o){this.#o=o,o&&o.setEmitListener(e=>this.dispatchEventToCallback(e))}getInputMapper(){return this.#o}dispatchEventToCallback(o){let e;switch(o.kind){case 0:return this.onPointerDown(o);case 1:this.onPointerMove(o);break;case 2:return this.onPointerUp(o)??!1;case 3:this.onGestureCancel(o);break;case 4:return this.onWheel(o);case 5:return this.onKeyPress(o);case 6:return this.onKeyUp(o);case 7:return this.onCopy(o);case 8:return this.onPaste(o);case 9:return this.onContextMenu(o);default:return e=o,e}return!0}onEvent(o){return this.#o?this.#o.onEvent(o):this.dispatchEventToCallback(o)}onPointerDown(o){return!1}onPointerMove(o){}onPointerUp(o){}onGestureCancel(o){}onWheel(o){return!1}onCopy(o){return!1}onPaste(o){return!1}onKeyPress(o){return!1}onKeyUp(o){return!1}onContextMenu(o){return!1}eventCanBeDeliveredToNonActiveTool(o){return!0}setEnabled(o){this.#e.set(o)}isEnabled(){return this.#e.get()}enabledValue(){return this.#e}setToolGroup(o){this.isEnabled()&&o.notifyEnabled(this),this.#t=o}getToolGroup(){return this.#t?this.#t:null}onDestroy(){this.#n?.remove(),this.#n=null,this.#t=null}};var Xi={updatedViewport:"Transformed Viewport",transformedElements:(s,o)=>`Transformed ${s} element${s===1?"":"s"} (${o})`,resizeOutputCommand:s=>`Resized image to ${s.w}x${s.h}`,enabledAutoresizeOutputCommand:"Enabled output autoresize",disabledAutoresizeOutputCommand:"Disabled output autoresize",addComponentAction:s=>`Added ${s}`,eraseAction:(s,o)=>`Erased ${o} ${s}`,duplicateAction:(s,o)=>`Duplicated ${o} ${s}`,unionOf:(s,o)=>`Union: ${o} ${s}`,inverseOf:s=>`Inverse of ${s}`,elements:"Elements",erasedNoElements:"Erased nothing",duplicatedNoElements:"Duplicated nothing",rotatedBy:s=>`Rotated by ${Math.abs(s)} degrees ${s<0?"clockwise":"counter-clockwise"}`,movedLeft:"Moved left",movedUp:"Moved up",movedDown:"Moved down",movedRight:"Moved right",zoomedOut:"Zoomed out",zoomedIn:"Zoomed in",andNMoreCommands:s=>`And ${s} more commands.`,selectedElements:s=>`Selected ${s} element${s===1?"":"s"}`};var Qi={unlabeledImageNode:"Unlabeled image node",stroke:"Stroke",svgObject:"SVG Object",emptyBackground:"Empty background",gridBackground:"Grid background",filledBackgroundWithColor:s=>`Filled background (${s})`,text:s=>`Text object: ${s}`,imageNode:s=>`Image: ${s}`,restyledElement:s=>`Restyled ${s}`};var Ji={pathNodeCount:s=>`There are ${s} visible path objects.`,textNodeCount:s=>`There are ${s} visible text nodes.`,imageNodeCount:s=>`There are ${s} visible image nodes.`,textNode:s=>`Text: ${s}`,imageNode:s=>`Image: ${s}`,unlabeledImageNode:"Unlabeled image",rerenderAsText:"Re-render as text"};var er={help:"Help",helpHidden:"Help hidden",next:"Next",previous:"Previous",close:"Close",helpScreenNavigationHelp:"Click on a control for more information.",helpControlsAccessibilityLabel:"Controls: Activate a control to show help."};var tr={...er,pen:"Pen",eraser:"Eraser",select:"Select",handTool:"Pan",zoom:"Zoom",image:"Image",reformatSelection:"Format selection",inputAltText:"Alt text",decreaseImageSize:"Decrease size",resetImage:"Reset",chooseFile:"Choose file",dragAndDropHereOrBrowse:`Drag and drop here
or
{{browse}}`,submit:"Submit",addAll:"Add all",cancel:"Cancel",resetView:"Reset view",thicknessLabel:"Thickness",colorLabel:"Color",fontLabel:"Font",textSize:"Size",resizeImageToSelection:"Resize image to selection",deleteSelection:"Delete selection",duplicateSelection:"Duplicate selection",exit:"Exit",save:"Save",undo:"Undo",redo:"Redo",fullStrokeEraser:"Full stroke eraser",selectPenType:"Pen type",selectShape:"Shape",pickColorFromScreen:"Pick color from screen",clickToPickColorAnnouncement:"Click on the screen to pick a color",colorSelectionCanceledAnnouncement:"Color selection canceled",selectionTool__lassoSelect:"Freeform selection",selectionTool__lassoSelect__help:"When enabled, dragging creates a freeform (lasso) selection.",selectionToolKeyboardShortcuts:"Selection tool: Use arrow keys to move selected items, lowercase/uppercase \u2018i\u2019 and \u2018o\u2019 to resize.",documentProperties:"Page",backgroundColor:"Background color",imageWidthOption:"Width",imageHeightOption:"Height",useGridOption:"Grid",enableAutoresizeOption:"Auto-resize",toggleOverflow:"More",about:"About",inputStabilization:"Stabilization",strokeAutocorrect:"Autocorrect",touchPanning:"Scroll with touch",roundedTipPen:"Round",roundedTipPen2:"Polyline",flatTipPen:"Flat",arrowPen:"Arrow",linePen:"Line",outlinedRectanglePen:"Outlined rectangle",filledRectanglePen:"Filled rectangle",outlinedCirclePen:"Outlined circle",lockRotation:"Lock rotation",paste:"Paste",errorImageHasZeroSize:"Error: Image has zero size",describeTheImage:"Image description",fileInput__loading:"Loading...",fileInput__andNMoreFiles:s=>`(...${s} more)`,penDropdown__baseHelpText:"This tool draws shapes or freehand lines.",penDropdown__colorHelpText:"Changes the pen's color",penDropdown__thicknessHelpText:"Changes the thickness of strokes drawn by the pen.",penDropdown__penTypeHelpText:`Changes the pen style.

Either a \u201Cpen\u201D style or \u201Cshape\u201D can be chosen. Choosing a \u201Cpen\u201D style draws freehand lines. Choosing a \u201Cshape\u201D draws shapes.`,penDropdown__autocorrectHelpText:`Converts approximate freehand lines and rectangles to perfect ones.

The pen must be held stationary at the end of a stroke to trigger a correction.`,penDropdown__stabilizationHelpText:`Draws smoother strokes.

This also adds a short delay between the mouse/stylus and the stroke.`,handDropdown__baseHelpText:"This tool is responsible for scrolling, rotating, and zooming the editor.",handDropdown__zoomInHelpText:"Zooms in.",handDropdown__zoomOutHelpText:"Zooms out.",handDropdown__resetViewHelpText:"Resets the zoom level to 100% and resets scroll.",handDropdown__zoomDisplayHelpText:"Shows the current zoom level. 100% shows the image at its actual size.",handDropdown__touchPanningHelpText:"When enabled, touchscreen gestures move the image rather than select or draw.",handDropdown__lockRotationHelpText:"When enabled, prevents touch gestures from rotating the screen.",eraserDropdown__baseHelpText:"This tool removes strokes, images, and text under the cursor.",eraserDropdown__thicknessHelpText:"Changes the size of the eraser.",eraserDropdown__fullStrokeEraserHelpText:`When in full-stroke mode, entire shapes are erased.

When not in full-stroke mode, shapes can be partially erased.`,selectionDropdown__baseHelpText:"Selects content and manipulates the selection",selectionDropdown__resizeToHelpText:`Crops the drawing to the size of what's currently selected.

If auto-resize is enabled, it will be disabled.`,selectionDropdown__deleteHelpText:"Erases selected items.",selectionDropdown__duplicateHelpText:"Makes a copy of selected items.",selectionDropdown__changeColorHelpText:"Changes the color of selected items.",pageDropdown__baseHelpText:"Controls the drawing canvas' background color, pattern, and size.",pageDropdown__backgroundColorHelpText:"Changes the background color of the drawing canvas.",pageDropdown__gridCheckboxHelpText:"Enables/disables a background grid pattern.",pageDropdown__autoresizeCheckboxHelpText:`When checked, the page grows to fit the drawing.

When unchecked, the page is visible and its size can be set manually.`,pageDropdown__aboutButtonHelpText:"Shows version, debug, and other information.",colorPickerPipetteHelpText:"Picks a color from the screen.",colorPickerToggleHelpText:"Opens/closes the color picker.",closeSidebar:s=>`Close sidebar for ${s}`,dropdownShown:s=>`Menu for ${s} shown`,dropdownHidden:s=>`Menu for ${s} hidden`,zoomLevel:s=>`Zoom: ${s}%`,colorChangedAnnouncement:s=>`Color changed to ${s}`,imageSize:(s,o)=>`Image size: ${s} ${o}`,imageLoadError:s=>`Error loading image: ${s}`};var or={penTool:s=>`Pen ${s}`,selectionTool:"Selection",selectAllTool:"Select all shortcut",eraserTool:"Eraser",touchPanTool:"Touch panning",twoFingerPanZoomTool:"Panning and zooming",undoRedoTool:"Undo/Redo",rightClickDragPanTool:"Right-click drag",pipetteTool:"Pick color from screen",keyboardPanZoom:"Keyboard pan/zoom shortcuts",selectionMenu__show:"Show selection menu",selectionMenu__copyToClipboard:"Copy to clipboard",selectionMenu__duplicate:"Duplicate",selectionMenu__delete:"Delete",selectionMenu__paste:"Paste",copyPasteError__heading:"Copy/paste",copyPasteError__description:"Something went wrong \u2014 this tool may not have clipboard access.",copyPasteError__errorDetails:"Show error",copyPasteError__pasteRetry:"To retry, please paste into the input box below:",copyPasteError__copyRetry:"To retry, please copy the text in the input box below:",copyPasteError__copyMe:"Copy me!",autocorrectedTo:s=>`Autocorrected to ${s}`,autocorrectionCanceled:"Autocorrect cancelled",textTool:"Text",enterTextToInsert:"Text to insert",changeTool:"Change tool",pasteHandler:"Copy paste handler",soundExplorer:"Sound-based image exploration",disableAccessibilityExploreTool:"Disable sound-based exploration",enableAccessibilityExploreTool:"Enable sound-based exploration",soundExplorerUsageAnnouncement:"Sound-based image exploration enabled: Click/drag the screen to play a sound representation of different parts of the image.",findLabel:"Find",toNextMatch:"Next",closeDialog:"Close",findDialogShown:"Find dialog shown",findDialogHidden:"Find dialog hidden",focusedFoundText:(s,o)=>`Viewing match ${s} of ${o}`,anyDevicePanning:"Any device panning",copied:s=>`Copied ${s} item(s)`,pasted:s=>`Pasted ${s} item(s)`,toolEnabledAnnouncement:s=>`${s} enabled`,toolDisabledAnnouncement:s=>`${s} disabled`};var lt={...tr,...or,...Xi,...Qi,...Ji,accessibilityInputInstructions:['Press "t" to read the contents of the viewport as text.',"Use the arrow keys to move the viewport, click and drag to draw strokes.",'Press "w" to zoom in and "s" to zoom out.'].join(" "),loading:s=>`Loading ${s}%...`,imageEditor:"Image Editor",doneLoading:"Done loading",undoAnnouncement:s=>`Undid ${s}`,redoAnnouncement:s=>`Redid ${s}`,softwareLibraries:"Libraries",developerInformation:"Developer information"};var Xu={...lt,pen:"Stift",eraser:"Radierer",select:"Auswahl",handTool:"Verschieben",zoom:"Vergr\xF6\xDFerung",image:"Bild",inputAltText:"Alt-Text: ",chooseFile:"W\xE4hle Datei: ",submit:"Absenden",cancel:"Abbrechen",resetView:"Ansicht zur\xFCcksetzen",thicknessLabel:"Dicke: ",colorLabel:"Farbe: ",fontLabel:"Schriftart: ",textSize:"Gr\xF6\xDFe: ",resizeImageToSelection:"Bildgr\xF6\xDFe an Auswahl anpassen",deleteSelection:"Auswahl l\xF6schen",duplicateSelection:"Auswahl duplizieren",undo:"R\xFCckg\xE4ngig",redo:"Wiederholen",pickColorFromScreen:"Farbe von Bildschirm ausw\xE4hlen",clickToPickColorAnnouncement:"Klicke auf den Bildschirm, um eine Farbe auszuw\xE4hlen",selectionToolKeyboardShortcuts:"Auswahl-Werkzeug: Verwende die Pfeiltasten, um ausgew\xE4hlte Elemente zu verschieben und \u201Ai\u2018 und \u201Ao\u2018, um ihre Gr\xF6\xDFe zu \xE4ndern.",touchPanning:"Ansicht mit Touchscreen verschieben",anyDevicePanning:"Ansicht mit jedem Eingabeger\xE4t verschieben",selectPenType:"Objekt-Typ: ",roundedTipPen:"Freihand",flatTipPen:"Stift (druckempfindlich)",arrowPen:"Pfeil",linePen:"Linie",outlinedRectanglePen:"Umrissenes Rechteck",filledRectanglePen:"Ausgef\xFClltes Rechteck",lockRotation:"Sperre Rotation",paste:"Einf\xFCgen",dropdownShown:s=>`Dropdown-Men\xFC f\xFCr ${s} angezeigt`,dropdownHidden:s=>`Dropdown-Men\xFC f\xFCr ${s} versteckt`,zoomLevel:s=>`Verg\xF6\xDFerung: ${s}%`,colorChangedAnnouncement:s=>`Farbe zu ${s} ge\xE4ndert`,imageSize:(s,o)=>`Bild-Gr\xF6\xDFe: ${s} ${o}`,imageLoadError:s=>`Fehler beim Laden des Bildes: ${s}`,errorImageHasZeroSize:"Fehler: Bild hat Gr\xF6\xDFe Null",penTool:s=>`Stift ${s}`,selectionTool:"Auswahl",eraserTool:"Radiergummi",touchPanTool:"Ansicht mit Touchscreen verschieben",twoFingerPanZoomTool:"Ansicht verschieben und vergr\xF6\xDFern",undoRedoTool:"R\xFCckg\xE4ngig/Wiederholen",rightClickDragPanTool:"Rechtsklick-Ziehen",pipetteTool:"Farbe von Bildschirm ausw\xE4hlen",keyboardPanZoom:"Tastaturk\xFCrzel zum Verschieben/Vergr\xF6\xDFern der Ansicht",textTool:"Text",enterTextToInsert:"Einzuf\xFCgender Text",changeTool:"Wechsle Werkzeug",pasteHandler:"Copy-Paste-Handler",findLabel:"Finde",toNextMatch:"N\xE4chstes",closeDialog:"Schlie\xDFen",findDialogShown:"Finde-Dialog angezeigt",findDialogHidden:"Finde-Dialog versteckt",focusedFoundText:(s,o)=>`Sieh Treffer ${s} von ${o} an`,toolEnabledAnnouncement:s=>`${s} aktiviert`,toolDisabledAnnouncement:s=>`${s} deaktiviert`,updatedViewport:"Transformierte Ansicht",transformedElements:(s,o)=>`${s} Element${s===1?"":"e"} transformiert (${o})`,resizeOutputCommand:s=>`Bildgr\xF6\xDFe auf ${s.w}x${s.h} ge\xE4ndert`,addComponentAction:s=>`${s} hinzugef\xFCgt`,eraseAction:(s,o)=>`${o} ${s} gel\xF6scht`,duplicateAction:(s,o)=>`${o} ${s} dupliziert`,inverseOf:s=>`${s} umgekehrt`,elements:"Elemente",erasedNoElements:"Nichts entfernt",duplicatedNoElements:"Nichts dupliziert",rotatedBy:s=>`${Math.abs(s)} Grad ${s<0?"im Uhrzeigersinn":"gegen den Uhrzeigersinn"} gedreht`,movedLeft:"Nacht links bewegt",movedUp:"Nacht oben bewegt",movedDown:"Nacht unten bewegt",movedRight:"Nacht rechts bewegt",zoomedOut:"Ansicht verkleinert",zoomedIn:"Ansicht vergr\xF6\xDFert",selectedElements:s=>`${s} Element${s===1?"":"e"} ausgew\xE4hlt`,stroke:"Strich",svgObject:"SVG-Objekt",text:s=>`Text-Objekt: ${s}`,pathNodeCount:s=>`Es gibt ${s} sichtbare Pfad-Objekte.`,textNodeCount:s=>`Es gibt ${s} sichtbare Text-Knotenpunkte.`,textNode:s=>`Text: ${s}`,imageNodeCount:s=>`Es gibt ${s} sichtbare Bild-Knoten.`,imageNode:s=>`Bild: ${s}`,unlabeledImageNode:"Bild ohne Label",rerenderAsText:"Als Text darstellen",accessibilityInputInstructions:"Dr\xFCcke \u201At\u2018, um den Inhalt des Ansichtsfensters als Text zu lesen. Verwende die Pfeiltasten, um die Ansicht zu verschieben, und klicke und ziehe, um Striche zu zeichnen. Dr\xFCcke \u201Aw\u2018 zum Vergr\xF6\xDFern und \u201As\u2018 zum Verkleinern der Ansicht.",loading:s=>`Laden ${s}%...`,doneLoading:"Laden fertig",imageEditor:"Bild-Editor",undoAnnouncement:s=>`${s} r\xFCckg\xE4ngig gemacht`,redoAnnouncement:s=>`${s} wiederholt`,reformatSelection:"Formatiere Auswahl",documentProperties:"Seite",backgroundColor:"Hintergrundfarbe: ",imageWidthOption:"Breite: ",imageHeightOption:"H\xF6he: ",useGridOption:"Gitter: ",toggleOverflow:"Mehr",selectAllTool:"Alle ausw\xE4hlen",soundExplorer:"Klangbasierte Bilderkundung",disableAccessibilityExploreTool:"Deaktiviere klangbasierte Erkundung",enableAccessibilityExploreTool:"Aktiviere klangbasierte Erkundung",unionOf:(s,o)=>`Vereinigung: ${o} ${s}`,emptyBackground:"Leerer Hintergrund",filledBackgroundWithColor:s=>`Gef\xFCllter Hintergrund (${s})`,restyledElement:s=>`${s} umgestaltet`};var tp={...lt};var rp={...lt,pen:"Lapiz",eraser:"Borrador",select:"Selecciona",handTool:"Mover",image:"Imagen",inputAltText:"Texto alternativo",resetImage:"Reiniciar",chooseFile:"Seleccionar archivo",cancel:"Cancelar",resetView:"Reiniciar vista",thicknessLabel:"Tama\xF1o",fontLabel:"Fuente:",textSize:"Tama\xF1o",resizeImageToSelection:"Redimensionar la imagen a lo que est\xE1 seleccionado",deleteSelection:"Borra la selecci\xF3n",duplicateSelection:"Duplica la selecci\xF3n",exit:"Salir",save:"Guardar",undo:"Deshace",redo:"Rehace",selectPenType:"Punta",selectShape:"Forma",pickColorFromScreen:"Selecciona un color de la pantalla",clickToPickColorAnnouncement:"Haga un clic en la pantalla para seleccionar un color",documentProperties:"Fondo",backgroundColor:"Color de fondo",imageWidthOption:"Ancho",imageHeightOption:"Alto",enableAutoresizeOption:"Redimensionar autom\xE1tico",toggleOverflow:"M\xE1s",about:"Acerca de",touchPanning:"Mover la pantalla con un dedo",roundedTipPen:"Lapiz Redondeado",arrowPen:"Flecha",linePen:"L\xEDnea",outlinedRectanglePen:"Rect\xE1ngulo delineado",filledRectanglePen:"Rect\xE1ngulo sin borde",lockRotation:"Bloquea rotaci\xF3n",paste:"Pegar",selectionMenu__paste:"Pegar",selectionMenu__delete:"Eliminar",selectionMenu__duplicate:"Duplicar",closeSidebar:s=>`Close sidebar for ${s}`,dropdownShown:s=>`Men\xFA por ${s} es visible`,dropdownHidden:s=>`Men\xFA por ${s} fue ocultado`,zoomLevel:s=>`Zoom: ${s}%`,colorChangedAnnouncement:s=>`Color fue cambiado a ${s}`,imageSize:(s,o)=>`Tama\xF1o del imagen: ${s} ${o}`,imageLoadError:s=>`Error cargando imagen: ${s}`,penTool:s=>`Lapiz ${s}`,selectionTool:"Selecciona",eraserTool:"Borrador",touchPanTool:"Instrumento de mover la pantalla con un dedo",undoRedoTool:"Deshace/rehace",pipetteTool:"Seleccione un color de la pantalla",keyboardPanZoom:"Mover la pantalla con el teclado",textTool:"Texto",enterTextToInsert:"Entra texto",findLabel:"Buscar",toNextMatch:"Pr\xF3xima",closeDialog:"Cerrar",anyDevicePanning:"Mover la pantalla con todo dispotivo",copied:s=>`${s} cosas fueron copiados`,pasted:s=>s===1?"Pegado":`${s} cosas fueron pegados`,toolEnabledAnnouncement:s=>`${s} fue activado`,toolDisabledAnnouncement:s=>`${s} fue desactivado`,resizeOutputCommand:s=>`Tama\xF1o de imagen fue cambiado a ${s.w}x${s.h}`,eraseAction:(s,o)=>`Borrado: ${o} ${s}`,rerenderAsText:"Redibuja la pantalla al texto",loading:s=>`Cargando: ${s}%...`,imageEditor:"Editor de dibujos",doneLoading:"El cargado termin\xF3",undoAnnouncement:s=>`${s} fue deshecho`,redoAnnouncement:s=>`${s} fue rehecho`};var _s=s=>{let o=/^(\w+)[_-](\w+)$/.exec(s);return o?o[1]:s},zn=(s,o,e)=>{let n;for(let i of s){let r=_s(i);if(n&&r!==n&&n in o)return o[n];if(i in o)return o[i];n=r}return n&&n in o?o[n]:e};var nr=s=>s.toUpperCase()===s&&s.toLowerCase()!==s&&s.length===1,ir=s=>s.toLowerCase()===s&&s.toUpperCase()!==s&&s.length===1,Et=class s{constructor(o){this.key=o.key,this.shiftKey=o.shiftKey,this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.metaKey=o.metaKey,this.controlOrMeta=o.controlOrMeta}matchesEvent(o){let e=o.key?.toLowerCase(),n=nr(o.key??""),i=ir(o.key??""),r=(o.ctrlKey??!1)||e==="control",a=(o.altKey??!1)||e==="alt",l=(o.metaKey??!1)||e==="meta",c=(o.shiftKey??n)||e==="shift",d=o.controlOrMeta||o.ctrlKey||o.metaKey||!1;if(this.key!==o.code&&(this.key.toLowerCase()!==e||(n||i)&&this.key!==o.key&&!(this.shiftKey===!0&&this.key.toUpperCase()===o.key)))return!1;let p=this.controlOrMeta;return(r===this.ctrlKey&&l===this.metaKey&&!p||p&&d)&&a===this.altKey&&(c===this.shiftKey||this.shiftKey===void 0)}toString(){let o=[];return this.ctrlKey&&this.key!=="control"&&o.push("Ctrl"),this.controlOrMeta&&o.push("CtrlOrMeta"),this.altKey&&this.key!=="alt"&&o.push("Alt"),this.metaKey&&this.key!=="meta"&&o.push("Meta"),this.shiftKey&&this.key!=="shift"&&o.push("Shift"),o.push(this.key),o.join("+")}static fromString(o){let e=x=>{let g;nr(x)?g=!0:(ir(x)||x.length>1)&&(g=!1);let y=x.toLowerCase();return y==="shift"&&(g=!0),{shiftKey:g,ctrlKey:y==="control"||y==="ctrl",altKey:y==="alt",metaKey:y==="meta",controlOrMeta:y==="control or meta"||y==="ctrlormeta"}};if(o.search(/[-+]/)===-1||o.length===1){let x=e(o);return new s({key:o,...x})}let r=/^(.*[-+])?(.+)$/g.exec(o);if(!r)throw new Error(`Invalid shortcut expression, ${o}!`);let a=r[2],l=e(a),c=(r[1]??"").split(/[-+]/),d=l.shiftKey,p=l.ctrlKey,u=l.altKey,h=l.metaKey,f=l.controlOrMeta;for(let x of c)if(x!=="")switch(x.toLowerCase()){case"shift":d=!0;break;case"anyshift":d=void 0;break;case"ctrl":case"control":p=!0;break;case"meta":h=!0;break;case"ctrlormeta":case"ctrl or meta":case"controlormeta":f=!0;break;case"alt":u=!0;break;default:throw new Error(`Unknown modifier: "${x}" in shortcut ${o}.`)}return new s({key:a,shiftKey:d,ctrlKey:p,altKey:u,metaKey:h,controlOrMeta:f})}};var F=class s{constructor(o){this.shortcutOverrides=Object.create(null);for(let e in o)this.overrideShortcut(e,o[e])}static{this.shortcuts=Object.create(null)}static{this.shortcutDefaultDescriptions=Object.create(null)}static{this.shortcutLocalizedDescriptions=Object.create(null)}overrideShortcut(o,e){this.shortcutOverrides[o]=[...e]}matchesShortcut(o,e){let n=this.shortcutOverrides[o];if(!n)if(o in s.shortcuts)n=s.shortcuts[o];else throw new Error(`No shortcut with ID ${o} exists!`);for(let i of n)if(i.matchesEvent(e))return!0;return!1}static registerDefaultKeyboardShortcut(o,e,n){if(o in s.shortcuts)return!1;let i=e.map(r=>typeof r=="string"?Et.fromString(r):r);return s.shortcuts[o]=[...i],s.shortcutDefaultDescriptions[o]=n,!0}static provideShortcutDescription(o,e,n){e in s.shortcutLocalizedDescriptions||(s.shortcutLocalizedDescriptions[e]=Object.create(null)),s.shortcutLocalizedDescriptions[e][o]=n}static getAllShortcutIds(){let o=[];for(let e in this.shortcuts)o.push(e);return o}static getShortcutDefaultKeybindings(o){if(!(o in s.shortcuts))throw new Error(`No shortcut with ID ${o} exists!`);return s.shortcuts[o]}static getShortcutDescription(o,e){return zn(e??[],this.shortcutLocalizedDescriptions,this.shortcutDefaultDescriptions)[o]??this.shortcutDefaultDescriptions[o]??null}};var Xt="jsdraw.tools.SelectionTool.selectAll";F.registerDefaultKeyboardShortcut(Xt,["CtrlOrMeta+KeyA"],"Select all");var Fo="jsdraw.tools.SelectionTool.duplicateSelection";F.registerDefaultKeyboardShortcut(Fo,["CtrlOrMeta+KeyD"],"Duplicate selection");var Ho="jsdraw.tools.SelectionTool.sendToBack";F.registerDefaultKeyboardShortcut(Ho,["End"],"Send to back");var Bn="jsdraw.tools.SelectionTool.translateLeft";F.registerDefaultKeyboardShortcut(Bn,["KeyA","KeyH","ArrowLeft"],"Move selection left");var Mn="jsdraw.tools.SelectionTool.translateRight";F.registerDefaultKeyboardShortcut(Mn,["KeyD","KeyL","ArrowRight"],"Move selection right");var Dn="jsdraw.tools.SelectionTool.translateUp";F.registerDefaultKeyboardShortcut(Dn,["KeyQ","KeyK","ArrowUp"],"Move selection up");var An="jsdraw.tools.SelectionTool.translateDown";F.registerDefaultKeyboardShortcut(An,["KeyE","KeyJ","ArrowDown"],"Move selection down");var Vn="jsdraw.tools.SelectionTool.rotateCCW";F.registerDefaultKeyboardShortcut(Vn,["Shift+KeyR"],"Rotate selection counter clockwise");var On="jsdraw.tools.SelectionTool.rotateCW";F.registerDefaultKeyboardShortcut(On,["KeyR"],"Rotate selection clockwise");var Fn="jsdraw.tools.SelectionTool.shrink.x";F.registerDefaultKeyboardShortcut(Fn,["KeyI"],"Decrease width");var Hn="jsdraw.tools.SelectionTool.stretch.x";F.registerDefaultKeyboardShortcut(Hn,["Shift+KeyI"],"Increase width");var Nn="jsdraw.tools.SelectionTool.shrink.y";F.registerDefaultKeyboardShortcut(Nn,["KeyO"],"Decrease height");var Wn="jsdraw.tools.SelectionTool.stretch.y";F.registerDefaultKeyboardShortcut(Wn,["Shift+KeyO"],"Increase height");var Un="jsdraw.tools.SelectionTool.shrink.xy";F.registerDefaultKeyboardShortcut(Un,["Comma"],"Decrease selection size");var $n="jsdraw.tools.SelectionTool.stretch.xy";F.registerDefaultKeyboardShortcut($n,["Period"],"Increase selection size");var No="jsdraw.tools.undo",rr="jsdaw.tools.redo";F.registerDefaultKeyboardShortcut(No,["CtrlOrMeta+KeyZ"],"Undo");F.registerDefaultKeyboardShortcut(rr,["CtrlOrMeta+Shift+KeyZ","CtrlOrMeta+KeyY"],"Redo");var Qt="jsdraw.tools.increaseSize";F.registerDefaultKeyboardShortcut(Qt,["Equal","Shift+Equal"],"Increase pen/eraser size");var Jt="jsdraw.tools.decreaseSize";F.registerDefaultKeyboardShortcut(Jt,["Minus","Shift+Minus"],"Decrease pen/eraser size");var eo="jsdraw.tools.snapToGrid";F.registerDefaultKeyboardShortcut(eo,["Control","Meta"],"Snap to grid (press and hold)");var sr="jsdraw.tools.lockToLine";F.registerDefaultKeyboardShortcut(sr,["Shift"],"Snap to XY axes (press and hold)");var ar="js-draw.tools.FindTool.toggleVisible";F.registerDefaultKeyboardShortcut(ar,["CtrlOrMeta+KeyF"],"Shows/hides the find tool");var qn="jsdraw.tools.PanZoom.moveLeft";F.registerDefaultKeyboardShortcut(qn,["ArrowLeft","KeyH","KeyA"],"Pan left");var Kn="jsdraw.tools.PanZoom.moveRight";F.registerDefaultKeyboardShortcut(Kn,["ArrowRight","KeyL","KeyD"],"Pan right");var Gn="jsdraw.tools.PanZoom.moveUp";F.registerDefaultKeyboardShortcut(Gn,["ArrowUp","KeyK","KeyQ"],"Pan up");var Zn="jsdraw.tools.PanZoom.moveDown";F.registerDefaultKeyboardShortcut(Zn,["ArrowDown","KeyJ","KeyE"],"Pan down");var _n="jsdraw.tools.PanZoom.rotateViewClockwise";F.registerDefaultKeyboardShortcut(_n,["Shift+KeyR"],"Rotate viewport clockwise");var jn="jsdraw.tools.PanZoom.rotateViewCounterClockwise";F.registerDefaultKeyboardShortcut(jn,["KeyR"],"Rotate viewport counter-clockwise");var Yn="jsdraw.tools.PanZoom.zoomIn";F.registerDefaultKeyboardShortcut(Yn,["KeyW"],"Zoom in");var Xn="jsdraw.tools.PanZoom.zoomOut";F.registerDefaultKeyboardShortcut(Xn,["KeyS"],"Zoom out");var Qn=class{constructor(o,e,n){this.initialVelocity=o;this.scrollBy=e;this.onComplete=n;this.running=!1;this.start()}async start(){if(this.running)return;this.currentVelocity=this.initialVelocity;let o=performance.now();this.running=!0;let e=5e3,n=200;for(this.currentVelocity.magnitude()>e&&(this.currentVelocity=this.currentVelocity.normalized().times(e));this.running&&this.currentVelocity.magnitude()>n;){let i=performance.now(),r=(i-o)/1e3;this.currentVelocity=this.currentVelocity.times(Math.pow(1/8,r)),this.scrollBy(this.currentVelocity.times(r)),await at(),o=i}this.running&&this.stop()}getCurrentVelocity(){return this.running?this.currentVelocity:null}stop(){this.running&&(this.running=!1,this.onComplete())}},De=class extends K{constructor(e,n,i){super(e.notifier,i);this.editor=e;this.mode=n;this.transform=null;this.initialRotationSnapAngle=.22;this.afterRotationStartSnapAngle=.07;this.pinchZoomStartThreshold=1.08;this.lastPointerDownTimestamp=0;this.initialTouchAngle=0;this.initialViewportRotation=0;this.initialViewportScale=0;this.isScaling=!1;this.isRotating=!1;this.inertialScroller=null;this.velocity=null}canReceiveInputInReadOnlyEditor(){return!0}computePinchData(e,n){if(e.id<n.id){let d=e;e=n,n=d}let i=n.screenPos.minus(e.screenPos),r=i.angle(),a=i.magnitude(),l=n.canvasPos.plus(e.canvasPos).times(.5),c=n.screenPos.plus(e.screenPos).times(.5);return{canvasCenter:l,screenCenter:c,angle:r,dist:a}}allPointersAreOfType(e,n){return e.every(i=>i.device===n)}onPointerDown({allPointers:e,current:n}){let i=!1,r=this.inertialScroller?.getCurrentVelocity()??S.zero;this.inertialScroller?.stop(),this.velocity=r,this.lastPointerDownTimestamp=n.timeStamp;let a=this.allPointersAreOfType(e,2),l=this.allPointersAreOfType(e,4);if(a&&e.length===2&&this.mode&2){let{screenCenter:c,angle:d,dist:p}=this.computePinchData(e[0],e[1]);this.lastTouchDist=p,this.startTouchDist=p,this.lastScreenCenter=c,this.initialTouchAngle=d,this.initialViewportRotation=this.editor.viewport.getRotationAngle(),this.initialViewportScale=this.editor.viewport.getScaleFactor(),this.isScaling=!1,this.isRotating=Math.abs(Math.sin(this.initialViewportRotation*2))>.001,i=!0}else e.length===1&&(this.mode&1&&a||l&&this.mode&4||this.mode&8)&&(this.lastScreenCenter=e[0].screenPos,this.isScaling=!1,i=!0);return i&&(this.lastTimestamp=performance.now(),this.transform??=xe.transformBy(I.identity),this.editor.display.setDraftMode(!0)),i}updateVelocity(e){let n=e.minus(this.lastScreenCenter),i=(performance.now()-this.lastTimestamp)/1e3;if(n.magnitude()===0&&i<.1||i===0)return;i=Math.max(i,.01);let r=n.times(1/i),a=r;this.velocity&&(a=this.velocity.lerp(r,.5)),this.velocity=a}getCenterDelta(e){return this.editor.viewport.screenToCanvasTransform.transformVec3(e.minus(this.lastScreenCenter))}toSnappedRotationDelta(e){let i=e-this.initialTouchAngle+this.initialViewportRotation,r=Math.PI/2,a=Math.round(i/r)*r,l=this.isRotating?this.afterRotationStartSnapAngle:this.initialRotationSnapAngle;return Math.abs(i-a)<l&&(i=a,i!==0&&(i+=1e-4)),i-this.editor.viewport.getRotationAngle()}toSnappedScaleFactor(e){let n=this.initialViewportScale*e/this.startTouchDist,i=this.editor.viewport.getScaleFactor(),r=Math.log(n)/Math.log(10),a=Math.round(r);return Math.abs(a-r)<.04?Math.pow(10,a)/i:e/this.lastTouchDist}handleTwoFingerMove(e){let{screenCenter:n,canvasCenter:i,angle:r,dist:a}=this.computePinchData(e[0],e[1]),l=this.getCenterDelta(n),c;if(this.isRotationLocked()?c=0:c=this.toSnappedRotationDelta(r),Math.abs(c)>1e-8&&(this.isRotating=!0),this.updateVelocity(n),!this.isScaling){let u=a/this.startTouchDist,h=this.pinchZoomStartThreshold,f=1/this.pinchZoomStartThreshold;(u>h||u<f)&&(this.isScaling=!0)}let d=1;this.isScaling&&(d=this.toSnappedScaleFactor(a),this.lastTouchDist=a);let p=I.translation(l).rightMul(I.scaling2D(d,i)).rightMul(I.zRotation(c,i));return this.lastScreenCenter=n,this.transform=xe.transformBy(this.transform.transform.rightMul(p)),p}handleOneFingerMove(e){let n=this.getCenterDelta(e.screenPos),i=I.translation(n);return this.transform=xe.transformBy(this.transform.transform.rightMul(i)),this.updateVelocity(e.screenPos),this.lastScreenCenter=e.screenPos,i}onPointerMove({allPointers:e}){this.transform??=xe.transformBy(I.identity);let n=I.identity;e.length===2?n=this.handleTwoFingerMove(e):e.length===1&&(n=this.handleOneFingerMove(e[0])),xe.transformBy(n).apply(this.editor),this.lastTimestamp=performance.now()}onPointerUp(e){let n=()=>{this.transform&&(this.transform.unapply(this.editor),this.editor.dispatch(this.transform,!1)),this.editor.display.setDraftMode(!1),this.transform=null,this.velocity=S.zero};if(e.current.device===2&&e.allPointers.length===1&&this.velocity!==null&&e.current.timeStamp-this.lastPointerDownTimestamp>30&&this.velocity!==null){let a=this.velocity;this.updateVelocity(e.current.screenPos),a.magnitude()<this.velocity.magnitude()&&(this.velocity=a),this.inertialScroller?.stop(),this.inertialScroller=new Qn(this.velocity,l=>{if(!this.transform)return;let c=this.editor.viewport.screenToCanvasTransform.transformVec3(l);this.transform.unapply(this.editor),this.transform=xe.transformBy(this.transform.transform.rightMul(I.translation(c))),this.transform.apply(this.editor)},n)}else n()}onGestureCancel(){this.inertialScroller?.stop(),this.velocity=S.zero,this.transform?.unapply(this.editor),this.editor.display.setDraftMode(!1),this.transform=null}updateTransform(e,n=!1){let i=e;this.transform&&(i=this.transform.transform.rightMul(e)),this.transform?.unapply(this.editor),this.transform=xe.transformBy(i),this.transform.apply(this.editor),n&&this.editor.announceForAccessibility(this.transform.description(this.editor,this.editor.localization))}applyAndFinalizeTransform(e){this.updateTransform(e,!0),this.transform=null}onWheel({delta:e,screenPos:n}){this.inertialScroller?.stop(),this.transform=xe.transformBy(I.identity);let i=this.editor.viewport.screenToCanvas(n),a=this.editor.viewport.screenToCanvasTransform.transformVec3(N.of(-e.x,-e.y,0)),l=e.z;l=Math.atan(l/2)*2;let d=I.scaling2D(Math.max(.4,Math.min(Math.pow(1.04,-l),4)),i).rightMul(I.translation(a));return this.applyAndFinalizeTransform(d),!0}onKeyPress(e){if(this.inertialScroller?.stop(),!(this.mode&16))return!1;this.transform=xe.transformBy(I.identity);let n=S.zero,i=1,r=0,a=this.editor.shortcuts;if(a.matchesShortcut(qn,e))n=S.of(-1,0);else if(a.matchesShortcut(Kn,e))n=S.of(1,0);else if(a.matchesShortcut(Gn,e))n=S.of(0,-1);else if(a.matchesShortcut(Zn,e))n=S.of(0,1);else if(a.matchesShortcut(Yn,e))i=1/2;else if(a.matchesShortcut(Xn,e))i=2;else if(a.matchesShortcut(_n,e))r=1;else if(a.matchesShortcut(jn,e))r=-1;else return!1;n=n.times(30),r*=Math.PI/8,n=n.times(-1),r=r*-1,i=1/i,r!==0&&(r+=1e-4),this.isRotationLocked()&&(r=0),n=this.editor.viewport.screenToCanvasTransform.transformVec3(n);let c=this.editor.viewport.visibleRect.center,d=I.scaling2D(i,c).rightMul(I.zRotation(r,c)).rightMul(I.translation(n));return this.applyAndFinalizeTransform(d),!0}isRotationLocked(){return!!(this.mode&32)}setModeEnabled(e,n){let i=this.mode;n?i|=e:i&=~e,this.setMode(i)}setMode(e){e!==this.mode&&(this.mode=e,this.editor.notifier.dispatch(2,{kind:2,tool:this}))}getMode(){return this.mode}};var lr=s=>({fill:s.fill,stroke:s.stroke?{...s.stroke}:void 0}),Wo=(s,o)=>(s===o||s.fill.eq(o.fill)&&s.stroke==null==(o.stroke==null)&&(s.stroke?.color?.eq(o.stroke?.color)??!0)&&s.stroke?.width===o.stroke?.width)??!1,Uo=s=>{let o=s.stroke?{color:s.stroke.color.toHexString(),width:s.stroke.width}:void 0;return{fill:s.fill.toHexString(),stroke:o}},$o=s=>{let o=s.stroke?{color:M.fromHex(s.stroke.color),width:s.stroke.width}:void 0;return{fill:M.fromHex(s.fill),stroke:o}};var Jn=s=>({...s,renderingStyle:lr(s.renderingStyle)}),qo=s=>{if(typeof s=="string"&&(s=JSON.parse(s)),typeof s.fontFamily!="string")throw new Error("Serialized textStyle missing string fontFamily attribute!");return{renderingStyle:$o(s.renderingStyle),size:s.size,fontWeight:s.fontWeight,fontVariant:s.fontVariant,fontFamily:s.fontFamily}},Ko=s=>({...s,renderingStyle:Uo(s.renderingStyle)});var cr=s=>{let o={};return s.color&&(o.color=s.color.toHexString()),s.textStyle&&(o.textStyle=Ko(s.textStyle)),o},dr=s=>{let o=s.color?M.fromHex(s.color):void 0,e=s.textStyle?qo(s.textStyle):void 0;return{color:o,textStyle:e}},dt=(s,o,e)=>new ei(s,o,e.getId(),e),Go=s=>!(!("getStyle"in s&&"updateStyle"in s&&"forceStyle"in s)||!("isRestylableComponent"in s)||!s.isRestylableComponent),ur="default-restyle-element",ei=class s extends st{constructor(e,n,i,r){super(ur,i,r);this.originalStyle=e;this.newStyle=n}getComponent(e){this.resolveComponent(e.image);let n=this.component;if(!n||!n.forceStyle||!n.updateStyle)throw new Error("this.component is missing forceStyle and/or updateStyle methods!");return n}apply(e){this.getComponent(e).forceStyle(this.newStyle,e)}unapply(e){this.getComponent(e).forceStyle(this.originalStyle,e)}description(e,n){return n.restyledElement(this.getComponent(e).description(n))}serializeToJSON(){return{id:this.componentID,originalStyle:cr(this.originalStyle),newStyle:cr(this.newStyle)}}static{U.register(ur,(e,n)=>{let i=dr(e.originalStyle),r=dr(e.newStyle),a=e.id;if(typeof e.id!="string")throw new Error(`json.id is of type ${typeof e.id}, not string.`);return new s(i,r,a)})}};var ut=s=>s.path?s.path:new W(s.startPoint,s.commands),G=(s,o)=>({startPoint:s.startPoint,style:o,commands:s.parts,path:s}),js=(s,o)=>s.path?s:{...s,path:o},Zo=(s,o,e={fastCheck:!0,expensiveCheck:!0})=>{let n=ut(s),i=s.style.stroke?.width??0,r=i>0&&s.style.fill.a===0,a=n.bbox.grownBy(i),l=r&&i>o.maxDimension&&a.containsRect(o);if(e.fastCheck&&l&&s.style.stroke){let c=i/2;for(let d of n.startEndPoints())if(o.isWithinRadiusOf(c,d))return{rectangle:o,path:G(W.fromRect(o),{fill:s.style.stroke.color}),fullScreen:!0}}if(e.expensiveCheck&&l&&s.style.stroke&&i>o.maxDimension*3){let c=n.signedDistance(o.center,i/2),d=i/6;if(c<-o.maxDimension/2-d)return{path:G(W.fromRect(o),{fill:s.style.stroke.color}),rectangle:o,fullScreen:!0};if(c>o.maxDimension/2+d)return{path:G(W.empty,{fill:M.transparent}),rectangle:z.empty,fullScreen:!1}}return null},ti=(s,o)=>{let e=ut(s),n=s.style.stroke?.width??0,i=n>0&&s.style.fill.a===0,r=e.bbox.grownBy(n),a=Zo(s,o,{fastCheck:!0,expensiveCheck:!1});if(a)return a.path;if(o.grownBy(n).transformedBoundingBox(I.scaling2D(4,o.center)).containsRect(r))return js(s,e);let c=[],d=e.startPoint;for(let h of e.parts){let f=W.computeBBoxForSegment(d,h).grownBy(n),v;h.kind===0||h.kind===1?v=h.point:v=h.endPoint,f.intersects(o)?c.push(h):i||h.kind===1?c.push({kind:1,point:v}):c.push({kind:0,point:v}),d=v}let p=new W(e.startPoint,c),u=s.style;return a=Zo(s,o,{fastCheck:!1,expensiveCheck:!0}),a?a.path:G(p,u)};var oe=class s extends Z{constructor(e,n){super("stroke",n);this.isRestylableComponent=!0;this.simplifiedPath=null;this.approximateRenderingTime=0,this.parts=[];for(let i of e){let r=ut(i),a=this.bboxForPart(r.bbox,i.style);this.contentBBox?this.contentBBox=this.contentBBox.union(a):this.contentBBox=a,this.parts.push({path:r,startPoint:r.startPoint,style:i.style,commands:r.parts}),this.approximateRenderingTime+=r.parts.length}this.contentBBox??=z.empty}static fromStroked(e,n){return typeof e=="string"&&(e=W.fromString(e)),new s([G(e,{fill:M.transparent,stroke:n})])}static fromFilled(e,n){return typeof e=="string"&&(e=W.fromString(e)),new s([G(e,{fill:n})])}getStyle(){if(this.parts.length===0)return{};let e=this.parts[0];return e.style.stroke===void 0||e.style.stroke.width===0?{color:e.style.fill}:{color:e.style.stroke.color}}updateStyle(e){return dt(this.getStyle(),e,this)}forceStyle(e,n){e.color&&(this.parts=this.parts.map(i=>{let r={...i.style,stroke:i.style.stroke?{...i.style.stroke}:void 0};return r.stroke&&r.stroke.width>0?r.stroke.color=e.color:r.fill=e.color,{path:i.path,startPoint:i.startPoint,commands:i.commands,style:r}}),n&&(n.image.queueRerenderOf(this),n.queueRerender()))}withRegionErased(e,n){let i=e.polylineApproximation(),r=c=>e.closedContainsPoint(c),a=[],l=!1;for(let c of this.parts){let d=c.path,p=g=>{if(c.style.fill.a>0){if(g.parts.length<1||g.parts.length===1&&g.parts[0].kind===0)return null;g=g.asClosed()}return isNaN(g.getExactBBox().area)?(console.warn("Prevented creating a stroke with NaN area"),l=!0,null):new s([G(g,c.style)],this.getZIndex())},u=[];for(let g of i)u.push(...d.intersection(g));let h=!1;if(u.length===0&&c.style.stroke&&c.style.stroke.width>e.bbox.minDimension*.3&&c.style.stroke.width<e.bbox.maxDimension*30){for(let g of i)u.push(...d.intersection(g,c.style.stroke.width/2));h=!0}u.sort(Bo);let v=(()=>{if(u.length===0)return!1;if(h)return u[0].curveIndex===0&&u[0].parameterValue<=0;let g=Sn(u[0],-1e-10);return r(d.at(g))})()?1:0,x=(g,y)=>{let m=p(g),C=v%2===1;v++,y!==void 0&&(C=y),y===void 0&&!C&&e.closedContainsPoint(g.getExactBBox().center)&&(C=!C),m&&(l||=C&&g.getExactBBox().maxDimension>e.getExactBBox().maxDimension*2,C||a.push(m))};if(c.style.fill.a===0){if(!(e.getExactBBox().maxDimension/10>d.getExactBBox().maxDimension)){let y=d.splitAt(u,{mapNewPoint:m=>n.roundPoint(m)});for(let m of y)x(m)}}else if(u.length>=2&&u.length%2===0){let g=d.splitAt(u,{mapNewPoint:y=>n.roundPoint(y)});for(let y=0;y<Math.floor(g.length/2);y++)x(g[y].union(g[g.length-y-1]).asClosed());g.length%2!==0&&x(g[Math.floor(g.length/2)].asClosed())}else x(d,!1)}return l?[this]:a}intersects(e){for(let n of this.parts){let i=n.style.stroke?.width,r=i?i/2:void 0;if(n.path.intersection(e,r).length>0)return!0}return!1}keyPoints(){return this.parts.map(e=>e.startPoint).flat()}intersectsRect(e){if(!e.intersects(this.getBBox()))return!1;for(let n of this.parts){let i=e.grownBy(-(n.style.stroke?.width??0));if(i.area!==0){for(let r of n.path.startEndPoints())if(i.containsPoint(r))return!0}}return super.intersectsRect(e)}computeSimplifiedPathFor(e){let n=[],i=!1,r=!1;for(let a of this.parts){if(r||!a.style.stroke||a.style.stroke.color.a<.99){n.push(a);continue}let l=Zo(a,e);l?(n.push(l.path),l.fullScreen&&(i=!0,r=!0)):n.push(a)}return{forVisibleRect:e,parts:n,occludes:i}}occludesEverythingBelowWhenRenderedInRect(e){return this.getBBox().containsRect(e)?((!this.simplifiedPath||!this.simplifiedPath.forVisibleRect.eq(e))&&(this.simplifiedPath=this.computeSimplifiedPathFor(e)),this.simplifiedPath.occludes):!1}render(e,n){e.startObject(this.getBBox());let i=this.parts;n&&this.simplifiedPath?.forVisibleRect?.containsRect(n)?i=this.simplifiedPath.parts:this.simplifiedPath=null;for(let r of i){let a=this.bboxForPart(r.path.bbox,r.style);n&&(!a.intersects(n)||(a.size.x>n.size.x*3||a.size.y>n.size.y*3)&&!r.path.roughlyIntersects(n,r.style.stroke?.width??0))||e.drawPath(r)}e.endObject(this.getLoadSaveData())}getProportionalRenderingTime(){return this.approximateRenderingTime}bboxForPart(e,n){return n.stroke?e.grownBy(n.stroke.width/2):e}getExactBBox(){let e=null;for(let{path:n,style:i}of this.parts){let r=this.bboxForPart(n.getExactBBox(),i);e??=r,e=e.union(r)}return e??z.empty}applyTransformation(e){this.contentBBox=z.empty;let n=!0;this.parts=this.parts.map(i=>{let r=i.path.transformedBy(e),a={...i.style,stroke:i.style.stroke?{...i.style.stroke}:void 0};if(a.stroke){let c=e.getScaleFactor();a.stroke.width*=c}let l=this.bboxForPart(r.bbox,a);return n?(this.contentBBox=l,n=!1):this.contentBBox=this.contentBBox.union(l),{path:r,startPoint:r.startPoint,commands:r.parts,style:a}})}getParts(){return[...this.parts]}getPath(){let e=null;for(let n of this.parts)e?e=e.union(n.path):e??=n.path;return e??W.empty}description(e){return e.stroke}createClone(){return new s(this.parts)}serializeToJSON(){return this.parts.map(e=>({style:Uo(e.style),path:e.path.serialize()}))}static deserializeFromJSON(e){if(typeof e=="string"&&(e=JSON.parse(e)),typeof e!="object"||typeof e.length!="number")throw new Error(`${e} is missing required field, parts, or parts is of the wrong type.`);let n=e.map(i=>{let r=$o(i.style);return G(W.fromString(i.path),r)});return new s(n)}};Z.registerComponent("stroke",oe.deserializeFromJSON);var kt=class{constructor(o,e,n,i){this.startPoint=o;this.minFitAllowed=e;this.maxFitAllowed=n;this.onCurveAdded=i;this.isFirstSegment=!0;this.lastExitingVec=null;this.currentCurve=null;this.lastPoint=this.startPoint,this.buffer=[this.startPoint.pos],this.momentum=S.zero,this.currentCurve=null,this.curveStartWidth=o.width,this.bbox=new z(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}preview(){return this.currentCurve?this.currentSegmentToPath():null}approxCurrentCurveLength(){if(!this.currentCurve)return 0;let o=this.currentCurve.p0,e=this.currentCurve.p1,n=this.currentCurve.p2,i=o.distanceTo(e),r=n.distanceTo(e);return i+r}finalizeCurrentCurve(){if(!this.currentCurve)return;this.onCurveAdded(this.currentSegmentToPath());let o=this.buffer[this.buffer.length-1];this.lastExitingVec=this.currentCurve.p2.minus(this.currentCurve.p1),console.assert(this.lastExitingVec.magnitude()!==0,"lastExitingVec has zero length!"),this.buffer=[this.buffer[this.buffer.length-2],o],this.currentCurve=null,this.isFirstSegment=!1}currentSegmentToPath(){if(this.currentCurve==null)throw new Error("Invalid State: currentCurve is null!");let o=this.currentCurve.normal(0).normalized();if(!isFinite(o.magnitude()))throw new Error(`startVec(${o}) is NaN or \u221E`);let e=this.currentCurve.at(0),n=this.currentCurve.at(1),i=this.currentCurve.p1;return{startPoint:e,controlPoint:i,endPoint:n,startWidth:this.curveStartWidth,endWidth:this.curveEndWidth}}computeExitingVec(){return this.momentum.normalized().times(this.lastPoint.width/2)}addPoint(o){if(this.lastPoint){let C=o.time-this.lastPoint.time;if(o.pos.eq(this.lastPoint.pos,1e-10)||C===0)return;if(isNaN(o.pos.magnitude())){console.warn("Discarding NaN point.",o);return}let P=Math.min(this.lastPoint.width,o.width)/3;if(this.startPoint.pos.distanceTo(o.pos)<P&&this.isFirstSegment)return;let E=C/1e3,T=o.pos.minus(this.lastPoint.pos).times(1/E);this.momentum=T}let e=this.lastPoint??o;this.lastPoint=o,this.buffer.push(o.pos);let n=o.width,i=this.curveEndWidth;if(this.curveEndWidth=n,this.bbox=this.bbox.grownToPoint(o.pos,n),this.currentCurve===null){let m=e.pos,C=e.pos.plus(this.lastExitingVec??S.unitX),P=o.pos;this.currentCurve=new Ee(m,C,P),console.assert(!isNaN(m.magnitude())&&!isNaN(C.magnitude())&&!isNaN(P.magnitude()),"Expected !NaN"),this.isFirstSegment?this.curveStartWidth=(this.curveStartWidth+n)/2:this.curveStartWidth=i}let r=this.lastExitingVec;if(!r){let m=Math.ceil(this.buffer.length/2);(m===0||m>=this.buffer.length)&&(m=this.buffer.length-1),r=this.buffer[m].minus(this.buffer[0])}let a=this.computeExitingVec(),l=1.7,c=this.buffer[0],d=o.pos,p=d.distanceTo(c),u=l*p;if(u===0||a.magnitude()===0||!isFinite(a.magnitude()))return;console.assert(isFinite(r.magnitude()),"Pre-normalized enteringVec has NaN or \u221E magnitude!"),r=r.normalized(),a=a.normalized(),console.assert(isFinite(r.magnitude()),"Normalized enteringVec has NaN or \u221E magnitude!");let h=new pe(c,c.plus(r.times(u))),v=new pe(d.minus(a.times(u)),d).intersection(h),x=null;v&&(x=v.point),x||(x=c.lerp(d,.5).lerp(c.plus(r.times(p)),.1)),(c.eq(x)||d.eq(x))&&(x=c.plus(r.times(p/5))),console.assert(!c.eq(x,1e-11),"Start and control points are equal!"),console.assert(!x.eq(d,1e-11),"Control and end points are equal!");let g=this.currentCurve;this.currentCurve=new Ee(c,x,d),isNaN(this.currentCurve.normal(0).magnitude())&&(console.error("NaN normal at 0. Curve:",this.currentCurve),this.currentCurve=g);let y=m=>{let C=Math.min(Math.max(Math.min(this.curveStartWidth,this.curveEndWidth)/4,this.minFitAllowed),this.maxFitAllowed),P=C,w=0;for(let E of this.buffer){let T=m.approximateDistance(E);if(T>C&&(T=m.distance(E),w+=Math.max(0,T-C),w>P))return!1}return!0};if(this.buffer.length>3&&this.approxCurrentCurveLength()>this.curveStartWidth/2&&!y(this.currentCurve)){this.currentCurve=g,this.curveEndWidth=i,this.lastPoint=e,this.finalizeCurrentCurve();return}}};var Ys=s=>(o,e)=>new oi(s,o,e),Rt=Ys,pr=(s,o,e)=>({points:[s,o[o.length-1]]}),hr=(s,o,e)=>({points:[...e.corners,e.corners[0]]}),oi=class{constructor(o,e,n){this.sourceFactory=o;this.startPoint=e;this.viewport=n;this.builder=o(e,n),this.points=[e]}getBBox(){return this.builder.getBBox()}build(){return this.builder.build()}preview(o){this.builder.preview(o)}addPoint(o){this.points.push(o),this.builder.addPoint(o)}async autocorrectShape(){let o=this.viewport.canvasToScreen(this.startPoint.pos),e=this.points.map(w=>this.viewport.canvasToScreen(w.pos)),n=z.bboxOf(e),i=this.viewport.canvasToScreen(this.viewport.snapToGrid(this.startPoint.pos)),r=this.points.map(w=>this.viewport.canvasToScreen(this.viewport.snapToGrid(w.pos))),a=z.bboxOf(r);if(n.maxDimension<32)return null;let l=Math.min(30,n.maxDimension/4),c=[{...pr(i,r,a),toleranceMultiplier:.5},pr(o,e,n),{...hr(i,r,a),toleranceMultiplier:.6},hr(o,e,n)],p=(w=>{for(let E of c){let T=E.points,V=w*w*(E.toleranceMultiplier??1),O=se=>{for(;se<0;)se+=T.length;return se%=T.length,T[se]},$=null,ie=1/0,ee=0;for(let se=0;se<T.length;se++){let Be=T[se],Fe=Be.squareDistanceTo(o);(!$||Fe<ie)&&(ie=Fe,$=Be,ee=se)}let de=0,ve=ee;for(let se of e){let Be=1/0,Fe=ve,Ke=6;for(let Ge=-Ke;Ge<=Ke;Ge++){let Se=ve+Ge,nt=O(Se-1),yt=O(Se),Me=O(Se+1),vo=new pe(nt,yt),yo=new pe(yt,Me),pn=vo.distance(se),He=yo.distance(se),xo=Math.min(pn,He),$t=xo*xo;$t<Be&&(Be=$t,Fe=Se)}if(ve=Fe,de=Math.max(Be,de),de>V)break}if(de<V)return T}return null})(l);if(!p)return null;let u=this.points[this.points.length-1],h=this.startPoint.width,f=u.width,v=this.startPoint.color,x=u.color,g=this.startPoint.time,y=u.time,m=w=>{let E=p[Math.max(0,Math.floor(w))],T=p[Math.min(Math.ceil(w),p.length-1)],V=E.lerp(T,w-Math.floor(w)),O=w/p.length;return{pos:this.viewport.screenToCanvas(V),width:h*(1-O)+f*O,color:v.mix(x,O),time:g*(1-O)+y*O}},C=this.sourceFactory(m(0),this.viewport),P=p.length<10;for(let w=0;w<p.length;w++)P&&C.addPoint(m(w-.001)),C.addPoint(m(w)),P&&C.addPoint(m(w+.001));return C.build()}};var pt=Rt((s,o)=>{let e=o.getSizeOfPixelOnCanvas()*3,n=o.getSizeOfPixelOnCanvas();return new _o(s,n,e,o)}),_o=class{constructor(o,e,n,i){this.startPoint=o;this.minFitAllowed=e;this.viewport=i;this.isFirstSegment=!0;this.parts=[];this.widthAverageNumSamples=1;this.curveFitter=new kt(o,e,n,r=>this.addCurve(r)),this.averageWidth=o.width,this.bbox=new z(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}getRenderingStyle(){return{fill:M.transparent,stroke:{color:this.startPoint.color,width:this.roundDistance(this.averageWidth)}}}previewCurrentPath(){let e=[...this.parts.slice(),...this.curveToPathCommands(this.curveFitter.preview())];return{startPoint:this.startPoint.pos,commands:e,style:this.getRenderingStyle()}}previewFullPath(){let o=this.previewCurrentPath();return o?[o]:null}previewStroke(){let o=this.previewFullPath();return o?new oe(o):null}preview(o){let e=this.previewFullPath();if(e){let n=this.viewport.visibleRect;o.startObject(n);for(let i of e)o.drawPath(i);o.endObject()}}build(){return this.curveFitter.finalizeCurrentCurve(),this.previewStroke()}getMinFit(){let o=Math.min(this.minFitAllowed,this.averageWidth/3);return o<1e-10&&(o=this.minFitAllowed),o}roundPoint(o){let e=this.getMinFit();return q.roundPoint(o,e)}roundDistance(o){let e=this.getMinFit();return q.roundPoint(o,e)}curveToPathCommands(o){if(!o){if(!this.isFirstSegment)return[];let n=q.roundPoint(this.averageWidth/10,Math.min(this.minFitAllowed,this.averageWidth/10)),i=this.roundPoint(this.startPoint.pos);return[{kind:3,controlPoint:i.plus(S.of(n,n)),endPoint:i.plus(S.of(0,n))},{kind:3,controlPoint:i.plus(S.of(-n,n)),endPoint:i.plus(S.of(-n,0))},{kind:3,controlPoint:i.plus(S.of(-n,-n)),endPoint:i.plus(S.of(0,-n))},{kind:3,controlPoint:i.plus(S.of(n,-n)),endPoint:i.plus(S.of(n,0))}]}let e=[];return this.isFirstSegment&&e.push({kind:1,point:this.roundPoint(o.startPoint)}),e.push({kind:3,controlPoint:this.roundPoint(o.controlPoint),endPoint:this.roundPoint(o.endPoint)}),e}addCurve(o){let e=this.curveToPathCommands(o);this.parts.push(...e),this.isFirstSegment&&(this.isFirstSegment=!1)}addPoint(o){this.curveFitter.addPoint(o),this.widthAverageNumSamples++,this.averageWidth=this.averageWidth*(this.widthAverageNumSamples-1)/this.widthAverageNumSamples+o.width/this.widthAverageNumSamples}};var $e=class{#e=null;constructor(){}setEmitListener(o){o&&typeof o=="object"?this.#e=e=>o.onEvent(e)??!1:this.#e=o}emit(o){return this.#e?.(o)??!1}};var Xs={kind:0,mass:.4,springConstant:100,frictionCoefficient:.28,maxPointDist:10,inertiaFraction:.75,minSimilarityToFinalize:0,velocityDecayFactor:.1},ni=class{constructor(o,e,n){this.updatePointer=e;this.options=n;this.runLoop=!0;this.lastUpdateTime=0;this.velocity=S.zero;this.strokePoint=o,this.targetPoint=o,this.targetInterval=10,this.loop()}async loop(){for(this.lastUpdateTime=performance.now();this.runLoop;)this.update(!1),await at()}setTarget(o){this.targetPoint=o}getNextVelocity(o){let e=this.targetPoint.minus(this.strokePoint),n=e.times(this.options.springConstant),r=this.options.mass*10,a=this.velocity.normalizedOrZero().times(-this.options.frictionCoefficient*r),l=n.plus(a).times(1/this.options.mass),c=this.options.velocityDecayFactor,d=this.velocity.times(1-c).plus(l.times(o/1e3));return e.normalizedOrZero().times(d.length()).lerp(d,this.options.inertiaFraction)}update(o){let e=performance.now(),n=e-this.lastUpdateTime,i=this.strokePoint.eq(this.targetPoint);if(n>this.targetInterval||o){if(!i){let r,a,l=1;do r=this.getNextVelocity(n/l),a=r.times(n/1e3),l++;while(a.magnitude()>this.options.maxPointDist&&l<10);for(let c=0;c<l;c++)this.velocity=this.getNextVelocity(n/l),a=this.velocity.times(n/1e3),this.strokePoint=this.strokePoint.plus(a),c<l-1&&this.updatePointer(this.strokePoint,e)}if(this.lastUpdateTime=e,o||!i)return this.updatePointer(this.strokePoint,e)}return!1}finish(){this.runLoop=!1;let o=this.targetPoint.minus(this.strokePoint);this.velocity.dot(o)>this.options.minSimilarityToFinalize&&this.updatePointer(this.targetPoint,performance.now())}cancel(){this.runLoop=!1}},It=class s extends $e{constructor(e,n=Xs){super();this.viewport=e;this.options=n;this.stabilizer=null;this.lastPointerEvent=null}mapPointerEvent(e){return Vo(e)&&e.kind!==2&&(this.lastPointerEvent=e),e.kind===3||e.allPointers.length>1||this.stabilizer===null?this.emit(e):(this.stabilizer.setTarget(e.current.screenPos),e.kind===1?this.stabilizer.update(!0):e.kind===2?(this.stabilizer.finish(),this.emit(e)):this.emit(e))}emitPointerMove(e,n){if(!this.lastPointerEvent)return!1;let i=this.lastPointerEvent.current.withScreenPosition(e,this.viewport).withTimestamp(n),r={kind:1,current:i,allPointers:[i]};return this.emit(r)}onEvent(e){if(Vo(e)||e.kind===3){e.kind===0&&(this.stabilizer===null?this.stabilizer=new ni(e.current.screenPos,(i,r)=>this.emitPointerMove(i,r),this.options):e.allPointers.length>1&&(this.stabilizer.cancel(),this.stabilizer=null));let n=this.mapPointerEvent(e);return(e.kind===2||e.kind===3)&&(this.stabilizer?.cancel(),this.stabilizer=null),n}return this.emit(e)}static fromEditor(e){return new s(e.viewport)}};var ii={maxSpeed:8.5,maxRadius:11,minTimeSeconds:.5},Lt=class{constructor(o,e,n){this.config=e;this.onStationary=n;this.timeout=null;this.stationaryStartPointer=o,this.lastPointer=o,this.averageVelocity=S.zero,this.setStationaryTimeout(this.config.minTimeSeconds*1e3)}onPointerMove(o){if(!this.stationaryStartPointer)return;if(o.id!==this.stationaryStartPointer.id)return!1;let e=o.screenPos.minus(this.lastPointer.screenPos),n=o.screenPos.minus(this.stationaryStartPointer.screenPos),i=(o.timeStamp-this.lastPointer.timeStamp)/1e3;i===0&&(i=1);let r=e.times(1/i);this.averageVelocity=this.averageVelocity.lerp(r,.5);let a=o.timeStamp-this.stationaryStartPointer.timeStamp,l=n.length()>this.config.maxRadius;if(this.hasMovedOutOfRadius||=l,l||this.averageVelocity.length()>this.config.maxSpeed||a<this.config.minTimeSeconds)return this.stationaryStartPointer=o,this.lastPointer=o,this.setStationaryTimeout(this.config.minTimeSeconds*1e3),!1;let c=this.config.minTimeSeconds*1e3-a;return this.lastPointer=o,c<=0}onPointerUp(o){o.id!==this.stationaryStartPointer?.id&&this.cancelStationaryTimeout()}destroy(){this.cancelStationaryTimeout(),this.stationaryStartPointer=null}getHasMovedOutOfRadius(){return this.hasMovedOutOfRadius}cancelStationaryTimeout(){this.timeout!==null&&(clearTimeout(this.timeout),this.timeout=null)}setStationaryTimeout(o){this.timeout===null&&(o<=0?this.onStationary(this.lastPointer):this.timeout=setTimeout(()=>{if(this.timeout=null,!this.stationaryStartPointer)return;let e=performance.now()-this.stationaryStartPointer.timeStamp,n=this.config.minTimeSeconds*1e3-e;n<=0?this.onStationary(this.lastPointer):this.setStationaryTimeout(n)},o))}};var ht=class extends K{constructor(e,n,i){super(e.notifier,n);this.editor=e;this.builder=null;this.lastPoint=null;this.startPoint=null;this.currentDeviceType=null;this.currentPointerId=null;this.shapeAutocompletionEnabled=!1;this.autocorrectedShape=null;this.lastAutocorrectedShape=null;this.removedAutocorrectedShapeTime=0;this.stationaryDetector=null;this.styleValue=_.fromInitialValue({factory:pt,color:M.blue,thickness:4,...i}),this.styleValue.onUpdateAndNow(r=>{this.style=r,this.noteUpdated()})}getPressureMultiplier(){let e=this.style.thickness;return 1/this.editor.viewport.getScaleFactor()*e}toStrokePoint(e){let i=Math.max(e.pressure??1,.3);return isFinite(i)||(console.warn("Non-finite pressure!",e),i=.3),console.assert(isFinite(e.canvasPos.length()),"Non-finite canvas position!"),console.assert(isFinite(e.screenPos.length()),"Non-finite screen position!"),console.assert(isFinite(e.timeStamp),"Non-finite timeStamp on pointer!"),{pos:e.canvasPos,width:i*this.getPressureMultiplier(),color:this.style.color,time:e.timeStamp}}previewStroke(){this.editor.clearWetInk();let e=this.editor.display.getWetInkRenderer();if(this.autocorrectedShape){let n=this.editor.viewport.visibleRect;this.autocorrectedShape.render(e,n)}else this.builder?.preview(e)}addPointToStroke(e){if(!this.builder)throw new Error("No stroke is currently being generated.");this.builder.addPoint(e),this.lastPoint=e,this.previewStroke()}onPointerDown(e){if(this.builder&&!this.eventCanCancelStroke(e))return!0;let{current:n,allPointers:i}=e,r=n.device===1,a=n.device===0;return i.length===1&&!r||a?(this.startPoint=this.toStrokePoint(n),this.builder=this.style.factory(this.startPoint,this.editor.viewport),this.currentDeviceType=n.device,this.currentPointerId=n.id,this.shapeAutocompletionEnabled?this.stationaryDetector=new Lt(n,ii,l=>this.autocorrectShape(l)):this.stationaryDetector=null,this.lastAutocorrectedShape=null,this.removedAutocorrectedShapeTime=0,!0):!1}eventCanCancelStroke(e){let n=this.lastPoint?.time??0;if(e.current.timeStamp-n>1e3)return!0;let i=this.currentDeviceType===0,r=e.current.device===2;return!(i&&r)}eventCanBeDeliveredToNonActiveTool(e){return this.eventCanCancelStroke(e)}onPointerMove({current:e}){if(!this.builder||e.device!==this.currentDeviceType||e.id!==this.currentPointerId)return;this.stationaryDetector?.onPointerMove(e)||(this.addPointToStroke(this.toStrokePoint(e)),this.autocorrectedShape&&(this.removedAutocorrectedShapeTime=performance.now(),this.autocorrectedShape=null,this.editor.announceForAccessibility(this.editor.localization.autocorrectionCanceled)))}onPointerUp({current:e}){if(!this.builder)return!1;if(e.id!==this.currentPointerId)return!0;this.stationaryDetector?.onPointerUp(e);let n=this.toStrokePoint(e),i={...n,width:this.lastPoint?.width??n.width};return this.addPointToStroke(i),this.finalizeStroke(),!1}onGestureCancel(){this.builder=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null}removedAutocorrectedShapeRecently(){return this.removedAutocorrectedShapeTime>performance.now()-320}async autocorrectShape(e){if(!this.builder||!this.builder.autocorrectShape||!this.shapeAutocompletionEnabled||this.autocorrectedShape)return;let n=await this.builder.autocorrectShape();if(!this.builder||!n)return;let i=n.getBBox().area;if(i===0||!isFinite(i))return;let r=n.description(this.editor.localization);this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(r)),this.autocorrectedShape=n,this.lastAutocorrectedShape=n,this.previewStroke()}finalizeStroke(){if(this.builder){this.lastAutocorrectedShape&&this.removedAutocorrectedShapeRecently()&&(this.autocorrectedShape=this.lastAutocorrectedShape);let e=this.autocorrectedShape??this.builder.build();if(this.previewStroke(),e.getBBox().area>0){e===this.autocorrectedShape&&this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(e.description(this.editor.localization)));let i=Q.addComponent(e,!0);this.editor.dispatch(i)}else console.warn("Pen: Not adding empty stroke",e,"to the canvas.")}this.builder=null,this.lastPoint=null,this.autocorrectedShape=null,this.lastAutocorrectedShape=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null}noteUpdated(){this.editor.notifier.dispatch(2,{kind:2,tool:this})}setColor(e){e.toHexString()!==this.style.color.toHexString()&&this.styleValue.set({...this.style,color:e})}setThickness(e){e!==this.style.thickness&&this.styleValue.set({...this.style,thickness:e})}setStrokeFactory(e){e!==this.style.factory&&this.styleValue.set({...this.style,factory:e})}setHasStabilization(e){let n=!!this.getInputMapper();e!==n&&(n?this.setInputMapper(null):this.setInputMapper(new It(this.editor.viewport)),this.noteUpdated())}setStrokeAutocorrectEnabled(e){e!==this.shapeAutocompletionEnabled&&(this.shapeAutocompletionEnabled=e,this.noteUpdated())}getStrokeAutocorrectionEnabled(){return this.shapeAutocompletionEnabled}getThickness(){return this.style.thickness}getColor(){return this.style.color}getStrokeFactory(){return this.style.factory}getStyleValue(){return this.styleValue}onKeyPress(e){let n=this.editor.shortcuts,i=n.matchesShortcut(No,e);if(this.builder&&i)return this.finalizeStroke(),!1;let r;return n.matchesShortcut(Jt,e)?r=this.getThickness()*2/3:n.matchesShortcut(Qt,e)&&(r=this.getThickness()*3/2),r!==void 0?(r=Math.min(Math.max(1,r),256),this.setThickness(r),!0):!1}};var jo=(s,o)=>{if(o.length===0)return null;let e=o[0].description(s);for(let n of o)if(n.description(s)!==e)return null;return e};var ne=class s extends U{constructor(o){super("erase"),this.toRemove=o.map(e=>e),this.applied=!1}apply(o){for(let e of this.toRemove){let n=o.image.findParent(e);n&&(n.remove(),o.image.onDestroyElement(e))}this.applied=!0,o.queueRerender()}unapply(o){for(let e of this.toRemove)o.image.findParent(e)||Q.addComponent(e).apply(o);this.applied=!1,o.queueRerender()}onDrop(o){if(this.applied)for(let e of this.toRemove)o.image.onDestroyElement(e)}description(o,e){if(this.toRemove.length===0)return e.erasedNoElements;let n=jo(e,this.toRemove)??e.elements;return e.eraseAction(n,this.toRemove.length)}serializeToJSON(){return this.toRemove.map(e=>e.serialize())}static{U.register("erase",(o,e)=>{if(!Array.isArray(o))throw new Error("seralized erase data must be an array");let n=o.map(i=>{let r=typeof i=="string"?i:`${i.id}`;return e.image.lookupElement(r)??Z.deserialize(i)});return new s(n)})}};var Qs=s=>{if(s.some(o=>o&&o.then))return Promise.all(s).then(()=>{})},ri=Qs;var Yo=class extends Pe{constructor(e,n,i){super();this.commands=e;this.applyChunkSize=n;this.descriptionOverride=i}apply(e){if(this.applyChunkSize===void 0){let n=this.commands.map(i=>i.apply(e));return ri(n)}else return e.asyncApplyCommands(this.commands,this.applyChunkSize)}unapply(e){let n=[...this.commands];if(n.reverse(),this.applyChunkSize===void 0){let i=n.map(r=>r.unapply(e));return ri(i)}else return e.asyncUnapplyCommands(n,this.applyChunkSize,!1)}onDrop(e){this.commands.forEach(n=>n.onDrop(e))}description(e,n){if(this.descriptionOverride)return this.descriptionOverride;let i=[],r=null,a=0,l=0;for(let c of this.commands){let d=c.description(e,n);if(d!==r&&r!==null&&(i.push(n.unionOf(r,a)),r=null,a=0),a++,l++,r??=d,i.length>12)break}return a>1?i.push(n.unionOf(r,a)):a===1&&i.push(r),l<this.commands.length&&i.push(n.andNMoreCommands(this.commands.length-l)),i.join(", ")}},si=class extends U{constructor(e,n,i){super("union");this.commands=e;this.applyChunkSize=n;this.descriptionOverride=i;this.nonserializableCommand=new Yo(e,n,i)}serializeToJSON(){return this.serializedData?this.serializedData:{applyChunkSize:this.applyChunkSize,data:this.commands.map(e=>e.serialize()),description:this.descriptionOverride}}apply(e){return this.serializedData=this.serializeToJSON(),this.nonserializableCommand.apply(e)}unapply(e){return this.nonserializableCommand.unapply(e)}onDrop(e){this.nonserializableCommand.onDrop(e)}description(e,n){return this.nonserializableCommand.description(e,n)}},mr=(s,o)=>{let e=!0;for(let r of s)if(!(r instanceof U)){e=!1;break}let n,i;if(typeof o=="number"?n=o:(n=o?.applyChunkSize,i=o?.description),e){let r=s;return new si(r,n,i)}else return new Yo(s,n,i)};U.register("union",(s,o)=>{if(typeof s.data.length!="number")throw new Error("Unions of commands must serialize to lists of serialization data.");let e=s.applyChunkSize;if(typeof e!="number"&&e!==void 0)throw new Error("serialized applyChunkSize is neither undefined nor a number.");let n=typeof s.description=="string"?s.description:void 0,i=[];for(let r of s.data)i.push(U.deserialize(r,o));return mr(i,{applyChunkSize:e,description:n})});var he=mr;var to=(e=>(e.PartialStroke="partial-stroke",e.FullStroke="full-stroke",e))(to||{}),ai=class extends K{constructor(e,n){super(e.notifier,e.localization.changeTool);this.editor=e;this.eraser=n}onPointerDown(e){if(e.allPointers.length===1&&e.current.device===1){let i=this.editor.toolController.getPrimaryTools().filter(r=>r.isEnabled());if(i.length?this.previousEnabledTool=i[0]:this.previousEnabledTool=null,this.previousEraserEnabledState=this.eraser.isEnabled(),this.eraser.setEnabled(!0),this.eraser.onPointerDown(e))return!0;this.restoreOriginalTool()}return!1}onPointerMove(e){this.eraser.onPointerMove(e)}restoreOriginalTool(){this.eraser.setEnabled(this.previousEraserEnabledState),this.previousEnabledTool&&this.previousEnabledTool.setEnabled(!0)}onPointerUp(e){this.eraser.onPointerUp(e),this.restoreOriginalTool()}onGestureCancel(e){this.eraser.onGestureCancel(e),this.restoreOriginalTool()}},mt=class extends K{constructor(e,n,i){super(e.notifier,n);this.editor=e;this.lastPoint=null;this.isFirstEraseEvt=!0;this.toAdd=new Set;this.eraseCommands=[];this.addCommands=[];this.thickness=i?.thickness??10,this.thicknessValue=_.fromInitialValue(this.thickness),this.thicknessValue.onUpdate(r=>{this.thickness=r,this.editor.notifier.dispatch(2,{kind:2,tool:this})}),this.modeValue=_.fromInitialValue(i?.mode??"full-stroke"),this.modeValue.onUpdate(r=>{this.editor.notifier.dispatch(2,{kind:2,tool:this})})}makeEraserSwitcherTool(){return new ai(this.editor,this)}clearPreview(){this.editor.clearWetInk()}getSizeOnCanvas(){return this.thickness/this.editor.viewport.getScaleFactor()}drawPreviewAt(e){this.clearPreview();let n=this.getSizeOnCanvas(),i=this.editor.display.getWetInkRenderer(),r=this.getEraserRect(e),a=this.getEraserRect(this.lastPoint??e),l={fill:M.transparent,stroke:{width:n/10,color:M.gray}};i.drawPath(G(W.fromConvexHullOf([...r.corners,...a.corners]),l))}getEraserRect(e){let n=this.getSizeOnCanvas(),i=S.of(n/2,n/2);return z.fromCorners(e.minus(i),e.plus(i))}eraseTo(e){if(!this.isFirstEraseEvt&&e.distanceTo(this.lastPoint)===0)return;this.isFirstEraseEvt=!1;let n=this.getEraserRect(e),i=new pe(this.lastPoint,e),r=z.union(i.bbox,n),l=this.editor.image.getComponentsIntersecting(r).filter(c=>c.intersects(i)||c.intersectsRect(n)).filter(c=>c.isSelectable());if(this.modeValue.get()==="full-stroke"){this.toRemove.push(...l);let c=l.map(d=>new ne([d]));c.forEach(d=>d.apply(this.editor)),this.eraseCommands.push(...c)}else{let c=[],d=[];for(let f of l){if(c.push(f),!f.withRegionErased||n.grownBy(n.maxDimension/3).containsRect(f.getExactBBox()))continue;let x=W.fromConvexHullOf([...n.corners,...this.getEraserRect(this.lastPoint??e).corners].map(g=>this.editor.viewport.roundPoint(g)));d.push(...f.withRegionErased(x,this.editor.viewport))}let p=new ne(c),u=d.map(f=>Q.addComponent(f));p.apply(this.editor),u.forEach(f=>f.apply(this.editor));let h=[];for(let f of c)this.toAdd.has(f)?this.toAdd.delete(f):h.push(f);this.toRemove.push(...h);for(let f of d)this.toAdd.add(f);this.eraseCommands.push(new ne(h)),this.addCommands.push(...u)}this.drawPreviewAt(e),this.lastPoint=e}onPointerDown(e){return e.allPointers.length===1||e.current.device===1?(this.lastPoint=e.current.canvasPos,this.toRemove=[],this.toAdd.clear(),this.isFirstEraseEvt=!0,this.drawPreviewAt(e.current.canvasPos),!0):!1}onPointerMove(e){let n=e.current.canvasPos;this.eraseTo(n)}onPointerUp(e){this.eraseTo(e.current.canvasPos);let n=[];if(this.addCommands.length>0){this.addCommands.forEach(i=>i.unapply(this.editor));for(let i of this.toAdd)this.toRemove.includes(i)&&(this.toAdd.delete(i),this.toRemove=this.toRemove.filter(r=>r!==i));for(let i of this.toRemove)this.toAdd.has(i)&&(this.toAdd.delete(i),this.toRemove=this.toRemove.filter(r=>r!==i));n.push(...[...this.toAdd].map(i=>Q.addComponent(i))),this.addCommands=[]}if(this.eraseCommands.length>0){this.eraseCommands.forEach(r=>r.unapply(this.editor)),this.eraseCommands=[];let i=new ne(this.toRemove);n.push(i)}n.length===1?this.editor.dispatch(n[0]):this.editor.dispatch(he(n)),this.clearPreview()}onGestureCancel(e){this.addCommands.forEach(n=>n.unapply(this.editor)),this.eraseCommands.forEach(n=>n.unapply(this.editor)),this.eraseCommands=[],this.addCommands=[],this.clearPreview()}onKeyPress(e){let n=this.editor.shortcuts,i;return n.matchesShortcut(Jt,e)?i=this.getThickness()*2/3:n.matchesShortcut(Qt,e)&&(i=this.getThickness()*3/2),i!==void 0?(i=Math.min(Math.max(1,i),200),this.setThickness(i),!0):!1}getThickness(){return this.thickness}setThickness(e){this.thicknessValue.set(e)}getThicknessValue(){return this.thicknessValue}getModeValue(){return this.modeValue}};var fr="text";var Js={fontFamily:"sans",size:12,renderingStyle:{fill:M.purple}},ce=class s extends Z{constructor(e,n,i=Js,r=0){super(fr);this.textObjects=e;this.transform=n;this.style=i;this.transformMode=r;this.isRestylableComponent=!0;this.recomputeBBox(),!e.some(l=>typeof l=="string")&&e.length>0&&(this.style=e[0].getTextStyle())}static applyTextStyles(e,n){let i=n.fontFamily.match(/\s/),r=n.fontFamily.match(/^".*"$/),a=i&&!r?`"${n.fontFamily.replace(/["]/g,'\\"')}"`:n.fontFamily;e.font=[n.fontStyle??"",n.fontWeight??"",(n.size??12)+"px",`${a}`].join(" "),e.textAlign="left"}static{this.textMeasuringCtx=null}static estimateTextDimens(e,n){let i=e.length*n.size,r=n.size;return new z(0,-r*2/3,i,r)}static getTextMetrics(e,n){if(s.textMeasuringCtx??=document.createElement("canvas").getContext("2d")??null,!s.textMeasuringCtx)return null;let i=s.textMeasuringCtx;return s.applyTextStyles(i,n),i.measureText(e)}static getTextDimens(e,n){let i=this.getTextMetrics(e,n);if(!i)return this.estimateTextDimens(e,n);let r=-i.actualBoundingBoxAscent,a=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent;return new z(0,r,i.width,a)}static getFontHeight(e){return e.size}computeUntransformedBBoxOfPart(e){return typeof e=="string"?s.getTextDimens(e,this.style):e.contentBBox}recomputeBBox(){let e=null,n=new s.TextCursor(this.transform,this.style);for(let i of this.textObjects){let r=n.update(i).transform,a=this.computeUntransformedBBoxOfPart(i).transformedBoundingBox(r);e??=a,e=e.union(a)}this.contentBBox=e??z.empty}renderInternal(e,n,i=I.identity){let r=new s.TextCursor(this.transform,this.style);for(let a of this.textObjects){let{transform:l,bbox:c}=r.update(a);n&&!n.intersects(c.transformedBoundingBox(i))||(typeof a=="string"?e.drawText(a,l,this.style):(e.pushTransform(l),a.renderInternal(e,n,i.rightMul(l)),e.popTransform()))}}render(e,n){e.startObject(this.contentBBox),this.renderInternal(e,n),e.endObject(this.getLoadSaveData())}getProportionalRenderingTime(){return this.textObjects.length}intersects(e){let n=new s.TextCursor(this.transform,this.style);for(let i of this.textObjects){let r=n.update(i).transform.inverse(),a=e.transformedBy(r);if(typeof i=="string"){if(s.getTextDimens(i,this.style).getEdges().some(c=>a.intersection(c)!==null))return!0}else if(i.intersects(a))return!0}return!1}getStyle(){return{color:this.style.renderingStyle.fill,textStyle:{...this.style,renderingStyle:{...this.style.renderingStyle}}}}updateStyle(e){return dt(this.getStyle(),e,this)}forceStyle(e,n){if(e.textStyle)this.style=Jn(e.textStyle);else if(e.color)this.style={...this.style,renderingStyle:{...this.style.renderingStyle,fill:e.color}};else return;for(let i of this.textObjects)i instanceof s&&i.forceStyle(e,n);n&&(n.image.queueRerenderOf(this),n.queueRerender())}getTextStyle(){return Jn(this.style)}getBaselinePos(){return this.transform.transformVec2(S.zero)}getTransform(){return this.transform}applyTransformation(e){this.transform=e.rightMul(this.transform),this.recomputeBBox()}createClone(){let e=this.textObjects.map(n=>typeof n=="string"?n:n.createClone());return new s(e,this.transform,this.style)}getText(){let e=[];for(let n of this.textObjects)typeof n=="string"?e.push(n):e.push(n.getText());return e.join(`
`)}description(e){return e.text(this.getText())}serializeToJSON(){let e=Ko(this.style);return{textObjects:this.textObjects.map(i=>typeof i=="string"?{text:i}:{json:i.serializeToJSON()}),transform:this.transform.toArray(),style:e}}static deserializeFromString(e){typeof e=="string"&&(e=JSON.parse(e));let n=qo(e.style),i=e.textObjects.map(l=>(l.text??null)!==null?l.text:s.deserializeFromString(l.json));if(e.transform=e.transform.filter(l=>typeof l=="number"),e.transform.length!==9)throw new Error(`Unable to deserialize transform, ${e.transform}.`);let r=e.transform,a=new I(...r);return new s(i,a,n)}static fromLines(e,n,i){let r=null,a=[],l=Math.round(this.getFontHeight(i)),c=S.zero;for(let d of e){r&&(c=c.plus(S.unitY.times(l)));let p=new s([d],I.translation(c),i);a.push(p),r=p}return new s(a,n,i)}static{this.TextCursor=class{constructor(e=I.identity,n){this.parentTransform=e;this.parentStyle=n;this.transform=I.identity}update(e){let n=I.identity,i=I.identity,r;typeof e=="string"?r=s.getTextDimens(e,this.parentStyle):(i=e.transform,r=e.getBBox());let a=typeof e=="string"?1:e.transformMode;a===1?n=this.transform.rightMul(n):(a===2||a===3)&&(n=this.transform.mapEntries((p,[u,h])=>{if(a===2)return u===1&&h===2?0:p;if(a===3)return u===0&&h===2?0:p;throw new Error("Unreachable")}).rightMul(n));let l=I.translation(S.of(r.width,0));this.transform=n.rightMul(i).rightMul(l);let c=this.parentTransform.rightMul(n);return{transform:c,bbox:r.transformedBoundingBox(c)}}}}};Z.registerComponent(fr,s=>ce.deserializeFromString(s));var Ae=class{constructor(o){this.viewport=o;this.selfTransform=null;this.transformStack=[];this.objectLevel=0;this.currentPaths=null}getViewport(){return this.viewport}setDraftMode(o){}flushPath(){if(!this.currentPaths)return;let o=null;for(let e of this.currentPaths){let{startPoint:n,commands:i,style:r}=e;!o||!Wo(o,r)?(o&&this.endPath(o),this.beginPath(n),o=r):this.moveTo(n);for(let a of i)a.kind===0?this.lineTo(a.point):a.kind===1?this.moveTo(a.point):a.kind===2?this.traceCubicBezierCurve(a.controlPoint1,a.controlPoint2,a.endPoint):a.kind===3&&this.traceQuadraticBezierCurve(a.controlPoint,a.endPoint)}o&&this.endPath(o),this.currentPaths=[]}drawPath(o){this.objectLevel===0||this.currentPaths===null?(this.currentPaths=[o],this.flushPath(),this.currentPaths=null):this.currentPaths.push(o)}drawRect(o,e,n){let i=W.fromRect(o,e);this.drawPath(G(i,n))}fillRect(o,e){let n=W.fromRect(o);this.drawPath(G(n,{fill:e}))}startObject(o,e){this.objectLevel>0&&this.flushPath(),this.currentPaths=[],this.objectLevel++}endObject(o,e){if(this.flushPath(),this.currentPaths=null,this.objectLevel--,this.objectLevel<0)throw new Error("More objects have ended than have been started (negative object nesting level)!")}getNestingLevel(){return this.objectLevel}canRenderFromWithoutDataLoss(o){return!1}renderFromOtherOfSameType(o,e){throw new Error(`Unable to render from ${e}: Not implemented`)}setTransform(o){this.selfTransform=o}pushTransform(o){this.flushPath(),this.transformStack.push(this.selfTransform),this.setTransform(this.getCanvasToScreenTransform().rightMul(o))}popTransform(){if(this.transformStack.length===0)throw new Error("Unable to pop more transforms than have been pushed!");this.flushPath(),this.setTransform(this.transformStack.pop()??null)}getCanvasToScreenTransform(){return this.selfTransform?this.selfTransform:this.viewport.canvasToScreenTransform}canvasToScreen(o){return this.getCanvasToScreenTransform().transformVec2(o)}getSizeOfCanvasPixelOnScreen(){return this.getCanvasToScreenTransform().transformVec3(S.unitX).length()}overrideVisibleRect(o){this.visibleRectOverride=o}getVisibleRect(){return this.visibleRectOverride??this.viewport.visibleRect}};var Qe=class s extends Ae{constructor(e,n){super(n);this.ctx=e;this.ignoreObjectsAboveLevel=null;this.ignoringObject=!1;this.currentObjectBBox=null;this.clipLevels=[];this.setDraftMode(!1)}transformBy(e){this.ctx.transform(e.a1,e.b1,e.a2,e.b2,e.a3,e.b3)}canRenderFromWithoutDataLoss(e){return e instanceof s}renderFromOtherOfSameType(e,n){if(!(n instanceof s))throw new Error(`${n} cannot be rendered onto ${this}`);e=this.getCanvasToScreenTransform().rightMul(e),this.ctx.save(),this.transformBy(e),this.ctx.drawImage(n.ctx.canvas,0,0),this.ctx.restore()}setDraftMode(e){e?(this.minSquareCurveApproxDist=9,this.minRenderSizeBothDimens=1,this.minRenderSizeAnyDimen=.1):(this.minSquareCurveApproxDist=.5,this.minRenderSizeBothDimens=.1,this.minRenderSizeAnyDimen=1e-6)}displaySize(){return S.of(this.ctx.canvas.clientWidth,this.ctx.canvas.clientHeight)}clear(){this.ctx.save(),this.ctx.resetTransform(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}beginPath(e){e=this.canvasToScreen(e),this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y)}endPath(e){e.fill.a>0&&(this.ctx.fillStyle=e.fill.toHexString(),this.ctx.fill()),e.stroke&&(this.ctx.strokeStyle=e.stroke.color.toHexString(),this.ctx.lineWidth=this.getSizeOfCanvasPixelOnScreen()*e.stroke.width,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.stroke(),this.ctx.lineWidth=1),this.ctx.closePath()}lineTo(e){e=this.canvasToScreen(e),this.ctx.lineTo(e.x,e.y)}moveTo(e){e=this.canvasToScreen(e),this.ctx.moveTo(e.x,e.y)}traceCubicBezierCurve(e,n,i){e=this.canvasToScreen(e),n=this.canvasToScreen(n),i=this.canvasToScreen(i);let r=n.minus(e),a=i.minus(n);r.magnitudeSquared()<this.minSquareCurveApproxDist&&a.magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(i.x,i.y):this.ctx.bezierCurveTo(e.x,e.y,n.x,n.y,i.x,i.y)}traceQuadraticBezierCurve(e,n){e=this.canvasToScreen(e),n=this.canvasToScreen(n),e.minus(n).magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(n.x,n.y):this.ctx.quadraticCurveTo(e.x,e.y,n.x,n.y)}drawPath(e){if(this.ignoringObject)return;let n=this.getVisibleRect();this.currentObjectBBox?.containsRect(n)&&(e=ti(e,n)),super.drawPath(e)}drawText(e,n,i){this.ctx.save(),n=this.getCanvasToScreenTransform().rightMul(n),this.transformBy(n),ce.applyTextStyles(this.ctx,i),i.renderingStyle.fill.a!==0&&(this.ctx.fillStyle=i.renderingStyle.fill.toHexString(),this.ctx.fillText(e,0,0)),i.renderingStyle.stroke&&(this.ctx.strokeStyle=i.renderingStyle.stroke.color.toHexString(),this.ctx.lineWidth=i.renderingStyle.stroke.width,this.ctx.strokeText(e,0,0)),this.ctx.restore()}drawImage(e){if(e.image.width===0||e.image.height===0)return;this.ctx.save();let n=this.getCanvasToScreenTransform().rightMul(e.transform);this.transformBy(n),this.ctx.drawImage(e.image,0,0),this.ctx.restore()}startObject(e,n){if(this.isTooSmallToRender(e)&&(this.ignoreObjectsAboveLevel=this.getNestingLevel(),this.ignoringObject=!0),super.startObject(e),this.currentObjectBBox=e,!this.ignoringObject&&n&&!e.containsRect(this.getVisibleRect())){this.clipLevels.push(this.objectLevel),this.ctx.save(),this.ctx.beginPath();for(let r of e.corners){let a=this.canvasToScreen(r);this.ctx.lineTo(a.x,a.y)}this.ctx.clip()}}endObject(){let e=this.objectLevel;this.currentObjectBBox=null,super.endObject(),!this.ignoringObject&&this.clipLevels.length>0&&this.clipLevels[this.clipLevels.length-1]===e&&(this.ctx.restore(),this.clipLevels.pop()),this.ignoreObjectsAboveLevel!==null&&this.getNestingLevel()<=this.ignoreObjectsAboveLevel&&(this.ignoreObjectsAboveLevel=null,this.ignoringObject=!1)}drawWithRawRenderingContext(e){this.ctx.save(),this.transformBy(this.getCanvasToScreenTransform()),e(this.ctx),this.ctx.restore()}drawPoints(...e){for(let i=0;i<e.length;i++){let r=this.canvasToScreen(e[i]);this.ctx.beginPath(),this.ctx.arc(r.x,r.y,10,0,Math.PI*2),this.ctx.fillStyle=M.ofRGBA(.5+Math.sin(i)/2,1,.5+Math.cos(i*.2)/4,.5).toHexString(),this.ctx.lineWidth=2,this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath(),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.ctx.fillText(`${i}`,r.x,r.y,10*2)}}isTooSmallToRender(e){let n=e.size.times(this.getSizeOfCanvasPixelOnScreen()),i=this.minRenderSizeBothDimens,r=Math.abs(n.x)<i&&Math.abs(n.y)<i,a=this.minRenderSizeAnyDimen,l=Math.abs(n.x)<a||Math.abs(n.y)<a;return r||l}static fromViewport(e,n={}){let i=document.createElement("canvas"),r=e.getScreenRectSize(),a=n.canvasSize??r;n.maxCanvasDimen&&a.maximumEntryMagnitude()>n.maxCanvasDimen&&(a=a.times(n.maxCanvasDimen/a.maximumEntryMagnitude())),i.width=a.x,i.height=a.y;let l=i.getContext("2d"),c=Math.min(a.x/r.x,a.y/r.y);return l.scale(c,c),{renderer:new s(l,e),element:i}}};var Xo="js-draw-image-background",gr="js-draw-image-background-grid-",br="js-draw-image-background-non-automatic-secondary-color",vr={1:"js-draw-image-background-grid",0:Xo,2:""},Re=class s extends Z{constructor(e,n){super("image-background",0);this.backgroundType=e;this.mainColor=n;this.viewportSizeChangeListener=null;this.autoresizeChangedListener=null;this.fillsScreen=!1;this.gridSize=q.getGridSize(2);this.gridStrokeWidth=.7;this.secondaryColor=null;this.isRestylableComponent=!0;this.contentBBox=z.empty}static ofGrid(e,n,i,r){let a=new s(1,e);return n!==void 0&&(a.gridSize=n),i!==void 0&&(a.secondaryColor=i),r!==void 0&&(a.gridStrokeWidth=r),a}getBackgroundType(){return this.backgroundType}getMainColor(){return this.mainColor}getSecondaryColor(){return this.secondaryColor}getGridSize(){return this.gridSize}getStyle(){let e=this.mainColor;return this.backgroundType===2&&(e=void 0),{color:e}}updateStyle(e){return dt(this.getStyle(),e,this)}forceStyle(e,n){let i=e.color;i&&(this.mainColor=i,i.eq(M.transparent)&&this.backgroundType===0?this.backgroundType=2:this.backgroundType===2&&(this.backgroundType=0),n&&(n.image.queueRerenderOf(this),n.queueRerender()))}onAddToImage(e){this.viewportSizeChangeListener&&(console.warn("onAddToImage called when background is already in an image"),this.onRemoveFromImage()),this.viewportSizeChangeListener=e.notifier.on(0,()=>{this.recomputeBBox(e)}),this.autoresizeChangedListener=e.notifier.on(1,()=>{this.recomputeBBox(e)}),this.recomputeBBox(e)}onRemoveFromImage(){this.viewportSizeChangeListener?.remove(),this.autoresizeChangedListener?.remove(),this.viewportSizeChangeListener=null,this.autoresizeChangedListener=null}recomputeBBox(e){let n=e.getImportExportViewport().visibleRect,i=!1;this.contentBBox.eq(n)||(this.contentBBox=n,i||=!this.fillsScreen);let r=e.getAutoresizeEnabled();r!==this.fillsScreen&&(this.fillsScreen=r,i=!0),i&&e.queueRerenderOf(this)}generateGridPath(e){let n=this.getFullBoundingBox(e),i=(e?.intersection(n)??n).grownBy(this.gridStrokeWidth/2),r=y=>Math.floor(y/this.gridSize)*this.gridSize,a=y=>Math.ceil(y/this.gridSize)*this.gridSize,l=a(i.y),c=r(i.y+i.h),d=a(i.x),p=r(i.x+i.w),u=[],h=(c-l)/this.gridSize,f=(p-d)/this.gridSize;if(h>1e3||f>1e3)return W.empty;let g=S.of(i.x,l);for(let y=l;y<=c;y+=this.gridSize)u.push({kind:1,point:S.of(i.x,y)}),u.push({kind:0,point:S.of(i.x+i.w,y)});for(let y=d;y<=p;y+=this.gridSize)u.push({kind:1,point:S.of(y,i.y)}),u.push({kind:0,point:S.of(y,i.y+i.h)});return new W(g,u)}getFullBoundingBox(e){return(this.fillsScreen?e:this.contentBBox)??this.contentBBox}render(e,n){if(this.backgroundType===2)return;let i=!n;this.fillsScreen&&(n??=e.getVisibleRect());let r=this.backgroundType===1,a=this.getFullBoundingBox(n);if(e.startObject(a,r),this.backgroundType===0||this.backgroundType===1){let d=n?.intersection(a);d?e.fillRect(d,this.mainColor):i&&e.fillRect(a,this.mainColor)}if(this.backgroundType===1){let d=this.secondaryColor;d??=M.ofRGBA(1-this.mainColor.r,1-this.mainColor.g,1-this.mainColor.b,.2),this.mainColor.a===0&&(d=M.ofRGBA(.5,.5,.5,.2));let p={fill:M.transparent,stroke:{width:this.gridStrokeWidth,color:d}};e.drawPath(G(this.generateGridPath(n),p))}let l=vr[this.backgroundType],c=[Xo];if(l!==Xo){c.push(l);let d=fe(this.gridSize).replace(/[.]/g,"p");c.push(gr+d)}this.secondaryColor!==null&&c.push(br),e.endObject(this.getLoadSaveData(),c)}intersects(e){return this.contentBBox.getEdges().some(n=>n.intersects(e))}isSelectable(){return!1}isBackground(){return!0}getSizingMode(){return this.fillsScreen?1:0}serializeToJSON(){return{mainColor:this.mainColor.toHexString(),secondaryColor:this.secondaryColor?.toHexString(),backgroundType:this.backgroundType,gridSize:this.gridSize,gridStrokeWidth:this.gridStrokeWidth}}applyTransformation(e){}description(e){return this.backgroundType===0?e.filledBackgroundWithColor(this.mainColor.toString()):this.backgroundType===2?e.emptyBackground:this.backgroundType===1?e.gridBackground:this.backgroundType}createClone(){return new s(this.backgroundType,this.mainColor)}static deserializeFromJSON(e){if(typeof e=="string"&&(e=JSON.parse(e)),typeof e.mainColor!="string")throw new Error("Error deserializing \u2014 mainColor must be of type string.");let n,i=e.backgroundType;if(i===2||i===1||i===0)n=i;else return i;let r=M.fromHex(e.mainColor),a=e.secondaryColor?M.fromHex(e.secondaryColor):null,l=e.gridSize??void 0,c=e.gridStrokeWidth??void 0,d=new s(n,r);return d.secondaryColor=a,l&&(d.gridSize=l),c&&(d.gridStrokeWidth=c),d}};Z.registerComponent("image-background",Re.deserializeFromJSON);var ta=async s=>{s.complete||await new Promise((o,e)=>{s.onload=n=>o(n),s.onerror=n=>e(n),s.onabort=n=>e(n)})},yr=ta;var Ie=class s extends Z{constructor(o){super("image-component"),this.image={...o,label:o.label??o.image.getAttribute("alt")??o.image.getAttribute("aria-label")??void 0},(n=>n.getAttribute("src")!==void 0)(o.image)&&!o.image.complete&&(o.image.onload=()=>this.recomputeBBox()),this.recomputeBBox()}getImageRect(){return new z(0,0,this.image.image.width,this.image.image.height)}recomputeBBox(){this.contentBBox=this.getImageRect(),this.contentBBox=this.contentBBox.transformedBoundingBox(this.image.transform)}static async fromImage(o,e){await yr(o);let n,i;typeof o.width=="number"&&typeof o.height=="number"&&o.width!==0&&o.height!==0?(n=o.width,i=o.height):(n=o.clientWidth,i=o.clientHeight);let r,a=o.src??"";if(a.startsWith("data:image/"))r=new Image,r.src=a,r.width=n,r.height=i;else{let l=document.createElement("canvas");l.width=n,l.height=i,l.getContext("2d").drawImage(o,0,0,l.width,l.height),a=l.toDataURL(),r=l}return r.setAttribute("alt",o.getAttribute("alt")??""),r.setAttribute("aria-label",o.getAttribute("aria-label")??""),new s({image:r,base64Url:a,transform:e})}render(o,e){o.startObject(this.contentBBox),o.drawImage(this.image),o.endObject(this.getLoadSaveData())}getProportionalRenderingTime(){return 10}intersects(o){let n=this.getImageRect().getEdges().map(i=>i.transformedBy(this.image.transform));for(let i of n)if(i.intersects(o))return!0;return!1}applyTransformation(o){this.image.transform=o.rightMul(this.image.transform),this.recomputeBBox()}description(o){return this.image.label?o.imageNode(this.image.label):o.unlabeledImageNode}getAltText(){return this.image.label}getURL(){return this.image.base64Url}getTransformation(){return this.image.transform}createClone(){return new s({...this.image})}serializeToJSON(){return{src:this.image.base64Url,label:this.image.label,width:this.image.image.width,height:this.image.image.height,transform:this.image.transform.toArray()}}static deserializeFromJSON(o){if(typeof o.src!="string")throw new Error(`${o} has invalid format! Expected src property.`);Ye(o.transform),We(o.width),We(o.height);let e=new Image;e.src=o.src,e.width=o.width,e.height=o.height;let n=new I(...o.transform);return new s({image:e,base64Url:o.src,label:o.label,transform:n})}};Z.registerComponent("image-component",Ie.deserializeFromJSON);var xr="svg-global-attributes",oo=class s extends Z{constructor(o){super(xr),this.contentBBox=z.empty;let e=["viewBox","width","height"];this.attrs=o.filter(([n,i])=>!e.includes(n))}render(o,e){if(o instanceof Le)for(let[n,i]of this.attrs)o.setRootSVGAttribute(n,i)}intersects(o){return!1}applyTransformation(o){}isSelectable(){return!1}getSizingMode(){return 2}createClone(){return new s(this.attrs)}description(o){return o.svgObject}serializeToJSON(){return JSON.stringify(this.attrs)}static deserializeFromString(o){return new s([])}};Z.registerComponent(xr,oo.deserializeFromString);var oa="unknown-svg-object";Z.registerComponent(oa,null);var tg=new z(0,0,500,500),Tr="svgAttrs",Cr="svgStyleAttrs",Sr="svgContainerID";var na=(s,o)=>{let e=s.length<o.length?s:o,n=e===s?o:s;for(let i=0;i<e.length;i++)if(e[i]!==n[i])return!1;return!0},wr=na;var Qo="js-draw-style-sheet",ft="http://www.w3.org/2000/svg",ci={fontWeight:"400",fontStyle:"normal"},Le=class s extends Ae{constructor(e,n,i=!1){super(n);this.elem=e;this.sanitize=i;this.lastPathStyle=null;this.lastPathString=[];this.lastContainerIDList=[];this.objectElems=null;this.overwrittenAttrs={};this.textContainer=null;this.textContainerTransform=null;this.textParentStyle=ci;this.clear(),this.addStyleSheet()}addStyleSheet(){if(!this.elem.querySelector(`#${Qo}`)){let e=document.createElementNS("http://www.w3.org/2000/svg","style");e.appendChild(document.createTextNode(`
				path {
					stroke-linecap: round;
					stroke-linejoin: round;
				}

				text {
					white-space: pre;
				}
			`.replace(/\s+/g,""))),e.setAttribute("id",Qo),this.elem.appendChild(e)}}setRootSVGAttribute(e,n){this.sanitize||(e in this.overwrittenAttrs||(this.overwrittenAttrs[e]=this.elem.getAttribute(e)),n!==null?this.elem.setAttribute(e,n):this.elem.removeAttribute(e))}displaySize(){return S.of(this.elem.clientWidth,this.elem.clientHeight)}clear(){if(this.lastPathString=[],this.lastContainerIDList=[],!this.sanitize){for(let e in this.overwrittenAttrs){let n=this.overwrittenAttrs[e];n?this.elem.setAttribute(e,n):this.elem.removeAttribute(e)}this.overwrittenAttrs={}}}addPathToSVG(){if(!this.lastPathStyle||this.lastPathString.length===0)return null;let e=document.createElementNS(ft,"path");e.setAttribute("d",this.lastPathString.join(" "));let n=this.lastPathStyle;return n.fill.a>0?e.setAttribute("fill",n.fill.toHexString()):e.setAttribute("fill","none"),n.stroke&&(e.setAttribute("stroke",n.stroke.color.toHexString()),e.setAttribute("stroke-width",fe(n.stroke.width*this.getSizeOfCanvasPixelOnScreen()))),this.elem.appendChild(e),this.objectElems?.push(e),e}drawPath(e){let n=e.style,i=ut(e).transformedBy(this.getCanvasToScreenTransform());(this.lastPathString.length===0||!this.lastPathStyle||!Wo(this.lastPathStyle,n))&&(this.addPathToSVG(),this.lastPathStyle=n,this.lastPathString=[]),this.lastPathString.push(i.toString())}transformFrom(e,n,i=!1){let r=i?e:this.getCanvasToScreenTransform().rightMul(e);if(r.eq(I.identity))n.style.transform="";else{let a=r.toCSSMatrix();n.style.transform=a,n.setAttribute("data-highp-transform",a)}}drawText(e,n,i){let r=(a,l)=>{l.fontFamily!==this.textParentStyle?.fontFamily&&(a.style.fontFamily=l.fontFamily),l.fontVariant!==this.textParentStyle?.fontVariant&&(a.style.fontVariant=l.fontVariant??""),l.fontWeight!==this.textParentStyle?.fontWeight&&(a.style.fontWeight=l.fontWeight??""),l.fontStyle!==this.textParentStyle?.fontStyle&&(a.style.fontStyle=l.fontStyle??""),l.size!==this.textParentStyle?.size&&(a.style.fontSize=l.size+"px");let c=l.renderingStyle.fill.toHexString();if(a.style.fill=c,l.renderingStyle.stroke){let d=l.renderingStyle.stroke;a.style.stroke=d.color.toHexString(),a.style.strokeWidth=d.width+"px"}};if(n=this.getCanvasToScreenTransform().rightMul(n),this.textContainer){let a=document.createElementNS(ft,"tspan");a.appendChild(document.createTextNode(e)),this.textContainer.appendChild(a),n=this.textContainerTransform.inverse().rightMul(n);let l=n.transformVec2(S.zero);a.setAttribute("x",`${fe(l.x)}`),a.setAttribute("y",`${fe(l.y)}`),r(a,i)}else{let a=document.createElementNS(ft,"text");a.appendChild(document.createTextNode(e)),this.transformFrom(n,a,!0),r(a,i),this.elem.appendChild(a),this.objectElems?.push(a),this.objectLevel>0&&(this.textContainer=a,this.textContainerTransform=n,this.textParentStyle={...ci,...i})}}drawImage(e){let n=e.label??e.image.getAttribute("aria-label")??"";n===""&&(n=e.image.getAttribute("alt")??"");let i=document.createElementNS(ft,"image");i.setAttribute("href",e.base64Url),i.setAttribute("width",e.image.getAttribute("width")??""),i.setAttribute("height",e.image.getAttribute("height")??""),i.setAttribute("aria-label",n),this.transformFrom(e.transform,i),this.elem.appendChild(i),this.objectElems?.push(i)}startObject(e){super.startObject(e),this.lastPathString=[],this.lastPathStyle=null,this.textContainer=null,this.textParentStyle=ci,this.objectElems=[]}endObject(e,n){if(super.endObject(e),this.addPathToSVG(),!!this.objectElems){if(e&&!this.sanitize){for(let a of this.objectElems){let l=e[Tr],c=e[Cr];if(l)for(let[d,p]of l)a.setAttribute(d,p);if(c)for(let d of c)a.style.setProperty(d.key,d.value,d.priority)}let i=e[Sr],r=[];if(i&&i[0]&&i[0].length&&(r=i[0]),r.length>0&&wr(this.lastContainerIDList,r)&&this.lastContainerIDList.length>=r.length-1){let a=r[r.length-1],l=this.elem.querySelectorAll(`g#${a}`);if(l.length>=1){let c=l[0];if(c.children.length===0||this.lastContainerIDList.length>=r.length)for(let d of this.objectElems)d.remove(),c.appendChild(d);else r=[]}}else r=[];this.lastContainerIDList=r}if(n&&this.objectElems)if(this.objectElems.length===1)this.objectElems[0].classList.add(...n);else{let i=document.createElementNS(ft,"g");i.classList.add(...n);for(let r of this.objectElems)r.remove(),i.appendChild(r);this.elem.appendChild(i)}}}unimplementedMessage(){throw new Error("Not implemenented!")}beginPath(e){this.unimplementedMessage()}endPath(e){this.unimplementedMessage()}lineTo(e){this.unimplementedMessage()}moveTo(e){this.unimplementedMessage()}traceCubicBezierCurve(e,n,i){this.unimplementedMessage()}traceQuadraticBezierCurve(e,n){this.unimplementedMessage()}drawPoints(...e){e.map(n=>{let i=document.createElementNS(ft,"circle");i.setAttribute("cx",`${n.x}`),i.setAttribute("cy",`${n.y}`),i.setAttribute("r","15"),this.elem.appendChild(i)})}drawSVGElem(e){if(this.sanitize||e.tagName.toLowerCase()==="style"&&e.getAttribute("id")===Qo)return;let n=e.cloneNode(!0);this.elem.appendChild(n),this.objectElems?.push(n)}drawWithSVGParent(e){let n=document.createElementNS(ft,"g");this.transformFrom(I.identity,n,!0),e(n,{sanitize:this.sanitize}),this.elem.appendChild(n),this.objectElems?.push(n)}isTooSmallToRender(e){return!1}static fromViewport(e,n=!0){let i,r;typeof n=="boolean"?(i=n,r=!1):(i=n.sanitize??!0,r=n.useViewBoxForPositioning??!1);let a="http://www.w3.org/2000/svg",l=document.createElementNS(a,"svg"),c=e.getScreenRectSize(),d=e.visibleRect,p;if(r){let h=e.visibleRect;p=[h.x,h.y,h.w,h.h],e=e.getTemporaryClone(),e.resetTransform(I.identity)}else p=[0,0,c.x,c.y];l.setAttribute("viewBox",p.map(h=>fe(h)).join(" ")),l.setAttribute("width",fe(c.x)),l.setAttribute("height",fe(c.y)),l.setAttribute("version","1.1"),l.setAttribute("baseProfile","full"),l.setAttribute("xmlns",a);let u=new s(l,e,i);return d.eq(e.visibleRect)||u.overrideVisibleRect(d),{element:l,renderer:u}}};var zt=30,Bt=class{constructor(o,e,n,i,r,a){this.presentation=o;this.parent=e;this.viewport=n;this.onDragStart=i;this.onDragUpdate=r;this.onDragEnd=a;this.dragLastPos=null;this.element=document.createElement("div"),this.element.classList.add(`${ge}handle`,`${ge}${o.action}`);let l=document.createElement("div");l.classList.add(`${ge}content`),this.element.appendChild(l),this.parentSide=o.side;let c=o.icon;switch(c&&(l.appendChild(c),c.classList.add("icon")),o.action==="rotate"?this.shape=0:this.shape=1,this.shape){case 0:this.element.classList.add(`${ge}circle`);break;case 1:this.element.classList.add(`${ge}square`);break;default:Ki(this.shape)}this.updatePosition()}addTo(o){o.appendChild(this.element)}remove(){this.element.remove()}getBBoxParentCoords(){let o=this.parent.getScreenRegion(),e=S.of(zt,zt),n=o.size.scale(this.parentSide).minus(e.times(1/2));return new z(n.x,n.y,e.x,e.y)}getBBoxCanvasCoords(){let o=this.parent.region,e=S.of(zt,zt).times(1/this.viewport.getScaleFactor()),n=o.size.scale(this.parentSide).minus(e.times(.5));return new z(n.x,n.y,e.x,e.y).translatedBy(o.topLeft)}updatePosition(){let o=this.getBBoxParentCoords();this.element.style.marginLeft=`${o.topLeft.x}px`,this.element.style.marginTop=`${o.topLeft.y}px`,this.element.style.width=`${o.w}px`,this.element.style.height=`${o.h}px`}containsPoint(o){let e=this.getBBoxCanvasCoords(),n=o.minus(e.center),i=e.size.x/2,r;return this.shape===0?r=n.magnitude()<=i:r=Math.abs(n.x)<=i&&Math.abs(n.y)<=i,r}handleDragStart(o){return this.onDragStart(o.canvasPos),this.dragLastPos=o.canvasPos,!0}handleDragUpdate(o){this.dragLastPos&&this.onDragUpdate(o.canvasPos)}handleDragEnd(){if(this.dragLastPos)return this.onDragEnd()}setSnapToGrid(o){this.snapToGrid=o}isSnappingToGrid(){return this.snapToGrid}};var Mt=class s extends U{constructor(e,n){super("duplicate");this.toDuplicate=e;this.duplicates=e.map((i,r)=>n&&n[r]?i.cloneWithId(n[r]):i.clone()),this.reverse=new ne(this.duplicates)}apply(e){this.reverse.unapply(e)}unapply(e){this.reverse.apply(e)}onDrop(e){this.reverse.onDrop(e)}description(e,n){return this.duplicates.length===0?n.duplicatedNoElements:n.duplicateAction(jo(n,this.duplicates)??n.elements,this.duplicates.length)}serializeToJSON(){return{originalIds:this.toDuplicate.map(e=>e.getId()),cloneIds:this.duplicates.map(e=>e.getId())}}static{U.register("duplicate",(e,n)=>{let i,r;Array.isArray(e)?(i=e,r=[]):(i=e.originalIds,r=e.cloneIds),jt(i),jt(r);let a=[],l=[];for(let c=0;c<i.length;c++){let d=i[c],p=n.image.lookupElement(d);p?(l.push(r[c]),a.push(p)):console.warn("Duplicate command: Could not find element with ID",d)}return new s(a,l)})}};var gt=(e=>(e.Lasso="lasso",e.Rectangle="rect",e))(gt||{});var Jo=class{constructor(o,e){this.editor=o;this.selection=e}onDragStart(o){this.selection.setTransform(I.identity),this.dragStartPoint=o}onDragUpdate(o){let e=this.editor.viewport.roundPoint(o.minus(this.dragStartPoint));this.selection.setTransform(I.translation(e))}onDragEnd(){return this.selection.finalizeTransform()}},en=class{constructor(o,e){this.editor=o;this.selection=e;this.mode=0}onDragStart(o,e){this.selection.setTransform(I.identity),this.mode=e,this.dragStartPoint=o,this.computeOriginAndScaleRate()}computeOriginAndScaleRate(){let o=this.selection.preTransformRegion,e=o.corners,n=0;for(let a=0;a<e.length;a++){let l=e[a],c=this.dragStartPoint.minus(l).magnitudeSquared();c>n&&(n=c,this.transformOrigin=l)}let i=1,r=1;this.transformOrigin.x>o.center.x&&(i=-1),this.transformOrigin.y>o.center.y&&(r=-1),this.scaleRate=S.of(i,r)}onDragUpdate(o){let e=o.minus(this.dragStartPoint),n=this.selection.preTransformRegion.width,i=this.selection.preTransformRegion.height,r=S.of(1,1);if(this.mode===1){let a=n+e.x*this.scaleRate.x;r=S.of(a/n,r.y)}if(this.mode===2){let a=i+e.y*this.scaleRate.y;r=S.of(r.x,a/i)}if(this.mode===0){let a=Math.abs(e.x)>Math.abs(e.y)?e.x:e.y,l=n+a;r=S.of(l/n,l/n)}if(r=r.map(a=>q.roundScaleRatio(a,2)),r.x!==0&&r.y!==0){let a=this.editor.viewport.roundPoint(this.transformOrigin);this.selection.setTransform(I.scaling2D(r,a))}}onDragEnd(){return this.selection.finalizeTransform()}},tn=class{constructor(o,e){this.editor=o;this.selection=e;this.startAngle=0;this.targetRotation=0;this.maximumDistFromStart=0}getAngle(o){let e=this.selection.preTransformRegion.center;return o.minus(e).angle()}roundAngle(o){let e=8/Math.PI;return Math.round(o*e)/e}onDragStart(o){this.startPoint=o,this.selection.setTransform(I.identity),this.startAngle=this.getAngle(o),this.targetRotation=0,this.maximumDistFromStart=0,this.startTime=performance.now()}setRotationTo(o){let e=this.editor.viewport.roundPoint(this.selection.preTransformRegion.center),i=I.zRotation(o).mapEntries(a=>q.roundScaleRatio(a)),r=I.translation(e).rightMul(i).rightMul(I.translation(e.times(-1)));this.selection.setTransform(r)}onDragUpdate(o){this.targetRotation=this.roundAngle(this.getAngle(o)-this.startAngle),this.setRotationTo(this.targetRotation);let e=o.minus(this.startPoint).magnitude();e>this.maximumDistFromStart&&(this.maximumDistFromStart=e)}onDragEnd(){return(performance.now()-this.startTime)/1e3<.4&&this.maximumDistFromStart<10&&this.targetRotation===0&&this.setRotationTo(-Math.PI/2),this.selection.finalizeTransform()}};var di=40,no=class{constructor(o,e,n,i,r){this.parent=o;this.viewport=e;this.icon=n;this.localization=r;this.lastDragPointer=null;this.element=document.createElement("div"),this.element.classList.add(`${ge}handle`,`${ge}selection-menu`),this.element.style.setProperty("--vertical-offset",`${di}px`),this.onClick=()=>{this.button?.focus({preventScroll:!0});let a=this.getBBoxCanvasCoords().center;i(a)},this.initUI(),this.updatePosition()}initUI(){let o=document.createElement("button");this.icon.classList.add("icon"),o.replaceChildren(this.icon),o.ariaLabel=this.localization.selectionMenu__show,o.title=o.ariaLabel,this.button=o,o.onkeydown=e=>{e.key==="Enter"&&(e.preventDefault(),this.onClick())},this.element.appendChild(o),requestAnimationFrame(()=>{this.updatePosition()})}addTo(o){o.appendChild(this.element)}remove(){this.element.remove()}getElementScreenSize(){return S.of(this.element.clientWidth,this.element.clientHeight)}getBBoxParentCoords(){let o=S.of(0,-di),e=this.getElementScreenSize();return new z(o.x,o.y,e.x,e.y)}getBBoxCanvasCoords(){let o=this.parent.region,e=this.viewport.getSizeOfPixelOnCanvas(),n=this.getElementScreenSize().times(e),i=di/this.viewport.getScaleFactor(),r=S.of(o.x,o.y-i),a=S.of(48,48).times(e);return new z(r.x,r.y,n.x,n.y).grownToSize(a)}updatePosition(){let o=this.getBBoxParentCoords();this.element.style.marginLeft=`${o.topLeft.x}px`,this.element.style.marginTop=`${o.topLeft.y}px`}containsPoint(o){return this.getBBoxCanvasCoords().containsPoint(o)}handleDragStart(o){return this.lastDragPointer=o,!0}handleDragUpdate(o){this.lastDragPointer=o}handleDragEnd(){this.lastDragPointer&&this.containsPoint(this.lastDragPointer.canvasPos)&&this.onClick(),this.lastDragPointer=null}};var ui=100,Pr=500,io=class s{constructor(o,e,n){this.editor=e;this.selectionTightBoundingBox=null;this.transform=I.identity;this.selectedElems=[];this.hasParent=!0;this.removedFromImage={};this.activeHandle=null;this.backgroundDragging=!1;this.selectionDuplicatedAnimationTimeout=null;o=[...o],this.selectedElems=o,this.originalRegion=z.empty,this.transformers={drag:new Jo(e,this),resize:new en(e,this),rotate:new tn(e,this)},this.outerContainer=document.createElement("div"),this.outerContainer.classList.add(`${ge}selection-outer-container`),this.innerContainer=document.createElement("div"),this.innerContainer.classList.add(`${ge}selection-inner-container`),this.backgroundElem=document.createElement("div"),this.backgroundElem.classList.add(`${ge}selection-background`),this.innerContainer.appendChild(this.backgroundElem),this.outerContainer.appendChild(this.innerContainer);let i=(p,u)=>{let h={0:"resize-xy",1:"resize-x",2:"resize-y"};return new Bt({action:h[p],side:u},this,this.editor.viewport,f=>this.transformers.resize.onDragStart(f,p),f=>this.transformers.resize.onDragUpdate(f),()=>this.transformers.resize.onDragEnd())},r=[i(1,S.of(0,.5)),i(1,S.of(1,.5))],a=i(2,S.of(.5,1)),l=i(0,S.of(1,1)),c=new Bt({action:"rotate",side:S.of(.5,0),icon:this.editor.icons.makeRotateIcon()},this,this.editor.viewport,p=>this.transformers.rotate.onDragStart(p),p=>this.transformers.rotate.onDragUpdate(p),()=>this.transformers.rotate.onDragEnd()),d=new no(this,this.editor.viewport,this.editor.icons.makeOverflowIcon(),n,this.editor.localization);this.childwidgets=[d,l,...r,a,c];for(let p of this.childwidgets)p.addTo(this.backgroundElem);this.recomputeRegion(),this.updateUI()}getBackgroundElem(){return this.backgroundElem}getTransform(){return this.transform}get preTransformRegion(){return this.originalRegion}get region(){let o=I.zRotation(this.regionRotation,this.originalRegion.center),e=this.transform.rightMul(o.inverse());return this.originalRegion.transformedBoundingBox(e)}computeTightBoundingBox(){return this.selectedElems.reduce((e,n)=>(e??n.getBBox()).union(n.getBBox()),null)??z.empty}get regionRotation(){return this.transform.transformVec3(S.unitX).angle()}get preTransformedScreenRegion(){let o=e=>this.editor.viewport.canvasToScreen(e);return z.fromCorners(o(this.preTransformRegion.topLeft),o(this.preTransformRegion.bottomRight))}get preTransformedScreenRegionRotation(){return this.editor.viewport.getRotationAngle()}getScreenRegion(){let o=this.editor.viewport.canvasToScreenTransform,e=this.editor.viewport.getScaleFactor(),n=o.transformVec2(this.region.center);return new z(n.x,n.y,e*this.region.width,e*this.region.height).translatedBy(this.region.size.times(-e/2))}get screenRegionRotation(){return this.regionRotation+this.editor.viewport.getRotationAngle()}setTransform(o,e=!0){this.transform=o,e&&this.hasParent&&this.previewTransformCmds()}getDeltaZIndexToMoveSelectionToTop(){if(this.selectedElems.length===0)return 0;let o=this.selectedElems[0].getZIndex(),e=this.editor.image.getComponentsIntersecting(this.region);return(e[e.length-1]?.getZIndex()??o)+1-o}finalizeTransform(){let o=this.transform,e=this.selectedElems;this.originalRegion=this.originalRegion.transformedBoundingBox(this.transform),this.transform=I.identity,this.scrollTo();let n;if(this.selectedElems.length>0){let i=this.getDeltaZIndexToMoveSelectionToTop();n=this.editor.dispatch(new s.ApplyTransformationCommand(this,e,this.originalRegion.center,o,i))}return n}sendToBack(){let e=this.editor.image.getComponentsIntersecting(this.editor.viewport.visibleRect)[0]?.getZIndex()??0,n=this.selectedElems[this.selectedElems.length-1]?.getZIndex()??0,r=e-1-n;if(r!==0){let a=this.selectedElems.map(l=>l.setZIndex(l.getZIndex()+r));return he(a,ui)}return null}static{U.register("selection-tool-transform",(o,e)=>{let n=o.transform,i=o.selectionCenter??[0,0],r=o.elems??[];Ye(n),Ye(i),jt(r);let a=new I(...n),l=r,c=parseInt(o.deltaZIndex??0),d=S.of(i[0]??0,i[1]??0);return new this.ApplyTransformationCommand(null,l,d,a,c)})}static{this.ApplyTransformationCommand=class extends U{constructor(e,n,i,r,a){super("selection-tool-transform");this.selection=e;this.selectionCenter=i;this.fullTransform=r;this.deltaZIndex=a;(c=>typeof c[0]=="string")(n)?this.selectedElemIds=n:(this.selectedElemIds=n.map(c=>c.getId()),this.transformCommands=n.map(c=>c.setZIndexAndTransformBy(this.fullTransform,c.getZIndex()+a)))}resolveToElems(e,n){this.transformCommands||(this.transformCommands=this.selectedElemIds.map(i=>{let r=e.image.lookupElement(i);if(!r)return console.warn(`Unable to find element with ID, ${i}.`),null;let a=r.getZIndex(),l=r.getZIndex()+this.deltaZIndex;return n&&(l=r.getZIndex(),a=r.getZIndex()-this.deltaZIndex),r.setZIndexAndTransformBy(this.fullTransform,l,a)}).filter(i=>i!==null))}async apply(e){this.resolveToElems(e,!1),this.selection?.setTransform(this.fullTransform,!1),this.selection?.updateUI(),await e.asyncApplyCommands(this.transformCommands,ui),this.selection?.setTransform(I.identity,!1),this.selection?.recomputeRegion(),this.selection?.updateUI()}async unapply(e){this.resolveToElems(e,!0),this.selection?.setTransform(this.fullTransform.inverse(),!1),this.selection?.updateUI(),await e.asyncUnapplyCommands(this.transformCommands,ui,!0),this.selection?.setTransform(I.identity,!1),this.selection?.recomputeRegion(),this.selection?.updateUI()}serializeToJSON(){return{elems:this.selectedElemIds,transform:this.fullTransform.toArray(),deltaZIndex:this.deltaZIndex,selectionCenter:this.selectionCenter.asArray()}}description(e,n){return n.transformedElements(this.selectedElemIds.length,wt(this.selectionCenter,this.fullTransform,!1,n))}}}previewTransformCmds(){if(this.selectedElems.length===0)return;if(this.selectedElems.length>Pr){this.updateUI();return}let o=this.editor.display.getWetInkRenderer();o.clear(),o.pushTransform(this.transform);let n=this.editor.viewport.visibleRect.union(this.region).transformedBoundingBox(this.transform.inverse());for(let i of this.selectedElems)i.render(o,n);o.popTransform(),this.updateUI()}recomputeRegion(){let o=this.computeTightBoundingBox();return this.selectionTightBoundingBox=o,o?(this.originalRegion=o,this.padRegion(),!0):(this.cancelSelection(),!1)}padRegion(){let o=this.selectionTightBoundingBox??this.originalRegion,e=this.getMinCanvasSize();if(o.w<e||o.h<e){let n=e/2;this.originalRegion=z.bboxOf(o.corners,n),this.updateUI()}}getMinCanvasSize(){return zt/this.editor.viewport.getScaleFactor()*2}getSelectedItemCount(){return this.selectedElems.length}updateUI(){if(!this.hasParent)return;let o=this.getScreenRegion();this.backgroundElem.style.marginLeft=`${o.topLeft.x}px`,this.backgroundElem.style.marginTop=`${o.topLeft.y}px`,this.backgroundElem.style.width=`${o.width}px`,this.backgroundElem.style.height=`${o.height}px`;let e=this.screenRegionRotation*180/Math.PI;this.backgroundElem.style.transform=`rotate(${e}deg)`,this.backgroundElem.style.transformOrigin="center";let n=`${ge}rotated-near-perpendicular`;Math.abs(Math.sin(this.screenRegionRotation))>.5?this.innerContainer.classList.add(n):this.innerContainer.classList.remove(n),o.width===0&&o.height===0?this.innerContainer.classList.add("-empty"):this.innerContainer.classList.remove("-empty");for(let i of this.childwidgets)i.updatePosition(this.getScreenRegion())}addRemoveSelectionFromImage(o){if(!(!o&&this.selectedElems.length>Pr)){for(let e of this.selectedElems){let n=this.editor.image.findParent(e);!o&&n?(this.removedFromImage[e.getId()]=!0,n.remove()):!n&&this.removedFromImage[e.getId()]&&(Q.addComponent(e).apply(this.editor),this.removedFromImage[e.getId()]=!1,delete this.removedFromImage[e.getId()])}this.editor.queueRerender().then(()=>{o?this.editor.display.getWetInkRenderer().clear():this.previewTransformCmds()})}}removeDeletedElemsFromSelection(){this.selectedElems=this.selectedElems.filter(o=>{let e=!!this.editor.image.findParent(o),n=this.removedFromImage[o.getId()];return e||n})}onDragStart(o){if(this.selectedElems.length===0)return!1;document.getSelection()?.removeAllRanges(),this.activeHandle=null;let e=!1;this.backgroundDragging=!1,this.region.containsPoint(o.canvasPos)&&(this.backgroundDragging=!0,e=!0);for(let n of this.childwidgets)n.containsPoint(o.canvasPos)&&(this.activeHandle=n,this.backgroundDragging=!1,e=!0);return e&&(this.removeDeletedElemsFromSelection(),this.addRemoveSelectionFromImage(!1)),this.activeHandle&&this.activeHandle.handleDragStart(o),this.backgroundDragging&&this.transformers.drag.onDragStart(o.canvasPos),e}onDragUpdate(o){this.backgroundDragging&&this.transformers.drag.onDragUpdate(o.canvasPos),this.activeHandle&&this.activeHandle.handleDragUpdate(o)}onDragEnd(){this.backgroundDragging?this.transformers.drag.onDragEnd():this.activeHandle&&this.activeHandle.handleDragEnd(),this.addRemoveSelectionFromImage(!0),this.backgroundDragging=!1,this.activeHandle=null,this.updateUI()}onDragCancel(){this.backgroundDragging=!1,this.activeHandle=null,this.setTransform(I.identity),this.addRemoveSelectionFromImage(!0),this.updateUI()}scrollTo(){if(this.selectedElems.length===0)return!1;let o=this.editor.viewport.getScreenRectSize(),e=new z(0,0,o.x,o.y),n=this.getScreenRegion();if(!e.containsPoint(n.center)){let i=n.center,r=e.getClosestPointOnBoundaryTo(i),a=this.editor.viewport.screenToCanvas(r),l=this.region.center,c=a.minus(l);return this.editor.dispatchNoAnnounce(q.transformBy(I.translation(c.times(.5))),!1),this.editor.queueRerender().then(()=>{this.previewTransformCmds()}),!0}return!1}deleteSelectedObjects(){return(this.backgroundDragging||this.activeHandle)&&this.onDragEnd(),new ne(this.selectedElems)}runSelectionDuplicatedAnimation(){this.selectionDuplicatedAnimationTimeout&&clearTimeout(this.selectionDuplicatedAnimationTimeout);let o=400;this.backgroundElem.style.animation=`${o}ms ease selection-duplicated-animation`,this.selectionDuplicatedAnimationTimeout=setTimeout(()=>{this.backgroundElem.style.animation="",this.selectionDuplicatedAnimationTimeout=null},o)}async duplicateSelectedObjects(){let o=this.backgroundDragging||this.activeHandle,e=null;o||this.runSelectionDuplicatedAnimation();let n;if(o){let r=this.getDeltaZIndexToMoveSelectionToTop();e=new s.ApplyTransformationCommand(null,this.selectedElems,this.region.center,this.transform,r),await e.apply(this.editor),this.addRemoveSelectionFromImage(!0),n=he(this.selectedElems.map(a=>Q.addComponent(a.clone()))),await e?.unapply(this.editor),this.addRemoveSelectionFromImage(!1),this.previewTransformCmds(),this.updateUI()}else n=new Mt(this.selectedElems);return n}snapSelectedObjectsToGrid(){let o=this.editor.viewport,e=this.computeTightBoundingBox().topLeft,i=o.snapToGrid(e).minus(e),r=this.getTransform();this.setTransform(r.rightMul(I.translation(i))),this.finalizeTransform()}setHandlesVisible(o){o?this.innerContainer.classList.remove("-hide-handles"):this.innerContainer.classList.add("-hide-handles")}addTo(o){this.outerContainer.parentElement&&this.outerContainer.remove(),o.appendChild(this.outerContainer),this.hasParent=!0}setToPoint(o){this.originalRegion=this.originalRegion.grownToPoint(o),this.selectionTightBoundingBox=null,this.updateUI()}cancelSelection(){this.outerContainer.parentElement&&this.outerContainer.remove(),this.originalRegion=z.empty,this.selectionTightBoundingBox=null,this.hasParent=!1}getSelectedObjects(){return[...this.selectedElems]}};var ro=class{constructor(o,e){this.viewport=o;this.scrollByCanvasDelta=e;this.started=!1;this.updateLoopId=0;this.updateLoopRunning=!1;this.targetPoint=null;this.scrollRate=1e3}getScrollForPoint(o){let e=this.viewport.getScreenRectSize(),n=new z(0,0,e.x,e.y),i=44,r=n.grownBy(-i);if(r.containsPoint(o))return S.zero;let a=r.getClosestPointOnBoundaryTo(o),l=a.distanceTo(o),c=a.minus(o),p=Math.min(l/i,1.25);return c.normalizedOrZero().times(p)}start(){this.started=!0}onPointerMove(o){this.started&&(this.getScrollForPoint(o)===S.zero?this.stopUpdateLoop():(this.targetPoint=o,this.startUpdateLoop()))}stop(){this.targetPoint=null,this.started=!1,this.stopUpdateLoop()}startUpdateLoop(){this.updateLoopRunning||(async()=>{this.updateLoopId++;let o=this.updateLoopId,e=performance.now();for(;this.updateLoopId===o&&this.targetPoint;){this.updateLoopRunning=!0;let n=performance.now(),i=n-e,a=this.getScrollForPoint(this.targetPoint).times(this.scrollRate*i/1e3);this.scrollByCanvasDelta(this.viewport.screenToCanvasTransform.transformVec3(a)),e=n,await at()}this.updateLoopRunning=!1})()}stopUpdateLoop(){this.updateLoopId++}};var ra=s=>new Promise(o=>{setTimeout(()=>o(),s)}),on=ra;var sa=0,aa=async(s,o,e)=>{let n=document.createElement("div"),{remove:i}=s.createHTMLOverlay(n),r=document.createElement("dialog");r.classList.add("editor-popup-menu");let a=240;r.style.setProperty("--hide-menu-animation-timeout",`${a}ms`);let l=()=>{let u=s.getOutputBBoxInDOM(),h=s.viewport.canvasToScreen(o).plus(u.topLeft);r.style.setProperty("--anchor-x",`${h.x}px`),r.style.setProperty("--anchor-y",`${h.y}px`)};l();let c=s.notifier.on(7,l);n.appendChild(r);let d=!1,p=async()=>{d||(d=!0,c.remove(),r.classList.add("-hide"),await on(a),r.close())};return new Promise(u=>{let h=!1,f=null,v=()=>{h||(u(f),h=!0)};r.onclose=()=>{i(),v()};let x=m=>{f=m,p(),v()};s.handlePointerEventsExceptClicksFrom(r,(m,C)=>C.target===r&&m==="pointerdown"?(p(),!0):!!d,(m,C)=>C.target===r);let g=document.createElement("div");g.classList.add("content"),g.role="menu";let y=[];g.addEventListener("keydown",m=>{let C=y.findIndex(w=>w===document.activeElement);if(C===-1)return;let P=C;m.key==="ArrowDown"?P++:m.key==="ArrowUp"?P--:m.key==="End"?P=y.length-1:m.key==="Home"&&(P=0),P<0&&(P+=y.length),P%=y.length,P!==C&&(m.preventDefault(),y[P].focus())});for(let m of e){let C=document.createElement("button");C.id=`menu-overlay-option-${sa++}`,C.role="menuitem",C.classList.add("option","editor-popup-menu-option"),C.replaceChildren(m.icon(),document.createTextNode(m.text)),C.onclick=P=>{P.defaultPrevented||x(m.key)},g.appendChild(C),y.length===0&&(C.autofocus=!0),y.push(C)}r.appendChild(g),r.showModal(),g.scrollIntoView({block:"nearest"})})},Er=aa;var la=async(s,o={})=>{try{let e=new FileReader;return await new Promise((n,i)=>{e.onload=()=>n(e.result),e.onerror=i,e.onabort=i,e.onprogress=r=>{o.onprogress?.(r)},e.readAsDataURL(s)})}catch(e){(o.onWarning??console.warn)("Unable to convert file to base64 with a FileReader: ",e);let n=await s.arrayBuffer(),i=new Uint8Array(n),r=30,a=[];for(let l=0;l<i.length;l+=r){let c=String.fromCharCode(...i.slice(l,l+r));a.push(btoa(c))}return`data:${s.type??"image/*"};base64,${a.join("")}`}},nn=la;var kr=s=>s.endsWith("+xml")||s.startsWith("text/"),Ve=class{constructor(o,e){this.editor=o;this.callbacks=e}#e=!1;paste(o){let e=n=>{if(this.callbacks?.onPasteError)return this.callbacks.onPasteError(n),Promise.resolve(!1);throw n};try{return this.pasteInternal(o).catch(e)}catch(n){return e(n)}}async pasteInternal(o){let e=this.editor,n=o?.dataTransfer??o?.clipboardData??null,i=!!n,r=(u,h)=>h&&e.toolController.dispatchInputEvent({kind:8,mime:u,data:h}),a=["image/svg+xml","text/html","image/png","image/jpeg","text/plain"],l=[],c=new Map,d=e.getCurrentSettings();if(i){l=[...n.files];for(let u of a){let h=n.getData(u);h&&c.set(u,h)}}else if(d.clipboardApi){let u=await d.clipboardApi.read();for(let[h,f]of u.entries())if(typeof f=="string")c.set(h,f);else{let v=f;v.type!==h&&(v=new Blob([v],{type:h})),l.push(v)}}else{let u=await navigator.clipboard.read();for(let h of u)for(let f of h.types)a.includes(f)&&l.push(await h.getType(f))}let p=async u=>{let h=kr(u);if(h){let f=c.get(u);if(r(u,f))return o?.preventDefault(),!0}for(let f of l)if(f?.type?.toLowerCase()===u)if(h){let x=await f.text();if(r(u,x))return o?.preventDefault(),!0}else{e.showLoadingWarning(0);let x=g=>{e.showLoadingWarning(g.loaded/g.total)};try{let g=await nn(f,{onprogress:x});if(r(u,g))return o?.preventDefault(),e.hideLoadingWarning(),!0}catch(g){console.error("Error reading image:",g)}e.hideLoadingWarning()}return!1};for(let u of a)if(await p(u))return!0;return!1}copy(o){let e=n=>{if(this.callbacks?.onCopyError)return this.callbacks.onCopyError(n),Promise.resolve();throw n};try{return this.copyInternal(o).catch(e)}catch(n){return e(n)}}copyInternal(o){let e=new Map;this.editor.toolController.dispatchInputEvent({kind:7,setData:(p,u)=>{e.set(p,u)}})&&o?.preventDefault();let i=[...e.keys()].some(p=>!kr(p)),r=p=>{if(!o)throw new Error(`Unable to copy -- no event provided${p?`. Original error: ${p}`:""}`);for(let[u,h]of e.entries())typeof h=="string"&&("clipboardData"in o?o.clipboardData?.setData(u,h):o.dataTransfer?.setData(u,h))},a=()=>{let h=(f=>{let v=Object.create(null);for(let[x,g]of Object.entries(f))"supports"in ClipboardItem&&typeof ClipboardItem.supports=="function"&&!ClipboardItem.supports(x)||(v[x]=g);return v})((f=>{let v=Object.create(null);for(let[x,g]of f.entries()){if(typeof g=="string"){let y=new Blob([new TextEncoder().encode(g)],{type:x});v[x]=y}else v[x]=g;x==="image/svg+xml"&&(v["text/html"]??=v[x])}return v})(e));return navigator.clipboard.write([new ClipboardItem(h)])},l=typeof ClipboardItem<"u"&&typeof navigator?.clipboard?.write<"u",c=!this.#e&&l&&(i||!o),d=this.editor.getCurrentSettings();if(c&&d.clipboardApi)return d.clipboardApi.write(e)??Promise.resolve();if(c){let p=null,u=h=>{console.warn("Unable to copy to the clipboard API. Future calls to .copy will use ClipboardEvents if possible.",h),this.#e=!0,r(h)};try{p=a()}catch(h){u(h)}if(p)return p.catch(u)}else r();return Promise.resolve()}};var ca=(s,o)=>{let e=document.createElement("div"),{remove:n}=s.createHTMLOverlay(e);e.classList.add("dialog-container","message-dialog-container",...o.classNames??[]);let i=document.createElement("dialog"),r=document.createElement("div");r.classList.add("message-dialog-content",...o.contentClassNames??[]);let a=document.createElement("h1");a.textContent=o.title,a.setAttribute("autofocus","true");let l=document.createElement("button");l.innerText=s.localization.closeDialog,l.classList.add("close");let c=document.createElement("div");c.classList.add("scroll"),c.onwheel=h=>h.stopPropagation(),r.replaceChildren(a,c,l),i.replaceChildren(r),e.replaceChildren(i);let d=300;i.style.setProperty("--close-delay",`${d}ms`);let p=async()=>{i.classList.add("-closing"),await on(d),i.close()};return(()=>{i.addEventListener("pointerdown",h=>{h.target===i&&p()}),i.onclose=()=>{n()},l.onclick=()=>p()})(),i.showModal(),{close:()=>p(),appendChild:h=>{c.appendChild(h)}}},pi=ca;var da=s=>{let o=e=>{let n=pi(s,{title:s.localization.copyPasteError__heading,classNames:["clipboard-error-dialog"]});n.appendChild(document.createTextNode(s.localization.copyPasteError__description));let i=document.createElement("details"),r=document.createElement("summary");return r.textContent=s.localization.copyPasteError__errorDetails,i.appendChild(r),i.appendChild(document.createTextNode(`Error: ${e}`)),n.appendChild(i),n};return{onCopyError(e){let n=o(e),i=document.createElement("label");i.textContent=s.localization.copyPasteError__copyRetry;let r=document.createElement("textarea");i.appendChild(r);let a=new Ve(s),l=c=>(c.preventDefault(),a.copy(c).then(()=>{n.close()}));r.oncopy=l,r.ondragstart=l,r.value=s.localization.copyPasteError__copyMe,n.appendChild(i),r.select(),document.execCommand("copy")},onPasteError(e){let n=o(e),i=document.createElement("label");i.textContent=s.localization.copyPasteError__pasteRetry;let r=document.createElement("textarea");i.appendChild(r);let a=new Ve(s),l=c=>(c.preventDefault(),a.paste(c).then(d=>{d&&n.close()}));r.onpaste=l,r.ondrop=l,n.appendChild(i),r.focus(),document.execCommand("paste")}}},hi=da;var ua=async(s,o,e,n,i)=>{let r=o.localization,a=s?.getSelectedItemCount()&&n,l=[{text:r.selectionMenu__paste,icon:()=>o.icons.makePasteIcon(),key:()=>{new Ve(o,hi(o)).paste()}}];(await Er(o,e,a?[{text:r.selectionMenu__duplicate,icon:()=>o.icons.makeDuplicateSelectionIcon(),key:async()=>{await o.dispatch(await s.duplicateSelectedObjects())}},{text:r.selectionMenu__delete,icon:()=>o.icons.makeDeleteSelectionIcon(),key:async()=>{await o.dispatch(s.deleteSelectedObjects()),i()}},{text:r.selectionMenu__copyToClipboard,icon:()=>o.icons.makeCopyIcon(),key:()=>{new Ve(o,hi(o)).copy()}},...l]:l))?.()},Rr=ua;var bt=class{render(o,e){o.drawPath(G(this.previewPath(),{fill:e}))}resolve(o,e){let n=this.previewPath(),i=c=>c.filter(d=>d.isSelectable()),r,a=e.getSizeOfPixelOnCanvas()*3;if(n.bbox.maxDimension<=a){let c=e.visibleRect.maxDimension/200,d=n.bbox.grownBy(c);r=o.getComponentsIntersecting(d).filter(p=>d.containsRect(p.getBBox())||p.intersectsRect(d)),r=i(r),r.length>1&&(r=[r[0]])}else r=i(this.resolveInternal(o));return r}};var so=class extends bt{constructor(e,n){super();this.viewport=n;this.boundaryPoints=[];this.boundaryPoints.push(e),this.lastPoint=e}onPointerMove(e){let n=this.boundaryPoints[this.boundaryPoints.length-1],i=this.viewport.getSizeOfPixelOnCanvas()*8;n.distanceTo(e)>=i&&this.boundaryPoints.push(e),this.lastPoint=e}previewPath(){let e=this.boundaryPoints.map(n=>({kind:0,point:n}));return e.push({kind:0,point:this.lastPoint}),new W(this.boundaryPoints[0],e).asClosed()}resolveInternal(e){let n=this.previewPath(),i=n.polylineApproximation(),r=e.getComponentsIntersecting(n.bbox),a=l=>{if(n.closedContainsRect(l.getExactBBox()))return!0;let c=!1;for(let d of l.keyPoints())if(n.closedContainsPoint(d)){c=!0;break}if(!c)return!1;for(let d of i)if(l.intersects(d))return!1;return!0};return r.filter(a)}};var ao=class extends bt{constructor(o){super(),this.rect=z.fromCorners(o,o)}onPointerMove(o){this.rect=this.rect.grownToPoint(o)}previewPath(){return W.fromRect(this.rect)}resolveInternal(o){return o.getComponentsIntersecting(this.rect).filter(e=>e.intersectsRect(this.rect))}};var ge="selection-tool-";var ze=class extends K{constructor(e,n){super(e.notifier,n);this.editor=e;this.removeSelectionScheduled=!1;this.startPoint=null;this.expandingSelectionBox=!1;this.shiftKeyPressed=!1;this.snapToGrid=!1;this.lastPointer=null;this.showContextMenu=async(e,n=!0)=>{await Rr(this.selectionBox,this.editor,e,n,()=>this.clearSelection())};this.selectionBoxHandlingEvt=!1;this.lastSelectedObjects=[];this.hasUnfinalizedTransformFromKeyPress=!1;this.modeValue=re.fromInitialValue("rect"),this.modeValue.onUpdate(()=>{this.editor.notifier.dispatch(2,{kind:2,tool:this})}),this.autoscroller=new ro(e.viewport,i=>{if(e.dispatch(q.transformBy(I.translation(i)),!1),this.lastPointer){let r=this.lastPointer.withScreenPosition(this.lastPointer.screenPos,e.viewport);this.onMainPointerUpdated(r)}}),this.handleOverlay=document.createElement("div"),e.createHTMLOverlay(this.handleOverlay),this.handleOverlay.style.display="none",this.handleOverlay.classList.add("handleOverlay"),e.notifier.on(7,i=>{this.editor.clearWetInk(),this.expandingSelectionBox||this.selectionBox?.padRegion(),this.selectionBox?.updateUI()}),this.editor.handleKeyEventsFrom(this.handleOverlay),this.editor.handlePointerEventsFrom(this.handleOverlay)}getSelectionColor(){let e=getComputedStyle(this.handleOverlay).getPropertyValue("--selection-background-color");return M.fromString(e).withAlpha(.5)}makeSelectionBox(e){this.prevSelectionBox=this.selectionBox,this.selectionBox=new io(e,this.editor,this.showContextMenu),this.expandingSelectionBox||this.prevSelectionBox?.cancelSelection(),this.selectionBox.addTo(this.handleOverlay)}onContextMenu(e){let n=this.selectionBox?.getScreenRegion()?.containsPoint(e.screenPos);return this.showContextMenu(e.canvasPos,n),!0}onPointerDown({allPointers:e,current:n}){let i=this.snapToGrid;if(i&&(n=n.snappedToGrid(this.editor.viewport)),e.length===1){this.startPoint=n.canvasPos;let r=!1;return this.selectionBox&&(i&&this.selectionBox.snapSelectedObjectsToGrid(),this.selectionBox.onDragStart(n)&&(r=!0,this.selectionBoxHandlingEvt=!0,this.expandingSelectionBox=!1)),r?this.autoscroller.start():(this.expandingSelectionBox=this.shiftKeyPressed,this.removeSelectionScheduled=!this.expandingSelectionBox,this.modeValue.get()==="lasso"?this.selectionBuilder=new so(n.canvasPos,this.editor.viewport):this.selectionBuilder=new ao(n.canvasPos)),!0}return!1}onPointerMove(e){this.onMainPointerUpdated(e.current)}onMainPointerUpdated(e){if(this.lastPointer=e,this.removeSelectionScheduled&&(this.removeSelectionScheduled=!1,this.handleOverlay.replaceChildren(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null),this.autoscroller.onPointerMove(e.screenPos),!this.expandingSelectionBox&&this.shiftKeyPressed&&this.startPoint){let n=this.editor.viewport.canvasToScreen(this.startPoint);e=e.lockedToXYAxesScreen(n,this.editor.viewport)}this.snapToGrid&&(e=e.snappedToGrid(this.editor.viewport)),this.selectionBoxHandlingEvt?this.selectionBox?.onDragUpdate(e):(this.selectionBuilder?.onPointerMove(e.canvasPos),this.editor.clearWetInk(),this.selectionBuilder?.render(this.editor.display.getWetInkRenderer(),this.getSelectionColor()))}onPointerUp(e){if(this.onMainPointerUpdated(e.current),this.autoscroller.stop(),this.selectionBoxHandlingEvt)this.selectionBox?.onDragEnd();else if(this.selectionBuilder){let n=this.selectionBuilder.resolve(this.editor.image,this.editor.viewport);this.selectionBuilder=null,this.editor.clearWetInk(),this.expandingSelectionBox&&this.selectionBox?this.setSelection([...this.selectionBox.getSelectedObjects(),...n]):this.setSelection(n)}this.expandingSelectionBox=!1,this.removeSelectionScheduled=!1,this.selectionBoxHandlingEvt=!1,this.lastPointer=null}onGestureCancel(){this.selectionBuilder&&(this.selectionBuilder=null,this.editor.clearWetInk()),this.autoscroller.stop(),this.selectionBoxHandlingEvt?this.selectionBox?.onDragCancel():this.removeSelectionScheduled||(this.selectionBox?.cancelSelection(),this.selectionBox=this.prevSelectionBox,this.selectionBox?.addTo(this.handleOverlay),this.selectionBox?.recomputeRegion(),this.prevSelectionBox=null),this.removeSelectionScheduled=!1,this.expandingSelectionBox=!1,this.lastPointer=null,this.selectionBoxHandlingEvt=!1}onSelectionUpdated(){let e=this.selectionBox?.getSelectedItemCount()??0,n=this.selectionBox?.getSelectedObjects()??[];(this.lastSelectedObjects.length!==e||n.some((r,a)=>this.lastSelectedObjects[a]!==r))&&(this.lastSelectedObjects=n,this.editor.notifier.dispatch(2,{kind:2,tool:this}),this.editor.notifier.dispatch(9,{kind:9,selectedComponents:n,tool:this}),e>0&&(this.editor.announceForAccessibility(this.editor.localization.selectedElements(e)),this.zoomToSelection())),e===0&&this.selectionBox&&(this.selectionBox.cancelSelection(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null)}zoomToSelection(){if(this.selectionBox){let e=this.selectionBox.region;this.editor.dispatchNoAnnounce(this.editor.viewport.zoomTo(e,!1),!1)}}onKeyPress(e){let n=this.editor.shortcuts;if(n.matchesShortcut(eo,e))return this.snapToGrid=!0,!0;if(this.selectionBox&&(n.matchesShortcut(Fo,e)||n.matchesShortcut(Ho,e)))return!0;if(n.matchesShortcut(Xt,e))return this.setSelection(this.editor.image.getAllComponents()),!0;if(e.ctrlKey)return!1;if((e.shiftKey||e.key==="Shift")&&(this.shiftKeyPressed=!0,e.key==="Shift"))return!0;let i=0,r=0,a=0,l=0,c=0;n.matchesShortcut(Bn,e)?r-=1:n.matchesShortcut(Mn,e)?r+=1:n.matchesShortcut(Dn,e)?a-=1:n.matchesShortcut(An,e)?a+=1:n.matchesShortcut(On,e)?i+=1:n.matchesShortcut(Vn,e)?i-=1:n.matchesShortcut(Fn,e)?l-=1:n.matchesShortcut(Hn,e)?l+=1:n.matchesShortcut(Nn,e)?c-=1:n.matchesShortcut(Wn,e)?c+=1:n.matchesShortcut(Un,e)?(l-=1,c-=1):n.matchesShortcut($n,e)&&(l+=1,c+=1);let d=r!==0||a!==0||i!==0||l!==0||c!==0;if(!this.selectionBox)d=!1;else if(d){let p=10*this.editor.viewport.getSizeOfPixelOnCanvas(),u=Math.PI/8,h=5/4,f=this.selectionBox.region,v=S.of(h**l,h**c),g=I.zRotation(i*u).mapEntries(P=>q.roundScaleRatio(P)),y=this.editor.viewport.roundPoint(f.center),m=I.scaling2D(v,this.editor.viewport.roundPoint(f.topLeft)).rightMul(I.translation(y).rightMul(g).rightMul(I.translation(y.times(-1)))).rightMul(I.translation(this.editor.viewport.roundPoint(S.of(r,a).times(p)))),C=this.selectionBox.getTransform();this.selectionBox.setTransform(C.rightMul(m)),this.selectionBox.scrollTo(),this.hasUnfinalizedTransformFromKeyPress=!0}return this.selectionBox&&!d&&(e.key==="Delete"||e.key==="Backspace")&&(this.editor.dispatch(this.selectionBox.deleteSelectedObjects()),this.clearSelection(),d=!0),d}onKeyUp(e){let n=this.editor.shortcuts;if(n.matchesShortcut(eo,e))return this.snapToGrid=!1,!0;if(n.matchesShortcut(Xt,e))return!0;if(this.selectionBox&&n.matchesShortcut(Fo,e))return this.selectionBox.duplicateSelectedObjects().then(i=>{this.editor.dispatch(i)}),!0;if(this.selectionBox&&n.matchesShortcut(Ho,e)){let i=this.selectionBox.sendToBack();return i&&this.editor.dispatch(i),!0}return e.shiftKey===!1&&(this.shiftKeyPressed=!1),e.key==="Shift"?(this.shiftKeyPressed=!1,!0):this.hasUnfinalizedTransformFromKeyPress?this.selectionBox?(this.selectionBox.finalizeTransform(),this.hasUnfinalizedTransformFromKeyPress=!1,!0):!1:!0}onCopy(e){if(!this.selectionBox)return!1;let n=this.selectionBox.getSelectedObjects(),i=this.selectionBox.region;if(n.length===0)return!1;let r=new q(()=>{}),l=this.selectionBox.getScreenRegion().size.times(this.editor.display.getDevicePixelRatio()).maximumEntryMagnitude()/(i.size.maximumEntryMagnitude()||1);l=Math.pow(2,Math.ceil(Math.log2(l))),r.updateScreenSize(i.size.times(l)),r.resetTransform(I.scaling2D(l).rightMul(I.translation(i.topLeft.times(-1))));let{element:c,renderer:d}=Le.fromViewport(r,{sanitize:!0,useViewBoxForPositioning:!0}),{element:p,renderer:u}=Qe.fromViewport(r,{maxCanvasDimen:4096}),h=[];for(let f of n)f.render(d),f.render(u),f instanceof ce&&h.push(f.getText());return e.setData("image/svg+xml",c.outerHTML),e.setData("text/html",c.outerHTML),e.setData("image/png",new Promise((f,v)=>{p.toBlob(x=>{x?f(x):v(new Error("Failed to convert canvas to blob."))},"image/png")})),h.length>0&&e.setData("text/plain",h.join(`
`)),!0}setEnabled(e){let n=this.isEnabled();super.setEnabled(e),n!==e&&(this.selectionBox?.cancelSelection(),this.onSelectionUpdated(),this.handleOverlay.replaceChildren(),this.selectionBox=null,this.shiftKeyPressed=!1,this.snapToGrid=!1,this.handleOverlay.style.display=e?"block":"none",e?(this.handleOverlay.tabIndex=0,this.handleOverlay.role="group",this.handleOverlay.ariaLabel=this.editor.localization.selectionToolKeyboardShortcuts):this.handleOverlay.tabIndex=-1)}getSelection(){return this.selectionBox}isSelecting(){return!!this.selectionBuilder}getSelectedObjects(){return this.selectionBox?.getSelectedObjects()??[]}setSelection(e){e=e.filter(i=>i.isSelectable()),e.sort((i,r)=>i.getZIndex()-r.getZIndex()),e=e.filter((i,r)=>r>0?i!==e[r-1]:!0);let n=null;for(let i of e)n?n=n.union(i.getBBox()):n=i.getBBox();this.clearSelectionNoUpdateEvent(),n&&this.makeSelectionBox(e),this.onSelectionUpdated()}clearSelectionNoUpdateEvent(){this.handleOverlay.replaceChildren(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null}clearSelection(){this.clearSelectionNoUpdateEvent(),this.onSelectionUpdated()}};var Ir="textEditorOverlay",Je=class extends K{constructor(e,n,i){super(e.notifier,n);this.editor=e;this.localizationTable=i;this.textInputElem=null;this.textMeasuringCtx=null;this.removeExistingCommand=null;let r=e.getCurrentSettings().text?.fonts??[];this.textStyleValue=_.fromInitialValue({size:32,fontFamily:r.length>0?r[0]:"sans-serif",renderingStyle:{fill:M.purple}}),this.textStyleValue.onUpdateAndNow(()=>{this.textStyle=this.textStyleValue.get(),this.updateTextInput(),this.editor.notifier.dispatch(2,{kind:2,tool:this})}),this.contentTransform=_.fromInitialValue(I.identity),this.textEditOverlay=document.createElement("div"),this.textEditOverlay.classList.add(Ir),this.editor.addStyleSheet(`
			.${Ir} textarea {
				background-color: rgba(0, 0, 0, 0);

				white-space: pre;
				overflow: hidden;

				padding: 0;
				margin: 0;
				border: none;
				padding: 0;

				min-width: 100px;
				min-height: 1.1em;
			}
		`),this.anchorControl=this.editor.anchorElementToCanvas(this.textEditOverlay,this.contentTransform)}initTextMeasuringCanvas(){this.textMeasuringCtx??=document.createElement("canvas").getContext("2d")}getTextAscent(e,n){if(this.initTextMeasuringCanvas(),this.textMeasuringCtx){this.textMeasuringCtx.textBaseline="alphabetic",ce.applyTextStyles(this.textMeasuringCtx,n);let i=this.textMeasuringCtx.measureText(e);return i.fontBoundingBoxAscent??i.actualBoundingBoxAscent}return n.size*2/3}flushInput(e=!0){if(!this.textInputElem)return;let n=this.textEditOverlay.parentElement,i=S.of(n?.scrollLeft??0,n?.scrollTop??0),r=this.textInputElem.value.trimEnd();if(this.textInputElem.value="",e){let a=this.textInputElem;this.textInputElem=null,a.remove()}if(r!==""){let a=i.times(-1),l=this.editor.viewport.screenToCanvasTransform.transformVec3(a),c=I.translation(l),d=ce.fromLines(r.split(`
`),c.rightMul(this.contentTransform.get()),this.textStyle),p=Q.addComponent(d);this.removeExistingCommand?(this.removeExistingCommand.unapply(this.editor),this.editor.dispatch(he([this.removeExistingCommand,p])),this.removeExistingCommand=null):this.editor.dispatch(p)}}updateTextInput(){if(!this.textInputElem)return;this.textInputElem.placeholder=this.localizationTable.enterTextToInsert,this.textInputElem.style.fontFamily=this.textStyle.fontFamily,this.textInputElem.style.fontStyle=this.textStyle.fontStyle??"",this.textInputElem.style.fontVariant=this.textStyle.fontVariant??"",this.textInputElem.style.fontWeight=this.textStyle.fontWeight??"",this.textInputElem.style.fontSize=`${this.textStyle.size}px`,this.textInputElem.style.color=this.textStyle.renderingStyle.fill.toHexString(),this.textInputElem.style.margin="0",this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`;let i=this.getTextAscent("Testing!",this.textStyle);this.textInputElem.style.transform=`translate(0, ${-i}px)`,this.textInputElem.style.transformOrigin="top left";let r=Math.floor(this.textStyle.size);this.textInputElem.style.lineHeight=`${r}px`}startTextInput(e,n){this.flushInput(),this.textInputElem=document.createElement("textarea"),this.textInputElem.value=n,this.textInputElem.style.display="inline-block";let i=this.editor.viewport.roundPoint(e),r=-this.editor.viewport.getRotationAngle(),a=S.of(1,1).times(this.editor.viewport.getSizeOfPixelOnCanvas());this.contentTransform.set(I.translation(i).rightMul(I.zRotation(r)).rightMul(I.scaling2D(a))),this.updateTextInput(),setTimeout(()=>this.updateTextInput(),0),this.textInputElem.oninput=()=>{this.textInputElem&&(this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`)},this.textInputElem.onblur=()=>{let l=this.textInputElem;this.flushInput(!1),this.textInputElem=null,l&&l.classList.add("-hiding"),setTimeout(()=>{l?.remove()},0)},this.textInputElem.onkeyup=l=>{l.isComposing||(l.key==="Enter"&&!l.shiftKey?(this.flushInput(),this.editor.focus()):l.key==="Escape"&&(this.textInputElem?.remove(),this.textInputElem=null,this.editor.focus(),this.removeExistingCommand?.unapply(this.editor),this.removeExistingCommand=null))},this.textEditOverlay.replaceChildren(this.textInputElem),setTimeout(()=>this.textInputElem?.focus(),0)}setEnabled(e){super.setEnabled(e),this.isEnabled()||this.flushInput(),this.textEditOverlay.style.display=e?"block":"none"}onPointerDown({current:e,allPointers:n}){if(e.device===1)return!1;if(n.length===1){let i=e.canvasPos,r=S.of(4,4).times(this.editor.viewport.getSizeOfPixelOnCanvas()),a=z.fromCorners(i.minus(r),i.plus(r)),c=this.editor.image.getComponentsIntersecting(a).filter(p=>p instanceof ce),d=this.editor.viewport.visibleRect;if(c=c.filter(p=>!p.getBBox().containsRect(d)),this.flushInput(),c.length>0){let p=c[c.length-1];this.setTextStyle(p.getTextStyle()),this.removeExistingCommand=new ne([p]),this.removeExistingCommand.apply(this.editor),this.startTextInput(p.getBaselinePos(),p.getText()),this.contentTransform.set(p.getTransform()),this.updateTextInput()}else this.removeExistingCommand=null,this.startTextInput(e.canvasPos,"");return!0}return!1}onGestureCancel(){this.flushInput(),this.editor.focus()}setFontFamily(e){e!==this.textStyle.fontFamily&&this.textStyleValue.set({...this.textStyle,fontFamily:e})}setColor(e){e.eq(this.textStyle.renderingStyle.fill)||this.textStyleValue.set({...this.textStyle,renderingStyle:{...this.textStyle.renderingStyle,fill:e}})}setFontSize(e){e!==this.textStyle.size&&this.textStyleValue.set({...this.textStyle,size:e})}getTextStyle(){return this.textStyle}getStyleValue(){return this.textStyleValue}setTextStyle(e){this.textStyleValue.set(e)}onDestroy(){super.onDestroy(),this.anchorControl.remove()}};var Dt=class extends K{constructor(e,n){super(e.notifier,n);this.editor=e;this.colorPreviewListener=null;this.colorSelectListener=null;this.enabledValue().onUpdateAndNow(()=>{this.updateSelectingStatus()})}canReceiveInputInReadOnlyEditor(){return!0}updateSelectingStatus(){let e="pipette--color-selection-in-progress";this.isEnabled()&&this.colorSelectListener&&this.colorPreviewListener?this.editor.getRootElement().classList.add(e):this.editor.getRootElement().classList.remove(e)}setColorListener(e,n){this.colorPreviewListener=e,this.colorSelectListener=n,this.updateSelectingStatus()}clearColorListener(){this.colorPreviewListener=null,this.colorSelectListener=null,this.updateSelectingStatus()}onPointerDown({current:e,allPointers:n}){return this.colorPreviewListener&&n.length===1?(this.colorPreviewListener(this.editor.display.getColorAt(e.screenPos)),!0):!1}onPointerMove({current:e}){this.colorPreviewListener?.(this.editor.display.getColorAt(e.screenPos))}onPointerUp({current:e}){this.colorSelectListener?.(this.editor.display.getColorAt(e.screenPos))}onGestureCancel(){this.colorSelectListener?.(null)}};var vt=class extends K{constructor(e){super(e.notifier,e.localization.changeTool);this.listeners=new Set([])}registerListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}onKeyPress(e){let n=Array.from(this.listeners.values());for(let i of n)if(i(e))return!0;return!1}};var lo=Rt((s,o)=>{let e=o.getSizeOfPixelOnCanvas()*3,n=o.getSizeOfPixelOnCanvas();return new rn(s,n,e,o)}),rn=class{constructor(o,e,n,i){this.startPoint=o;this.minFitAllowed=e;this.viewport=i;this.isFirstSegment=!0;this.pathStartConnector=null;this.mostRecentConnector=null;this.nextCurveStartConnector=null;this.lastUpperBezier=null;this.lastLowerBezier=null;this.parts=[];this.upperSegments=[],this.lowerSegments=[],this.curveFitter=new kt(o,e,n,r=>this.addCurve(r)),this.curveStartWidth=o.width,this.bbox=new z(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}getRenderingStyle(){return{fill:this.startPoint.color??null}}previewCurrentPath(o=!0){let e=this.upperSegments.slice(),n=this.lowerSegments.slice(),i,r,a=this.curveFitter.preview();if(a&&o){let{upperCurveCommand:d,lowerToUpperConnector:p,upperToLowerConnector:u,lowerCurveCommand:h}=this.segmentToPath(a);e.push(d),n.push(h),i=p,r=this.pathStartConnector??[u]}else{if(this.mostRecentConnector===null||this.pathStartConnector===null)return null;i=this.mostRecentConnector,r=this.pathStartConnector}let l,c=n[n.length-1];return c.kind===0||c.kind===1?l=c.point:l=c.endPoint,{startPoint:l,commands:[i,...e.reverse(),...r,...n],style:this.getRenderingStyle()}}previewFullPath(){let o=this.previewCurrentPath();return o?[...this.parts,o]:null}preview(o){let e=this.previewFullPath();if(e){let n=this.viewport.visibleRect;o.startObject(n);for(let i of e)o.drawPath(i);o.endObject()}}build(){return this.curveFitter.finalizeCurrentCurve(),this.isFirstSegment&&this.addCurve(null),new oe(this.previewFullPath())}roundPoint(o){let e=Math.min(this.minFitAllowed,this.curveStartWidth/3);return e<1e-10&&(e=this.minFitAllowed),q.roundPoint(o,e)}shouldStartNewSegment(o,e){if(!this.lastLowerBezier||!this.lastUpperBezier)return!1;let n=(c,d)=>{let p=c.intersectsBezier(d);return p.length?p[0].point:null},i=c=>c.p2.minus(c.p1).normalized(),r=c=>c.p1.minus(c.p0).normalized();if(r(e).dot(i(this.lastUpperBezier))<.35||r(o).dot(i(this.lastLowerBezier))<.35||r(e).dot(i(e))<0||r(o).dot(i(o))<0)return!0;let a=n(o,this.lastUpperBezier),l=n(e,this.lastLowerBezier);return!!(a||l)}addCurve(o){if(!o){if(!this.isFirstSegment)return;let p=q.roundPoint(this.startPoint.width/2.2,Math.min(this.minFitAllowed,this.startPoint.width/4)),u=this.roundPoint(this.startPoint.pos),h=this.startPoint.pos.plus(S.of(p,0));this.lowerSegments.push({kind:3,controlPoint:u.plus(S.of(p,p)),endPoint:u.plus(S.of(0,p))},{kind:3,controlPoint:u.plus(S.of(-p,p)),endPoint:u.plus(S.of(-p,0))},{kind:3,controlPoint:u.plus(S.of(-p,-p)),endPoint:u.plus(S.of(0,-p))},{kind:3,controlPoint:u.plus(S.of(p,-p)),endPoint:u.plus(S.of(p,0))});let f={kind:0,point:h};this.pathStartConnector=[f],this.mostRecentConnector=f;return}let{upperCurveCommand:e,lowerToUpperConnector:n,upperToLowerConnector:i,lowerCurveCommand:r,lowerCurve:a,upperCurve:l,nextCurveStartConnector:c}=this.segmentToPath(o),d=this.shouldStartNewSegment(a,l);if(d){let p=this.previewCurrentPath(!1);p?(this.parts.push(p),this.upperSegments=[],this.lowerSegments=[]):d=!1}(this.isFirstSegment||d)&&(this.pathStartConnector=this.nextCurveStartConnector??[i],this.isFirstSegment=!1),this.mostRecentConnector=n,this.nextCurveStartConnector=c,this.lowerSegments.push(r),this.upperSegments.push(e),this.lastLowerBezier=a,this.lastUpperBezier=l,this.curveStartWidth=o.startWidth}segmentToPath(o){let e=new Ee(o.startPoint,o.controlPoint,o.endPoint),n=e.normal(0),i=e.normal(1);n=n.times(o.startWidth/2),i=i.times(o.endWidth/2),isFinite(n.magnitude())||(console.error("Warning: startVec is NaN or \u221E",n,i,o),n=i);let r=o.startPoint,a=o.endPoint,l=o.controlPoint,d=e.nearestPointTo(l).parameterValue,p=e.normal(d).times(o.startWidth/2*d+o.endWidth/2*(1-d)),u=this.roundPoint(r.plus(n)),h=this.roundPoint(l.plus(p)),f=this.roundPoint(a.plus(i)),v=this.roundPoint(l.minus(p)),x=this.roundPoint(a.minus(i)),g=this.roundPoint(r.minus(n)),y={kind:3,controlPoint:h,endPoint:f},m={kind:0,point:u},C={kind:0,point:x},P=[{kind:0,point:x},{kind:0,point:f}],w={kind:3,controlPoint:v,endPoint:g},E=new Ee(x,v,g),T=new Ee(u,h,f);return{upperCurveCommand:w,upperToLowerConnector:m,lowerToUpperConnector:C,lowerCurveCommand:y,upperCurve:E,lowerCurve:T,nextCurveStartConnector:P}}addPoint(o){this.curveFitter.addPoint(o)}};var co=Rt((s,o)=>{let e=o.getSizeOfPixelOnCanvas()*.65;return new sn(s,e,o)}),sn=class{constructor(o,e,n){this.minFitAllowed=e;this.viewport=n;this.parts=[];this.widthAverageNumSamples=1;this.lastLineSegment=null;this.averageWidth=o.width,this.startPoint={...o,pos:this.roundPoint(o.pos)},this.lastPoint=this.startPoint.pos,this.bbox=new z(this.startPoint.pos.x,this.startPoint.pos.y,0,0),this.parts=[{kind:1,point:this.startPoint.pos}]}getBBox(){return this.bbox.grownBy(this.averageWidth)}getRenderingStyle(){return{fill:M.transparent,stroke:{color:this.startPoint.color,width:this.roundDistance(this.averageWidth)}}}previewCurrentPath(){let o=this.startPoint.pos,e=[...this.parts];return e.length<=1&&e.push({kind:0,point:o.plus(S.of(this.averageWidth/4,0))}),{startPoint:o,commands:e,style:this.getRenderingStyle()}}previewFullPath(){return[this.previewCurrentPath()]}preview(o){let e=this.previewFullPath();if(e){let n=this.viewport.visibleRect;o.startObject(n);for(let i of e)o.drawPath(i);o.endObject()}}build(){return new oe(this.previewFullPath())}getMinFit(){let o=Math.min(this.minFitAllowed,this.averageWidth/4);return o<1e-10&&(o=this.minFitAllowed),o}roundPoint(o){let e=this.getMinFit();return q.roundPoint(o,e)}roundDistance(o){let e=this.getMinFit();return q.roundPoint(o,e)}addPoint(o){this.widthAverageNumSamples++,this.averageWidth=this.averageWidth*(this.widthAverageNumSamples-1)/this.widthAverageNumSamples+o.width/this.widthAverageNumSamples;let e=this.roundPoint(o.pos);e.eq(this.lastPoint)||(this.lastLineSegment&&this.lastLineSegment.direction.dot(e.minus(this.lastPoint).normalized())>.997&&(this.parts.pop(),this.lastPoint=this.lastLineSegment.p1),this.parts.push({kind:0,point:this.roundPoint(o.pos)}),this.bbox=this.bbox.grownToPoint(e),this.lastLineSegment=new pe(this.lastPoint,e),this.lastPoint=e)}};var A="toolbar-";var fi=class{constructor(o,e,n){this.parent=o;this.notifier=e;this.onDestroy=n;this.dropdownToggleListener=null;this.hideDropdownTimeout=null;this.visible=_.fromInitialValue(!1),this.dropdownContainer=document.createElement("div"),this.dropdownContainer.classList.add(`${A}dropdown`),this.dropdownContainer.classList.add("hidden"),o.target.insertAdjacentElement("afterend",this.dropdownContainer),this.dropdownToggleListener=this.notifier.on(0,i=>{i.dropdown!==this&&i.fromToplevelDropdown&&this.setVisible(!1)})}onActivated(){}repositionDropdown(){let o=this.dropdownContainer.getBoundingClientRect(),e=document.scrollingElement?.clientWidth??document.body.clientHeight,n=document.scrollingElement?.clientHeight??document.body.clientHeight,i,r;o.left>e/2&&(i=`calc(${this.parent.target.clientWidth+"px"} - 100%)`),o.bottom>n&&o.top-o.height>0&&(r=`calc(-${this.parent.target.clientHeight}px - 100%)`),i||r?this.dropdownContainer.style.translate=`${i??"0"} ${r??"0"}`:this.dropdownContainer.style.translate=""}setVisible(o){if(this.visible.get()===o)return;this.hideDropdownTimeout&&(clearTimeout(this.hideDropdownTimeout),this.hideDropdownTimeout=null,this.dropdownContainer.classList.remove("hiding"),this.repositionDropdown());let n=150;if(this.visible.set(o),o)this.dropdownContainer.classList.remove("hidden"),this.notifier.dispatch(0,{dropdown:this,fromToplevelDropdown:this.parent.isToplevel()}),this.repositionDropdown();else{this.notifier.dispatch(1,{dropdown:this,fromToplevelDropdown:this.parent.isToplevel()}),this.dropdownContainer.classList.add("hiding");let r=n*.95;this.hideDropdownTimeout=setTimeout(()=>{this.dropdownContainer.classList.add("hidden"),this.dropdownContainer.classList.remove("hiding"),this.repositionDropdown()},r)}let i=`var(--dropdown-${o?"show":"hide"}-animation)`;this.dropdownContainer.style.animation=`${n}ms ease ${i}`}requestShow(){this.setVisible(!0)}requestHide(){this.setVisible(!1)}appendChild(o){this.dropdownContainer.appendChild(o)}clearChildren(){this.dropdownContainer.replaceChildren()}destroy(){this.setVisible(!1),this.dropdownContainer.remove(),this.dropdownToggleListener?.remove(),this.clearChildren(),this.onDestroy()}},uo=class{constructor(o,e){this.localization=e;this.dropdowns=new Set;this.listeners=[];this.connectedNotifiers=[];this.notifier=new Ue,this.notifier.on(0,({dropdown:n,fromToplevelDropdown:i})=>{n&&(o(this.localization.dropdownShown(n.parent.getTitle())),this.connectedNotifiers.forEach(r=>{r.dispatch(13,{kind:13,fromToplevelDropdown:i,layoutManager:this})}))}),this.notifier.on(1,({dropdown:n})=>{n&&o(this.localization.dropdownHidden(n.parent.getTitle()))})}connectToEditorNotifier(o){this.connectedNotifiers.push(o),this.refreshListeners()}createToolMenu(o){let e=new fi(o,this.notifier,()=>{this.dropdowns.delete(e),this.refreshListeners()});return this.dropdowns.add(e),this.refreshListeners(),e}refreshListeners(){let o=()=>{this.listeners.forEach(e=>e.remove()),this.listeners=[]};this.dropdowns.size===0?o():this.listeners.length!==this.connectedNotifiers.length&&(o(),this.listeners=this.connectedNotifiers.map(e=>e.on(13,n=>{n.kind!==13||n.layoutManager===this||this.notifier.dispatch(0,{fromToplevelDropdown:n.fromToplevelDropdown})})))}};var xa=(s,o)=>{let e=new Map,n=null,i=!1,r=()=>{if(e.size===0)i?(i=!1,o.onEnd()):n!==null&&(clearTimeout(n),n=null);else{let l=Date.now(),c=0;for(let u of e.values()){let h=l-u.timeEnter;c=Math.max(h,c)}let d=o.longPressTimeout??700;n!==null&&(clearTimeout(n),n=null);let p=d-c;p<=0?(o.onStart(),i=!0):n=setTimeout(()=>{n=null,r()},p)}},a=l=>{let c={timeEnter:Date.now()};l.type==="pointerenter"?e.set(l.pointerId,c):(l.type==="pointerleave"||l.type==="pointercancel")&&e.clear(),r()};return s.addEventListener("pointerenter",a),s.addEventListener("pointerleave",a),s.addEventListener("pointercancel",a),{removeListeners:()=>{s.removeEventListener("pointerenter",a),s.removeEventListener("pointerleave",a),s.removeEventListener("pointercancel",a)}}},Br=xa;var Ta=(s,o)=>{let e="has-long-press-or-hover",n="no-long-press-or-hover";s.classList.add("no-long-press-or-hover");let{removeListeners:i}=Br(s,{onStart(){s.classList.remove(n),s.classList.add(e)},onEnd(){s.classList.add(n),s.classList.remove(e)},longPressTimeout:o?.timeout});return{removeEventListeners:()=>{s.classList.remove(n),i()}}},et=Ta;var Ca=(s,o)=>{let e=[...o.draggableChildElements,s],n=0,i=0,r=0,a=0,l=!1,c=null,d=g=>{if(!g)return!1;if(e.includes(g))return!0;let y=["INPUT","SELECT","IMG"],m=!1,C=g.parentElement;for(;C&&!y.includes(C.tagName);){if(e.includes(C)){m=!0;break}C=C.parentElement}return!y.includes(g.tagName)&&m},p=[],u=(g,y,m)=>{s.addEventListener(g,y,m),p.push(()=>{s.removeEventListener(g,y)})},h=5,f=()=>Math.hypot(n-r,i-a)<h,v=!1;u("pointerdown",g=>{g.defaultPrevented||!d(g.target)||g.isPrimary&&(v=!1,n=g.clientX,i=g.clientY,r=g.clientX,a=g.clientY,c=null,l=!0)},{passive:!0});let x=g=>{l&&(c!==null&&(s.releasePointerCapture(c),c=null),o.onDragEnd({roughlyClick:f(),endTimestamp:performance.now(),displacement:S.of(n-r,i-a)}),l=!1,v=!1)};return u("pointermove",g=>{if(!g.isPrimary||!l)return;if(g.pointerType==="mouse"&&g.buttons===0){x(g);return}c===null&&!f()&&(s.setPointerCapture(g.pointerId),c=g.pointerId);let y=g.clientX,m=g.clientY,C=y-n,P=m-i;(!(Math.abs(y-r)<=h&&Math.abs(m-a)<=h)||v)&&(o.onDrag(C,P,S.of(y-r,m-a)),n=y,i=m,v=!0)}),u("pointerleave",g=>{c===null&&l&&g.isPrimary&&(s.setPointerCapture(g.pointerId),c=g.pointerId)}),u("pointerup",x),u("pointercancel",x),{removeListeners:()=>{for(let g of p)g()}}},gi=Ca;var Sa=s=>{let o=(n,i)=>{let r=getComputedStyle(n);for(let a=0;a<r.length;a++){let l=r.item(a),c=r.getPropertyValue(l);i.style?.setProperty(l,c)}for(let a=0;a<n.children.length;a++){let l=n.children.item(a),c=i.children.item(a);l&&c?o(l,c):console.warn("CloneElement: Missing child")}},e=s.cloneNode(!0);return o(s,e),e},Mr=Sa;var wa=(s,o,e,n)=>{let i=document.createElement("div");i.classList.add("help-page-container");let r=document.createElement("div");r.classList.add("label","-space-above"),r.setAttribute("aria-live","polite");let a=0,l=s[0]??null,c=[];i.addEventListener("click",x=>{x.target===i&&e()});let d=()=>{if(!l)return z.empty;let x=l.targetElements.map(g=>z.of(g.getBoundingClientRect()));return z.union(...x)},p=()=>{let x=d();for(let g=0;g<c.length;g++)for(let{container:y,bbox:m}of c[g])if(g===a)y.classList.add("-active"),y.classList.remove("-clickable","-background"),y.onclick=()=>{};else{m.containsRect(x)?(y.classList.add("-background"),y.classList.remove("-active","-clickable")):(y.classList.add("-clickable"),y.classList.remove("-active","-background"));let C=g;y.onclick=()=>{o(C)}}},u=()=>{let x=z.of(r.getBoundingClientRect()),g=d();if(x.intersects(g)){let y=z.of(i.getBoundingClientRect()),m=g.topLeft.y,C=y.bottomLeft.y-g.bottomLeft.y;m>C&&m>x.height/3&&(r.classList.remove("-small-space-above","-large-space-above"),r.classList.add("-large-space-below")),m<C&&C>x.height&&(r.classList.add("-large-space-above"),r.classList.remove("-large-space-below"))}},h=()=>{i.replaceChildren(),r.classList.remove("-large-space-above"),r.classList.add("-small-space-above","-large-space-below"),i.appendChild(r);let x=new z(0,0,window.innerWidth,window.innerHeight);c=[];for(let g=0;g<s.length;g++){let y=s[g],m=[];for(let C of y.targetElements){let P=z.of(C.getBoundingClientRect());if(!x.intersects(P)){let T=x.bottomLeft.lerp(x.bottomRight,.5),V=P.bottomLeft.lerp(P.bottomRight,.5),O=T.minus(V);P=P.translatedBy(O)}let w=Mr(C);for(let T of w.querySelectorAll("input"))T.disabled=!0;w.style.margin="0";let E=document.createElement("div");E.classList.add("cloned-element-container"),E.role="group",E.ariaLabel=n.localization.helpControlsAccessibilityLabel,E.style.position="absolute",E.style.left=`${P.topLeft.x}px`,E.style.top=`${P.topLeft.y}px`,E.replaceChildren(w),et(E,{timeout:0}),m.push({container:E,bbox:P}),i.appendChild(E)}c.push(m)}p()},f=()=>{h(),u()},v=()=>{let x=document.createElement("div");x.textContent=l?.helpText??"",x.classList.add("current-item-help");let g=document.createElement("div");g.textContent=n.localization.helpScreenNavigationHelp,g.classList.add("navigation-help"),r.replaceChildren(x,...a===0?[g]:[]),p()};return v(),{addToParent:x=>{h(),x.appendChild(i),u()},refresh:f,setPageIndex:x=>{a=x,l=s[x],v()}}},po=class{constructor(o,e){this.createOverlay=o;this.context=e}#e=[];showHelpOverlay(){let o=document.createElement("dialog");o.setAttribute("autofocus","true"),o.classList.add("toolbar-help-overlay");let e=!1,n=()=>{if(e)return;let m=250;o.classList.add("-hiding"),setTimeout(()=>o.close(),m)},i=0,r=()=>{performance.now()-i<100||n()},a=()=>{let m=document.createElement("button");m.classList.add("close-button"),m.appendChild(this.context.icons.makeCloseIcon());let C=this.context.localization.close;return m.setAttribute("aria-label",C),m.setAttribute("title",C),m.onclick=()=>{n()},m},l=()=>{let m=re.fromInitialValue(0),C=document.createElement("div");C.classList.add("navigation-content");let P=wa(this.#e,T=>m.set(T),r,this.context);P.addToParent(C);let w=T=>{T>=this.#e.length||T<0?(console.warn("Help screen: Navigated to out-of-bounds page",T),C.style.display="none"):(C.style.display="",P.setPageIndex(T))};m.onUpdateAndNow(w);let E={content:C,currentPage:m,toNext:()=>{E.hasNext()&&m.set(m.get()+1)},toPrevious:()=>{E.hasPrevious()&&m.set(m.get()-1)},hasNext:()=>m.get()+1<this.#e.length,hasPrevious:()=>m.get()>0,refreshCurrent:()=>{P.refresh()}};return E},c=m=>{let C=document.createElement("div");C.classList.add("navigation-buttons");let P=document.createElement("button"),w=document.createElement("button");P.textContent=this.context.localization.next,w.textContent=this.context.localization.previous,P.classList.add("next"),w.classList.add("previous");let E=()=>{C.classList.remove("-has-next","-has-previous"),m.hasNext()?(C.classList.add("-has-next"),P.disabled=!1):(C.classList.remove("-has-next"),P.disabled=!0),m.hasPrevious()?(C.classList.add("-has-previous"),w.disabled=!1):(C.classList.remove("-has-previous"),w.disabled=!0)};return m.currentPage.onUpdateAndNow(E),P.onclick=()=>{m.toNext()},w.onclick=()=>{m.toPrevious()},C.replaceChildren(w,P),C},d=l(),p=c(d);o.replaceChildren(a(),p,d.content),this.createOverlay(o),o.showModal();let u=30,h=m=>{m>0&&!d.hasPrevious()&&(m=0),m<0&&!d.hasNext()&&(m=0),(m>u||m<-u)&&(m=u*Math.sign(m)),o.style.transform=`translate(${m}px, 0px)`,m>=u?p.classList.add("-highlight-previous"):p.classList.remove("-highlight-previous"),m<=-u?p.classList.add("-highlight-next"):p.classList.remove("-highlight-next")},f=gi(o,{draggableChildElements:[d.content],onDrag:(m,C,P)=>{o.classList.add("-dragging"),h(P.x)},onDragEnd:m=>{if(o.classList.remove("-dragging"),h(0),!m.roughlyClick){let C=m.displacement.x;C>u?d.toPrevious():C<-u&&d.toNext(),i=m.endTimestamp}}}),v;window.ResizeObserver&&(v=new ResizeObserver(()=>{d.refreshCurrent()}),v.observe(o));let x=()=>{requestAnimationFrame(()=>d.refreshCurrent())},g=window.matchMedia?.("(prefers-color-scheme: dark)");g?.addEventListener("change",x);let y=[d.content,p,o];o.onclick=m=>{y.includes(m.target)&&r()},o.onkeyup=m=>{m.code==="Escape"?(n(),m.preventDefault()):m.code==="ArrowRight"?(d.toNext(),m.preventDefault()):m.code==="ArrowLeft"&&(d.toPrevious(),m.preventDefault())},o.addEventListener("close",()=>{this.context.announceForAccessibility(this.context.localization.helpHidden),g?.removeEventListener("change",x),f.removeListeners(),v?.disconnect(),o.remove()})}registerTextHelpForElement(o,e){this.registerTextHelpForElements([o],e)}registerTextHelpForElements(o,e){this.#e.push({targetElements:[...o],helpText:e})}hasHelpText(){return this.#e.length>0}createToggleButton(){let o=document.createElement("div");o.classList.add("toolbar-help-overlay-button");let e=document.createElement("button");e.classList.add("button");let n=this.context.icons.makeHelpIcon();return n.classList.add("icon"),e.appendChild(n),e.setAttribute("aria-label",this.context.localization.help),e.onclick=()=>{this.showHelpOverlay()},o.appendChild(e),o}};var ae=class s{constructor(o,e,n){this.editor=o;this.id=e;this.dropdown=null;this.disabled=!1;this.#t=!1;this.#o=[];this.subWidgets={};this.toplevel=!0;this.#n=null;this.localizationTable=n??o.localization;let i=new uo(r=>this.editor.announceForAccessibility(r),this.localizationTable);i.connectToEditorNotifier(o.notifier),this.layoutManager=i,this.icon=null,this.container=document.createElement("div"),this.container.classList.add(`${A}toolContainer`,`${A}toolButtonContainer`,`${A}internalWidgetId--${e.replace(/[^a-zA-Z0-9_]/g,"-")}`),this.dropdownContent=document.createElement("div"),this.#e=!1,this.button=document.createElement("div"),this.button.classList.add(`${A}button`),this.label=document.createElement("label"),this.button.setAttribute("role","button"),this.button.tabIndex=0,this.button.oncontextmenu=r=>{r.preventDefault()},et(this.button)}#e;#t;#o;#n;#i(){this.#n?.();let o=this.editor.toolController.getMatchingTools(vt),e=null;if(o.length>0&&this.onKeyPress!==s.prototype.onKeyPress){let i=a=>this.onKeyPress(a),r=o[0];r.registerListener(i),e=()=>{r.removeListener(i)}}let n=this.editor.isReadOnlyReactiveValue().onUpdateAndNow(i=>{i&&this.shouldAutoDisableInReadOnlyEditor()&&!this.disabled?(this.setDisabled(!0),this.#t=!0,this.#e&&this.dropdown?.requestHide()):!i&&this.#t&&(this.#t=!1,this.setDisabled(!1))});this.#n=()=>{n.remove(),e?.(),this.#n=null}}shouldAutoDisableInReadOnlyEditor(){return!0}getId(){return this.id}setTags(o){let e=n=>`toolwidget-tag--${n}`;for(let n of this.#o)this.container.classList.remove(e(n));this.#o=[...o];for(let n of this.#o)this.container.classList.add(e(n))}getTags(){return[...this.#o]}getUniqueIdIn(o){let e=this.getId(),n=0;for(;e in o&&o[e]!==this;)e=this.getId()+"-"+n.toString(),n++;return e}fillDropdown(o,e){if(Object.keys(this.subWidgets).length===0)return!1;for(let n in this.subWidgets){let i=this.subWidgets[n],r=i.addTo(o);i.setIsToplevel(!1);let a=i.getHelpText();a&&e?.registerTextHelpForElement(r,a)}return!0}getHelpText(){}setupActionBtnClickListener(o){return this.setUpButtonEventListeners(o)}setUpButtonEventListeners(o){let e={Enter:!0," ":!0};o.onkeydown=n=>{let i=!1;if(n.key in e&&(this.disabled||(this.handleClick(),i=!0)),!i){let r=In(n);i=this.editor.toolController.dispatchInputEvent(r)}i&&n.preventDefault()},o.onkeyup=n=>{if(n.key in e)return;let i=Rn(n);this.editor.toolController.dispatchInputEvent(i)&&n.preventDefault()},o.onclick=()=>{this.disabled||this.handleClick()},o.ondblclick=n=>{n.preventDefault()}}onKeyPress(o){return!1}get hasDropdown(){return this.#e}addSubWidget(o){let e=o.getUniqueIdIn(this.subWidgets);this.subWidgets[e]=o}setLayoutManager(o){o!==this.layoutManager&&(this.layoutManager=o,this.container.parentElement&&this.addTo(this.container.parentElement))}addTo(o){this.icon=null,this.updateIcon(),this.label.innerText=this.getTitle();let e="long-label";this.label.innerText.length>7?this.label.classList.add(e):this.label.classList.remove(e),this.setUpButtonEventListeners(this.button),this.container.replaceChildren(),this.button.replaceChildren(this.icon,this.label),this.container.appendChild(this.button);let n=new po(r=>this.editor.createHTMLOverlay(r),this.editor),i=this.getHelpText();return i&&n.registerTextHelpForElement(this.dropdownContent,[this.getTitle(),i].join(`

`)),this.dropdownContent.replaceChildren(),this.#e=this.fillDropdown(this.dropdownContent,n),this.#e&&(this.button.classList.add("has-dropdown"),this.dropdown?.destroy(),this.dropdownIcon=this.createDropdownIcon(),this.button.appendChild(this.dropdownIcon),this.dropdown=this.layoutManager.createToolMenu({target:this.button,getTitle:()=>this.getTitle(),isToplevel:()=>this.toplevel}),this.dropdown.visible.onUpdate(r=>{r?this.container.classList.add("dropdownVisible"):this.container.classList.remove("dropdownVisible"),r||this.focus()}),n.hasHelpText()&&this.dropdown.appendChild(n.createToggleButton()),this.dropdown.appendChild(this.dropdownContent)),this.setDropdownVisible(!1),this.container.parentElement&&this.container.remove(),this.#i(),o.appendChild(this.container),this.container}remove(){this.container.remove(),this.#n?.()}focus(){this.button.focus()}addCSSClassToContainer(o){this.container.classList.add(o)}removeCSSClassFromContainer(o){this.container.classList.remove(o)}updateIcon(){let o=this.createIcon();o?this.container.classList.remove("no-icon"):(o=document.createElement("div"),this.container.classList.add("no-icon")),this.icon?.replaceWith(o),this.icon=o,this.icon.classList.add(`${A}icon`)}setDisabled(o){this.disabled=o,this.#t=!1,this.disabled?(this.button.classList.add("disabled"),this.button.setAttribute("aria-disabled","true")):(this.button.classList.remove("disabled"),this.button.removeAttribute("aria-disabled"))}setSelected(o){this.isSelected()!==o&&(this.button.setAttribute("role","switch"),o?(this.container.classList.add("selected"),this.button.setAttribute("aria-checked","true")):(this.container.classList.remove("selected"),this.button.setAttribute("aria-checked","false")))}setDropdownVisible(o){o?this.dropdown?.requestShow():this.dropdown?.requestHide()}activateDropdown(){this.dropdown?.onActivated()}mustBeInToplevelMenu(){return!1}canBeInOverflowMenu(){return!this.mustBeInToplevelMenu()}getButtonWidth(){return this.button.clientWidth}isHidden(){return this.container.style.display==="none"}setHidden(o){this.container.style.display=o?"none":""}setIsToplevel(o){this.toplevel=o}isDropdownVisible(){return this.dropdown?.visible?.get()??!1}isSelected(){return this.container.classList.contains("selected")}createDropdownIcon(){let o=this.editor.icons.makeDropdownIcon();return o.classList.add(`${A}showHideDropdownIcon`),o}serializeState(){let o={};for(let e in this.subWidgets)o[e]=this.subWidgets[e].serializeState();return{subwidgetState:o}}deserializeFrom(o){if(o.subwidgetState){Mo(o.subwidgetState);for(let e in o.subwidgetState)if(e in this.subWidgets){let n=o.subwidgetState[e];n&&this.subWidgets[e].deserializeFrom(n)}}}};var tt=(()=>{return((s,o,e,n)=>{let i=o.createElement("canvas").getContext("2d"),r={r:0,g:0,b:0,h:0,s:0,v:0,a:1},a,l,c,d,p,u,h,f,v,x,g,y,m,C,P,w,E={},T={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:()=>n,a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},V={},O="",$={},ie=!1;function ee(b){if(typeof b=="object")for(let k in b)switch(k){case"el":Fe(b.el),b.wrap!==!1&&Ge(b.el);break;case"parent":a=o.querySelector(b.parent),a&&(a.appendChild(l),T.parent=b.parent,a===o.body&&(a=n));break;case"themeMode":T.themeMode=b.themeMode,b.themeMode==="auto"&&s.matchMedia&&s.matchMedia("(prefers-color-scheme: dark)").matches&&(T.themeMode="dark");case"theme":b.theme&&(T.theme=b.theme),l.className=`clr-picker clr-${T.theme} clr-${T.themeMode}`,T.inline&&Ke();break;case"rtl":T.rtl=!!b.rtl,o.querySelectorAll(".clr-field").forEach(D=>D.classList.toggle("clr-rtl",T.rtl));break;case"margin":b.margin*=1,T.margin=isNaN(b.margin)?T.margin:b.margin;break;case"wrap":b.el&&b.wrap&&Ge(b.el);break;case"formatToggle":T.formatToggle=!!b.formatToggle,ue("clr-format").style.display=T.formatToggle?"block":"none",T.formatToggle&&(T.format="auto");break;case"swatches":if(Array.isArray(b.swatches)){let D=[];b.swatches.forEach((H,Y)=>{D.push(`<button type="button" id="clr-swatch-${Y}" aria-labelledby="clr-swatch-label clr-swatch-${Y}" style="color: ${H};">${H}</button>`)}),ue("clr-swatches").innerHTML=D.length?`<div>${D.join("")}</div>`:"",T.swatches=b.swatches.slice()}break;case"swatchesOnly":T.swatchesOnly=!!b.swatchesOnly,l.setAttribute("data-minimal",T.swatchesOnly);break;case"alpha":T.alpha=!!b.alpha,l.setAttribute("data-alpha",T.alpha);break;case"inline":if(T.inline=!!b.inline,l.setAttribute("data-inline",T.inline),T.inline){let D=b.defaultColor||T.defaultColor;C=yt(D),Ke(),nt(D)}break;case"clearButton":typeof b.clearButton=="object"&&(b.clearButton.label&&(T.clearLabel=b.clearButton.label,h.innerHTML=T.clearLabel),b.clearButton=b.clearButton.show),T.clearButton=!!b.clearButton,h.style.display=T.clearButton?"block":"none";break;case"clearLabel":T.clearLabel=b.clearLabel,h.innerHTML=T.clearLabel;break;case"closeButton":T.closeButton=!!b.closeButton,T.closeButton?l.insertBefore(f,p):p.appendChild(f);break;case"closeLabel":T.closeLabel=b.closeLabel,f.innerHTML=T.closeLabel;break;case"a11y":let R=b.a11y,B=!1;if(typeof R=="object")for(let D in R)R[D]&&T.a11y[D]&&(T.a11y[D]=R[D],B=!0);if(B){let D=ue("clr-open-label"),H=ue("clr-swatch-label");D.innerHTML=T.a11y.open,H.innerHTML=T.a11y.swatch,f.setAttribute("aria-label",T.a11y.close),h.setAttribute("aria-label",T.a11y.clear),v.setAttribute("aria-label",T.a11y.hueSlider),g.setAttribute("aria-label",T.a11y.alphaSlider),u.setAttribute("aria-label",T.a11y.input),c.setAttribute("aria-label",T.a11y.instruction)}break;default:T[k]=b[k]}}function de(b,k){typeof b=="string"&&typeof k=="object"&&(V[b]=k,ie=!0)}function ve(b){delete V[b],Object.keys(V).length===0&&(ie=!1,b===O&&Be())}function se(b){if(ie){let k=["el","wrap","rtl","inline","defaultColor","a11y"];for(let R in V){let B=V[R];if(b.matches(R)){O=R,$={},k.forEach(D=>delete B[D]);for(let D in B)$[D]=Array.isArray(T[D])?T[D].slice():T[D];ee(B);break}}}}function Be(){Object.keys($).length>0&&(ee($),O="",$={})}function Fe(b){j(o,"click",b,k=>{T.inline||(se(k.target),m=k.target,P=m.value,C=yt(P),l.classList.add("clr-open"),Ke(),nt(P),(T.focusInput||T.selectInput)&&(u.focus({preventScroll:!0}),u.setSelectionRange(m.selectionStart,m.selectionEnd)),T.selectInput&&u.select(),(w||T.swatchesOnly)&&Di().shift().focus(),m.dispatchEvent(new Event("open",{bubbles:!0})))}),j(o,"input",b,k=>{let R=k.target.parentNode;R.classList.contains("clr-field")&&(R.style.color=k.target.value)})}function Ke(){if(!l||!m&&!T.inline)return;let b=a,k=s.scrollY,R=l.offsetWidth,B=l.offsetHeight,D={left:!1,top:!1},H,Y,we,te={x:0,y:0};if(b&&(H=s.getComputedStyle(b),Y=parseFloat(H.marginTop),we=parseFloat(H.borderTopWidth),te=b.getBoundingClientRect(),te.y+=we+k),!T.inline){let me=m.getBoundingClientRect(),Ze=me.x,it=k+me.y+me.height+T.margin;b?(Ze-=te.x,it-=te.y,Ze+R>b.clientWidth&&(Ze+=me.width-R,D.left=!0),it+B>b.clientHeight-Y&&B+T.margin<=me.top-(te.y-k)&&(it-=me.height+B+T.margin*2,D.top=!0),it+=b.scrollTop):(Ze+R>o.documentElement.clientWidth&&(Ze+=me.width-R,D.left=!0),it+B-k>o.documentElement.clientHeight&&B+T.margin<=me.top&&(it=k+me.y-B-T.margin,D.top=!0)),l.classList.toggle("clr-left",D.left),l.classList.toggle("clr-top",D.top),l.style.left=`${Ze}px`,l.style.top=`${it}px`,te.x+=l.offsetLeft,te.y+=l.offsetTop}E={width:c.offsetWidth,height:c.offsetHeight,x:c.offsetLeft+te.x,y:c.offsetTop+te.y}}function Ge(b){o.querySelectorAll(b).forEach(k=>{let R=k.parentNode;if(!R.classList.contains("clr-field")){let B=o.createElement("div"),D="clr-field";(T.rtl||k.classList.contains("clr-rtl"))&&(D+=" clr-rtl"),B.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',R.insertBefore(B,k),B.setAttribute("class",D),B.style.color=k.value,B.appendChild(k)}})}function Se(b){if(m&&!T.inline){let k=m;b&&(m=n,P!==k.value&&(k.value=P,k.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(()=>{P!==k.value&&k.dispatchEvent(new Event("change",{bubbles:!0}))}),l.classList.remove("clr-open"),ie&&Be(),k.dispatchEvent(new Event("close",{bubbles:!0})),T.focusInput&&k.focus({preventScroll:!0}),m=n}}function nt(b){let k=Ts(b),R=xs(k);yo(R.s,R.v),To(k,R),v.value=R.h,l.style.color=`hsl(${R.h}, 100%, 50%)`,x.style.left=`${R.h/360*100}%`,d.style.left=`${E.width*R.s/100}px`,d.style.top=`${E.height-E.height*R.v/100}px`,g.value=R.a*100,y.style.left=`${R.a*100}%`}function yt(b){let k=b.substring(0,3).toLowerCase();return k==="rgb"||k==="hsl"?k:"hex"}function Me(b){b=b!==n?b:u.value,m&&(m.value=b,m.dispatchEvent(new Event("input",{bubbles:!0}))),T.onChange&&T.onChange.call(s,b,m),o.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:b,currentEl:m}}))}function vo(b,k){let R={h:v.value*1,s:b/E.width*100,v:100-k/E.height*100,a:g.value/100},B=vs(R);yo(R.s,R.v),To(B,R),Me()}function yo(b,k){let R=T.a11y.marker;b=b.toFixed(1)*1,k=k.toFixed(1)*1,R=R.replace("{s}",b),R=R.replace("{v}",k),d.setAttribute("aria-label",R)}function pn(b){return{pageX:b.changedTouches?b.changedTouches[0].pageX:b.pageX,pageY:b.changedTouches?b.changedTouches[0].pageY:b.pageY}}function He(b){let k=pn(b),R=k.pageX-E.x,B=k.pageY-E.y;a&&(B+=a.scrollTop),$t(R,B),b.preventDefault(),b.stopPropagation()}function xo(b,k){let R=d.style.left.replace("px","")*1+b,B=d.style.top.replace("px","")*1+k;$t(R,B)}function $t(b,k){b=b<0?0:b>E.width?E.width:b,k=k<0?0:k>E.height?E.height:k,d.style.left=`${b}px`,d.style.top=`${k}px`,vo(b,k),d.focus()}function To(b,k){b===void 0&&(b={}),k===void 0&&(k={});let R=T.format;for(let H in b)r[H]=b[H];for(let H in k)r[H]=k[H];let B=Cs(r),D=B.substring(0,7);switch(d.style.color=D,y.parentNode.style.color=D,y.style.color=B,p.style.color=B,c.style.display="none",c.offsetHeight,c.style.display="",y.nextElementSibling.style.display="none",y.nextElementSibling.offsetHeight,y.nextElementSibling.style.display="",R==="mixed"?R=r.a===1?"hex":"rgb":R==="auto"&&(R=C),R){case"hex":u.value=B;break;case"rgb":u.value=Ss(r);break;case"hsl":u.value=ws(ys(r));break}o.querySelector(`.clr-format [value="${R}"]`).checked=!0}function gs(){let b=v.value*1,k=d.style.left.replace("px","")*1,R=d.style.top.replace("px","")*1;l.style.color=`hsl(${b}, 100%, 50%)`,x.style.left=`${b/360*100}%`,vo(k,R)}function bs(){let b=g.value/100;y.style.left=`${b*100}%`,To({a:b}),Me()}function vs(b){let k=b.s/100,R=b.v/100,B=k*R,D=b.h/60,H=B*(1-e.abs(D%2-1)),Y=R-B;B=B+Y,H=H+Y;let we=e.floor(D)%6,te=[B,H,Y,Y,H,B][we],me=[H,B,B,H,Y,Y][we],Ze=[Y,Y,H,B,B,H][we];return{r:e.round(te*255),g:e.round(me*255),b:e.round(Ze*255),a:b.a}}function ys(b){let k=b.v/100,R=k*(1-b.s/100/2),B;return R>0&&R<1&&(B=e.round((k-R)/e.min(R,1-R)*100)),{h:b.h,s:B||0,l:e.round(R*100),a:b.a}}function xs(b){let k=b.r/255,R=b.g/255,B=b.b/255,D=e.max(k,R,B),H=e.min(k,R,B),Y=D-H,we=D,te=0,me=0;return Y&&(D===k&&(te=(R-B)/Y),D===R&&(te=2+(B-k)/Y),D===B&&(te=4+(k-R)/Y),D&&(me=Y/D)),te=e.floor(te*60),{h:te<0?te+360:te,s:e.round(me*100),v:e.round(we*100),a:b.a}}function Ts(b){let k=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,R,B;return i.fillStyle="#000",i.fillStyle=b,R=k.exec(i.fillStyle),R?(B={r:R[3]*1,g:R[4]*1,b:R[5]*1,a:R[6]*1},B.a=+B.a.toFixed(2)):(R=i.fillStyle.replace("#","").match(/.{2}/g).map(D=>parseInt(D,16)),B={r:R[0],g:R[1],b:R[2],a:1}),B}function Cs(b){let k=b.r.toString(16),R=b.g.toString(16),B=b.b.toString(16),D="";if(b.r<16&&(k="0"+k),b.g<16&&(R="0"+R),b.b<16&&(B="0"+B),T.alpha&&(b.a<1||T.forceAlpha)){let H=b.a*255|0;D=H.toString(16),H<16&&(D="0"+D)}return"#"+k+R+B+D}function Ss(b){return!T.alpha||b.a===1&&!T.forceAlpha?`rgb(${b.r}, ${b.g}, ${b.b})`:`rgba(${b.r}, ${b.g}, ${b.b}, ${b.a})`}function ws(b){return!T.alpha||b.a===1&&!T.forceAlpha?`hsl(${b.h}, ${b.s}%, ${b.l}%)`:`hsla(${b.h}, ${b.s}%, ${b.l}%, ${b.a})`}function Ps(){o.getElementById("clr-picker")||(a=n,l=o.createElement("div"),l.setAttribute("id","clr-picker"),l.className="clr-picker",l.innerHTML=`<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="${T.a11y.input}"><div id="clr-color-area" class="clr-gradient" role="application" aria-label="${T.a11y.instruction}"><div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue"><input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="${T.a11y.hueSlider}"><div id="clr-hue-marker"></div></div><div class="clr-alpha"><input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="${T.a11y.alphaSlider}"><div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented"><legend>${T.a11y.format}</legend><input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div><button type="button" id="clr-clear" class="clr-clear" aria-label="${T.a11y.clear}">${T.clearLabel}</button><div id="clr-color-preview" class="clr-preview"><button type="button" id="clr-close" class="clr-close" aria-label="${T.a11y.close}">${T.closeLabel}</button></div><span id="clr-open-label" hidden>${T.a11y.open}</span><span id="clr-swatch-label" hidden>${T.a11y.swatch}</span>`,o.body.appendChild(l),c=ue("clr-color-area"),d=ue("clr-color-marker"),h=ue("clr-clear"),f=ue("clr-close"),p=ue("clr-color-preview"),u=ue("clr-color-value"),v=ue("clr-hue-slider"),x=ue("clr-hue-marker"),g=ue("clr-alpha-slider"),y=ue("clr-alpha-marker"),Fe(T.el),Ge(T.el),j(l,"mousedown",b=>{l.classList.remove("clr-keyboard-nav"),b.stopPropagation()}),j(c,"mousedown",b=>{j(o,"mousemove",He)}),j(c,"touchstart",b=>{o.addEventListener("touchmove",He,{passive:!1})}),j(d,"mousedown",b=>{j(o,"mousemove",He)}),j(d,"touchstart",b=>{o.addEventListener("touchmove",He,{passive:!1})}),j(u,"change",b=>{let k=u.value;if(m||T.inline){let R=k===""?k:nt(k);Me(R)}}),j(h,"click",b=>{Me(""),Se()}),j(f,"click",b=>{Me(),Se()}),j(ue("clr-format"),"click",".clr-format input",b=>{C=b.target.value,To(),Me()}),j(l,"click",".clr-swatches button",b=>{nt(b.target.textContent),Me(),T.swatchesOnly&&Se()}),j(o,"mouseup",b=>{o.removeEventListener("mousemove",He)}),j(o,"touchend",b=>{o.removeEventListener("touchmove",He)}),j(o,"mousedown",b=>{w=!1,l.classList.remove("clr-keyboard-nav"),Se()}),j(o,"keydown",b=>{let k=b.key,R=b.target,B=b.shiftKey;if(k==="Escape"?Se(!0):["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(k)&&(w=!0,l.classList.add("clr-keyboard-nav")),k==="Tab"&&R.matches(".clr-picker *")){let H=Di(),Y=H.shift(),we=H.pop();B&&R===Y?(we.focus(),b.preventDefault()):!B&&R===we&&(Y.focus(),b.preventDefault())}}),j(o,"click",".clr-field button",b=>{ie&&Be(),b.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),j(d,"keydown",b=>{let k={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(k).includes(b.key)&&(xo(...k[b.key]),b.preventDefault())}),j(c,"click",He),j(v,"input",gs),j(g,"input",bs))}function Di(){return Array.from(l.querySelectorAll("input, button")).filter(R=>!!R.offsetWidth)}function ue(b){return o.getElementById(b)}function j(b,k,R,B){let D=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof R=="string"?b.addEventListener(k,H=>{D.call(H.target,R)&&B.call(H.target,H)}):(B=R,b.addEventListener(k,B))}function Co(b,k){k=k!==n?k:[],o.readyState!=="loading"?b(...k):o.addEventListener("DOMContentLoaded",()=>{b(...k)})}NodeList!==n&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function Es(b,k){m=k,P=m.value,se(k),C=yt(b),Ke(),nt(b),Me(),P!==b&&m.dispatchEvent(new Event("change",{bubbles:!0}))}let hn=(()=>{let b={init:Ps,set:ee,wrap:Ge,close:Se,setInstance:de,setColor:Es,removeInstance:ve,updatePosition:Ke,ready:Co};function k(R){Co(()=>{R&&(typeof R=="string"?Fe(R):ee(R))})}for(let R in b)k[R]=function(){for(var B=arguments.length,D=new Array(B),H=0;H<B;H++)D[H]=arguments[H];Co(b[R],D)};return Co(()=>{s.addEventListener("resize",R=>{k.updatePosition()}),s.addEventListener("scroll",R=>{k.updatePosition()})}),k})();return hn.coloris=hn,hn})(window,document,Math)})(),Dr=tt.coloris,Ar=tt.init,ET=tt.set,kT=tt.wrap,bi=tt.close,RT=tt.setInstance,IT=tt.removeInstance,LT=tt.updatePosition;var Pa=s=>(o,e)=>new vi(s,o,e),qe=Pa,vi=class{constructor(o,e,n){this.sourceFactory=o;this.startPoint=e;this.viewport=n;this.builder=o(e,n),this.points=[e]}getBBox(){return this.builder.getBBox()}build(){return this.builder.build()}preview(o){this.builder.preview(o)}addPoint(o){this.points.push(o),this.builder.addPoint(o)}async autocorrectShape(){let o=r=>({...r,pos:this.viewport.snapToGrid(r.pos)}),e=o(this.startPoint),n=this.sourceFactory(e,this.viewport),i=this.points.map(r=>o(r));for(let r of i)n.addPoint(r);return n.build()}};var yi=qe((s,o)=>new an(s,o)),an=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o}getLineWidth(){return Math.max(this.endPoint.width,this.startPoint.width)}getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,n=e.minus(o).normalized(),i=e.distanceTo(o),r=Math.min(this.getLineWidth(),i/2),a=this.startPoint.width/2,l=this.endPoint.width/2,c=e.minus(n.times(r)),d=n.orthog(),p=d.times(a),u=d.times(l),h=new W(c.minus(u),[{kind:0,point:o.minus(p)},{kind:0,point:o.plus(p)},{kind:0,point:c.plus(u)},{kind:0,point:c.plus(d.times(r).plus(u))},{kind:0,point:e.plus(n.times(l))},{kind:0,point:c.plus(d.times(-r).minus(u))},{kind:0,point:c.minus(u)}]).mapPoints(v=>this.viewport.roundPoint(v));return new oe([{startPoint:h.startPoint,commands:h.parts,style:{fill:this.startPoint.color}}])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o)}addPoint(o){this.endPoint=o}};var xi=qe((s,o)=>new ln(s,o)),ln=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o}getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,n=e.minus(o).normalized(),i=this.startPoint.width/2,r=this.endPoint.width/2,a=n.orthog(),l=a.times(i),c=a.times(r),d=o.minus(l),p=new W(d,[{kind:0,point:o.plus(l)},{kind:0,point:e.plus(c)},{kind:0,point:e.minus(c)},{kind:0,point:o.minus(l)}]).mapPoints(h=>this.viewport.roundPoint(h));return new oe([G(p,{fill:this.startPoint.color})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o)}addPoint(o){this.endPoint=o}};var Ti=qe((s,o)=>new ho(s,!0,o)),Ci=qe((s,o)=>new ho(s,!1,o)),ho=class{constructor(o,e,n){this.startPoint=o;this.filled=e;this.viewport=n;this.endPoint=o}getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.viewport.getRotationAngle(),e=I.zRotation(-o),n=e.inverse().transformVec2(this.startPoint.pos),i=e.inverse().transformVec2(this.endPoint.pos),r=z.fromCorners(n,i),a=W.fromRect(r,this.filled?null:this.endPoint.width).transformedBy(e).mapPoints(c=>this.viewport.roundPoint(c));return new oe([G(a,{fill:this.endPoint.color})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o)}addPoint(o){this.endPoint=o}};var wi=qe((s,o)=>new Si(s,o)),Si=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o}getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=[],n=Math.PI*2/6,i=q.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=this.startPoint.pos.lerp(this.endPoint.pos,.5),l=this.endPoint.pos.minus(r).length()-i/2,c=r.plus(S.of(l,0));for(let u=n;u<=Math.PI*2;u+=n){let h=S.of(l*Math.cos(u),-l*Math.sin(u)).plus(r),v=S.of(Math.cos(u-n/2),-Math.sin(u-n/2)).times(l*1.141).plus(r);o.push({kind:3,controlPoint:v,endPoint:h})}o.push({kind:0,point:c});let d=new W(c,o).mapPoints(u=>this.viewport.roundPoint(u));return new oe([G(d,{fill:M.transparent,stroke:{width:i,color:this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o)}addPoint(o){this.endPoint=o}};var Ea=(s,o)=>{let e=document.createElement("span"),n=document.createElement("span"),i=document.createElement("input");i.type="button",i.classList.add("coloris_input"),e.classList.add("color-input-container"),n.classList.add("color-input-wrapper"),n.appendChild(i),e.appendChild(n);let r=ka(s,e,h=>{i.value=h.toHexString(),c();let f=i.parentElement;f&&f.classList.contains("clr-field")&&(f.style.color=i.value)}),a,l=()=>{a=M.fromHex(i.value)},c=()=>{l(),a&&(s.announceForAccessibility(s.localization.colorChangedAnnouncement(a.toHexString())),o(a),s.notifier.dispatch(12,{kind:12,color:a}))};i.oninput=l;let d=!1;i.addEventListener("open",()=>{d=!0,s.notifier.dispatch(11,{kind:11,open:!0}),r.cancel(),e.classList.add("picker-open"),document.querySelector("#clr-picker #clr-hue-slider")?.focus()});let p=()=>{d=!1,s.notifier.dispatch(11,{kind:11,open:!1}),c(),i.focus(),e.classList.remove("picker-open")};return i.addEventListener("close",()=>{p()}),{input:i,container:e,setValue:h=>{typeof h=="object"&&(h=h.toHexString()),i.value=h,i.dispatchEvent(new Event("input",{bubbles:!0}))},closePicker:()=>{d&&c()},registerWithHelpTextDisplay:h=>{h.registerTextHelpForElement(n,s.localization.colorPickerToggleHelpText),r.registerWithHelpTextDisplay(h)}}},ka=(s,o,e)=>{let n=document.createElement("button");n.classList.add("pipetteButton"),n.title=s.localization.pickColorFromScreen,n.setAttribute("alt",n.title);let i=document.createElement("span");i.classList.add("pickColorInstructions"),i.innerText=s.localization.clickToPickColorAnnouncement;let r=p=>{n.replaceChildren(s.icons.makePipetteIcon(p),i)};r();let a=s.toolController.getMatchingTools(Dt)[0],l=()=>{a?.clearColorListener(),r(),n.classList.remove("active")},c=p=>{l(),p&&e(p)},d=p=>{p?r(p):r()};return n.onclick=()=>{if(n.classList.contains("active")){l(),s.announceForAccessibility(s.localization.colorSelectionCanceledAnnouncement);return}a?.setColorListener(d,c),a&&(n.classList.add("active"),s.announceForAccessibility(s.localization.clickToPickColorAnnouncement))},o.appendChild(n),{cancel:()=>{l()},registerWithHelpTextDisplay:p=>{p.registerTextHelpForElement(n,s.localization.colorPickerPipetteHelpText)}}},ot=Ea;var Ra=()=>{let s=[...document.querySelectorAll("*:focus")];return s.length&&s.some(o=>o.classList.contains(`${A}button`))},be=class extends ae{constructor(e,n,i,r){super(e,i,r);this.targetTool=n;this.targetTool.enabledValue().onUpdateAndNow(a=>{a?(this.setSelected(!0),Ra()&&this.focus()):(this.setSelected(!1),this.setDropdownVisible(!1))})}shouldAutoDisableInReadOnlyEditor(){return!this.targetTool.canReceiveInputInReadOnlyEditor()}handleClick(){this.hasDropdown?this.targetTool.isEnabled()?this.setDropdownVisible(!this.isDropdownVisible()):(this.targetTool.setEnabled(!0),this.activateDropdown()):this.targetTool.setEnabled(!this.targetTool.isEnabled())}onKeyPress(e){return this.isSelected()&&e.code==="Space"&&this.hasDropdown?(this.handleClick(),!0):!1}addTo(e){let n=super.addTo(e);return this.setSelected(this.targetTool.isEnabled()),n}};var Pi="jsdraw.toolbar.SelectionTool.resizeImageToSelection";F.registerDefaultKeyboardShortcut(Pi,["ctrlOrMeta+r"],"Resize image to selection");var mo=[1,2,3,4,5,6,7,8,9].map(s=>`jsdraw.toolbar.PenTool.select-pen-${s}`);for(let s=0;s<mo.length;s++){let o=mo[s];F.registerDefaultKeyboardShortcut(o,[`CtrlOrMeta+Digit${s+1}`],"Select pen style "+(s+1))}var Ei="jsdraw.toolbar.SaveActionWidget.save";F.registerDefaultKeyboardShortcut(Ei,["ctrlOrMeta+KeyS"],"Save");var ki="jsdraw.toolbar.ExitActionWidget.exit";F.registerDefaultKeyboardShortcut(ki,["Alt+KeyQ"],"Exit");var Ia=0,La=(s,o)=>{let e=document.createElement("div"),n=document.createElement("label"),i=document.createElement("input");e.classList.add(`${A}thicknessSliderContainer`),i.id=`${A}thicknessInput${Ia++}`,n.innerText=s.localization.thicknessLabel,n.setAttribute("for",i.id);let r=c=>Math.log10(c),a=c=>10**c;i.type="range",i.oninput=()=>{o(a(parseFloat(i.value)))},e.appendChild(n),e.appendChild(i);let l=(c,d)=>{let p=(f,v)=>(v?Math.ceil:Math.floor)(f*100)/100,u=p(r(c),!1),h=p(r(d),!0);i.min=`${u}`,i.max=`${h}`,i.step=`${fe((h-u)/20)}`};return l(2,262),{container:e,addTo:c=>{c.appendChild(e)},setBounds:l,setValue:c=>{i.value=r(c).toString()}}},cn=La;var za=s=>{let o=(e,n,i,r)=>{let a=n!==r&&e!==0,l=i+e<=0,d=i+n+e>r;return a&&!l&&!d};s.onwheel=e=>{let n=o(e.deltaX,s.clientWidth,s.scrollLeft,s.scrollWidth),i=o(e.deltaY,s.clientHeight,s.scrollTop,s.scrollHeight);(n||i)&&e.stopPropagation()}},fo=za;var Ri=0,Ba=(s,o,e)=>{let n=document.createElement("div");n.classList.add(`${A}grid-selector`);let i=re.fromInitialValue(o),r=document.createElement("div");r.role="group",r.id=`${A}-grid-select-id-${Ri++}`,fo(r);let a=document.createElement("label");a.textContent=s,a.htmlFor=r.id,n.appendChild(a);let l=`${A}-grid-selector-${Ri++}`,c=u=>{let h=document.createElement("div");h.classList.add("choice-button");let f=document.createElement("input");f.type="radio",f.id=`${A}-grid-select-button-${Ri++}`,et(h);let v=document.createElement("label"),x=()=>{v.setAttribute("title",u.title);let P=document.createElement("span");P.classList.add("button-label-text");let w=u.makeIcon();w.classList.add("icon"),P.innerText=u.title,v.htmlFor=f.id,v.replaceChildren(w,P)};x();let g=()=>{f.name=l};g();let y=()=>{f.checked?h.classList.add("checked"):h.classList.remove("checked")};f.oninput=()=>{f.checked&&i.set(u.id),y()},f.onfocus=()=>{h.querySelector(":focus-visible")&&h.classList.add("focus-visible")},f.onblur=()=>{h.classList.remove("focus-visible")},h.oncontextmenu=P=>{P.preventDefault()},h.replaceChildren(f,v),r.appendChild(h);let m=P=>{f.checked=P,y()};return m(!1),{choiceRecord:u,setChecked:m,updateIcon:()=>{x()},updateButtonRadiogroupName:g}},d=[];for(let u of e)d.push(c(u));n.appendChild(r),i.onUpdateAndNow(u=>{for(let h=0;h<d.length;h++)d[h].setChecked(d[h].choiceRecord.id===u)});let p={value:i,_radiogroupName:l,linkWith:u=>{p._radiogroupName=u._radiogroupName,l=u._radiogroupName;for(let h of d)h.updateButtonRadiogroupName()},updateIcons:()=>{d.forEach(u=>u.updateIcon())},getRootElement(){return n},addTo:u=>{u.appendChild(n)}};return p},Ii=Ba;var At=class s extends be{constructor(e,n,i){super(e,n,"pen",i);this.tool=n;this.updateInputs=()=>{};this.shapelikeIDs=["pressure-sensitive-pen","freehand-pen"];let r=e.getCurrentSettings().pens?.additionalPenTypes??[],a=e.getCurrentSettings().pens?.filterPenTypes??(()=>!0);this.penTypes=[{name:this.localizationTable.flatTipPen,id:"pressure-sensitive-pen",factory:lo},{name:this.localizationTable.roundedTipPen,id:"freehand-pen",factory:pt},{name:this.localizationTable.roundedTipPen2,id:"polyline-pen",factory:co},...r.filter(l=>!l.isShapeBuilder),{name:this.localizationTable.arrowPen,id:"arrow",isShapeBuilder:!0,factory:yi},{name:this.localizationTable.linePen,id:"line",isShapeBuilder:!0,factory:xi},{name:this.localizationTable.filledRectanglePen,id:"filled-rectangle",isShapeBuilder:!0,factory:Ti},{name:this.localizationTable.outlinedRectanglePen,id:"outlined-rectangle",isShapeBuilder:!0,factory:Ci},{name:this.localizationTable.outlinedCirclePen,id:"outlined-circle",isShapeBuilder:!0,factory:wi},...r.filter(l=>l.isShapeBuilder)].filter(a),this.editor.notifier.on(2,l=>{if(l.kind!==2)throw new Error("Invalid event type!");l.tool===this.tool&&(this.updateIcon(),this.updateInputs())})}static{this.idCounter=0}getTitle(){return this.targetTool.description}getCurrentPenTypeIdx(){let e=this.tool.getStrokeFactory();for(let n=0;n<this.penTypes.length;n++)if(this.penTypes[n].factory===e)return n;return-1}getCurrentPenType(){for(let e of this.penTypes)if(e.factory===this.tool.getStrokeFactory())return e;return null}createIconForRecord(e){let n={...this.tool.getStyleValue().get()};e?.factory&&(n.factory=e.factory);let i=e?.factory;return!i||i===pt||i===lo||i===co?this.editor.icons.makePenIcon(n):this.editor.icons.makeIconFromFactory(n)}createIcon(){return this.createIconForRecord(this.getCurrentPenType())}createPenTypeSelector(e){let n=this.penTypes.map((d,p)=>({id:p,makeIcon:()=>this.createIconForRecord(d),title:d.name,isShapeBuilder:d.isShapeBuilder??!1})),i=n.filter(d=>!d.isShapeBuilder),r=Ii(this.localizationTable.selectPenType,this.getCurrentPenTypeIdx(),i),a=n.filter(d=>d.isShapeBuilder),l=Ii(this.localizationTable.selectShape,this.getCurrentPenTypeIdx(),a),c=d=>{this.tool.setStrokeFactory(this.penTypes[d].factory)};return r.value.onUpdate(c),l.value.onUpdate(c),e?.registerTextHelpForElements([r.getRootElement(),l.getRootElement()],this.localizationTable.penDropdown__penTypeHelpText),{setValue:d=>{r.value.set(d),l.value.set(d)},updateIcons:()=>{r.updateIcons(),l.updateIcons()},addTo:d=>{i.length&&r.addTo(d),a.length&&l.addTo(d)}}}createStrokeCorrectionOptions(e){let n=document.createElement("div");n.classList.add("action-button-row",`${A}-pen-tool-toggle-buttons`);let i=(l,c)=>{let d=document.createElement("button");d.classList.add(`${A}-toggle-button`);let p=c.cloneNode(!0);p.classList.add("icon");let u=document.createElement("span");u.innerText=l,d.replaceChildren(p,u),d.setAttribute("role","switch"),n.appendChild(d);let h=!1,f=x=>{},v={setChecked(x){h=x,d.setAttribute("aria-checked",`${h}`),f(h)},setOnInputListener(x){f=x},addHelpText(x){e?.registerTextHelpForElement(d,x)}};return d.onclick=()=>{v.setChecked(!h)},v},r=i(this.localizationTable.inputStabilization,this.editor.icons.makeStrokeSmoothingIcon());r.setOnInputListener(l=>{this.tool.setHasStabilization(l)});let a=i(this.localizationTable.strokeAutocorrect,this.editor.icons.makeShapeAutocorrectIcon());return a.setOnInputListener(l=>{this.tool.setStrokeAutocorrectEnabled(l)}),a.addHelpText(this.localizationTable.penDropdown__autocorrectHelpText),r.addHelpText(this.localizationTable.penDropdown__stabilizationHelpText),{update:()=>{r.setChecked(!!this.tool.getInputMapper()),a.setChecked(this.tool.getStrokeAutocorrectionEnabled())},addTo:l=>{l.appendChild(n)}}}getHelpText(){return this.localizationTable.penDropdown__baseHelpText}fillDropdown(e,n){let i=document.createElement("div");i.classList.add(`${A}spacedList`,`${A}nonbutton-controls-main-list`);let{container:r,setValue:a}=cn(this.editor,v=>{this.tool.setThickness(v)}),l=document.createElement("div"),c=document.createElement("label"),d=ot(this.editor,v=>{this.tool.setColor(v)}),{input:p,container:u}=d;p.id=`${A}colorInput${s.idCounter++}`,c.innerText=this.localizationTable.colorLabel,c.setAttribute("for",p.id),l.appendChild(c),l.appendChild(u);let h=this.createStrokeCorrectionOptions(n),f=this.createPenTypeSelector(n);return n?.registerTextHelpForElement(l,this.localizationTable.penDropdown__colorHelpText),n&&d.registerWithHelpTextDisplay(n),n?.registerTextHelpForElement(r,this.localizationTable.penDropdown__thicknessHelpText),this.updateInputs=()=>{d.setValue(this.tool.getColor()),a(this.tool.getThickness()),f.updateIcons(),f.setValue(this.getCurrentPenTypeIdx()),h.update()},this.updateInputs(),i.replaceChildren(l,r),f.addTo(i),e.replaceChildren(i),h.addTo(e),!0}onKeyPress(e){if(!this.isSelected())return!1;for(let n=0;n<mo.length;n++){let i=mo[n];if(this.editor.shortcuts.matchesShortcut(i,e)){let r=n;if(r<this.penTypes.length)return this.tool.setStrokeFactory(this.penTypes[r].factory),!0}}return!!super.onKeyPress(e)}serializeState(){return{...super.serializeState(),color:this.tool.getColor().toHexString(),thickness:this.tool.getThickness(),strokeFactoryId:this.getCurrentPenType()?.id,inputStabilization:!!this.tool.getInputMapper(),strokeAutocorrect:this.tool.getStrokeAutocorrectionEnabled()}}deserializeFrom(e){super.deserializeFrom(e);let n=(i,r)=>{let a=typeof e[i];if(a!==r)throw new Error(`Deserializing property ${i}: Invalid type. Expected ${r}, was ${a}.`)};if(e.color&&(n("color","string"),this.tool.setColor(M.fromHex(e.color))),e.thickness&&(n("thickness","number"),this.tool.setThickness(e.thickness)),e.strokeFactoryId){n("strokeFactoryId","string");let i=e.strokeFactoryId;for(let r of this.penTypes)if(i===r.id){this.tool.setStrokeFactory(r.factory);break}}e.inputStabilization!==void 0&&this.tool.setHasStabilization(!!e.inputStabilization),e.strokeAutocorrect!==void 0&&this.tool.setStrokeAutocorrectEnabled(!!e.strokeAutocorrect)}};var Vt=class s extends be{constructor(e,n,i){super(e,n,"eraser-tool-widget",i);this.tool=n;this.updateInputs=()=>{};this.editor.notifier.on(2,r=>{r.kind===2&&r.tool===this.tool&&(this.updateInputs(),this.updateIcon())})}getHelpText(){return this.localizationTable.eraserDropdown__baseHelpText}getTitle(){return this.localizationTable.eraser}makeIconForType(e){return this.editor.icons.makeEraserIcon(this.tool.getThickness(),e)}createIcon(){return this.makeIconForType(this.tool.getModeValue().get())}static{this.idCounter=0}makeEraserTypeSelector(e){let n=document.createElement("div"),i=document.createElement("label"),r=document.createElement("input");r.id=`${A}eraserToolWidget-${s.idCounter++}`,i.htmlFor=r.id,i.innerText=this.localizationTable.fullStrokeEraser,r.type="checkbox",r.oninput=()=>{this.tool.getModeValue().set(r.checked?"full-stroke":"partial-stroke")};let a=()=>{r.checked=this.tool.getModeValue().get()==="full-stroke"};return n.replaceChildren(i,r),e?.registerTextHelpForElement(n,this.localizationTable.eraserDropdown__fullStrokeEraserHelpText),{addTo:l=>{l.appendChild(n)},updateValue:a}}fillDropdown(e,n){let i=document.createElement("div");i.classList.add(`${A}spacedList`,`${A}nonbutton-controls-main-list`);let r=cn(this.editor,l=>{this.tool.setThickness(l)});r.setBounds(10,55),n?.registerTextHelpForElement(r.container,this.localizationTable.eraserDropdown__thicknessHelpText);let a=this.makeEraserTypeSelector(n);return this.updateInputs=()=>{r.setValue(this.tool.getThickness()),a.updateValue()},this.updateInputs(),i.replaceChildren(r.container),a.addTo(i),e.replaceChildren(i),!0}serializeState(){return{...super.serializeState(),thickness:this.tool.getThickness(),mode:this.tool.getModeValue().get()}}deserializeFrom(e){if(super.deserializeFrom(e),e.thickness){let n=parseFloat(e.thickness);if(typeof n!="number"||!isFinite(n))throw new Error(`Deserializing property ${n} is not a number or is not finite.`);this.tool.setThickness(n)}if(e.mode){let n=e.mode;Object.values(to).includes(n)&&this.tool.getModeValue().set(n)}}};var Ma=(s="")=>{let o=document.createElement("div");return o.classList.add("tool-dropdown-separator"),o.innerText=s,{addTo:e=>{e.appendChild(o)}}},go=Ma;var Da=(s,o)=>{let e=document.createElement("div");e.classList.add("toolbar-button-grid"),e.style.setProperty("--column-count",`${o}`);let n=i=>{let r=document.createElement("button");r.classList.add("button");let a=i.icon();a.classList.add("icon");let l=document.createElement("label");return l.textContent=i.label,l.classList.add("button-label-text"),r.onclick=i.onClick,i.enabled&&i.enabled.onUpdateAndNow(c=>{r.disabled=!c}),r.replaceChildren(a,l),e.appendChild(r),et(r),i.onCreated?.(r),r};return s.map(n),{container:e}},Vr=Da;var Aa=(s,o,e)=>{let n=document.createElement("div");n.classList.add("selection-format-menu",`${A}spacedList`,`${A}indentedList`);let i=document.createElement("div"),r=document.createElement("label"),a=ot(s,p=>{let u=o.getSelection();if(u){let h=[];for(let v of u.getSelectedObjects())Go(v)&&h.push(v.updateStyle({color:p}));let f=he(h);s.dispatch(f)}}),{input:l,container:c}=a;r.innerText=e.colorLabel;let d=()=>{let p=o.getSelection();if(p&&p.getSelectedItemCount()>0){l.disabled=!1,n.classList.remove("disabled");let u=[];for(let h of p.getSelectedObjects())if(Go(h)){let f=h.getStyle().color;f&&u.push(f)}a.setValue(M.average(u))}else l.disabled=!0,n.classList.add("disabled"),a.setValue(M.transparent)};return i.replaceChildren(r,c),n.replaceChildren(i),{addTo:p=>{p.appendChild(n)},update:d,registerHelpText:p=>{p.registerTextHelpForElement(i,e.selectionDropdown__changeColorHelpText),a.registerWithHelpTextDisplay(p)}}},Li=class extends ae{constructor(e,n,i){super(e,"selection-mode-toggle",i);this.tool=n;e.notifier.on(2,r=>{r.kind===2&&r.tool===n&&this.setSelected(n.modeValue.get()==="lasso")}),this.setSelected(!1)}shouldAutoDisableInReadOnlyEditor(){return!1}setModeFlag(e){this.tool.modeValue.set(e?"lasso":"rect")}handleClick(){this.setModeFlag(!this.isSelected())}getTitle(){return this.localizationTable.selectionTool__lassoSelect}createIcon(){return this.editor.icons.makeSelectionIcon("lasso")}fillDropdown(e){return!1}getHelpText(){return this.localizationTable.selectionTool__lassoSelect__help}},Ot=class extends be{constructor(e,n,i){super(e,n,"selection-tool-widget",i);this.tool=n;this.updateFormatMenu=()=>{};this.addSubWidget(new Li(e,n,this.localizationTable));let r=()=>{let a=this.tool.getSelection();return!!a&&a.getSelectedItemCount()>0};this.hasSelectionValue=re.fromInitialValue(r()),this.editor.notifier.on(2,a=>{if(a.kind!==2)throw new Error("Invalid event type!");a.tool===this.tool&&(this.hasSelectionValue.set(r()),this.updateFormatMenu())}),n.modeValue.onUpdate(()=>{this.updateIcon()})}resizeImageToSelection(){let e=this.tool.getSelection();e&&this.editor.dispatch(this.editor.setImportExportRect(e.region))}onKeyPress(e){return this.editor.shortcuts.matchesShortcut(Pi,e)?(this.resizeImageToSelection(),!0):!!super.onKeyPress(e)}getTitle(){return this.localizationTable.select}createIcon(){return this.editor.icons.makeSelectionIcon(this.tool.modeValue.get())}getHelpText(){return this.localizationTable.selectionDropdown__baseHelpText}createSelectionActions(e){let n=this.editor.icons;return{container:Vr([{icon:()=>n.makeDeleteSelectionIcon(),label:this.localizationTable.deleteSelection,onCreated:r=>{e?.registerTextHelpForElement(r,this.localizationTable.selectionDropdown__deleteHelpText)},onClick:()=>{let r=this.tool.getSelection();this.editor.dispatch(r.deleteSelectedObjects()),this.tool.clearSelection()},enabled:this.hasSelectionValue},{icon:()=>n.makeDuplicateSelectionIcon(),label:this.localizationTable.duplicateSelection,onCreated:r=>{e?.registerTextHelpForElement(r,this.localizationTable.selectionDropdown__duplicateHelpText)},onClick:async()=>{let a=await this.tool.getSelection()?.duplicateSelectedObjects();a&&this.editor.dispatch(a)},enabled:this.hasSelectionValue},{icon:()=>n.makeResizeImageToSelectionIcon(),label:this.localizationTable.resizeImageToSelection,onCreated:r=>{e?.registerTextHelpForElement(r,this.localizationTable.selectionDropdown__resizeToHelpText)},onClick:()=>{this.resizeImageToSelection()},enabled:this.hasSelectionValue}],3).container}}fillDropdown(e,n){super.fillDropdown(e,n);let i=document.createElement("div");i.classList.add(`${A}nonbutton-controls-main-list`),e.appendChild(i),go().addTo(i);let r=this.createSelectionActions(n);i.appendChild(r.container),go(this.localizationTable.reformatSelection).addTo(i);let a=Aa(this.editor,this.tool,this.localizationTable);return a.addTo(i),this.updateFormatMenu=()=>a.update(),n&&a.registerHelpText(n),a.update(),!0}serializeState(){return{...super.serializeState(),selectionMode:this.tool.modeValue.get()}}deserializeFrom(e){super.deserializeFrom(e),Object.values(gt).includes(e.selectionMode)&&this.tool.modeValue.set(e.selectionMode)}};var Ft=class s extends be{constructor(e,n,i){super(e,n,"text-tool-widget",i);this.tool=n;this.updateDropdownInputs=null;e.notifier.on(2,r=>{r.kind===2&&r.tool===n&&(this.updateIcon(),this.updateDropdownInputs?.())})}getTitle(){return this.targetTool.description}createIcon(){let e=this.tool.getTextStyle();return this.editor.icons.makeTextIcon(e)}static{this.idCounter=0}fillDropdown(e){let n=document.createElement("div");n.classList.add(`${A}spacedList`,`${A}nonbutton-controls-main-list`);let i=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div"),l=document.createElement("select"),c=document.createElement("label"),d=document.createElement("input"),p=document.createElement("label"),{input:u,container:h,setValue:f}=ot(this.editor,m=>{this.tool.setColor(m)}),v=document.createElement("label"),x=new Set,g=m=>{let C=document.createElement("option");C.value=m,C.textContent=m,l.appendChild(C),x.add(m)};d.setAttribute("type","number"),d.min="1",d.max="128",c.innerText=this.localizationTable.fontLabel,v.innerText=this.localizationTable.colorLabel,p.innerText=this.localizationTable.textSize,u.id=`${A}-text-color-input-${s.idCounter++}`,v.setAttribute("for",u.id),d.id=`${A}-text-size-input-${s.idCounter++}`,p.setAttribute("for",d.id);let y=this.editor.getCurrentSettings().text?.fonts??[];for(let m of y)g(m);return l.classList.add("font-selector"),l.id=`${A}-text-font-input-${s.idCounter++}`,c.setAttribute("for",l.id),l.onchange=()=>{this.tool.setFontFamily(l.value)},d.onchange=()=>{let m=parseInt(d.value);!isNaN(m)&&m>0&&this.tool.setFontSize(m)},r.appendChild(v),r.appendChild(h),i.appendChild(c),i.appendChild(l),a.appendChild(p),a.appendChild(d),this.updateDropdownInputs=()=>{let m=this.tool.getTextStyle();f(m.renderingStyle.fill),x.has(m.fontFamily)||g(m.fontFamily),l.value=m.fontFamily,d.value=`${m.size}`},this.updateDropdownInputs(),n.replaceChildren(r,a,i),e.appendChild(n),!0}serializeState(){let e=this.tool.getTextStyle();return{...super.serializeState(),fontFamily:e.fontFamily,textSize:e.size,color:e.renderingStyle.fill.toHexString()}}deserializeFrom(e){e.fontFamily&&typeof e.fontFamily=="string"&&this.tool.setFontFamily(e.fontFamily),e.color&&typeof e.color=="string"&&this.tool.setColor(M.fromHex(e.color)),e.textSize&&typeof e.textSize=="number"&&this.tool.setFontSize(e.textSize),super.deserializeFrom(e)}};var Va=(s,o,e)=>{let n=document.createElement("div"),i=document.createElement("button"),r=document.createElement("button"),a=document.createElement("button"),l=document.createElement("span");i.innerText="+",r.innerText="-",a.innerText=s.resetView,n.replaceChildren(l,i,r,a),n.classList.add(`${A}zoomLevelEditor`),l.classList.add("zoomDisplay");let c,d=()=>{let u=o.viewport.getScaleFactor()*100;u>.1?u=Math.round(u*10)/10:u=Math.round(u*1e3)/1e3,u!==c&&(l.textContent=s.zoomLevel(u),c=u)};d(),o.notifier.on(7,u=>{u.kind===7&&(d(),a.disabled=u.newTransform.eq(I.identity))});let p=u=>{let h=o.viewport.visibleRect.center,f=I.scaling2D(u,h);o.dispatch(q.transformBy(f),!1)};return i.onclick=()=>{p(5/4)},r.onclick=()=>{p(4/5)},a.onclick=()=>{o.dispatch(q.transformBy(o.viewport.canvasToScreenTransform.inverse()),!1)},e?.registerTextHelpForElement(i,s.handDropdown__zoomInHelpText),e?.registerTextHelpForElement(r,s.handDropdown__zoomOutHelpText),e?.registerTextHelpForElement(a,s.handDropdown__resetViewHelpText),e?.registerTextHelpForElement(l,s.handDropdown__zoomDisplayHelpText),n},dn=class extends ae{constructor(e,n,i,r,a,l,c){super(e,`pan-mode-${i}`,c);this.tool=n;this.flag=i;this.makeIcon=r;this.title=a;this.helpText=l;e.notifier.on(2,d=>{if(d.kind===2&&d.tool===n){let p=!!(n.getMode()&8);this.setSelected(!!(n.getMode()&i)||p),this.setDisabled(p&&i!==8)}}),this.setSelected(!1)}shouldAutoDisableInReadOnlyEditor(){return!1}setModeFlag(e){this.tool.setModeEnabled(this.flag,e)}handleClick(){this.setModeFlag(!this.isSelected())}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(e){return!1}getHelpText(){return this.helpText}},Ht=class s extends be{constructor(o,e,n){let i=o.toolController.getPrimaryTools().includes(e),r=(i?e:s.getPrimaryHandTool(o.toolController))??e;super(o,r,"hand-tool-widget",n),this.overridePanZoomTool=(i?s.getOverrideHandTool(o.toolController):e)??e,this.allowTogglingBaseTool=r!==null,this.allowTogglingBaseTool||this.container.classList.add("dropdownShowable");let a=new dn(o,this.overridePanZoomTool,1,()=>this.editor.icons.makeTouchPanningIcon(),n.touchPanning,n.handDropdown__touchPanningHelpText,n),l=new dn(o,this.overridePanZoomTool,32,()=>this.editor.icons.makeRotationLockIcon(),n.lockRotation,n.handDropdown__lockRotationHelpText,n);this.addSubWidget(a),this.addSubWidget(l)}static getPrimaryHandTool(o){return o.getPrimaryTools().filter(i=>i instanceof De)[0]}static getOverrideHandTool(o){return o.getMatchingTools(De)[0]}shouldAutoDisableInReadOnlyEditor(){return!1}getTitle(){return this.localizationTable.handTool}createIcon(){return this.editor.icons.makeHandToolIcon()}handleClick(){this.allowTogglingBaseTool?super.handleClick():this.setDropdownVisible(!this.isDropdownVisible())}getHelpText(){return this.localizationTable.handDropdown__baseHelpText}fillDropdown(o,e){super.fillDropdown(o,e);let n=document.createElement("div");n.classList.add(`${A}nonbutton-controls-main-list`),go().addTo(n);let i=Va(this.localizationTable,this.editor,e);return n.appendChild(i),o.appendChild(n),!0}setSelected(o){this.allowTogglingBaseTool&&super.setSelected(o)}serializeState(){let o=this.overridePanZoomTool.getMode();return{...super.serializeState(),touchPanning:o&1,rotationLocked:o&32}}deserializeFrom(o){o.touchPanning!==void 0&&this.overridePanZoomTool.setModeEnabled(1,!!o.touchPanning),o.rotationLocked!==void 0&&this.overridePanZoomTool.setModeEnabled(32,!!o.rotationLocked),super.deserializeFrom(o)}};var Oe=class extends ae{constructor(e,n,i,r,a,l,c=!1,d=!0){super(e,n,l);this.makeIcon=i;this.title=r;this.clickAction=a;this.mustBeToplevel=c;this.#e=d}#e;#t=void 0;setHelpText(e){this.#t=e}getHelpText(){return this.#t}shouldAutoDisableInReadOnlyEditor(){return this.#e}handleClick(){this.clickAction()}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(e){return!1}mustBeInToplevelMenu(){return this.mustBeToplevel}};var Oa=0,Fa=(s,o,{accepts:e="*",allowMultiSelect:n=!1,customPickerAction:i}={})=>{let r=document.createElement("div"),a=document.createElement("label"),l=document.createElement("input"),c=document.createElement("div");c.classList.add("toolbar--file-input-description");let d=document.createElement("span");r.classList.add("toolbar--file-input-container"),a.appendChild(document.createTextNode(s)),l.accept=e,l.type=i?"button":"file",l.classList.add("file-input"),l.multiple=n;let p=`js-draw-file-input-${Oa++}`;l.setAttribute("id",p),a.htmlFor=p;let u=o.icons.makeUploadFileIcon();u.classList.add("icon"),c.replaceChildren(u,d),a.appendChild(c),r.replaceChildren(a,l);let h=Ln.fromInitialValue([]),f=!1,v=null,x=()=>{let y=h.get();if(f){if(d.textContent=o.localization.fileInput__loading,v){let m=document.createElement("b");m.textContent=o.localization.cancel,m.classList.add("cancel-button"),d.appendChild(m)}u.style.display="none"}else if(y.length>0){let m=y.map(P=>P.name),C=5;if(m.length<=C)d.textContent=m.join(`
`);else{let P=m.slice(0,C-1);d.textContent=[...P,o.localization.fileInput__andNMoreFiles(m.length-P.length)].join(`
`)}u.style.display="none"}else{u.style.display="";let C=o.localization.dragAndDropHereOrBrowse.split(/[{]{2}(.*)[}]{2}/g);d.replaceChildren();for(let P=0;P<C.length;P++)if(P%2===1){let w=document.createElement("b");w.textContent=C[P],d.appendChild(w)}else d.appendChild(document.createTextNode(C[P]))}};if((()=>{a.addEventListener("dragover",y=>{y.preventDefault(),a.classList.add("drag-target")}),a.addEventListener("dragenter",y=>{y.preventDefault(),a.classList.add("drag-target")}),a.addEventListener("dragleave",y=>{y.preventDefault();let m=y.relatedTarget;(!m||!a.contains(m))&&a.classList.remove("drag-target")}),a.addEventListener("drop",y=>{y.preventDefault(),a.classList.remove("drag-target");let m=[];y.dataTransfer&&m.push(...y.dataTransfer.files),h.set(m)}),l.addEventListener("change",()=>{let y=l.files??[];h.set([...y])})})(),i){let y=async()=>{if(f){v?.();return}r.classList.add("-loading"),f=!0,x();try{let m=await i({setOnCancelCallback:C=>{if(!f)throw new Error("Task already completed. Can't register cancel handler.");v=()=>{v=null,x(),C()},x()}});m&&h.set(m)}finally{r.classList.remove("-loading"),f=!1,x()}};l.onclick=y}return h.onUpdate(y=>{y.length===0&&l.files&&l.files.length>0&&(l.value=""),v?.()}),h.onUpdateAndNow(x),{container:r,input:l,selectedFiles:h,addTo:y=>{y.appendChild(r)}}},Or=Fa;var Ha=s=>{let o=s/1024,e=o/1024,n=e/1024,i="B",r=s;return n>=1?(r=n,i="GiB"):e>=1?(r=e,i="MiB"):o>=1&&(r=o,i="KiB"),{size:r,units:i}},Fr=Ha;var bo=class s{constructor(o,e,n){this.imageBase64Url=o;this.preview=e;this.onUrlUpdate=n;this.originalSrc=o,e.src=o}updateImageData(o){this.preview.src=o,this.imageBase64Url=o,this.onUrlUpdate()}decreaseSize(o=3/4){let e=document.createElement("canvas");e.width=this.preview.naturalWidth*o,e.height=this.preview.naturalHeight*o,e.getContext("2d")?.drawImage(this.preview,0,0,e.width,e.height);let i=this.originalSrc?.startsWith("data:image/jpeg;")?"image/jpeg":"image/png";this.updateImageData(e.toDataURL(i))}reset(){this.updateImageData(this.originalSrc)}isChanged(){return this.imageBase64Url!==this.originalSrc}isLarge(){return this.getBase64Url().length>125829.12}getBase64Url(){return this.imageBase64Url}getAltText(){return this.altText}setAltText(o){this.altText=o,this.preview.alt=o}static fromSrcAndPreview(o,e,n){return new s(o,e,n)}static fromRenderable(o,e){let n=new Image;n.src=o.base64Url;let i=new s(o.base64Url,n,e),r=o.label??o.image.getAttribute("alt");return r&&i.setAltText(r),{wrapper:i,preview:n}}};var Na=s=>{let o=document.createElement("div");o.classList.add("toolbar-snapped-scroll-list");let e=document.createElement("div");e.classList.add("scroller");let n=re.fromInitialValue(0),i=null,r=()=>{let u=document.createElement("div");u.classList.add("page-markers"),u.setAttribute("tabindex","-1");let h=[];return _.union([n,s]).onUpdateAndNow(([v,x])=>{let g=!1;for(;x.length<h.length;)h.pop(),g=!0;let y;for(let m=0;m<x.length;m++){let C;if(m>=h.length){C=document.createElement("div");let w=document.createElement("div");w.classList.add("content"),C.replaceChildren(w),h.push(C),g=!0}else C=h[m];C.classList.add("marker"),m===v?(C.classList.add("-active"),y=C):C.classList.remove("-active");let P=m;C.onclick=()=>{c.get()[P]?.element?.scrollIntoView({block:"nearest",behavior:"smooth"})}}g&&u.replaceChildren(...h),y&&u.scrollHeight>o.clientHeight&&y.scrollIntoView({block:"nearest"}),h.length===1?u.classList.add("-one-element"):u.classList.remove("-one-element")}),u},a=()=>{i=new IntersectionObserver(u=>{for(let h of u)if(h.isIntersecting&&h.intersectionRatio>.7){let f=h.target.getAttribute("data-item-index");if(f===null)throw new Error("Could not find attribute data-item-index");let v=Number(f);n.set(v);break}},{root:e,threshold:.9})},l=()=>{i&&(i.disconnect(),n.set(0),i=null)},c=_.map(s,u=>u.map((h,f)=>{let v=document.createElement("div");return h.element.parentElement&&h.element.remove(),v.appendChild(h.element),v.classList.add("item"),v.setAttribute("data-item-index",`${f}`),{element:v,data:h.data}})),d=[];c.onUpdateAndNow(u=>{n.set(-1);for(let h of d)i?.unobserve(h.element);e.replaceChildren(),u.length>1?a():l(),u.length===0?o.classList.add("-empty"):o.classList.remove("-empty");for(let h of u)e.appendChild(h.element);if(n.set(0),i)for(let h of u)i.observe(h.element)});let p=_.map(n,u=>{let h=s.get();return 0<=u&&u<h.length?h[u].data:null});return fo(e),o.replaceChildren(r(),e),{container:o,visibleItem:p}},Hr=Na;var Wa=async s=>{let o=[],e=new Image,n=await nn(s);return n&&o.push({image:e,base64Url:n,transform:I.identity}),o},Nr=Wa;var Nt=class s extends ae{constructor(o,e){e??=o.localization,super(o,"insert-image-widget",e),this.container.classList.add("dropdownShowable"),o.notifier.on(9,n=>{n.kind===9&&this.isDropdownVisible()&&this.updateInputs()}),this.images=re.fromInitialValue([]),this.images.onUpdateAndNow(()=>{this.onImageDataUpdate()})}getTitle(){return this.localizationTable.image}createIcon(){return this.editor.icons.makeInsertImageIcon()}setDropdownVisible(o){super.setDropdownVisible(o),this.isDropdownVisible()?this.updateInputs():this.selectedFiles?.set([])}handleClick(){this.setDropdownVisible(!this.isDropdownVisible())}static{this.nextInputId=0}fillDropdown(o){let e=document.createElement("div");e.classList.add("insert-image-widget-dropdown-content",`${A}spacedList`,`${A}nonbutton-controls-main-list`);let{container:n,selectedFiles:i}=Or(this.localizationTable.chooseFile,this.editor,{accepts:"image/*",allowMultiSelect:!0,customPickerAction:this.editor.getCurrentSettings().image?.showImagePicker}),r=document.createElement("div");this.imagesPreview=Hr(this.images),this.statusView=document.createElement("div");let a=document.createElement("div");a.classList.add("action-button-row"),this.statusView.classList.add("insert-image-image-status-view"),this.submitButton=document.createElement("button"),this.selectedFiles=i,this.imageAltTextInput=document.createElement("input");let l=document.createElement("label"),c=`insert-image-alt-text-input-${s.nextInputId++}`;return this.imageAltTextInput.setAttribute("id",c),l.htmlFor=c,l.innerText=this.localizationTable.inputAltText,this.imageAltTextInput.type="text",this.imageAltTextInput.placeholder=this.localizationTable.describeTheImage,this.statusView.setAttribute("aria-live","polite"),this.submitButton.innerText=this.localizationTable.submit,this.imagesPreview.visibleItem.onUpdateAndNow(()=>this.onImageDataUpdate()),this.imageAltTextInput.oninput=()=>{let d=this.imagesPreview.visibleItem.get();d&&(d.setAltText(this.imageAltTextInput.value),this.submitButton.style.display="")},this.selectedFiles.onUpdateAndNow(async d=>{if(d.length===0){this.images.set([]);return}let p=(await Promise.all(d.map(async u=>{let h;try{h=await Nr(u)}catch(f){console.error("Image load error",f);let v=this.localizationTable.imageLoadError(f);return this.statusView.innerText=v,[]}return h.map(f=>{let{wrapper:v,preview:x}=bo.fromRenderable(f,()=>this.onImageDataUpdate());return{data:v,element:x}})}))).flat();this.images.set(p)}),r.replaceChildren(l,this.imageAltTextInput),a.replaceChildren(this.submitButton),e.replaceChildren(n,r,this.imagesPreview.container,this.statusView,a),o.replaceChildren(e),!0}onImageDataUpdate(){if(!this.imagesPreview)return;let o=this.imagesPreview.visibleItem.get(),e=o?.getBase64Url();this.imageAltTextInput.value=o?.getAltText()??"",e?(this.submitButton.disabled=!1,this.submitButton.style.display="",this.updateImageSizeDisplay()):(this.submitButton.disabled=!0,this.submitButton.style.display="none",this.statusView.innerText="",this.submitButton.disabled=!0),this.images.get().length<=1?this.submitButton.innerText=this.localizationTable.submit:this.submitButton.innerText=this.localizationTable.addAll}hideDialog(){this.setDropdownVisible(!1)}updateImageSizeDisplay(){let o=this.imagesPreview.visibleItem.get(),e=o?.getBase64Url()??"",{size:n,units:i}=Fr(e.length),r=document.createElement("span");r.innerText=this.localizationTable.imageSize(Math.round(n),i);let a=document.createElement("button");a.innerText=this.localizationTable.decreaseImageSize,a.onclick=()=>{o?.decreaseSize()};let l=document.createElement("button");l.innerText=this.localizationTable.resetImage,l.onclick=()=>{o?.reset()},this.statusView.replaceChildren(r),o?.isLarge()?this.statusView.appendChild(a):o?.isChanged()?this.statusView.appendChild(l):this.images.get().some(d=>d.data?.isChanged()||d.data?.isLarge())&&(a.disabled=!0,this.statusView.appendChild(a))}updateInputs(){(()=>{this.selectedFiles?.set([]),this.imageAltTextInput.value="",this.submitButton.disabled=!0,this.statusView.innerText="",this.submitButton.style.display=""})();let e=this.editor.toolController.getMatchingTools(ze),n=e.map(r=>r.getSelectedObjects()).flat(),i=null;if(n.length===1&&n[0]instanceof Ie){i=n[0];let r=new Image,a=bo.fromSrcAndPreview(i.getURL(),r,()=>this.onImageDataUpdate());a.setAltText(i.getAltText()??""),this.images.set([{data:a,element:r}])}else n.length>0&&e.forEach(r=>r.clearSelection());this.submitButton.style.display="none",this.submitButton.onclick=async()=>{let r=[],a=I.identity,l=null;for(let{data:c}of this.images.get()){if(!c)continue;let d=new Image;d.src=c.getBase64Url();let p=c.getAltText();p&&d.setAttribute("alt",p);let u;try{u=await Ie.fromImage(d,a)}catch(v){console.error("Error loading image",v),this.statusView.innerText=this.localizationTable.imageLoadError(v);return}let h=u.getBBox();if(h.area===0){this.statusView.innerText=this.localizationTable.errorImageHasZeroSize;return}r.push(u),l??=h,l.union(h);let f=S.of(0,h.height);a=a.rightMul(I.translation(f))}if(r.length){if(!l)throw new Error("Logic error: Full bounding box must be calculated when components are to be added.");if(this.hideDialog(),i){let c=new ne([i]),d=i.getTransformation(),p=i.getBBox().width||1,u=l.transformedBoundingBox(d).width||1,h=I.scaling2D(p/u),f=[];for(let v of r)f.push(Q.addComponent(v),v.transformBy(d.rightMul(h)),v.setZIndex(i.getZIndex()));this.editor.dispatch(he([...f,c])),e[0]?.setSelection(r)}else await this.editor.addAndCenterComponents(r)}}}};var Wt=class s extends ae{constructor(e,n){super(e,"document-properties-widget",n);this.updateDropdownContent=()=>{};this.dropdownUpdateQueued=!1;this.container.classList.add("dropdownShowable"),this.editor.notifier.on(3,()=>{this.queueDropdownUpdate()}),this.editor.image.notifier.on(0,()=>{this.queueDropdownUpdate()})}getTitle(){return this.localizationTable.documentProperties}createIcon(){return this.editor.icons.makeConfigureDocumentIcon()}handleClick(){this.setDropdownVisible(!this.isDropdownVisible()),this.queueDropdownUpdate()}queueDropdownUpdate(){this.dropdownUpdateQueued||(requestAnimationFrame(()=>this.updateDropdown()),this.dropdownUpdateQueued=!0)}updateDropdown(){this.dropdownUpdateQueued=!1,this.isDropdownVisible()&&this.updateDropdownContent()}setBackgroundColor(e){this.editor.dispatch(this.editor.setBackgroundColor(e))}getBackgroundColor(){return this.editor.estimateBackgroundColor()}removeBackgroundComponents(){let e=[];for(let n of this.editor.image.getBackgroundComponents())n instanceof Re&&e.push(n);return new ne(e)}setBackgroundType(e){let n=this.editor.estimateBackgroundColor(),i=new Re(e,n),r=this.editor.image.addComponent(i);return he([this.removeBackgroundComponents(),r])}getBackgroundType(){let e=this.editor.image.getBackgroundComponents();for(let n=e.length-1;n>=0;n--){let i=e[n];if(i instanceof Re)return i.getBackgroundType()}return 2}updateImportExportRectSize(e){let n=c=>(c!==void 0&&(!isFinite(c)||c<=0)&&(c=100),c),i=n(e.width),r=n(e.height),a=this.editor.getImportExportRect(),l=new z(a.x,a.y,i??a.w,r??a.h);this.editor.dispatch(this.editor.image.setImportExportRect(l)),this.editor.queueRerender()}getHelpText(){return this.localizationTable.pageDropdown__baseHelpText}static{this.idCounter=0}fillDropdown(e,n){let i=document.createElement("div");i.classList.add(`${A}spacedList`,`${A}nonbutton-controls-main-list`,`${A}document-properties-widget`);let r=()=>{let m=document.createElement("div"),C=document.createElement("label");C.innerText=this.localizationTable.backgroundColor;let{input:P,container:w,setValue:E,registerWithHelpTextDisplay:T}=ot(this.editor,O=>{O.eq(this.getBackgroundColor())||this.setBackgroundColor(O)});return P.id=`${A}docPropertiesColorInput-${s.idCounter++}`,C.htmlFor=P.id,m.replaceChildren(C,w),{setBgColorInputValue:E,backgroundColorRow:m,registerWithHelp:O=>{O&&(O?.registerTextHelpForElement(m,this.localizationTable.pageDropdown__backgroundColorHelpText),T(O))}}},{backgroundColorRow:a,setBgColorInputValue:l,registerWithHelp:c}=r(),d=(m,C)=>{let P=document.createElement("div"),w=document.createElement("label"),E=document.createElement("input");return E.id=`${A}docPropertiesCheckbox-${s.idCounter++}`,w.htmlFor=E.id,E.type="checkbox",w.innerText=m,E.oninput=()=>{C(E.checked)},P.replaceChildren(w,E),{container:P,checkbox:E}},{container:p,checkbox:u}=d(this.localizationTable.useGridOption,m=>{if(this.getBackgroundType()===1===m)return;let w=0;m&&(w=1),this.editor.dispatch(this.setBackgroundType(w))}),h=(m,C)=>{let P=document.createElement("div"),w=document.createElement("label"),E=document.createElement("input");return w.innerText=m,E.type="number",E.min="0",E.id=`${A}docPropertiesDimensionRow-${s.idCounter++}`,w.htmlFor=E.id,E.style.flexGrow="2",E.style.width="25px",E.oninput=()=>{C(parseFloat(E.value))},P.classList.add("js-draw-size-input-row"),P.replaceChildren(w,E),{setValue:T=>{if(document.activeElement===E&&E.value.match(/^0*$/)){let V=E.value;E.type="text",E.value=T.toString();let O=Math.max(1,E.value.length-V.length);E.setSelectionRange(0,O),E.type="number"}else E.value=T.toString()},setIsAutomaticSize:T=>{E.disabled=T;let V="size-input-row--automatic-size";T?P.classList.add(V):P.classList.remove(V)},element:P}},f=h(this.localizationTable.imageWidthOption,m=>{this.updateImportExportRectSize({width:m})}),v=h(this.localizationTable.imageHeightOption,m=>{this.updateImportExportRectSize({height:m})}),{container:x,checkbox:g}=d(this.localizationTable.enableAutoresizeOption,m=>{let C=this.editor.image;this.editor.dispatch(C.setAutoresizeEnabled(m))}),y=document.createElement("button");return y.classList.add("about-button"),y.innerText=this.localizationTable.about,y.onclick=()=>{this.editor.showAboutDialog()},c(n),n?.registerTextHelpForElement(p,this.localizationTable.pageDropdown__gridCheckboxHelpText),n?.registerTextHelpForElement(x,this.localizationTable.pageDropdown__autoresizeCheckboxHelpText),n?.registerTextHelpForElement(y,this.localizationTable.pageDropdown__aboutButtonHelpText),this.updateDropdownContent=()=>{l(this.getBackgroundColor());let m=this.editor.image.getAutoresizeEnabled(),C=this.editor.getImportExportRect();f.setValue(C.width),v.setValue(C.height),g.checked=m,f.setIsAutomaticSize(m),v.setIsAutomaticSize(m),u.checked=this.getBackgroundType()===1},this.updateDropdownContent(),i.replaceChildren(a,p,f.element,v.element,x,y),e.replaceChildren(i),!0}};var zi=class extends Oe{constructor(o,e,n,i={}){super(o,"save-button",()=>i.icon??o.icons.makeSaveIcon(),i.label??e.save,n),this.setTags(["save"])}shouldAutoDisableInReadOnlyEditor(){return!1}onKeyPress(o){return this.editor.shortcuts.matchesShortcut(Ei,o)?(this.clickAction(),!0):super.onKeyPress(o)}mustBeInToplevelMenu(){return!0}},Wr=zi;var Bi=class extends Oe{constructor(o,e,n,i={}){super(o,"exit-button",()=>i.icon??o.icons.makeCloseIcon(),i.label??e.exit,n),this.setTags(["exit"])}shouldAutoDisableInReadOnlyEditor(){return!1}onKeyPress(o){return this.editor.shortcuts.matchesShortcut(ki,o)?(this.clickAction(),!0):super.onKeyPress(o)}mustBeInToplevelMenu(){return!0}},Ur=Bi;var Ut=class s{constructor(o,e){this.editor=o;this.#e=[];this.#t={};this.#o=[];this.#n=null;this.closeColorPickerOverlay=null;this.localizationTable=e??o.localization,s.colorisStarted||(Ar(),s.colorisStarted=!0),this.setupColorPickers()}#e;#t;#o;static{this.colorisStarted=!1}#n;setupCloseColorPickerOverlay(){this.closeColorPickerOverlay||(this.closeColorPickerOverlay=document.createElement("div"),this.closeColorPickerOverlay.className=`${A}closeColorPickerOverlay`,this.editor.createHTMLOverlay(this.closeColorPickerOverlay),this.#e.push(this.editor.handlePointerEventsExceptClicksFrom(this.closeColorPickerOverlay,o=>(o==="pointerdown"&&bi(),o==="pointerup"&&this.editor.focus(),!0))))}setupColorPickers(){if(this.#n){this.#n();return}this.setupCloseColorPickerOverlay();let o=12,e=[M.red.toHexString(),M.purple.toHexString(),M.blue.toHexString(),M.clay.toHexString(),M.black.toHexString(),M.white.toHexString()],n=e.length,i=!1,r=()=>{try{Dr({el:".coloris_input",format:"hex",selectInput:!1,focusInput:!1,themeMode:"auto",swatches:e})}catch(l){console.warn("Failed to initialize Coloris. Error: ",l),i||(i=!0,document.addEventListener("load",()=>{r()},{once:!0}))}};r(),this.#n=r;let a=l=>{let c=!1;for(let d of e)d===l&&(c=!0);c||(e.push(l),e.length>o&&e.splice(n,1),r())};this.#e.push(this.editor.notifier.on(11,l=>{l.kind===11&&this.closeColorPickerOverlay&&(this.closeColorPickerOverlay.style.display=l.open?"block":"none")})),this.#e.push(this.editor.notifier.on(12,l=>{l.kind===12&&a(l.color.toHexString())}))}closeColorPickers(){bi?.()}getWidgetUniqueId(o){return o.getUniqueIdIn(this.#t)}getWidgetFromId(o){return this.#t[o]}getAllWidgets(){return this.#o}addWidget(o){let e=o.getUniqueIdIn(this.#t);this.#t[e]=o,this.#o.push(o),this.addWidgetInternal(o),this.setupColorPickers()}removeWidget(o){let e=o.getUniqueIdIn(this.#t);this.removeWidgetInternal(o),delete this.#t[e],this.#o=this.#o.filter(n=>n!==o)}static{this.rootToolbarId="root-toolbar--"}serializeState(){let o={};for(let e in this.#t)o[e]=this.#t[e].serializeState();return o[s.rootToolbarId]=this.serializeInternal(),JSON.stringify(o)}deserializeState(o){let e=JSON.parse(o);Mo(e),Zi(e);let n=s.rootToolbarId;n in e&&typeof e[n]<"u"&&this.deserializeInternal(e[n]);for(let i in e)if(i!==n){if(!(i in this.#t)){console.warn(`Unable to deserialize widget ${i} \xAD\u2014 no such widget.`);continue}typeof e[i]=="object"&&e[i]&&this.#t[i].deserializeFrom(e[i])}}serializeInternal(){}deserializeInternal(o){}makeActionButton(o,e,n=!0){typeof n=="boolean"&&(n={mustBeToplevel:n});let i=n.mustBeToplevel??!0,r=n.autoDisableInReadOnlyEditors??!0,a=typeof o=="string"?o:o.label,l="action-button",c=()=>typeof o=="string"?null:o.icon;return new Oe(this.editor,l,c,a,e,this.editor.localization,i,r)}addActionButton(o,e,n=!0){let i=this.makeActionButton(o,e,n);return this.addWidget(i),i}addTaggedActionButton(o,e,n,i=!0){let r=this.makeActionButton(e,n,i);return r.setTags(o),this.addWidget(r),r}addSaveButton(o,e={}){let n=new Wr(this.editor,this.localizationTable,o,e);return this.addWidget(n),n}addExitButton(o,e={}){let n=new Ur(this.editor,this.localizationTable,o,e);return this.addWidget(n),n}addUndoRedoButtons(o=!0){let e=()=>this.addTaggedActionButton(["undo"],{label:this.localizationTable.undo,icon:this.editor.icons.makeUndoIcon()},()=>{this.editor.history.undo()}),n=()=>this.addTaggedActionButton(["redo"],{label:this.localizationTable.redo,icon:this.editor.icons.makeRedoIcon()},()=>{this.editor.history.redo()}),i,r;o?(i=e(),r=n()):(r=n(),i=e()),i.setDisabled(!0),r.setDisabled(!0),this.editor.notifier.on(3,a=>{if(a.kind!==3)throw new Error("Wrong event type!");i.setDisabled(a.undoStackSize===0),r.setDisabled(a.redoStackSize===0)})}addWidgetsForPrimaryTools(o){for(let e of this.editor.toolController.getPrimaryTools())if(!(o&&!o?.(e)))if(e instanceof ht){let n=new At(this.editor,e,this.localizationTable);this.addWidget(n)}else e instanceof mt?this.addWidget(new Vt(this.editor,e,this.localizationTable)):e instanceof ze?this.addWidget(new Ot(this.editor,e,this.localizationTable)):e instanceof Je?this.addWidget(new Ft(this.editor,e,this.localizationTable)):e instanceof De&&this.addWidget(new Ht(this.editor,e,this.localizationTable))}addDefaultToolWidgets(){this.addWidgetsForPrimaryTools(),this.addDefaultEditorControlWidgets()}addDefaultEditorControlWidgets(){this.addWidget(new Wt(this.editor,this.localizationTable)),this.addWidget(new Nt(this.editor,this.localizationTable))}addDefaultActionButtons(){this.addUndoRedoButtons()}remove(){this.closeColorPickerOverlay?.remove();for(let o of this.#e)o.remove();this.#e=[],this.onRemove();for(let o of this.#o)o.remove()}manageListener(o){this.#e.push(o)}};var Ya=s=>s instanceof U?new class extends U{constructor(){super(...arguments);this._command=s}serializeToJSON(){return s.serialize()}apply(e){s.unapply(e)}unapply(e){s.apply(e)}onDrop(e){s.onDrop(e)}description(e,n){return n.inverseOf(s.description(e,n))}}("inverse"):new class extends Pe{apply(e){s.unapply(e)}unapply(e){s.apply(e)}onDrop(e){s.onDrop(e)}description(e,n){return n.inverseOf(s.description(e,n))}};U.register("inverse",(s,o)=>Ya(U.deserialize(s,o)));var $r=`\`@js-draw/material-icons\`: Material icon integration for \`js-draw\`.

All icons in \`@js-draw/material-icons\` were found using [Google WebFonts search](https://fonts.google.com/icons) and downloaded from there.

A copy of the license for these icons is included below:

\`\`\`

                                 Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      "License" shall mean the terms and conditions for use, reproduction,
      and distribution as defined by Sections 1 through 9 of this document.

      "Licensor" shall mean the copyright owner or entity authorized by
      the copyright owner that is granting the License.

      "Legal Entity" shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under common
      control with that entity. For the purposes of this definition,
      "control" means (i) the power, direct or indirect, to cause the
      direction or management of such entity, whether by contract or
      otherwise, or (ii) ownership of fifty percent (50%) or more of the
      outstanding shares, or (iii) beneficial ownership of such entity.

      "You" (or "Your") shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      "Source" form shall mean the preferred form for making modifications,
      including but not limited to software source code, documentation
      source, and configuration files.

      "Object" form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      "Work" shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      "Derivative Works" shall mean any work, whether in Source or Object
      form, that is based on (or derived from) the Work and for which the
      editorial revisions, annotations, elaborations, or other modifications
      represent, as a whole, an original work of authorship. For the purposes
      of this License, Derivative Works shall not include works that remain
      separable from, or merely link (or bind by name) to the interfaces of,
      the Work and Derivative Works thereof.

      "Contribution" shall mean any work of authorship, including
      the original version of the Work and any modifications or additions
      to that Work or Derivative Works thereof, that is intentionally
      submitted to Licensor for inclusion in the Work by the copyright owner
      or by an individual or Legal Entity authorized to submit on behalf of
      the copyright owner. For the purposes of this definition, "submitted"
      means any form of electronic, verbal, or written communication sent
      to the Licensor or its representatives, including but not limited to
      communication on electronic mailing lists, source code control systems,
      and issue tracking systems that are managed by, or on behalf of, the
      Licensor for the purpose of discussing and improving the Work, but
      excluding communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as "Not a Contribution."

      "Contributor" shall mean Licensor and any individual or Legal Entity
      on behalf of whom a Contribution has been received by Licensor and
      subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      copyright license to reproduce, prepare Derivative Works of,
      publicly display, publicly perform, sublicense, and distribute the
      Work and such Derivative Works in Source or Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have made,
      use, offer to sell, sell, import, and otherwise transfer the Work,
      where such license applies only to those patent claims licensable
      by such Contributor that are necessarily infringed by their
      Contribution(s) alone or by combination of their Contribution(s)
      with the Work to which such Contribution(s) was submitted. If You
      institute patent litigation against any entity (including a
      cross-claim or counterclaim in a lawsuit) alleging that the Work
      or a Contribution incorporated within the Work constitutes direct
      or contributory patent infringement, then any patent licenses
      granted to You under this License for that Work shall terminate
      as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a "NOTICE" text file as part of its
          distribution, then any Derivative Works that You distribute must
          include a readable copy of the attribution notices contained
          within such NOTICE file, excluding those notices that do not
          pertain to any part of the Derivative Works, in at least one
          of the following places: within a NOTICE text file distributed
          as part of the Derivative Works; within the Source form or
          documentation, if provided along with the Derivative Works; or,
          within a display generated by the Derivative Works, if and
          wherever such third-party notices normally appear. The contents
          of the NOTICE file are for informational purposes only and
          do not modify the License. You may add Your own attribution
          notices within Derivative Works that You distribute, alongside
          or as an addendum to the NOTICE text from the Work, provided
          that such additional attribution notices cannot be construed
          as modifying the License.

      You may add Your own copyright statement to Your modifications and
      may provide additional or different license terms and conditions
      for use, reproduction, or distribution of Your modifications, or
      for any such Derivative Works as a whole, provided Your use,
      reproduction, and distribution of the Work otherwise complies with
      the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state otherwise,
      any Contribution intentionally submitted for inclusion in the Work
      by You to the Licensor shall be under the terms and conditions of
      this License, without any additional terms or conditions.
      Notwithstanding the above, nothing herein shall supersede or modify
      the terms of any separate license agreement you may have executed
      with Licensor regarding such Contributions.

   6. Trademarks. This License does not grant permission to use the trade
      names, trademarks, service marks, or product names of the Licensor,
      except as required for reasonable and customary use in describing the
      origin of the Work and reproducing the content of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or conditions
      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
      PARTICULAR PURPOSE. You are solely responsible for determining the
      appropriateness of using or redistributing the Work and assume any
      risks associated with Your exercise of permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and grossly
      negligent acts) or agreed to in writing, shall any Contributor be
      liable to You for damages, including any direct, indirect, special,
      incidental, or consequential damages of any character arising as a
      result of this License or out of the use or inability to use the
      Work (including but not limited to damages for loss of goodwill,
      work stoppage, computer failure or malfunction, or any and all
      other commercial damages or losses), even if such Contributor
      has been advised of the possibility of such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by reason
      of your accepting any such warranty or additional liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets "[]"
      replaced with your own identifying information. (Don't include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same "printed page" as the copyright notice for easier
      identification within third-party archives.

   Copyright [yyyy] [name of copyright owner]

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
\`\`\`
`;var Xa='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M480-339.5 234.261-585.239 283-633.978l197 198 197-197 48.739 48.739L480-339.5Z"/></svg>',qr=Xa;var Qa='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M261.152-194.022v-68.13h311.674q67.848 0 116.435-45.783 48.587-45.782 48.587-113.108 0-67.087-48.587-112.99-48.587-45.902-116.435-45.902H283.805l110.173 110.174-47.739 47.739L154.022-614l192.217-192.218 47.739 47.74-110.173 110.413h288.021q96.196 0 165.294 65.674 69.098 65.674 69.098 161.348 0 95.434-69.098 161.228-69.098 65.793-165.294 65.793H261.152Z"/></svg>',Kr=Qa;var Ja='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M388.174-194.022q-96.196 0-165.174-65.674-68.978-65.674-68.978-161.347 0-95.435 68.978-161.229 68.978-65.793 165.174-65.793h288.261L566.022-758.478l47.739-47.74L806.218-614 613.761-422.022l-47.739-47.739 110.413-110.174H387.174q-67.848 0-116.435 45.783-48.587 45.782-48.587 113.109 0 67.326 48.587 113.108 48.587 45.783 116.435 45.783h311.674v68.13H388.174Z"/></svg>',Gr=Ja;var el='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M687.805-222.152h203v68.13h-271.37l68.37-68.13Zm-515.501 68.13-81.478-84.239q-20.431-19.622-19.792-47.235.64-27.613 19.031-47.004l456.326-494.413q18.391-19.391 46.314-19.272 27.923.12 47.404 19.511L841.283-615.5q19.63 19.622 20.63 47.855 1 28.232-18.63 47.623l-341.957 366H172.304Zm302.695-68.13 322.305-349.37-203.413-213.413-452.848 499.174 61.37 63.609h272.586ZM480-480Z"/></svg>',Zr=el;var tl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M813-61 605-269 503-160H179l-81-84q-18-17-17.5-41.5T97-327l216-234L61-813l43-43 752 752-43 43ZM206-220h274l83-91-209-209-212 234 64 66Zm482-138-42-42 158-172-207-217-161 179-41-41 160-174q16-17 40.567-17 24.566 0 41.433 17l205 215q17 17 18 42t-16 42L688-358ZM541-505Zm-82 89Z"/></svg>',_r=tl;var ol='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M402.097-34.022q-27.578 0-52.794-12.858-25.216-12.859-40.216-36.337L53.044-468.24l20.928-16q17.985-15 41.322-19 23.336-4 47.801 14.383l114.514 87.312v-411.804q0-13.641 9.439-23.016 9.439-9.375 23.174-9.375t22.952 9.375q9.217 9.375 9.217 23.016v533.978L172.935-404.022l189.934 284.373q6.805 10.323 16.699 15.584 9.893 5.26 22.432 5.26h291.826q37.1 0 62.355-25.254 25.254-25.254 25.254-62.354v-587.413q0-13.641 9.439-23.016 9.439-9.376 23.174-9.376T837-796.842q9.218 9.375 9.218 23.016v587.413q0 63.957-44.218 108.174-44.217 44.217-108.174 44.217H402.097Zm43.946-443.587v-417.174q0-13.641 9.274-23.016 9.273-9.375 23.008-9.375t22.998 9.375q9.264 9.375 9.264 23.016v417.174h-64.544Zm168.196 0v-376.217q0-13.641 9.426-23.016 9.426-9.376 23.141-9.376 13.614 0 22.795 9.376 9.182 9.375 9.182 23.016v376.217h-64.544ZM477.065-288.326Z"/></svg>',jr=ol;var nl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M439.5-74.022q-32.2 0-61.652-13.247-29.452-13.248-49.153-38.535L109.543-404.913l27.218-27.065q15.888-15.545 38.194-18.773 22.306-3.227 42.219 7.49l93.978 49.652v-357.348q0-13.915 9.653-23.512 9.653-9.596 23.66-9.596 14.008 0 23.456 9.596 9.449 9.597 9.449 23.512v467.631l-150.935-80.348 156.478 197.761q10.486 12.622 25.085 19.028 14.599 6.407 31.024 6.407H652.87q36.463 0 61.677-25.04t25.214-61.692v-163.942q0-27.891-19.091-46.815-19.092-18.924-46.888-18.924H457.37v-66.457h216.058q55.15 0 93.97 38.647t38.82 93.549v164.022q0 64.195-44.577 108.652-44.576 44.456-108.664 44.456H439.5ZM191.761-662.609q-11.535-19.444-17.746-41.981-6.211-22.538-6.211-46.401 0-73.357 51.604-124.77 51.603-51.413 124.818-51.413t124.853 51.635q51.638 51.635 51.638 124.895 0 23.799-6.211 46.238t-17.745 41.797l-57.5-33.108q7-12 11-26t4-29.478q0-45.522-32.118-77.522-32.118-32-78-32t-77.882 32.083q-32 32.083-32 77.917 0 15 4 29t11 26l-57.5 33.108Zm291.456 330.696Z"/></svg>',Yr=nl;var il='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="m724.391-486.891 48.979-48.739 52.521 52.521q21.631 21.746 21.631 52.156t-21.631 52.04L672.087-226.348q-22.746 22.631-52.155 22.631-29.41 0-52.041-22.631L249.587-544.891q-22.391-22.152-22.511-51.739-.119-29.588 22.511-52.218l153.565-152.565q22.63-22.63 52.098-22.63 29.467 0 52.098 22.63l47.282 47.522-47.739 48.5-51.521-51.522L295.087-596.63l325.022 325.782 160.043-160.043-55.761-56ZM533.574-30.761q-98.76 0-186.047-37.5-87.288-37.5-152.168-102.88-64.881-65.381-102.38-152.638-37.5-87.257-37.5-185.982h62.63q0 78.565 28.163 148.75t76.967 124.587q48.804 54.402 115.272 89.663 66.467 35.261 142.554 43.978L355.848-228 401-273.152 631.152-43.053Q608.253-37 585.237-33.88t-51.663 3.12ZM664.63-602.63q-15 0-27.5-12.5t-12.5-27.5v-120q0-15 12.5-27.5t27.5-12.5h1v-42q0-33 22.5-55.5t55.5-22.5q33 0 55.5 22.5t22.5 55.5v42h2q15 0 27.5 12.5t12.5 27.5v120q0 15-12.5 27.5t-27.5 12.5h-159Zm39-200h80v-42.106q0-17.894-11-28.894t-29-11q-18 0-29 11t-11 28.894v42.106ZM540.239-513.761Z"/></svg>',Xr=il;var rl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M182.152-114.022q-27.599 0-47.865-20.265-20.265-20.266-20.265-47.865v-595.696q0-27.697 20.265-48.033 20.266-20.337 47.865-20.337h595.696q27.697 0 48.033 20.337 20.337 20.336 20.337 48.033v595.696q0 27.599-20.337 47.865-20.336 20.265-48.033 20.265H182.152Zm0-68.13h595.696v-595.696H182.152v595.696Zm50.739-92.696h495.218L578-476.587l-132 171-93-127-120.109 157.739Zm-50.739 92.696v-595.696 595.696Zm157.966-383.783q22.576 0 38.262-15.803 15.685-15.803 15.685-38.38 0-22.576-15.803-38.262-15.803-15.685-38.38-15.685-22.576 0-38.262 15.803-15.685 15.803-15.685 38.38 0 22.576 15.803 38.262 15.803 15.685 38.38 15.685Z"/></svg>',Qr=rl;var sl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M425.935-154.022v-544.065H194.022v-108.131h572.196v108.131H534.304v544.065H425.935Z"/></svg>',Jr=sl;var al='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M120-439v-83h60v83h-60Zm0-170v-83h60v83h-60Zm0-171v-60h60v60h-60Zm148 0v-60h83v60h-83Zm171 660v-60h83v60h-83Zm0-660v-60h83v60h-83Zm170 660v-60h83v60h-83Zm171 0v-60h60v60h-60Zm0-148v-83h60v83h-60Zm0-171v-83h60v83h-60Zm0-170v-171H609v-60h231v231h-60ZM120-120v-231h60v171h171v60H120Z"/></svg>',es=al;var ll='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M261-120q-24.75 0-42.375-17.625T201-180v-570h-41v-60h188v-30h264v30h188v60h-41v570q0 24-18 42t-42 18H261Zm438-630H261v570h438v-570ZM367-266h60v-399h-60v399Zm166 0h60v-399h-60v399ZM261-750v570-570Z"/></svg>',ts=ll;var cl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M180-81q-24 0-42-18t-18-42v-603h60v603h474v60H180Zm120-120q-24 0-42-18t-18-42v-560q0-24 18-42t42-18h440q24 0 42 18t18 42v560q0 24-18 42t-42 18H300Zm0-60h440v-560H300v560Zm0 0v-560 560Z"/></svg>',Mi=cl;var dl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M220-80q-24 0-42-18t-18-42v-680q0-24 18-42t42-18h340l240 240v156h-60v-116H520v-220H220v680h300v60H220Zm0-60v-680 680Zm536-223 28 28-164 164v51h51l164-164 28 28L687-80H580v-107l176-176Zm107 107L756-363l61-61q9-9 21-9t21 9l65 65q9 9 9 21t-9 21l-61 61Z"/></svg>',os=dl;var ul='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M378-246 154-470l43-43 181 181 384-384 43 43-427 427Z"/></svg>',ns=ul;var pl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M545.63-401.022 431.587-515.065 217.478-301.196l114.283 114.283L545.63-401.022Zm-65.304-163.021 114.283 114.282 214.674-214.674-114.044-114.282-214.913 214.674Zm-72.848-23.87 211 211L389.5-147.935q-21.152 21.153-58.359 21.153-37.206 0-58.119-21.153l-10.761-10.521-44.913 44.674h-155L184.26-235.456l-3.761-4q-24.391-24.153-23.891-61.12.5-36.968 24.891-61.359l225.978-225.978Zm0 0 241.783-241.783q19.63-19.63 48.859-19.63 29.228 0 49.098 19.63l111.043 111.283q19.63 19.63 19.13 51.478-.5 31.848-20.13 51.479L618.478-376.913l-211-211Z"/></svg>',is=pl;var hl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M180-180h44l443-443-44-44-443 443v44Zm614-486L666-794l42-42q17-17 42-17t42 17l44 44q17 17 17 42t-17 42l-42 42Zm-42 42L248-120H120v-128l504-504 128 128Zm-107-21-22-22 44 44-22-22Z"/></svg>',rs=hl;var ml='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M250-160q-86 0-148-62T40-370q0-78 49.5-137.5T217-579q20-97 94-158.5T482-799q113 0 189.5 81.5T748-522v24q72-2 122 46.5T920-329q0 69-50 119t-119 50H510q-24 0-42-18t-18-42v-258l-83 83-43-43 156-156 156 156-43 43-83-83v258h241q45 0 77-32t32-77q0-45-32-77t-77-32h-63v-84q0-89-60.5-153T478-739q-89 0-150 64t-61 153h-19q-62 0-105 43.5T100-371q0 62 43.929 106.5Q187.857-220 250-220h140v60H250Zm230-290Z"/></svg>',ss=ml;var fl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M435-80q-48-7-93-25t-85-48l43-44q32 24 66 37.5t69 19.5v60Zm90 0v-60q110-21 182.5-103.5T780-443q0-127-86.5-213.5T480-743h-20l79 79-44 44-153-153 153-153 44 44-79 79h20q75 0 140.5 28T735-698q49 49 77 114.5T840-443q0 140-89 241T525-80ZM194-216q-28-38-46.5-84.5T122-398h61q5 38 18.5 73t36.5 65l-44 44Zm-72-272q7-50 25-95.5t47-85.5l44 43q-23 33-36.5 68T183-488h-61Z"/></svg>',as=fl;var gl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M180-120q-24 0-42-18t-18-42h60v60Zm-60-120v-125h60v125h-60Zm0-185v-111h60v111h-60Zm0-171v-124h60v124h-60Zm0-184q0-24 18-42t42-18v60h-60Zm120 660v-60h125v60H240Zm0-660v-60h125v60H240Zm185 660v-60h111v60H425Zm0-660v-60h111v60H425Zm171 660v-60h124v60H596Zm0-660v-60h124v60H596Zm184 660v-60h60q0 24-18 42t-42 18Zm0-120v-125h60v125h-60Zm0-185v-111h60v111h-60Zm0-171v-124h60v124h-60Zm0-184v-60q24 0 42 18t18 42h-60Z"/></svg>',ls=gl;var bl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="m249-207-42-42 231-231-231-231 42-42 231 231 231-231 42 42-231 231 231 231-42 42-231-231-231 231Z"/></svg>',cs=bl;var vl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M600-360Zm-280 98q10 2 19.5 2H360q5.5 0 10.25-.25T380-261v121h440v-440H699q.5-5 .75-9.75T700-600v-20.5q0-9.5-2-19.5h122q24.75 0 42.375 17.625T880-580v440q0 24.75-17.625 42.375T820-80H380q-24.75 0-42.375-17.625T320-140v-122Zm40-58q-117 0-198.5-81.5T80-600q0-117 81.5-198.5T360-880q117 0 198.5 81.5T640-600q0 117-81.5 198.5T360-320Zm-.212-60Q451-380 515.5-444.288q64.5-64.288 64.5-155.5T515.712-755.5q-64.288-64.5-155.5-64.5T204.5-755.712q-64.5 64.288-64.5 155.5T204.288-444.5q64.288 64.5 155.5 64.5ZM360-600Z"/></svg>',ds=vl;var yl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="M560-120q-12 0-21-9t-9-21q0-13 9-21.5t21-8.5q59 0 99.5-24t40.5-56q0-23-29.5-45T591-339l47-47q63 19 92.5 52.5T760-260q0 67-61 103.5T560-120ZM240-414q-64-14-92-44t-28-62q0-35 26-63t120-62q66-24 85-39t19-35q0-25-22-43t-68-18q-27 0-46 7t-34 22q-8 8-20.5 9.5T157-748q-11-8-11.5-20t7.5-21q17-22 51-36.5t76-14.5q68 0 109 32.5t41 88.5q0 41-28.5 69.5T290-590q-67 25-88.5 39.5T180-520q0 16 27 30.5t81 27.5l-48 48Zm496-154L608-696l45-45q18-18 40-18t40 18l48 48q18 18 18 40t-18 40l-45 45ZM220-180h42l345-345-42-42-345 345v42Zm-60 60v-128l405-405 128 128-405 405H160Zm405-447 42 42-42-42Z"/></svg>',us=yl;var xl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="m480-522 42 42 249-249-42-42-249 249ZM180-180h42l258-258-42-42-258 258v42Zm362-238L418-542l198-198-30-30-234 234-43-43 228-228q25-25 49.5-25.5T637-807l23 23 45-45q11-11 25-11t25 11l73 73q11 11 11 26t-11 26L542-418ZM244-120H120v-124l298-298 124 124-298 298Z"/></svg>',ps=xl;var Tl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 0 24 24" width="48"><path style="fill: var(--icon-color);" d="M19 2h-4.18C14.4.84 13.3 0 12 0S9.6.84 9.18 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>',hs=Tl;var Cl='<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"><path style="fill: var(--icon-color);" d="m141-518-60-6q5-46 20-90t40-82l51 33q-19 34-32 70.5T141-518Zm55 317q-32-31-56.5-69T101-353l58-19q13 37 33 69t47 59l-43 43Zm102-568-33-51q40-25 82.5-39.5T438-880l6 60q-41 5-75.5 17.5T298-769ZM488-82q-38 0-74-6t-68-17l22-58q27 10 59 15t61 6v60Zm232-635q-29-29-62-50.5T587-802l21-57q47 16 85.5 41.5T763-760l-43 43Zm93 600L682-248v130h-60v-232h232v60H724l131 131-42 42Zm6-367q-1-29-5.5-59T797-600l58-18q12 32 18 65.5t6 68.5h-60Z"/></svg>',ms=Cl;var X=s=>{let o=document.createElement("div");return o.innerHTML=s,o.childNodes[0]},Sl=({IconProvider:s,EraserMode:o})=>class extends s{makeUndoIcon(){return X(Kr)}makeRedoIcon(){return X(Gr)}makeDropdownIcon(){return X(qr)}makeEraserIcon(e,n){return X(n===o.PartialStroke?_r:Zr)}makeSelectionIcon(e){return X(e==="lasso"?ms:ls)}makeRotateIcon(){return X(as)}makeHandToolIcon(){return X(jr)}makeTouchPanningIcon(){return X(Yr)}makeRotationLockIcon(){return X(Xr)}makeInsertImageIcon(){return X(Qr)}makeUploadFileIcon(){return X(ss)}makeTextIcon(e){return X(Jr)}makePenIcon(e){let n=this.isRoundedTipPen(e)?rs:is;this.isPolylinePen(e)&&(n=ps);let i=X(n);i.setAttribute("viewBox","0 -880 960 1000");let r=document.createElementNS("http://www.w3.org/2000/svg","path");if(r.setAttribute("d",`
			M110,-25 L850,-25
		`),r.style.stroke=e.color.toHexString(),r.style.strokeWidth=`${Math.sqrt(e.thickness)*20}`,this.isRoundedTipPen(e)?r.style.strokeLinecap="round":r.style.strokeLinecap="square",i.insertAdjacentElement("afterbegin",r),e.color.a<1){let a=this.makeCheckerboardPattern(),l=document.createElementNS("http://www.w3.org/2000/svg","defs");l.appendChild(a.patternDefElement),i.appendChild(l);let c=r.cloneNode();c.style.stroke=a.patternRef,i.insertAdjacentElement("afterbegin",c)}return i}makeShapeAutocorrectIcon(){return X(ds)}makeStrokeSmoothingIcon(){return X(us)}makeResizeImageToSelectionIcon(){return X(es)}makeDuplicateSelectionIcon(){return X(Mi)}makeCopyIcon(){return X(Mi)}makePasteIcon(){return X(hs)}makeDeleteSelectionIcon(){return X(ts)}makeCloseIcon(){return X(cs)}makeSaveIcon(){return X(ns)}makeConfigureDocumentIcon(){return X(os)}licenseInfo(){return $r}},fs=Sl;return Bs(wl);})();
/*! Bundled license information:

@melloware/coloris/dist/esm/coloris.js:
  (*!
  * Copyright (c) 2021-2023 Momo Bassit.
  * Licensed under the MIT License (MIT)
  * https://github.com/mdbassit/Coloris
  * Version: 0.21.1
  * NPM: https://github.com/melloware/coloris-npm
  *)
*/
